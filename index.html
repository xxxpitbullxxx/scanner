<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V40 - Hard Reset</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* RESET TOTALE */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: #000; font-family: monospace; height: 100vh; overflow: hidden; }

        /* SEZIONE CAMERA (Fissa in alto, 40%) */
        #cam-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 40%;
            background: black; z-index: 10;
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* MIRINO (Semplificato) */
        #guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 3px solid #00E0FF; width: 90%; height: 30%; 
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); pointer-events: none;
        }

        /* TAB DI NAVIGAZIONE (Sopra la camera) */
        .tabs {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
            display: flex; background: rgba(0,0,0,0.8);
        }
        .tab {
            flex: 1; padding: 15px; text-align: center; color: #fff; font-weight: bold;
            border-bottom: 4px solid #444; cursor: pointer;
        }
        .tab.active { border-bottom-color: #00E0FF; background: rgba(0,224,255,0.1); }
        .tab.front-active { border-bottom-color: #FFD60A; background: rgba(255,214,10,0.1); }

        /* SEZIONE DATI (Fissa in basso, 60%, SCORREVOLE) */
        #data-section {
            position: fixed; top: 40%; bottom: 0; left: 0; width: 100%;
            background: #121212; border-top: 4px solid #333;
            overflow-y: scroll; /* FORZA SCORRIMENTO */
            -webkit-overflow-scrolling: touch;
            padding: 15px; padding-bottom: 200px; /* SPAZIO EXTRA PER SCROLL */
        }

        /* PULSANTE AZIONE */
        #btn-action {
            width: 100%; padding: 20px; font-size: 20px; font-weight: bold;
            border: none; border-radius: 8px; margin-bottom: 20px;
            cursor: pointer; background: #00E0FF; color: #000;
        }

        /* CAMPI DATI */
        .field {
            background: #222; margin-bottom: 10px; padding: 12px;
            border-left: 5px solid #555; border-radius: 4px;
        }
        .field.ok { border-left-color: #32d74b; background: #1a2a1a; }
        
        .label { color: #888; font-size: 10px; display: block; margin-bottom: 5px; }
        .value { color: #fff; font-size: 16px; font-weight: bold; min-height: 20px; }

        /* DEBUG AREA (Per vedere cosa legge il fronte) */
        #raw-text {
            font-size: 10px; color: #555; margin-top: 20px; 
            border: 1px solid #333; padding: 5px; display: none;
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div id="cam-section">
        <div class="tabs">
            <div class="tab active" id="tab-retro" onclick="setMode('RETRO')">1. RETRO</div>
            <div class="tab" id="tab-front" onclick="setMode('FRONTE')">2. FRONTE</div>
        </div>
        <video id="webcam" autoplay playsinline></video>
        <div id="guide"></div>
    </div>

    <div id="data-section">
        <button id="btn-action">SCANSIONA RETRO</button>

        <div class="field"><span class="label">COGNOME</span><div class="value" id="res-cog"></div></div>
        <div class="field"><span class="label">NOME</span><div class="value" id="res-nom"></div></div>
        <div class="field"><span class="label">NUMERO DOCUMENTO</span><div class="value" id="res-doc"></div></div>
        <div class="field"><span class="label">DATA DI NASCITA</span><div class="value" id="res-dob"></div></div>
        <div class="field"><span class="label">DATA SCADENZA</span><div class="value" id="res-exp"></div></div>
        <div class="field"><span class="label">SESSO</span><div class="value" id="res-sex"></div></div>
        
        <hr style="border-color:#333; margin: 20px 0;">
        <div style="color:#FFD60A; font-weight:bold; margin-bottom:10px;">DATI FRONTE</div>

        <div class="field"><span class="label">CITTADINANZA</span><div class="value" id="res-cit"></div></div>
        <div class="field"><span class="label">LUOGO DI NASCITA</span><div class="value" id="res-birthplace"></div></div>
        <div class="field"><span class="label">RESIDENZA (Indirizzo)</span><div class="value" id="res-addr"></div></div>
        <div class="field"><span class="label">ENTE RILASCIO</span><div class="value" id="res-org"></div></div>

        <div id="raw-text">TESTO GREZZO OCR...</div>
        <br><br><br> </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const btn = document.getElementById('btn-action');
        const guide = document.getElementById('guide');
        const rawDiv = document.getElementById('raw-text');
        let mode = 'RETRO';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } })
            .then(s => video.srcObject = s);

        function setMode(m) {
            mode = m;
            if (m === 'RETRO') {
                document.getElementById('tab-retro').className = 'tab active';
                document.getElementById('tab-front').className = 'tab';
                guide.style.borderColor = '#00E0FF';
                guide.style.height = '30%'; // Stretto per MRZ
                btn.style.backgroundColor = '#00E0FF';
                btn.innerText = "SCANSIONA RETRO";
                video.style.filter = "contrast(1.2)"; // Contrasto per retro
            } else {
                document.getElementById('tab-front').className = 'tab front-active';
                document.getElementById('tab-retro').className = 'tab';
                guide.style.borderColor = '#FFD60A';
                guide.style.height = '70%'; // AMPIO per il fronte
                btn.style.backgroundColor = '#FFD60A';
                btn.innerText = "SCANSIONA FRONTE";
                video.style.filter = "brightness(1.1)"; // Luminosità per scritte grigie
                rawDiv.style.display = 'block'; // Mostra debug
            }
        }

        document.getElementById('btn-action').addEventListener('click', async () => {
            btn.innerText = "ELABORAZIONE...";
            const ctx = canvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            
            // Ritaglio
            let cw = vw * 0.90;
            // Se fronte, prendiamo quasi tutto lo schermo verticale
            let ch = (mode === 'RETRO') ? vh * 0.30 : vh * 0.70; 
            let cx = (vw - cw) / 2;
            let cy = (vh / 2) - (ch / 2);

            canvas.width = cw * 2; canvas.height = ch * 2; // Zoom 2x

            if (mode === 'RETRO') {
                ctx.filter = 'grayscale(100%) contrast(300%)';
            } else {
                // Filtro più delicato per il fronte
                ctx.filter = 'grayscale(100%) contrast(150%) brightness(110%)'; 
            }
            
            ctx.drawImage(video, cx, cy, cw, ch, 0, 0, canvas.width, canvas.height);

            try {
                // Whitelist estesa per il fronte
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                
                if (mode === 'RETRO') parseRetro(text);
                else parseFronte(text);
                
                btn.innerText = "COMPLETATO";
            } catch (e) { btn.innerText = "ERRORE"; }
        });

        // --- RETRO (Logica V36 ripristinata) ---
        function fix(s) { return s.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/A/g,'4'); }
        function parseRetro(txt) {
            const lines = txt.split('\n').map(l => l.replace(/\s/g,'').toUpperCase());
            
            // 1. Doc Number
            let docL = lines.find(l => (l.includes('ITA')||l.includes('1TA')) && l.length>10);
            if(docL) {
                let m = docL.match(/(ITA|1TA)/);
                if(m) {
                    let c = docL.substr(m.index+3, 9);
                    // Logica Anchor Lock V36
                    if(c.length===9) setVal('res-doc', c);
                }
            }
            // 2. Data & Sesso
            let datL = lines.find(l => l.match(/^\d/) && (l.includes('M')||l.includes('F')));
            if(datL) {
                let d=fix(datL.substr(4,2)); let m=fix(datL.substr(2,2)); let y=fix(datL.substr(0,2));
                setVal('res-dob', `${d}/${m}/${y>40?'19'+y:'20'+y}`);
                setVal('res-sex', datL.includes('M')?'M':'F');
                // Scadenza
                let idx = datL.search(/[MF]/);
                if(idx>-1) {
                    let s = datL.substr(idx+1).replace(/</g,'');
                    if(s.length>=6) {
                        let ed=fix(s.substr(4,2)); let em=fix(s.substr(2,2)); let ey=fix(s.substr(0,2));
                        setVal('res-exp', `${ed}/${em}/20${ey}`);
                    }
                }
            }
            // 3. Nome (Logica V36: cerca <<)
            let nomL = lines.find(l => l.includes('<<') && !l.includes('ITA'));
            if(nomL) {
                let parts = nomL.split('<<');
                setVal('res-cog', parts[0].replace(/</g,' '));
                setVal('res-nom', parts[1].replace(/</g,' '));
            }
            alert("Retro OK. Passa al Fronte.");
            setMode('FRONTE');
        }

        // --- FRONTE (Nuova Logica Grandangolo) ---
        function parseFronte(txt) {
            rawDiv.innerText = txt; // DEBUG: Vedi cosa legge!
            const up = txt.toUpperCase();
            
            // Cittadinanza
            if(up.includes('CITTADINANZA')) setVal('res-cit', 'ITALIANA');

            // Luogo Nascita (Cerca riga con NATO)
            let lines = up.split('\n');
            let natoIdx = lines.findIndex(l => l.includes('NATO') || l.includes('LUOGO'));
            if(natoIdx > -1 && lines[natoIdx+1]) {
                setVal('res-birthplace', lines[natoIdx+1].replace(/[^A-Z ]/g,''));
            }

            // Ente
            if(up.includes('MINISTERO')) setVal('res-org', 'MINISTERO DELL\'INTERNO');
            else if(up.includes('COMUNE')) {
                let com = lines.find(l => l.includes('COMUNE'));
                if(com) setVal('res-org', com.replace(/[^A-Z ]/g,''));
            }

            // Residenza (Cerca VIA, PIAZZA, ecc)
            // Se non legge nulla, prova a cambiare angolazione della luce!
            let addr = lines.find(l => l.match(/(VIA |VIALE |PIAZZA |CORSO |VICOLO |LARGO )/));
            if(addr) {
                setVal('res-addr', addr);
            } else {
                // Fallback: cerca dopo RESIDENZA
                let resIdx = up.indexOf('RESIDENZA');
                if(resIdx > -1) {
                    let chunk = up.substr(resIdx+9, 60);
                    setVal('res-addr', chunk.split('\n')[0]);
                }
            }
        }

        function setVal(id, v) {
            if(!v) return;
            let el = document.getElementById(id);
            el.innerText = v;
            el.parentElement.classList.add('ok');
        }
    </script>
</body>
</html>
