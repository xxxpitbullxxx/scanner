<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner V13 - Analisi Totale</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* Scorrimento libero garantito */
        html, body { background: #f0f2f5; margin: 0; padding: 0; overflow-y: auto !important; height: auto !important; -webkit-overflow-scrolling: touch; }
        .camera-container { position: relative; width: 100%; height: 350px; background: #000; border-bottom: 4px solid #007AFF; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .target { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 60%; border: 3px solid #34C759; border-radius: 15px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); pointer-events: none; z-index: 5; }
        
        .panel { padding: 20px; }
        .btn-scan { background: #007AFF; color: white; width: 100%; padding: 20px; border: none; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        
        .results-box { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .input-item { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; }
        
        #console-log { font-family: monospace; font-size: 10px; color: #d9534f; background: #fff; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ccc; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="camera-container">
        <video id="webcam" autoplay playsinline></video>
        <div class="target"></div>
    </div>

    <div class="panel">
        <div id="status" style="text-align:center; font-weight:bold; color:#007AFF; margin-bottom:10px;">PRONTO</div>
        <button class="btn-scan" id="go-scan">AVVIA SCANSIONE</button>

        <div class="results-box">
            <div class="input-item"><label>Cognome</label><input type="text" id="val-cognome"></div>
            <div class="input-item"><label>Nome</label><input type="text" id="val-nome"></div>
            <div class="input-item"><label>Data Nascita</label><input type="text" id="val-data"></div>
            <div class="input-item"><label>N. Documento</label><input type="text" id="val-doc"></div>
            <div class="input-item"><label>Indirizzo/Residenza</label><input type="text" id="val-res"></div>
        </div>

        <div id="console-log">Log di sistema: in attesa...</div>
    </div>

    <canvas id="hidden-canvas"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('hidden-canvas');
        const debug = document.getElementById('console-log');
        const status = document.getElementById('status');

        // Accesso Camera semplificato per massima compatibilitÃ 
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(s => { video.srcObject = s; debug.innerText = "Camera OK"; })
            .catch(e => { debug.innerText = "Errore Camera: " + e; });

        document.getElementById('go-scan').addEventListener('click', async () => {
            status.innerText = "SCANSIONE IN CORSO...";
            debug.innerText = "Cattura immagine...";
            
            const ctx = canvas.getContext('2d');
            // Risoluzione media per non bloccare il processore
            canvas.width = 1280;
            canvas.height = 800;

            // Filtro contrasto per separare le lettere dallo sfondo
            ctx.filter = 'grayscale(100%) contrast(180%)';
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            debug.innerText = "Avvio Tesseract engine...";

            try {
                // Analisi con Tesseract
                const result = await Tesseract.recognize(canvas, 'ita+eng', {
                    logger: m => { if(m.status === 'recognizing text') debug.innerText = "Progresso: " + (m.progress * 100).toFixed(0) + "%"; }
                });

                debug.innerText = "Testo grezzo trovato: " + result.data.text.substring(0, 30) + "...";
                processResults(result.data.text);
                status.innerText = "COMPLETATO!";
            } catch (err) {
                debug.innerText = "Errore OCR: " + err;
                status.innerText = "ERRORE";
            }
        });

        function processResults(raw) {
            const t = raw.toUpperCase();
            
            // 1. Numero Documento
            const doc = t.match(/[A-Z]{2}\s?\d{5}[A-Z]{2}/) || t.match(/[A-Z]{2}\s?\d{7}/);
            if (doc) document.getElementById('val-doc').value = doc[0].replace(/\s/g, '');

            // 2. Data di Nascita
            const data = t.match(/\d{2}.\d{2}.\d{4}/);
            if (data) document.getElementById('val-data').value = data[0];

            // 3. Cognome e Nome
            const lines = t.split('\n').map(l => l.trim()).filter(l => l.length > 2);
            lines.forEach((l, i) => {
                if (l.includes("COGNOME")) document.getElementById('val-cognome').value = lines[i+1]?.split(' ')[0] || "";
                if (l.includes("NOME")) {
                    let nome = lines[i+1]?.split(' ')[0] || "";
                    if (nome.endsWith('L') && nome.length > 4) nome = nome.slice(0, -1);
                    document.getElementById('val-nome').value = nome;
                }
                if (l.includes("VIA") || l.includes("PIAZZA")) document.getElementById('val-res').value = l;
            });

            // 4. Zona MRZ (Retro)
            const mrz = t.replace(/\s/g, '').match(/([A-Z]+)<<([A-Z]+)/);
            if (mrz) {
                document.getElementById('val-cognome').value = mrz[1];
                document.getElementById('val-nome').value = mrz[2];
            }
        }
    </script>
</body>
</html>
