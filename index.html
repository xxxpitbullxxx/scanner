<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner V33 - Hybrid Focus</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: monospace; background: #000; color: #fff; margin: 0; overflow: hidden; }
        
        .viewport { position: relative; width: 100vw; height: 55vh; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Mirino calibrato per le 3 righe MRZ */
        .scan-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 92%; height: 32%; 
            border: 3px solid #007AFF; /* Blu Focus */
            border-radius: 8px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.85);
            z-index: 10;
        }
        /* Linee divisorie visive per aiutare l'allineamento */
        .scan-line { width: 100%; height: 33.3%; border-bottom: 1px solid rgba(0, 122, 255, 0.3); box-sizing: border-box; }

        .hud-panel { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 45vh; 
            background: #1c1c1e; border-top: 2px solid #333; padding: 20px; box-sizing: border-box; 
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        .btn-scan { 
            background: #007AFF; color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .field-box { background: #2c2c2e; padding: 10px; border-radius: 8px; border-left: 5px solid #444; }
        .field-box.ok { border-left-color: #32d74b; background: #1a2e1e; }
        
        label { font-size: 10px; color: #888; display: block; margin-bottom: 4px; }
        .val { font-size: 18px; font-weight: bold; color: #fff; letter-spacing: 1px; min-height: 22px; }

        #log { font-size: 10px; color: #666; text-align: center; margin-top: 5px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="video" autoplay playsinline></video>
        <div class="scan-guide">
            <div class="scan-line"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <div class="hud-panel">
        <button class="btn-scan" id="scan-btn">SCANSIONE HD</button>
        
        <div class="field-box" id="box-doc">
            <label>NUMERO DOCUMENTO</label>
            <div class="val" id="res-doc">---</div>
        </div>
        <div class="field-box" id="box-dat">
            <label>DATA DI NASCITA</label>
            <div class="val" id="res-dob">---</div>
        </div>
        <div class="field-box" id="box-nom">
            <label>NOME COMPLETO</label>
            <div class="val" id="res-name">---</div>
        </div>
        
        <div id="log">Inquadra le 3 righe MRZ</div>
    </div>

    <canvas id="proc-canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('proc-canvas');
        const log = document.getElementById('log');

        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 } } 
        }).then(s => video.srcObject = s);

        document.getElementById('scan-btn').addEventListener('click', async () => {
            log.innerText = "SCANSIONE 2X IN CORSO...";
            
            // Ritaglio
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const cw = vw * 0.92;
            const ch = vh * 0.32;
            const cx = (vw - cw) / 2;
            const cy = (vh - ch) / 2;

            // TRUCCO RISOLUZIONE: Usiamo un canvas grande il DOPPIO del ritaglio
            // Questo aiuta Tesseract a leggere i caratteri piccoli del numero documento
            canvas.width = cw * 2;
            canvas.height = ch * 2;
            
            const ctx = canvas.getContext('2d');
            ctx.filter = 'grayscale(100%) contrast(200%) brightness(110%)';
            // Disegniamo l'immagine ingrandita 2x
            ctx.drawImage(video, cx, cy, cw, ch, 0, 0, cw * 2, ch * 2);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                    logger: m => log.innerText = `OCR: ${Math.round(m.progress * 100)}%`
                });
                
                analyzeText(text);
                log.innerText = "FINITO";
            } catch (e) { log.innerText = "Errore OCR"; }
        });

        // Correzione Intelligente
        function clean(str, type) {
            if(!str) return "";
            if (type === 'DOC') {
                // Forza: LL NNNNN LL
                let s = str.substring(0, 9);
                let res = "";
                for(let i=0; i<s.length; i++) {
                    if([0,1,7,8].includes(i)) res += s[i].replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
                    else res += s[i].replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
                }
                return res;
            }
            if (type === 'DATE') {
                return str.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
            }
            if (type === 'NAME') {
                return str.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B').replace(/</g, ' ').trim();
            }
            return str;
        }

        function analyzeText(raw) {
            console.log(raw);
            const lines = raw.split('\n').map(l => l.replace(/\s/g, '').toUpperCase()).filter(l => l.length > 6);

            // 1. TROVA RIGA DOCUMENTO (Contiene IT e numeri)
            // Migliorato: Cerca C<IT, ITA, o I<IT
            let docRow = lines.find(l => (l.includes('IT') || l.includes('1T')) && l.match(/[0-9]/) && l.includes('<'));
            
            if (docRow) {
                // Regex flessibile per catturare i 9 caratteri dopo il codice paese
                let m = docRow.match(/IT([A-Z0-9]{9})/);
                if (!m) m = docRow.match(/1T([A-Z0-9]{9})/); // Fix comune errore OCR
                
                if (m) {
                    let docNum = clean(m[1], 'DOC');
                    // Controllo validitÃ : deve iniziare con lettere e finire con lettere
                    if (docNum.match(/^[A-Z]{2}[0-9]{5}[A-Z]{2}$/)) {
                        document.getElementById('res-doc').innerText = docNum;
                        document.getElementById('box-doc').classList.add('ok');
                    }
                }
            }

            // 2. TROVA DATA DI NASCITA (Inizia con numeri)
            let dateRow = lines.find(l => l.match(/^\d/) && (l.includes('M') || l.includes('F')));
            if (dateRow) {
                let dob = clean(dateRow.substring(0, 6), 'DATE');
                if (dob.length === 6) {
                    let y = dob.substr(0,2);
                    let m = dob.substr(2,2);
                    let d = dob.substr(4,2);
                    let fullY = (parseInt(y) > 40) ? '19'+y : '20'+y;
                    document.getElementById('res-dob').innerText = `${d}/${m}/${fullY}`;
                    document.getElementById('box-dat').classList.add('ok');
                }
            }

            // 3. TROVA NOME (Contiene << e non inizia con numeri)
            let nameRow = lines.find(l => l.includes('<<') && !l.match(/^\d/) && !l.includes('IT'));
            if (nameRow) {
                let parts = nameRow.split('<<');
                let full = "";
                if (parts[0]) full += clean(parts[0], 'NAME') + " ";
                if (parts[1]) full += clean(parts[1], 'NAME');
                document.getElementById('res-name').innerText = full;
                document.getElementById('box-nom').classList.add('ok');
            }
        }
    </script>
</body>
</html>
