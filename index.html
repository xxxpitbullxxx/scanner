<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <!-- Librerie -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; position: relative; overflow-x: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* LOGO STYLES */
        .logo-main-circle { width: 180px; height: 180px; border-radius: 50%; overflow: hidden; border: 4px solid #d4af37; background: white; margin: 0 auto 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logo-main-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }
        .header-logo-circle { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid #d4af37; background: white; flex-shrink: 0; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }

        /* SCANNER STYLE */
        .scan-wrapper { position: relative; width: 100%; background: #000; overflow: hidden; height: 60vh; max-height: 500px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* GUIDE VISIVE (V104 STYLE) */
        .guide-overlay { position: absolute; inset: 0; pointer-events: none; }
        
        /* Zona Indirizzo (Gialla) */
        .guide-address {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            width: 94%; height: 14%;
            border: 2px dashed #FFD60A; border-radius: 4px;
            background: rgba(255, 214, 10, 0.1);
        }
        /* Zona MRZ (Azzurra - Bassa e stretta per evitare barcode) */
        .guide-mrz {
            position: absolute; top: 85%; left: 50%; transform: translate(-50%, -50%);
            width: 96%; height: 18%;
            border: 2px solid #00E0FF; border-radius: 4px;
            background: rgba(0, 224, 255, 0.1);
        }
        .guide-label {
            position: absolute; top: -22px; left: 0;
            background: rgba(0,0,0,0.8); color: white; font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 4px; white-space: nowrap;
        }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 15px; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #0f766e; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-secondary { background: #fff; color: #334155; border: 2px solid #e2e8f0; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .input-group { margin-bottom: 12px; }
        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .input-label.required::after { content: " *"; color: #ef4444; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: #fff; color: #1e293b; }
        .input-field:focus { border-color: #0f766e; outline: none; }

        .flag-btn { font-size: 24px; padding: 4px; opacity: 0.5; transition: 0.2s; cursor: pointer; background: transparent; border: none; filter: grayscale(100%); }
        .flag-btn.active { opacity: 1; transform: scale(1.1); filter: grayscale(0%); }

        .info-box { background: #eff6ff; border: 1px solid #dbeafe; color: #1e40af; padding: 12px; border-radius: 10px; font-size: 13px; line-height: 1.4; margin-bottom: 20px; text-align: left; }
        .success-box { background: #f0fdf4; border: 1px solid #86efac; color: #166534; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 600; margin-top: 15px; text-align: center; }

        .card-select { width: 100%; padding: 16px; border: 2px solid #f1f5f9; border-radius: 16px; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .card-select:hover { border-color: #0f766e; background: #f0fdfa; }

        .upload-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .upload-preview { width: 100%; height: 180px; border: 2px dashed #cbd5e1; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden; margin-bottom: 8px; }
        .upload-preview img { width: 100%; height: 100%; object-fit: contain; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 20px; padding: 20px; }

        .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURAZIONE ---
        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", code: "123456#" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", code: "9988" },
            "REGINA": { id: "REGINA", name: "Santa Regina", code: "4567" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome: "Benvenuto! Completa il check-in online.", login_ph: "CODICE PRENOTAZIONE", start_btn: "INIZIA IL CHECK-IN", 
                scan_title: "SCANSIONA DOCUMENTO", scan_info: "Inquadra il documento in orizzontale.", 
                scan_help: "Inquadra il RETRO: Indirizzo in alto, codici MRZ in basso.",
                photo_req: "FOTO OBBLIGATORIA", confirm_btn: "CONFERMA E CONTINUA", 
                add_guest: "AGGIUNGI OSPITE", save_guest: "SALVA OSPITE",
                warning_save: "Compila i campi obbligatori", finish_btn: "FINISCI E PROCEDI", verify: "Verifica Dati", 
                doc_type: "Tipo Documento", doc_e: "C.I. Elettronica", doc_p: "C.I. Cartacea", doc_pass: "Passaporto", doc_l: "Patente di Guida",
                thanks: "Grazie", success_msg: "Check-in completato con successo.", exit: "Esci", guest_list: "Ospiti Registrati", 
                ocr_btn: "SCATTA E LEGGI", ocr_processing: "ELABORAZIONE...", ocr_file_btn: "ðŸ“ CARICA FOTO",
                ocr_warn: "ATTENZIONE: Luci e ombre possono falsare i dati. Controlla nella scheda successiva.",
                guest_count_q: "Quanti ospiti siete? (1+ anni)", 
                guest_count_tip: "âš ï¸ IMPORTANTE: Se ognuno compila dal proprio telefono, scrivi 1 e poi invia questo link agli altri. Se invece compili TU per tutti ora, scrivi il numero totale.",
                continue: "CONTINUA",
                share_link: "COPIA LINK PER ALTRI OSPITI", guests_missing: "Mancano ancora ospiti da registrare",
                upload_docs_title: "Carica Documenti", upload_docs_desc: "Carica la foto fronte e retro del documento. Ãˆ obbligatorio.",
                take_photo: "SCATTA", upload_file: "CARICA", proceed_docs: "PROCEDI AI DOCUMENTI",
                label_res_zone: "RESIDENZA", label_mrz_zone: "CODICI MRZ",
                save_link_msg: "ðŸ’¡ SALVA QUESTO LINK! Ti servirÃ  per rivedere il codice porta senza rifare il check-in.",
                front: "Fronte", back_doc: "Retro"
            },
            en: { 
                welcome: "Welcome! Please complete online check-in.", login_ph: "BOOKING CODE", start_btn: "START CHECK-IN", 
                scan_title: "SCAN DOCUMENT", scan_info: "Scan document horizontally.", 
                scan_help: "Frame the BACK: Address top, MRZ codes bottom.",
                photo_req: "DOCUMENT PHOTO", confirm_btn: "SAVE & CONTINUE", 
                add_guest: "ADD GUEST", save_guest: "SAVE GUEST",
                warning_save: "Fill mandatory fields", finish_btn: "FINISH AND PROCEED", verify: "Verify Data",
                doc_type: "Document Type", doc_e: "Electronic ID", doc_p: "Paper ID", doc_pass: "Passport", doc_l: "Driving License",
                thanks: "Thank you", success_msg: "Check-in completed successfully.", exit: "Exit", guest_list: "Guests", 
                ocr_btn: "SNAP & READ", ocr_processing: "PROCESSING...", ocr_file_btn: "ðŸ“ UPLOAD FILE",
                ocr_warn: "WARNING: Check data in next screen.",
                guest_count_q: "How many guests? (1+ years)", 
                guest_count_tip: "âš ï¸ IMPORTANT: If everyone fills from their own phone, enter 1. If YOU fill for everyone now, enter total number.",
                continue: "CONTINUE",
                share_link: "COPY LINK FOR OTHERS", guests_missing: "Guests missing",
                upload_docs_title: "Upload Documents", upload_docs_desc: "Upload front and back photo. Mandatory.",
                take_photo: "TAKE", upload_file: "UPLOAD", proceed_docs: "PROCEED TO DOCS",
                label_res_zone: "ADDRESS", label_mrz_zone: "MRZ CODES",
                save_link_msg: "ðŸ’¡ SAVE THIS LINK! You'll need it to see the door code again.",
                front: "Front", back_doc: "Back"
            }
        };

        // --- ICONS ---
        const Icon = ({ name }) => {
            if(name==='scan') return <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7V5a2 2 0 012-2h2m10 0h2a2 2 0 012 2v2m0 10v2a2 2 0 01-2 2h-2m-10 0H5a2 2 0 01-2-2v-2M7 12h10"/></svg>;
            if(name==='check') return <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>;
            if(name==='trash') return <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>;
            if(name==='camera') return <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3" strokeWidth="2"/></svg>;
            if(name==='chevronLeft') return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"/></svg>;
            if(name==='lock') return <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>;
            if(name==='copy') return <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>;
            if(name==='upload') return <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>;
            return null;
        };

        // --- COMPONENTS ---
        const Header = ({ showBack, backStep, setStep, setLang, lang }) => (
            <div className="flex flex-col bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                <div className="flex justify-end p-2 pb-0">
                     <div className="flex space-x-1">
                        {['it','en','fr','es','de'].map(l => (
                             <button key={l} onClick={() => setLang(l)} className={`flag-btn ${lang === l ? 'active' : ''}`}>
                                 {l === 'it' ? 'ðŸ‡®ðŸ‡¹' : l === 'en' ? 'ðŸ‡¬ðŸ‡§' : l === 'fr' ? 'ðŸ‡«ðŸ‡·' : l === 'es' ? 'ðŸ‡ªðŸ‡¸' : 'ðŸ‡©ðŸ‡ª'}
                             </button>
                        ))}
                    </div>
                </div>
                <div className="flex items-center justify-center p-3 pt-0">
                    {showBack && <button onClick={() => setStep(backStep)} className="absolute left-4 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                    <div className="header-logo-circle"><img src="logo.png" /></div>
                    <div className="ml-3"><span className="block font-bold text-slate-700 text-[14px] leading-tight uppercase tracking-widest">Tuscan Retreats</span></div>
                </div>
            </div>
        );

        const SignaturePad = ({ canvasRef }) => {
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000'; };
                resize(); window.addEventListener('resize', resize);
                let isDrawing = false;
                const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const rect = canvas.getBoundingClientRect(); const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left; const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top; ctx.moveTo(x,y); };
                const draw = (e) => { if(!isDrawing) return; e.preventDefault(); const rect = canvas.getBoundingClientRect(); const x = (e.touches?e.touches[0].clientX:e.clientX)-rect.left; const y = (e.touches?e.touches[0].clientY:e.clientY)-rect.top; ctx.lineTo(x,y); ctx.stroke(); };
                const stop = () => isDrawing = false;
                canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stop);
            }, []);
            return <canvas ref={canvasRef} className="w-full h-full" />;
        };

        const CopyField = ({ label, value }) => (
            <div className="flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-200 relative group text-left mb-2">
                <span className="text-[9px] text-slate-400 uppercase font-bold">{label}</span>
                <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-sm truncate mr-2">{value || "-"}</span>
                    {value && <button onClick={(e) => {
                        e.stopPropagation(); navigator.clipboard.writeText(value);
                        alert("Copiato: " + value);
                    }} className="p-1 hover:bg-white rounded text-blue-600"><Icon name="copy"/></button>}
                </div>
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [lang, setLang] = useState('it');
            const [step, setStep] = useState('login');
            const [property, setProperty] = useState(null);
            const [guests, setGuests] = useState([]);
            const [formData, setFormData] = useState({});
            const [isScanning, setIsScanning] = useState(false);
            const [videoStream, setVideoStream] = useState(null);
            const [images, setImages] = useState({front:null, back:null});
            const [docType, setDocType] = useState('electronic');
            const [expectedGuests, setExpectedGuests] = useState(1);
            const [adminData, setAdminData] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);
            const [user, setUser] = useState(null);
            const [ocrProcessing, setOcrProcessing] = useState(false);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const sigCanvasRef = useRef(null);

            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;

            // INIT & ROUTING
            useEffect(() => {
                const init = async () => {
                    if (window.FirebaseSDK) {
                        try {
                            const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                            const auth = window.FirebaseSDK.getAuth(app);
                            window.db = window.FirebaseSDK.getFirestore(app);
                            await window.FirebaseSDK.signInAnonymously(auth);
                            window.FirebaseSDK.onAuthStateChanged(auth, setUser);
                        } catch(e) { console.error("FB Init", e); }
                    }
                    // URL Check
                    const params = new URLSearchParams(window.location.search);
                    const p = params.get('p');
                    if (p && PROPERTIES[p.toUpperCase()]) {
                        setProperty(PROPERTIES[p.toUpperCase()]);
                        setStep('welcome');
                    }
                };
                init();
            }, []);

            // CAMERA LOGIC
            const startCamera = async () => {
                setIsScanning(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    setVideoStream(stream);
                } catch(e) { 
                    alert("Errore fotocamera. Usa il caricamento file."); 
                    setIsScanning(false); 
                }
            };

            useEffect(() => {
                if(isScanning && videoRef.current && videoStream) {
                    videoRef.current.srcObject = videoStream;
                    videoRef.current.onloadedmetadata = () => videoRef.current.play();
                }
            }, [isScanning, videoStream]);

            const stopCamera = () => {
                if(videoStream) videoStream.getTracks().forEach(t => t.stop());
                setVideoStream(null);
                setIsScanning(false);
            };

            // OCR LOGIC
            const runOCR = async (source) => {
                setOcrProcessing(true);
                const canvas = document.getElementById('ocr-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1000; canvas.height = 600; // High Res
                ctx.drawImage(source, 0, 0, 1000, 600);
                ctx.filter = 'grayscale(100%) contrast(150%)'; 
                
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                    const clean = text.toUpperCase().replace(/\s/g, '');
                    let newData = {...formData};
                    let found = false;

                    if (docType === 'passport') {
                        // Logic Passaporto
                        let r1 = clean.match(/P<([A-Z]{3})([A-Z<]+)/);
                        if(r1) { 
                            newData.surname = r1[2].split('<<')[0].replace(/</g, ' '); 
                            newData.name = r1[2].split('<<')[1].replace(/</g, ' ');
                            found = true; 
                        }
                    } else {
                        // Logic CIE V104 (Retro)
                        let nm = clean.match(/([A-Z0-9]+)<<([A-Z0-9]+)/);
                        if(nm) { 
                             newData.surname = nm[1].replace(/\d/g,'').replace(/</g,' ');
                             newData.name = nm[2].replace(/\d/g,'').replace(/</g,' ');
                             found = true;
                        }
                        // Address from visual zone
                        const lines = text.toUpperCase().split('\n');
                        lines.forEach(l => {
                            if(l.match(/(VIA|PIAZZA|CORSO|V\.|P\.)/)) { newData.residenceAddress = l.trim(); }
                        });
                    }

                    if(found) { setFormData(newData); alert("Dati trovati!"); setStep('manual_entry'); } 
                    else { alert("Dati non chiari. Inserisci manualmente."); }
                } catch(e) { alert("Errore lettura OCR"); }
                
                setOcrProcessing(false);
                stopCamera();
            };

            const handleFileUpload = (e) => {
                if(e.target.files[0]) {
                    const img = new Image();
                    img.onload = () => runOCR(img);
                    img.src = URL.createObjectURL(e.target.files[0]);
                }
            };

            const addGuest = () => {
                setGuests([...guests, formData]);
                setFormData({});
                setImages({front:null, back:null});
                setStep('guest_list');
            };

            const saveAll = async () => {
                const id = `${property?.id}_${Date.now()}`;
                if (window.db) {
                     await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id), {
                         guests, 
                         signature: sigCanvasRef.current?.toDataURL(),
                         property: property.name,
                         date: new Date().toISOString()
                     });
                }
                setStep('success');
            };

            const fetchAdmin = async () => {
                if(!window.db) return;
                const snap = await window.FirebaseSDK.getDocs(window.FirebaseSDK.collection(window.db, 'artifacts', appId, 'public', 'data', 'checkins'));
                let d = []; snap.forEach(doc => d.push({id: doc.id, ...doc.data()}));
                setAdminData(d);
            };

            // RENDER
            if (step === 'login') return (
                <div className="app-container p-8 justify-center text-center">
                    <div className="logo-main-circle"><img src="logo.png" /></div>
                    <h1 className="text-2xl font-bold mb-6">LOGIN</h1>
                    <button onClick={() => setStep('admin_pass')} className="text-slate-400 text-sm underline">Admin</button>
                </div>
            );

            if (step === 'admin_pass') return (
                <div className="app-container p-8 justify-center text-center">
                    <input id="pwd" type="password" className="input-field mb-4 text-center" placeholder="Password" />
                    <button onClick={() => { if(document.getElementById('pwd').value==='W0d@w0d@') { fetchAdmin(); setStep('admin_panel'); } }} className="btn btn-primary">ENTRA</button>
                </div>
            );

            if (step === 'admin_panel') return (
                <div className="app-container p-6 overflow-y-auto">
                    <Header showBack={true} backStep="login" setStep={setStep} setLang={setLang} lang={lang} />
                    <h2 className="text-xl font-bold text-center my-4">Pannello Admin</h2>
                    {adminData.map((s, i) => (
                        <div key={i} className="p-4 border rounded-xl mb-2 shadow-sm bg-slate-50" onClick={() => setSelectedSession(s)}>
                            <div className="font-bold">{s.guests[0]?.surname} {s.guests[0]?.name}</div>
                            <div className="text-xs text-gray-500">{s.property} - {new Date(s.date).toLocaleDateString()}</div>
                        </div>
                    ))}
                    {selectedSession && (
                        <div className="modal" onClick={() => setSelectedSession(null)}>
                            <div className="bg-white w-full rounded-2xl p-6 max-h-[85vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                {selectedSession.guests.map((g, idx) => (
                                    <div key={idx} className="mb-6 border-b pb-4">
                                        <h3 className="font-bold mb-2">Ospite {idx+1}</h3>
                                        <div className="grid grid-cols-2 gap-2">
                                            <CopyField label="Cognome" value={g.surname} />
                                            <CopyField label="Nome" value={g.name} />
                                            <CopyField label="Nato il" value={g.birthDate} />
                                            <CopyField label="Cittadinanza" value={g.citizenship} />
                                            <div className="col-span-2"><CopyField label="Indirizzo" value={g.residenceAddress} /></div>
                                        </div>
                                    </div>
                                ))}
                                <button className="btn btn-primary mt-4" onClick={() => setSelectedSession(null)}>Chiudi</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (step === 'welcome') return (
                <div className="app-container p-8 justify-center text-center">
                    <div className="logo-main-circle"><img src="logo.png"/></div>
                    <h1 className="text-2xl font-bold mb-2">Benvenuto a {property?.name}</h1>
                    <button onClick={() => setStep('guests_count')} className="btn btn-primary mt-8">{t.start_btn}</button>
                </div>
            );

            if (step === 'guests_count') return (
                <div className="app-container p-8 justify-center text-center">
                    <h2 className="text-xl font-bold mb-4">{t.guest_count_q}</h2>
                    <div className="info-blue">{t.guest_count_tip}</div>
                    <div className="flex items-center justify-center gap-6 mb-8">
                        <button onClick={()=>setExpectedGuests(Math.max(1, expectedGuests-1))} className="btn btn-secondary w-12">-</button>
                        <span className="text-3xl font-bold">{expectedGuests}</span>
                        <button onClick={()=>setExpectedGuests(expectedGuests+1)} className="btn btn-secondary w-12">+</button>
                    </div>
                    <button onClick={() => { setGuests([]); setStep('guest_list'); }} className="btn btn-primary">{t.continue}</button>
                </div>
            );

            if (step === 'guest_list') return (
                <div className="app-container p-6">
                    <Header setStep={setStep} setLang={setLang} lang={lang} />
                    <h2 className="text-xl font-bold mb-4">Ospiti {guests.length}/{expectedGuests}</h2>
                    {guests.map((g, i) => (
                        <div key={i} className="p-3 border rounded-lg mb-2 flex justify-between">
                            <span>{g.name} {g.surname}</span> <span className="text-green-600">âœ“</span>
                        </div>
                    ))}
                    {guests.length < expectedGuests ? 
                        <button onClick={() => { setFormData({}); setStep('type_select'); }} className="btn btn-secondary mt-4">+ {t.add_guest}</button> :
                        <button onClick={() => setStep('sign')} className="btn btn-primary mt-4">{t.finish_btn}</button>
                    }
                </div>
            );

            if (step === 'type_select') return (
                <div className="app-container p-6 text-center">
                    <Header showBack={true} backStep="guest_list" setStep={setStep} setLang={setLang} lang={lang} />
                    <h2 className="text-xl font-bold my-6">{t.doc_type}</h2>
                    <div className="space-y-3">
                        <div onClick={()=>{setDocType('electronic'); setStep('scan')}} className="card-select">C.I. Elettronica</div>
                        <div onClick={()=>{setDocType('paper'); setStep('scan')}} className="card-select">C.I. Cartacea</div>
                        <div onClick={()=>{setDocType('passport'); setStep('scan')}} className="card-select">Passaporto</div>
                    </div>
                </div>
            );

            if (step === 'scan') return (
                <div className="app-container flex flex-col bg-black text-white">
                    {isScanning ? (
                        <div className="flex-1 relative">
                            <div className="scan-wrapper-full">
                                <video ref={videoRef} autoPlay playsInline></video>
                                <div className="guide-overlay">
                                    <div className="zone-residenza"><span className="label-guide">{t.label_res_zone}</span></div>
                                    <div className="zone-mrz"><span className="label-guide">{t.label_mrz_zone}</span></div>
                                </div>
                            </div>
                            <div className="p-4 flex gap-4 justify-center bg-white">
                                <button onClick={stopCamera} className="btn btn-danger w-1/3">Stop</button>
                                <button onClick={() => { 
                                    const cvs = document.createElement('canvas'); 
                                    cvs.width=1000; cvs.height=600; 
                                    cvs.getContext('2d').drawImage(videoRef.current,0,0,1000,600); 
                                    runOCR(cvs); 
                                }} className="btn btn-primary w-1/3">SCATTA</button>
                            </div>
                        </div>
                    ) : (
                        <div className="p-6 bg-white text-slate-800 flex-1 flex flex-col justify-center">
                            <h2 className="text-xl font-bold mb-4">{t.scan_title}</h2>
                            <p className="mb-6 text-sm">{t.scan_help}</p>
                            <button onClick={startCamera} className="btn btn-primary mb-4">{t.ocr_btn}</button>
                            <button onClick={() => fileInputRef.current.click()} className="btn btn-secondary mb-4">{t.ocr_file_btn}</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                            <button onClick={() => setStep('manual_entry')} className="text-xs underline text-gray-500">Salta Scansione</button>
                            {ocrProcessing && <p className="text-blue-600 font-bold mt-4 animate-pulse">Analisi in corso...</p>}
                        </div>
                    )}
                </div>
            );

            if (step === 'manual_entry') return (
                <div className="app-container p-6 overflow-y-auto">
                    <Header showBack={true} backStep="scan" setStep={setStep} setLang={setLang} lang={lang} />
                    <h2 className="text-xl font-bold my-4 text-center">{t.verify}</h2>
                    <div className="space-y-4 pb-20">
                        <input className="input-field" placeholder="Cognome" value={formData.surname || ''} onChange={e=>setFormData({...formData, surname:e.target.value.toUpperCase()})} />
                        <input className="input-field" placeholder="Nome" value={formData.name || ''} onChange={e=>setFormData({...formData, name:e.target.value.toUpperCase()})} />
                        <select className="input-field" value={formData.citizenship || 'ITALIANA'} onChange={e=>setFormData({...formData, citizenship:e.target.value})}>
                            <option value="ITALIANA">ITALIANA</option><option value="ESTERA">ESTERA</option>
                        </select>
                        <input className="input-field" placeholder="Indirizzo" value={formData.residenceAddress || ''} onChange={e=>setFormData({...formData, residenceAddress:e.target.value})} />
                        <button onClick={() => setStep('upload_docs')} className="btn btn-success mt-4">AVANTI</button>
                    </div>
                </div>
            );

            if (step === 'upload_docs') return (
                <div className="app-container p-6 text-center">
                    <h2 className="text-xl font-bold mb-4">{t.photo_req}</h2>
                    <div className="mb-4">
                        <div className="upload-preview mb-2">{images.front ? <img src={images.front}/> : <span className="text-gray-300">Fronte</span>}</div>
                        <div className="upload-row">
                             <button className="upload-btn-small" onClick={()=>document.getElementById('f-cam').click()}>Scatta</button>
                             <button className="upload-btn-small" onClick={()=>document.getElementById('f-up').click()}>Carica</button>
                             <input type="file" id="f-cam" capture="environment" className="hidden" onChange={e=>setImages({...images, front:URL.createObjectURL(e.target.files[0])})} />
                             <input type="file" id="f-up" className="hidden" onChange={e=>setImages({...images, front:URL.createObjectURL(e.target.files[0])})} />
                        </div>
                    </div>
                    <button onClick={addGuest} disabled={!images.front} className="btn btn-primary">SALVA OSPITE</button>
                </div>
            );

            if (step === 'sign') return (
                <div className="app-container p-6 text-center">
                    <h2 className="text-xl font-bold mb-4">{t.sign_title}</h2>
                    <div className="border-2 border-dashed h-40 mb-4 rounded-xl overflow-hidden"><SignaturePad canvasRef={sigCanvasRef} /></div>
                    <button onClick={saveAll} className="btn btn-primary">{t.confirm_btn}</button>
                </div>
            );

            if (step === 'success') return (
                <div className="app-container p-8 justify-center text-center">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><Icon name="check" /></div>
                    <h2 className="text-2xl font-bold mb-2">Fatto!</h2>
                    <div className="bg-slate-100 p-6 rounded-xl my-6">
                        <p className="text-xs text-gray-500 mb-1">CODICE PORTA</p>
                        <p className="text-4xl font-mono font-bold tracking-widest">{property?.code}</p>
                    </div>
                    <div className="info-success mb-6">{t.save_link_msg}</div>
                    <button onClick={() => { navigator.clipboard.writeText(window.location.href); alert("Link copiato!"); }} className="btn btn-secondary border-green-200 text-green-700">{t.share_link}</button>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
