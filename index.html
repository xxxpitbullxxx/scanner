<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner V30 - Pattern Lock</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: monospace; background: #111; color: #fff; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        .viewport { position: relative; width: 100%; max-width: 600px; height: 60vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* MIRINO: Verde quando aggancia, Rosso quando cerca */
        .scanner-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 20%; 
            border: 4px solid #ff3b30; /* Rosso di default */
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.85);
            z-index: 10; transition: border-color 0.3s;
        }
        .scanner-box.locked { border-color: #32d74b; } /* Diventa verde se trova il pattern */

        .hud { position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 14px; color: #aaa; }

        .output-panel { 
            width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; 
            background: #222; border-top: 2px solid #333; height: 40vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #result-display { 
            font-size: 32px; letter-spacing: 4px; font-weight: bold; color: #32d74b; 
            background: #000; padding: 15px 30px; border-radius: 10px; border: 2px solid #333;
            margin-bottom: 20px; text-transform: uppercase;
        }

        .btn-scan { 
            background: #007AFF; color: white; border: none; padding: 15px 40px; 
            font-size: 18px; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,122,255,0.4);
        }
        .btn-scan:active { transform: scale(0.95); }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="video" autoplay playsinline></video>
        <div class="scanner-box" id="guide"></div>
        <div class="hud" id="status">INQUADRA LA RIGA "C&lt;ITA..."</div>
    </div>

    <div class="output-panel">
        <div id="result-display">-------</div>
        <button class="btn-scan" id="start-btn">AVVIA SCANSIONE</button>
    </div>

    <canvas id="hidden-canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('hidden-canvas');
        const display = document.getElementById('result-display');
        const guide = document.getElementById('guide');
        const status = document.getElementById('status');

        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
        }).then(stream => video.srcObject = stream);

        document.getElementById('start-btn').addEventListener('click', () => {
            status.innerText = "ANALISI IN CORSO...";
            scanFrame();
        });

        async function scanFrame() {
            const ctx = canvas.getContext('2d');
            
            // 1. Ritaglio stretto (solo la zona dentro il rettangolo rosso)
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const cropW = vw * 0.85;
            const cropH = vh * 0.20;
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            canvas.width = cropW;
            canvas.height = cropH;

            // 2. Filtro Binario Estremo (Bianco/Nero puro)
            ctx.filter = 'grayscale(100%) contrast(300%)';
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            try {
                // Eseguiamo l'OCR
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'
                });

                // 3. IL FILTRO "PATTERN LOCK"
                // Cerchiamo ESATTAMENTE 2 lettere, 5 numeri, 2 lettere. 
                // Se non c'è, restituiamo NULLA.
                const clean = text.replace(/\s/g, '');
                
                // Regex per la CIE (es. CA50322TW)
                // Cerca un blocco che abbia 2 lettere, 5 numeri, 2 lettere
                // Oppure cerca dentro la stringa MRZ (dopo C<IT o dopo ITA)
                let match = clean.match(/[A-Z]{2}[0-9]{5}[A-Z]{2}/);
                
                // Regex secondaria per MRZ (che potrebbe contenere errori comuni come O al posto di 0)
                if (!match) match = clean.match(/IT([A-Z0-9]{9})/);
                if (!match) match = clean.match(/C<IT([A-Z0-9]{9})/);

                if (match) {
                    let code = match[1] || match[0];
                    code = fixChars(code); // Correggiamo eventuali 0/O scambiati
                    
                    // Solo se il codice corretto è lungo 9 caratteri lo mostriamo
                    if (code.length === 9) {
                        display.innerText = code;
                        guide.classList.add('locked'); // Diventa verde
                        status.innerText = "DOCUMENTO TROVATO";
                        return; // Stop scansione
                    }
                }

                // Se siamo qui, non ha trovato nulla di valido. Riprova tra poco.
                guide.classList.remove('locked');
                status.innerText = "Nessun codice valido... Riprova";
                // setTimeout(scanFrame, 500); // Scommenta se vuoi scansione continua

            } catch (e) {
                console.error(e);
            }
        }

        function fixChars(str) {
            // Logica posizionale: LL NNNNN LL
            let res = "";
            let s = str.substring(0, 9);
            for (let i = 0; i < 9; i++) {
                let c = s[i];
                if ([0,1,7,8].includes(i)) { // Lettere
                    res += c.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
                } else { // Numeri
                    res += c.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
                }
            }
            return res;
        }
    </script>
</body>
</html>
