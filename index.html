<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <!-- LIBRERIE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

    <!-- FONT & STILI -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; position: relative; overflow-x: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* LOGHI */
        .logo-main-circle { width: 160px; height: 160px; border-radius: 50%; overflow: hidden; border: 4px solid #d4af37; background: white; margin: 0 auto 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .logo-main-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }
        .header-logo-circle { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #d4af37; background: white; flex-shrink: 0; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }

        /* FOTO HOST */
        .host-photo-circle { width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin: 0 auto 15px; }
        .host-photo-circle img { width: 100%; height: 100%; object-fit: cover; }

        /* SCANNER FULL SCREEN */
        .scan-wrapper-full {
            position: relative; width: 100vw; height: 500px; background: #000; overflow: hidden;
            left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* GUIDE VISIVE */
        .guide-overlay { position: absolute; inset: 0; pointer-events: none; }
        
        /* Giallo: Indirizzo (Alto) */
        .zone-residenza {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            width: 94%; height: 14%; 
            border: 2px dashed #FFD60A; border-radius: 6px; 
            background: rgba(255, 214, 10, 0.1);
            box-shadow: 0 0 0 999px rgba(0,0,0,0.5); /* Oscura il resto */
            z-index: 10;
        }
        /* Azzurro: MRZ (Basso) */
        .zone-mrz {
            position: absolute; top: 85%; left: 50%; transform: translate(-50%, -50%);
            width: 96%; height: 18%; 
            border: 2px solid #00E0FF; border-radius: 6px;
            background: rgba(0, 224, 255, 0.1);
            z-index: 10;
        }
        .label-guide { 
            position: absolute; top: -25px; left: 0;
            font-size: 11px; font-weight: 800; padding: 2px 8px; 
            background: rgba(0,0,0,0.8); color: white; border-radius: 4px; 
            text-transform: uppercase; white-space: nowrap;
        }

        /* UI ELEMENTS */
        .input-field { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; background: #fff; transition: all 0.2s; margin-bottom: 8px; color: #1e293b; }
        .input-field:focus { border-color: #0f766e; outline: none; box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1); }
        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 2px; }
        .input-label.required::after { content: " *"; color: #ef4444; }

        .btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 15px; display: flex; justify-content: center; align-items: center; transition: 0.2s; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #0f766e; color: white; box-shadow: 0 4px 10px rgba(15, 118, 110, 0.2); }
        .btn-secondary { background: #fff; color: #334155; border: 2px solid #e2e8f0; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .flag-btn { font-size: 24px; padding: 5px; opacity: 0.5; transition: 0.2s; background: transparent; border: none; filter: grayscale(100%); cursor: pointer; }
        .flag-btn.active { opacity: 1; transform: scale(1.1); filter: grayscale(0%); }

        .card-select { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #f1f5f9; background: white; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .card-select:hover { border-color: #0f766e; background: #f0fdfa; }

        .upload-preview { width: 100%; height: 200px; border: 2px dashed #cbd5e1; border-radius: 16px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden; margin-bottom: 10px; position: relative; }
        .upload-preview img { width: 100%; height: 100%; object-fit: contain; }
        .upload-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .upload-btn-small { flex: 1; padding: 12px; border-radius: 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; border: 1px solid #cbd5e1; background: white; color: #334155; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 20px; padding: 20px; }

        .info-blue { background: #eff6ff; border: 1px solid #dbeafe; color: #1e40af; padding: 15px; border-radius: 12px; font-size: 13px; line-height: 1.5; margin-bottom: 20px; text-align: left; }
        .info-success { background: #f0fdf4; border: 1px solid #86efac; color: #166534; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 600; margin-top: 20px; text-align: center; line-height: 1.4; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <!-- Canvas nascosti per il ritaglio immagine -->
    <canvas id="crop-canvas" style="display:none;"></canvas>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURAZIONE ---
        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", code: "123456#" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", code: "9988" },
            "REGINA": { id: "REGINA", name: "Santa Regina", code: "4567" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome_title: "Benvenuto", welcome_text: "Ciao! Sono Giulia. Per rendere il tuo arrivo piÃ¹ semplice, ti chiedo di completare il check-in online.",
                start_btn: "INIZIA IL CHECK-IN", login_ph: "CODICE PRENOTAZIONE", enter: "ENTRA",
                guest_q: "Quanti ospiti siete? (1+ anni)", guest_tip: "âš ï¸ IMPORTANTE: Se ognuno compila dal proprio telefono, scrivi 1 e poi invia questo link agli altri. Se invece compili TU per tutti ora, scrivi il numero totale di ospiti.", continue: "CONTINUA",
                doc_type: "Tipo Documento", doc_e: "C.I. Elettronica", doc_p: "C.I. Cartacea", doc_pass: "Passaporto", doc_l: "Patente di Guida",
                scan_title: "SCANSIONA DOCUMENTO", scan_info: "Inquadra il documento in orizzontale.", scan_help: "Retro C.I. o Pagina Dati Passaporto.",
                ocr_btn: "SCATTA E LEGGI", ocr_file_btn: "ðŸ“ CARICA FOTO", ocr_processing: "ELABORAZIONE...", ocr_warn: "ATTENZIONE: Luci e ombre possono falsare i dati.", ocr_success: "Dati rilevati! Verifica i campi.",
                verify: "Verifica Dati", photo_req: "FOTO OBBLIGATORIA", save: "SALVA OSPITE",
                label_surname: "Cognome", label_name: "Nome", label_sex: "Sesso", label_birth: "Nato il", label_city: "Comune Nascita", label_prov: "Prov.", label_citizenship: "Cittadinanza", label_res_city: "CittÃ  Residenza", label_res_prov: "Prov.", label_address: "Via / Piazza", label_civic: "Civico", label_docnum: "N. Documento", label_expiry: "Scadenza", label_issued: "Rilasciato da", label_issued_ph: "Es. Comune di...",
                front: "Fronte", back_doc: "Retro", take_photo: "SCATTA FOTO", upload_file: "CARICA FILE",
                sign_title: "Firma e Tassa", tax_info: "Tassa soggiorno da pagare in loco.", clear_sign: "CANCELLA FIRMA", confirm_btn: "CONFERMA E FINE",
                success_title: "Fatto!", success_msg: "Check-in completato con successo.", save_link_msg: "ðŸ’¡ IMPORTANTE: Salva questo link! Se dimentichi il codice, potrai riaprirlo per visualizzarlo senza rifare il check-in.", share_link: "INVIA LINK AGLI ALTRI", exit: "Esci"
            },
            en: { 
                welcome_title: "Welcome", welcome_text: "Hi! I'm Giulia. Please complete online check-in.",
                start_btn: "START CHECK-IN", login_ph: "BOOKING CODE", enter: "ENTER",
                guest_q: "How many guests?", guest_tip: "âš ï¸ IMPORTANT: Enter 1 if each person fills their own. Enter total if YOU fill for everyone.", continue: "CONTINUE",
                doc_type: "Document Type", doc_e: "Electronic ID", doc_p: "Paper ID", doc_pass: "Passport", doc_l: "Driving License",
                scan_title: "SCAN DOCUMENT", scan_info: "Scan document horizontally.", scan_help: "ID Back or Passport Data Page.",
                ocr_btn: "SNAP & READ", ocr_file_btn: "ðŸ“ UPLOAD FILE", ocr_processing: "PROCESSING...", ocr_warn: "WARNING: Check data carefully.", ocr_success: "Data detected!",
                verify: "Verify Data", photo_req: "PHOTO REQUIRED", save: "SAVE GUEST",
                label_surname: "Surname", label_name: "Name", label_sex: "Sex", label_birth: "Birth Date", label_city: "Birth City", label_prov: "Prov.", label_citizenship: "Citizenship", label_res_city: "Residence City", label_res_prov: "Prov.", label_address: "Address", label_civic: "No.", label_docnum: "Doc Number", label_expiry: "Expiry Date", label_issued: "Issued by", label_issued_ph: "Ex. City of...",
                front: "Front", back_doc: "Back", take_photo: "TAKE PHOTO", upload_file: "UPLOAD FILE",
                sign_title: "Signature", tax_info: "City tax to be paid on site.", clear_sign: "CLEAR", confirm_btn: "CONFIRM & FINISH",
                success_title: "Done!", success_msg: "Check-in completed.", save_link_msg: "ðŸ’¡ SAVE THIS LINK!", share_link: "SEND LINK TO OTHERS", exit: "Exit"
            },
            fr: { welcome_title: "Bienvenue", welcome_text: "Salut ! Je suis Giulia. Veuillez complÃ©ter l'enregistrement.", start_btn: "COMMENCER", login_ph: "CODE", enter: "ENTRER", guest_q: "Combien d'invitÃ©s ?", guest_tip: "âš ï¸ IMPORTANT : Entrez 1 si chacun remplit le sien.", continue: "CONTINUER", doc_type: "Type de document", doc_e: "C.I. Ã‰lectronique", doc_p: "C.I. Papier", doc_pass: "Passeport", doc_l: "Permis", scan_title: "SCANNER", scan_info: "Horizontalement.", scan_help: "Verso C.I. ou Passeport.", ocr_btn: "SCANNER", ocr_file_btn: "ðŸ“ FICHIER", ocr_processing: "TRAITEMENT...", ocr_warn: "Attention aux reflets.", ocr_success: "DonnÃ©es trouvÃ©es !", verify: "VÃ©rifier", photo_req: "PHOTO", save: "ENREGISTRER", label_surname: "Nom", label_name: "PrÃ©nom", label_sex: "Sexe", label_birth: "NÃ© le", label_city: "Ville Naissance", label_prov: "Prov.", label_citizenship: "NationalitÃ©", label_res_city: "Ville RÃ©sidence", label_res_prov: "Prov.", label_address: "Adresse", label_civic: "NÂ°", label_docnum: "NÂ° Doc", label_expiry: "Expiration", label_issued: "DÃ©livrÃ© par", label_issued_ph: "Ex. Ville de...", front: "Recto", back_doc: "Verso", take_photo: "PHOTO", upload_file: "FICHIER", sign_title: "Signature", tax_info: "Taxe de sÃ©jour sur place.", clear_sign: "EFFACER", confirm_btn: "TERMINER", success_title: "Fini !", success_msg: "Enregistrement terminÃ©.", save_link_msg: "ðŸ’¡ SAUVEGARDEZ CE LIEN !", share_link: "PARTAGER LIEN", exit: "Sortie" },
            es: { welcome_title: "Bienvenido", welcome_text: "Â¡Hola! Soy Giulia. Complete el registro.", start_btn: "EMPEZAR", login_ph: "CÃ“DIGO", enter: "ENTRAR", guest_q: "Â¿CuÃ¡ntos huÃ©spedes?", guest_tip: "âš ï¸ IMPORTANTE: Ingrese 1 si cada uno llena el suyo.", continue: "CONTINUAR", doc_type: "Tipo Documento", doc_e: "DNI ElectrÃ³nico", doc_p: "DNI Papel", doc_pass: "Pasaporte", doc_l: "Licencia", scan_title: "ESCANEAR", scan_info: "Horizontalmente.", scan_help: "Dorso DNI o Pasaporte.", ocr_btn: "ESCANEAR", ocr_file_btn: "ðŸ“ ARCHIVO", ocr_processing: "PROCESANDO...", ocr_warn: "Cuidado con los reflejos.", ocr_success: "Â¡Datos encontrados!", verify: "Verificar", photo_req: "FOTO", save: "GUARDAR", label_surname: "Apellido", label_name: "Nombre", label_sex: "Sexo", label_birth: "Nacido el", label_city: "Ciudad Nacimiento", label_prov: "Prov.", label_citizenship: "Nacionalidad", label_res_city: "Ciudad Residencia", label_res_prov: "Prov.", label_address: "DirecciÃ³n", label_civic: "NÂ°", label_docnum: "NÂ° Doc", label_expiry: "Caducidad", label_issued: "Expedido por", label_issued_ph: "Ej. Ciudad de...", front: "Frente", back_doc: "Dorso", take_photo: "FOTO", upload_file: "ARCHIVO", sign_title: "Firma", tax_info: "Tasa turÃ­stica en el lugar.", clear_sign: "BORRAR", confirm_btn: "TERMINAR", success_title: "Â¡Hecho!", success_msg: "Registro completado.", save_link_msg: "ðŸ’¡ Â¡GUARDE ESTE ENLACE!", share_link: "COMPARTIR ENLACE", exit: "Salir" },
            de: { welcome_title: "Willkommen", welcome_text: "Hallo! Ich bin Giulia. Bitte Check-in abschlieÃŸen.", start_btn: "STARTEN", login_ph: "CODE", enter: "EINGEBEN", guest_q: "Wie viele GÃ¤ste?", guest_tip: "âš ï¸ WICHTIG: Geben Sie 1 ein, wenn jeder selbst ausfÃ¼llt.", continue: "WEITER", doc_type: "Dokumentart", doc_e: "Elektronisch ID", doc_p: "Papier ID", doc_pass: "Reisepass", doc_l: "FÃ¼hrerschein", scan_title: "SCANNEN", scan_info: "Horizontal.", scan_help: "RÃ¼ckseite ID oder Reisepass.", ocr_btn: "SCANNEN", ocr_file_btn: "ðŸ“ DATEI", ocr_processing: "VERARBEITUNG...", ocr_warn: "Achten Sie auf Reflexionen.", ocr_success: "Daten gefunden!", verify: "ÃœberprÃ¼fen", photo_req: "FOTO", save: "SPEICHERN", label_surname: "Nachname", label_name: "Vorname", label_sex: "Geschlecht", label_birth: "Geburtsdatum", label_city: "Geburtsort", label_prov: "Prov.", label_citizenship: "NationalitÃ¤t", label_res_city: "Wohnort", label_res_prov: "Prov.", label_address: "Adresse", label_civic: "Nr.", label_docnum: "Dokument Nr.", label_expiry: "Ablaufdatum", label_issued: "Ausgestellt von", label_issued_ph: "Z.B. Stadt...", front: "Vorderseite", back_doc: "RÃ¼ckseite", take_photo: "FOTO", upload_file: "DATEI", sign_title: "Unterschrift", tax_info: "Kurtaxe vor Ort.", clear_sign: "LÃ–SCHEN", confirm_btn: "FERTIGSTELLEN", success_title: "Fertig!", success_msg: "Check-in abgeschlossen.", save_link_msg: "ðŸ’¡ LINK SPEICHERN!", share_link: "LINK TEILEN", exit: "Beenden" }
        };

        // --- ICONE SVG ---
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                check: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>,
                trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>,
                camera: <React.Fragment><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3" strokeWidth="2"/></React.Fragment>,
                chevronLeft: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"/>,
                lock: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>,
                copy: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>,
                download: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>,
                upload: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>,
                scan: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7V5a2 2 0 012-2h2m10 0h2a2 2 0 012 2v2m0 10v2a2 2 0 01-2 2h-2m-10 0H5a2 2 0 01-2-2v-2M7 12h10"/>,
                share: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            };
            return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">{icons[name] || icons.camera}</svg>;
        };

        const SVGIcons = {
            electronic: <svg viewBox="0 0 24 24" className="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="14" rx="2" /><path d="M7 15h.01M11 15h.01M15 15h.01M19 15h.01M7 11h.01M11 11h.01M15 11h.01" /><circle cx="17" cy="9" r="1"/></svg>,
            paper: <svg viewBox="0 0 24 24" className="w-12 h-12 text-orange-600" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
            passport: <svg viewBox="0 0 24 24" className="w-12 h-12 text-green-600" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/><path d="M12 12a3 3 0 100-6 3 3 0 000 6z"/><path d="M12 15a5 5 0 00-5 5h10a5 0 00-5-5z"/></svg>,
            license: <svg viewBox="0 0 24 24" className="w-12 h-12 text-pink-600" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="14" rx="2" /><path d="M7 9h2" /><path d="M7 13h10" /><path d="M7 17h6" /><circle cx="16" cy="10" r="2" /></svg>
        };

        const CopyField = ({ label, value }) => (
            <div className="flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-200 relative group text-left mb-2">
                <span className="text-[9px] text-slate-400 uppercase font-bold">{label}</span>
                <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-sm truncate mr-2">{value || "-"}</span>
                    {value && <button onClick={(e) => {
                        e.stopPropagation(); navigator.clipboard.writeText(value); alert("Copiato!");
                    }} className="p-1 hover:bg-white rounded text-blue-600"><Icon name="copy" className="w-4 h-4"/></button>}
                </div>
            </div>
        );

        const Header = ({ showBack, backStep, setStep, setLang, lang }) => (
            <div className="flex flex-col bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                <div className="flex justify-end p-2 pb-0">
                     <div className="flex space-x-1">
                        {['it','en','fr','es','de'].map(l => (
                             <button key={l} onClick={() => setLang(l)} className={`flag-btn ${lang === l ? 'active' : ''}`}>
                                 {l === 'it' ? 'ðŸ‡®ðŸ‡¹' : l === 'en' ? 'ðŸ‡¬ðŸ‡§' : l === 'fr' ? 'ðŸ‡«ðŸ‡·' : l === 'es' ? 'ðŸ‡ªðŸ‡¸' : 'ðŸ‡©ðŸ‡ª'}
                             </button>
                        ))}
                    </div>
                </div>
                <div className="flex items-center justify-center p-3 pt-0">
                    {showBack && <button onClick={() => setStep(backStep)} className="absolute left-4 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                    <div className="header-logo-circle"><img src="logo.png" /></div>
                    <div className="ml-3"><span className="block font-bold text-slate-700 text-[14px] leading-tight uppercase tracking-widest">Tuscan Retreats</span></div>
                </div>
            </div>
        );

        const SignaturePad = ({ canvasRef }) => {
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000'; };
                resize(); window.addEventListener('resize', resize);
                const getPos = (e) => { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; };
                const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
                const draw = (e) => { if (!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                const stop = () => isDrawing = false;
                canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stop);
                return () => { window.removeEventListener('resize', resize); };
            }, []);
            return <canvas ref={canvasRef} className="w-full h-full" />;
        };

        function App() {
            const [lang, setLang] = useState('it');
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('login');
            const [property, setProperty] = useState(null);
            const [bookingDetails, setBookingDetails] = useState({ guestName: '', doorCode: '' });
            const [guests, setGuests] = useState([]);
            const [formData, setFormData] = useState({});
            const [isScanning, setIsScanning] = useState(false);
            const [videoStream, setVideoStream] = useState(null);
            const [images, setImages] = useState({ front: null, back: null });
            const [docType, setDocType] = useState('electronic');
            const [expectedGuests, setExpectedGuests] = useState(1);
            const [adminData, setAdminData] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);
            const [moturistCode, setMoturistCode] = useState("");
            const [dates, setDates] = useState({ arrival: new Date().toISOString().split('T')[0], departure: "" });
            const [searchTerm, setSearchTerm] = useState("");
            const [ocrProcessing, setOcrProcessing] = useState(false);
            
            const videoRef = useRef(null);
            const fileInputRef = useRef(null);
            const sigCanvasRef = useRef(null);
            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;

            // INIT
            useEffect(() => {
                const init = async () => {
                    if (window.FirebaseSDK) {
                        try {
                            const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                            const auth = window.FirebaseSDK.getAuth(app);
                            window.db = window.FirebaseSDK.getFirestore(app);
                            await window.FirebaseSDK.signInAnonymously(auth);
                            window.FirebaseSDK.onAuthStateChanged(auth, setUser);
                        } catch(e) { console.error("FB Init", e); }
                    }
                    const params = new URLSearchParams(window.location.search);
                    const p = params.get('p');
                    const d = params.get('d');
                    if (p && PROPERTIES[p.toUpperCase()]) {
                        setProperty(PROPERTIES[p.toUpperCase()]);
                        setStep('welcome');
                    } else if (d) {
                        try {
                            const decoded = JSON.parse(atob(d));
                            if (PROPERTIES[decoded.p]) {
                                setProperty(PROPERTIES[decoded.p]);
                                setBookingDetails({ guestName: decoded.n || "Ospite", doorCode: decoded.c });
                                if (localStorage.getItem(`checkin_done_session_${d}`)) setStep('success');
                                else setStep('welcome');
                            }
                        } catch(e) {}
                    }
                };
                init();
            }, []);

            // CAMERA & OCR
            const startCamera = async () => {
                setIsScanning(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } });
                    setVideoStream(stream);
                } catch(e) { alert("Camera error"); setIsScanning(false); }
            };

            useEffect(() => {
                if(isScanning && videoRef.current && videoStream) {
                    videoRef.current.srcObject = videoStream;
                    videoRef.current.onloadedmetadata = () => videoRef.current.play();
                }
            }, [isScanning, videoStream]);

            const stopCamera = () => {
                if(videoStream) videoStream.getTracks().forEach(t => t.stop());
                setVideoStream(null);
                setIsScanning(false);
            };

            const captureAndRead = async () => {
                if(!videoRef.current) return;
                setOcrProcessing(true);
                const canvas = document.createElement('canvas');
                // CROP LOGIC (V104)
                const w = videoRef.current.videoWidth;
                const h = videoRef.current.videoHeight;
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0, w, h);
                
                // Crop logic simulation (Taking full image for now but focusing OCR)
                stopCamera(); 
                
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                    const clean = text.toUpperCase().replace(/\s/g, '');
                    let newData = { ...formData };
                    let found = false;

                    // PARSING
                    if (docType === 'passport') {
                        let r1 = clean.match(/P<([A-Z]{3})([A-Z<]+)/);
                        if(r1) { 
                            newData.surname = r1[2].split('<<')[0].replace(/</g, ' '); 
                            newData.name = r1[2].split('<<')[1].replace(/</g, ' ');
                            found = true; 
                        }
                    } else { // CIE
                        let nm = clean.match(/([A-Z0-9]+)<<([A-Z0-9]+)/);
                        if(nm) { 
                            newData.surname = nm[1].replace(/\d/g,'').replace(/</g,' ');
                            newData.name = nm[2].replace(/\d/g,'').replace(/</g,' ');
                            found = true;
                        }
                        const lines = text.toUpperCase().split('\n');
                        lines.forEach(l => {
                            if(l.match(/(VIA|PIAZZA|CORSO|V\.|P\.)/)) newData.residenceAddress = l.trim();
                        });
                    }
                    
                    if(found) { setFormData(newData); alert(t.ocr_success); }
                    else { alert("Dati non chiari, inserire manualmente."); }
                    setStep('manual_entry');
                } catch(e) { alert("Errore OCR"); setStep('manual_entry'); }
                setOcrProcessing(false);
            };

            const handleFileUpload = (e) => {
                if(e.target.files[0]) {
                    // Logic for file upload OCR (simplified for brevity)
                    alert("Funzione file caricata"); 
                    setStep('manual_entry');
                }
            };

            const addGuest = () => {
                setGuests([...guests, formData]);
                setFormData({});
                setImages({ front: null, back: null });
                setStep('guest_list');
            };

            const saveAll = async () => {
                // Save to Firebase logic
                if (window.db) {
                    const id = `${property?.id}_${Date.now()}`;
                    await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id), {
                        guests, 
                        signature: sigCanvasRef.current?.toDataURL(),
                        property: property.name,
                        date: new Date().toISOString()
                    });
                }
                setStep('success');
            };

            // RENDER STEPS
            const renderStep = () => {
                switch(step) {
                    case 'login': return (
                        <div className="app-container p-8 justify-center text-center">
                            <div className="logo-main-circle"><img src="logo.png" /></div>
                            <h1 className="text-3xl font-bold text-slate-800 mb-6 uppercase tracking-tight">Login</h1>
                            <input id="code" className="input-field text-center mb-4" placeholder={t.login_ph} />
                            <button onClick={() => { 
                                const c = document.getElementById('code').value.toUpperCase();
                                if(c==='ADMIN') setStep('admin_pass');
                                else if(PROPERTIES[c]) { setProperty(PROPERTIES[c]); setStep('welcome'); } 
                            }} className="btn btn-primary">{t.enter}</button>
                            <button onClick={() => setStep('admin_pass')} className="mt-10 text-xs text-slate-400 underline">Area Proprietario</button>
                        </div>
                    );
                    case 'welcome': return (
                         <div className="app-container p-8 justify-center text-center">
                            <div className="logo-main-circle"><img src="logo.png"/></div>
                            <h1 className="text-2xl font-bold mb-2">{t.welcome_title} {property?.name}</h1>
                             <div className="bg-teal-50 border-l-4 border-teal-600 p-8 rounded-r-3xl shadow-sm mb-10 flex flex-col items-center">
                                <div className="host-photo-circle"><img src="image_1d2726.jpg" /></div>
                                <p className="text-lg italic leading-relaxed mt-2">"{t.welcome_text}"</p>
                                <p className="font-bold text-teal-800 mt-2">- Giulia</p>
                            </div>
                            <button onClick={() => setStep('guests_count')} className="btn btn-primary uppercase font-bold shadow-xl">{t.start_btn}</button>
                        </div>
                    );
                    case 'guests_count': return (
                         <div className="app-container p-8 justify-center text-center">
                            <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="welcome" />
                            <h2 className="text-2xl font-bold mb-4 mt-8">{t.guest_count_q}</h2>
                            <div className="info-blue">{t.guest_count_tip}</div>
                            <div className="flex items-center justify-center gap-6 mb-8">
                                <button onClick={()=>setExpectedGuests(Math.max(1, expectedGuests-1))} className="w-12 h-12 bg-slate-100 rounded-full text-2xl font-bold">-</button>
                                <span className="text-4xl font-bold text-teal-700">{expectedGuests}</span>
                                <button onClick={()=>setExpectedGuests(expectedGuests+1)} className="w-12 h-12 bg-teal-100 rounded-full text-2xl font-bold text-teal-700">+</button>
                            </div>
                            <button onClick={() => { setGuests([]); setStep('guest_list'); }} className="btn btn-primary w-full">{t.continue}</button>
                         </div>
                    );
                    case 'guest_list': return (
                        <div className="app-container flex flex-col">
                            <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guests_count" />
                            <div className="p-6 bg-white border-b flex justify-between items-center shadow-sm font-bold uppercase">
                                <span>{t.guest_list}</span><div className="text-teal-600 bg-teal-50 px-4 py-1 rounded-full text-sm border border-teal-100">{guests.length} / {expectedGuests}</div>
                            </div>
                            <div className="flex-1 p-6 space-y-4 overflow-y-auto">
                                {guests.map((g, i) => (
                                    <div key={i} className="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                                        <div className="font-bold uppercase">{g.surname} {g.name}</div>
                                        <button onClick={() => setGuests(guests.filter((_, idx) => idx !== i))} className="text-red-400 p-2"><Icon name="trash" /></button> 
                                    </div>
                                ))}
                                {guests.length < expectedGuests ? 
                                    <button onClick={startNewGuest} className="w-full py-6 border-2 border-dashed border-teal-700 rounded-2xl font-bold text-lg hover:bg-teal-50 transition uppercase text-teal-700">+ {t.add_guest}</button> :
                                    <div className="p-4 bg-green-50 border border-green-200 rounded-xl text-green-800 text-center font-bold text-sm">Tutti registrati!</div>
                                }
                            </div>
                            <div className="p-6 border-t shadow-lg text-center">
                                <button onClick={() => setStep('sign')} disabled={guests.length < expectedGuests} className="btn btn-primary w-full uppercase font-bold disabled:opacity-50">{t.finish_btn}</button>
                            </div>
                        </div>
                    );
                    case 'type_select': return (
                         <div className="app-container p-6 text-center">
                             <Header showBack={true} backStep="guest_list" setStep={setStep} setLang={setLang} lang={lang} />
                             <h2 className="text-xl font-bold my-6">{t.doc_type}</h2>
                             <div className="space-y-3">
                                <div onClick={()=>{setDocType('electronic'); setStep('scan')}} className="card-select shadow-sm flex items-center p-4 border rounded-xl">{SVGIcons.electronic}<h3 className="font-bold ml-4">{t.doc_e}</h3></div>
                                <div onClick={()=>{setDocType('paper'); setStep('scan')}} className="card-select shadow-sm flex items-center p-4 border rounded-xl">{SVGIcons.paper}<h3 className="font-bold ml-4">{t.doc_p}</h3></div>
                                <div onClick={()=>{setDocType('passport'); setStep('scan')}} className="card-select shadow-sm flex items-center p-4 border rounded-xl">{SVGIcons.passport}<h3 className="font-bold ml-4">{t.doc_pass}</h3></div>
                                <div onClick={()=>{setDocType('license'); setStep('scan')}} className="card-select shadow-sm flex items-center p-4 border rounded-xl">{SVGIcons.license}<h3 className="font-bold ml-4">{t.doc_l}</h3></div>
                             </div>
                         </div>
                    );
                    case 'scan': return (
                        <div className="app-container flex flex-col bg-black">
                            {isScanning ? (
                                <div className="flex-1 relative">
                                    <div className="scan-wrapper-full"><video ref={videoRef} autoPlay playsInline></video></div>
                                    <div className="guide-overlay">
                                        <div className="zone-residenza"><span className="label-guide">{t.label_res_zone}</span></div>
                                        <div className="zone-mrz"><span className="label-guide">{t.label_mrz_zone}</span></div>
                                    </div>
                                    <div className="p-4 bg-white flex justify-center gap-4 absolute bottom-0 w-full">
                                        <button onClick={stopCamera} className="btn btn-danger w-1/3">Stop</button>
                                        <button onClick={captureAndRead} className="btn btn-primary w-1/3">{t.ocr_btn}</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="p-6 bg-white text-slate-800 flex-1 flex flex-col justify-center text-center">
                                    <h2 className="text-xl font-bold mb-4">{t.scan_title}</h2>
                                    <p className="mb-6 text-sm">{t.scan_help}</p>
                                    <div className="warning-red mb-4">{t.ocr_warn}</div>
                                    <button onClick={startCamera} className="btn btn-primary mb-4 w-full"><Icon name="camera" /> {t.ocr_btn}</button>
                                    <div className="relative">
                                        <button onClick={() => fileInputRef.current.click()} className="btn btn-secondary w-full">{t.ocr_file_btn}</button>
                                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                                    </div>
                                    <button onClick={() => setStep('manual_entry')} className="btn btn-secondary mt-4 w-full">SALTA SCANSIONE</button>
                                </div>
                            )}
                        </div>
                    );
                    case 'manual_entry': return (
                         <div className="app-container p-6 overflow-y-auto">
                            <Header showBack={true} backStep="scan" setStep={setStep} setLang={setLang} lang={lang} />
                            <h2 className="text-xl font-bold my-4 text-center">{t.verify}</h2>
                            <div className="space-y-4 pb-20">
                                <input className="input-field" placeholder={t.label_surname} value={formData.surname || ''} onChange={e=>setFormData({...formData, surname:e.target.value.toUpperCase()})} />
                                <input className="input-field" placeholder={t.label_name} value={formData.name || ''} onChange={e=>setFormData({...formData, name:e.target.value.toUpperCase()})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <select className="input-field" value={formData.sex || 'M'} onChange={e=>setFormData({...formData, sex:e.target.value})}><option value="M">M</option><option value="F">F</option></select>
                                    <input className="input-field" type="date" value={formData.birthDate || ''} onChange={e=>setFormData({...formData, birthDate:e.target.value})} />
                                </div>
                                <select className="input-field" value={formData.citizenship || 'ITALIANA'} onChange={e=>setFormData({...formData, citizenship:e.target.value})}>
                                    <option value="ITALIANA">ITALIANA</option><option value="ESTERA">ESTERA</option>
                                </select>
                                <input className="input-field" placeholder={t.label_address} value={formData.residenceAddress || ''} onChange={e=>setFormData({...formData, residenceAddress:e.target.value})} />
                                {formData.citizenship === 'ITALIANA' && (
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="input-field" placeholder={t.label_res_city} value={formData.residenceCity || ''} onChange={e=>setFormData({...formData, residenceCity:e.target.value})} />
                                        <input className="input-field" placeholder={t.label_res_prov} value={formData.residenceProvince || ''} onChange={e=>setFormData({...formData, residenceProvince:e.target.value})} />
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="input-field" placeholder={t.label_docnum} value={formData.docNumber || ''} onChange={e=>setFormData({...formData, docNumber:e.target.value})} />
                                    <input className="input-field" type="date" value={formData.expiryDate || ''} onChange={e=>setFormData({...formData, expiryDate:e.target.value})} />
                                </div>
                                <button onClick={() => setStep('upload_docs')} className="btn btn-success mt-4 w-full">AVANTI</button>
                            </div>
                        </div>
                    );
                    case 'upload_docs': return (
                         <div className="app-container flex flex-col p-6 text-center">
                            <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="manual_entry" />
                            <h2 className="text-xl font-bold mb-4">{t.upload_docs_title}</h2>
                            <p className="text-sm text-gray-500 mb-6">{t.upload_docs_desc}</p>
                            <div className="mb-6"><span className="input-label mb-2 text-center block w-full">{t.front}</span><div className="upload-preview mb-2">{images.front ? <img src={images.front} /> : <Icon name="camera" className="w-12 h-12 text-slate-300" />}</div><div className="upload-row"><button className="upload-btn-small" onClick={() => document.getElementById('cam-front').click()}><Icon name="camera" className="w-4 h-4"/> {t.take_photo}</button><button className="upload-btn-small" onClick={() => document.getElementById('file-front').click()}><Icon name="upload" className="w-4 h-4"/> {t.upload_file}</button></div><input id="cam-front" type="file" accept="image/*" capture="environment" onChange={e => e.target.files[0] && setImages({...images, front: URL.createObjectURL(e.target.files[0])})} className="hidden" /><input id="file-front" type="file" accept="image/*" onChange={e => e.target.files[0] && setImages({...images, front: URL.createObjectURL(e.target.files[0])})} className="hidden" /></div>
                            {docType !== 'passport' && <div className="mb-6"><span className="input-label mb-2 text-center block w-full">{t.back_doc}</span><div className="upload-preview mb-2">{images.back ? <img src={images.back} /> : <Icon name="camera" className="w-12 h-12 text-slate-300" />}</div><div className="upload-row"><button className="upload-btn-small" onClick={() => document.getElementById('cam-back').click()}><Icon name="camera" className="w-4 h-4"/> {t.take_photo}</button><button className="upload-btn-small" onClick={() => document.getElementById('file-back').click()}><Icon name="upload" className="w-4 h-4"/> {t.upload_file}</button></div><input id="cam-back" type="file" accept="image/*" capture="environment" onChange={e => e.target.files[0] && setImages({...images, back: URL.createObjectURL(e.target.files[0])})} className="hidden" /><input id="file-back" type="file" accept="image/*" onChange={e => e.target.files[0] && setImages({...images, back: URL.createObjectURL(e.target.files[0])})} className="hidden" /></div>}
                            <button onClick={addGuest} disabled={!images.front} className="btn btn-success w-full mt-4">{t.save}</button>
                        </div>
                    );
                    case 'sign': return (
                        <div className="app-container p-6 text-center">
                            <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guest_list" />
                            <h2 className="text-2xl font-bold mb-6">{t.sign_title}</h2>
                            <div className="info-blue mb-6">{t.tax_info}</div>
                            <div className="border-2 border-dashed border-slate-300 h-40 mb-4 rounded-xl overflow-hidden relative">
                                <span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-slate-300 font-bold pointer-events-none">FIRMA QUI</span>
                                <SignaturePad canvasRef={sigCanvasRef} />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => { const ctx = sigCanvasRef.current.getContext('2d'); ctx.clearRect(0,0,999,999); }} className="btn btn-danger w-1/3">{t.clear_sign}</button>
                                <button onClick={saveToCloud} disabled={isSaving} className="btn btn-primary w-2/3">{isSaving ? '...' : t.confirm_btn}</button>
                            </div>
                        </div>
                    );
                    case 'success': return (
                        <div className="app-container bg-teal-900 text-white items-center p-10 text-center justify-center">
                            <div className="w-24 h-24 bg-white text-teal-700 rounded-full flex items-center justify-center mb-8 shadow-2xl"><Icon name="check" /></div>
                            <h1 className="text-3xl font-bold mb-2">{t.thanks}</h1>
                            <p className="opacity-80 text-lg mb-12">{t.success_msg}</p>
                            <div className="bg-white text-slate-900 rounded-3xl p-10 w-full shadow-2xl relative z-10 border border-teal-500 text-center">
                                <p className="input-label text-slate-400 text-center mb-6">{property?.type === 'electronic' ? "CODICE TASTIERINO" : "CODICE KEYBOX"}</p>
                                <div className="flex flex-col items-center">
                                    <div className="p-6 bg-slate-50 rounded-2xl mb-4 text-teal-600 border border-teal-100 shadow-inner"><Icon name="lock" /></div>
                                    <div className="text-5xl font-mono font-bold tracking-widest text-slate-800">{bookingDetails.doorCode || "9988"}</div>
                                </div>
                            </div>
                            <div className="info-success mt-6 text-teal-900 bg-teal-50">{t.save_link_msg}</div>
                            <button onClick={shareLink} className="btn btn-secondary mt-4 w-full">{t.share_link}</button>
                            <button onClick={handleExit} className="mt-8 text-teal-200 underline text-sm">{t.exit}</button>
                        </div>
                    );
                    default: return null;
                }
            };
            return renderStep();
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
