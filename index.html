<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- OCR Engine -->
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; overflow-x: hidden; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); position: relative; overflow-x: hidden; }
        
        /* LOGO GIULIA - ZOOM 115% */
        .logo-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; padding: 25px 0; background: white; }
        .logo-circle {
            width: 200px; height: 200px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden;
            border: 3px solid #d4af37; position: relative;
        }
        .logo-img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); position: relative; z-index: 2; }

        /* HEADER LOGO */
        .header-logo-circle { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid #d4af37; background: white; flex-shrink: 0; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }

        /* SCANNER FULL WIDTH */
        .scan-wrapper-full {
            position: relative;
            width: 100vw; 
            height: 480px;
            background: #000;
            overflow: hidden;
            left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* GUIDE VISIVE - MISURE DA TUO SCRIPT V104 */
        .guide-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
        
        /* Rettangolo Giallo - Indirizzo (Centrale/Alto) */
        .zone-residenza {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            width: 94%; height: 14%; border: 3px solid #FFD60A; border-radius: 4px;
            background: rgba(255, 214, 10, 0.1); z-index: 10;
            display: flex; justify-content: center; align-items: flex-start;
        }

        /* Rettangolo Azzurro - MRZ (Basso) */
        .zone-mrz {
            position: absolute; top: 82%; left: 50%; transform: translate(-50%, -50%);
            width: 96%; height: 22%; border: 3px solid #00E0FF; border-radius: 4px;
            background: rgba(0, 224, 255, 0.1); z-index: 10;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .label-guide { 
            position: absolute; top: -20px; left: 0;
            font-size: 10px; font-weight: 800; padding: 2px 6px; 
            background: rgba(0,0,0,0.7); color: white; border-radius: 4px; 
            text-transform: uppercase; letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .info-blue { color: #1e40af; font-size: 13px; line-height: 1.5; background: #eff6ff; padding: 15px; border-radius: 12px; border: 1px solid #dbeafe; text-align: left; margin-bottom: 20px; }
        .info-success { background: #f0fdf4; border: 1px solid #86efac; color: #166534; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 600; margin-top: 20px; text-align: center; line-height: 1.4; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .input-field { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; background: #fff; transition: all 0.2s; margin-bottom: 8px; color: #1e293b; }
        .input-field:focus { border-color: #0f766e; outline: none; box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1); }
        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 4px; text-align: left; }
        .input-label.required::after { content: " *"; color: #ef4444; }

        .btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: none; }
        .btn-primary { background: #0f766e; color: white; }
        .btn-secondary { background: #334155; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-primary:active:not(:disabled) { transform: scale(0.97); }
        .btn-primary:disabled, .btn-success:disabled { background: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; box-shadow: none; }
        
        .flag-btn { font-size: 24px; padding: 4px 6px; opacity: 0.5; transition: 0.2s; cursor: pointer; border: none; background: transparent; filter: grayscale(100%); }
        .flag-btn.active { opacity: 1; transform: scale(1.1); filter: grayscale(0%); }

        .card-select { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #f1f5f9; background: white; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .card-select:hover { border-color: #0f766e; background: #f0fdfa; }

        .upload-preview { width: 100%; height: 200px; border: 2px dashed #cbd5e1; border-radius: 16px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden; position: relative; margin-bottom: 10px; }
        .upload-preview img { width: 100%; height: 100%; object-fit: contain; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", type: "electronic", defaultCode: "123456#" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", type: "keybox", defaultCode: "9988" },
            "REGINA": { id: "REGINA", name: "Santa Regina", type: "keybox", defaultCode: "4567" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome: "Ciao! Sono Giulia. Per rendere il tuo arrivo piÃ¹ semplice, ti chiedo di completare il check-in online.", 
                login_ph: "CODICE PRENOTAZIONE", start_btn: "INIZIA IL CHECK-IN", 
                scan_rear: "SCANSIONA DOC", scan_info: "Inquadra il RETRO del documento.", 
                scan_help: "Inquadra la zona MRZ in basso e la zona Indirizzo in alto.",
                photo_req: "FOTO OBBLIGATORIA", confirm_btn: "CONFERMA E CONTINUA", recover_btn: "VEDI IL TUO CODICE PORTA", add_guest: "AGGIUNGI OSPITE", save_guest: "SALVA OSPITE",
                warning_save: "Compila i campi obbligatori e carica le foto per salvare", finish_btn: "FINISCI E PROCEDI", verify: "Verifica Dati", front: "Fronte", back_doc: "Retro",
                doc_type: "Tipo Documento", doc_e: "C.I. Elettronica", doc_p: "C.I. Cartacea", doc_pass: "Passaporto", doc_l: "Patente di Guida",
                label_surname: "Cognome", label_name: "Nome", label_sex: "Sesso", label_birth: "Nato il", label_city: "Comune Nascita", label_prov: "Prov.", label_citizenship: "Cittadinanza", label_res_city: "CittÃ  Residenza", label_res_prov: "Prov.", label_address: "Via / Piazza", label_civic: "Civico", label_docnum: "N. Documento", label_expiry: "Scadenza",
                thanks: "Grazie", success_msg: "Check-in completato con successo.", exit: "Esci", guest_list: "Ospiti Registrati", cloud_save: "Salvataggio...",
                data_true_label: "Dichiaro che i dati inseriti sono reali", clear_sign: "CANCELLA FIRMA", sign_title: "Firma e Tassa",
                ocr_btn: "SCATTA E LEGGI", ocr_processing: "ELABORAZIONE...", ocr_file_btn: "ðŸ“ CARICA FOTO",
                ocr_success: "Dati rilevati! Verifica i campi compilati e inserisci quelli mancanti. Poi prosegui per caricare le foto.",
                guest_count_q: "Quanti ospiti siete? (1+ anni)", 
                guest_count_tip: "âš ï¸ IMPORTANTE: Se ognuno compila dal proprio telefono, scrivi 1. Se invece compili TU per tutti ora, scrivi il numero totale di ospiti.",
                continue: "CONTINUA",
                share_link: "INVIA LINK A CHI SI DEVE ANCORA REGISTRARE",
                save_link_msg: "ðŸ’¡ IMPORTANTE: Salva questo link! Se dimentichi il codice porta, potrai riaprirlo per visualizzarlo senza rifare il check-in.",
                label_res_zone: "INDIRIZZO", label_mrz_zone: "CODICI MRZ"
            },
            en: { 
                welcome: "Hi! I'm Giulia. To make your arrival smoother, please complete the online check-in.", 
                login_ph: "BOOKING CODE", start_btn: "START CHECK-IN", scan_rear: "SCAN DOC", scan_info: "Frame the BACK of the document.", 
                scan_help: "Frame MRZ codes at bottom and Address at top.",
                photo_req: "PHOTO REQUIRED", confirm_btn: "SAVE & CONTINUE", recover_btn: "VIEW YOUR DOOR CODE", add_guest: "ADD GUEST", save_guest: "SAVE GUEST",
                warning_save: "Fill all mandatory fields", finish_btn: "FINISH AND PROCEED", verify: "Verify Data", front: "Front", back_doc: "Back",
                thanks: "Thank you", success_msg: "Check-in successfully completed.", exit: "Exit", guest_list: "Guests", cloud_save: "Saving...",
                ocr_btn: "SNAP & READ", ocr_processing: "PROCESSING...", ocr_file_btn: "ðŸ“ UPLOAD FILE",
                guest_count_q: "How many guests? (1+ years)", 
                guest_count_tip: "âš ï¸ IMPORTANT: If everyone fills from their own phone, enter 1. If YOU fill for everyone now, enter total number.",
                continue: "CONTINUE",
                share_link: "SEND LINK TO GUESTS YET TO REGISTER",
                save_link_msg: "ðŸ’¡ IMPORTANT: Save this link! If you forget the door code, you can reopen it without repeating check-in.",
                label_res_zone: "ADDRESS", label_mrz_zone: "MRZ CODES"
            },
            fr: { 
                welcome: "Salut ! Je suis Giulia. Veuillez complÃ©ter l'enregistrement en ligne.", 
                login_ph: "CODE", start_btn: "COMMENCER", scan_rear: "SCANNER DOC", scan_info: "Scannez le document horizontalement.", 
                scan_help: "Cadrez le verso (Adresse en haut, MRZ en bas).",
                thanks: "Merci", success_msg: "Enregistrement terminÃ© con successo.", exit: "Sortie", guest_list: "InvitÃ©s",
                guest_count_q: "Combien d'invitÃ©s ? (1+ ans)", 
                guest_count_tip: "âš ï¸ IMPORTANT : Si chacun remplit depuis son tÃ©lÃ©phone, entrez 1. Si VOUS remplissez pour tout le monde, entrez le total.",
                continue: "CONTINUER",
                share_link: "ENVOYER LIEN Ã€ CEUX QUI DOIVENT S'ENREGISTRER",
                save_link_msg: "ðŸ’¡ IMPORTANT : Sauvegardez ce lien ! Se dimentichi il codice, potrai riaprirlo per visualizzarlo senza rifare il check-in.",
                label_res_zone: "ADRESSE", label_mrz_zone: "CODES MRZ"
            },
            es: { 
                welcome: "Â¡Hola! Soy Giulia. Complete el registro en lÃ­nea.", 
                login_ph: "CÃ“DIGO", start_btn: "EMPEZAR", scan_rear: "ESCANEAR DOC", scan_info: "Encuadre el reverso (DirecciÃ³n arriba, MRZ abajo).",
                thanks: "Gracias", success_msg: "Registro completado.", exit: "Salir", guest_list: "HuÃ©spedes",
                guest_count_q: "Â¿CuÃ¡ntos huÃ©spedes? (1+ aÃ±os)", 
                guest_count_tip: "âš ï¸ IMPORTANTE: Si cada uno llena desde su telÃ©fono, ingrese 1. Si USTED llena por todos, ingrese il total.",
                continue: "CONTINUAR",
                share_link: "ENVIAR ENLACE A LOS QUE FALTAN",
                save_link_msg: "ðŸ’¡ IMPORTANTE: Â¡Guarde este enlace! Se dimentichi il codice, potrai riaprirlo per visualizzarlo senza rifare il check-in.",
                label_res_zone: "DIRECCIÃ“N", label_mrz_zone: "CÃ“DIGOS MRZ"
            },
            de: { 
                welcome: "Hallo! Ich bin Giulia. Bitte schlieÃŸen Sie den Online-Check-in ab.", 
                login_ph: "CODE", start_btn: "STARTEN", scan_rear: "DOKUMENT SCANNEN", scan_info: "Dokument horizontal scannen.", 
                scan_help: "RÃ¼ckseite einrahmen (Adresse oben, MRZ unten).",
                thanks: "Danke", success_msg: "Check-in erfolgreich abgeschlossen.", exit: "Beenden", guest_list: "GÃ¤ste",
                guest_count_q: "Wie viele GÃ¤ste? (1+ Jahre)", 
                guest_count_tip: "âš ï¸ WICHTIG: Se ognuno compila dal proprio telefono, scrivi 1. Se invece compili TU per tutti ora, scrivi il numero totale.",
                continue: "WEITER",
                share_link: "LINK AN ANDERE GÃ„STE SENDEN",
                save_link_msg: "ðŸ’¡ WICHTIG: Speichern Sie diesen Link! Se dimentichi il codice, potrai riaprirlo per visualizzarlo senza rifare il check-in.",
                label_res_zone: "ADRESSE", label_mrz_zone: "MRZ CODES"
            }
        };

        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                check: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>,
                trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>,
                camera: <React.Fragment><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3" strokeWidth="2"/></React.Fragment>,
                chevronLeft: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />,
                lock: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />,
                copy: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />,
                download: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />,
                upload: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            };
            return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">{icons[name] || icons.camera}</svg>;
        };

        const SignaturePad = ({ canvasRef }) => {
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000'; };
                resize(); window.addEventListener('resize', resize);
                const getPos = (e) => { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; };
                const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
                const draw = (e) => { if (!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                const stop = () => isDrawing = false;
                canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseleave', stop);
                canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stop);
                return () => { window.removeEventListener('resize', resize); canvas.removeEventListener('mousedown', start); canvas.removeEventListener('mousemove', draw); canvas.removeEventListener('mouseup', stop); canvas.removeEventListener('mouseleave', stop); canvas.removeEventListener('touchstart', start); canvas.removeEventListener('touchmove', draw); canvas.removeEventListener('touchend', stop); };
            }, []);
            return <canvas ref={canvasRef} className="w-full h-full" />;
        };

        const Header = ({ showBack, backStep, setStep, setLang, lang }) => (
            <div className="flex flex-col bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                <div className="flex justify-end p-2 pb-0">
                     <div className="flex space-x-1">
                        {['it','en','fr','es','de'].map(l => (
                             <button key={l} onClick={() => setLang(l)} className={`flag-btn ${lang === l ? 'active' : ''}`}>
                                 {l === 'it' ? 'ðŸ‡®ðŸ‡¹' : l === 'en' ? 'ðŸ‡¬ðŸ‡§' : l === 'fr' ? 'ðŸ‡«ðŸ‡·' : l === 'es' ? 'ðŸ‡ªðŸ‡¸' : 'ðŸ‡©ðŸ‡ª'}
                             </button>
                        ))}
                    </div>
                </div>
                <div className="flex items-center justify-center p-3 pt-0">
                    {showBack && <button onClick={() => setStep(backStep)} className="absolute left-4 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                    <div className="header-logo-circle"><img src="logo.png" /></div>
                    <div className="ml-3"><span className="block font-bold text-slate-700 text-[14px] leading-tight uppercase tracking-widest">Tuscan Retreats</span></div>
                </div>
            </div>
        );

        function App() {
            const [lang, setLang] = useState('it');
            const [user, setUser] = useState(null);
            const [step, setStep] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return (params.get('d') || params.get('p')) ? 'welcome' : 'login';
            });
            const [property, setProperty] = useState(null);
            const [bookingDetails, setBookingDetails] = useState({ guestName: '', doorCode: '' });
            const [guests, setGuests] = useState([]);
            const [docType, setDocType] = useState('electronic');
            const [images, setImages] = useState({ front: null, back: null });
            const [isScanning, setIsScanning] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [adminData, setAdminData] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);
            const [moturistCode, setMoturistCode] = useState("");
            const [dates, setDates] = useState({ arrival: new Date().toISOString().split('T')[0], departure: "" });
            const [expectedGuests, setExpectedGuests] = useState(1);
            const [ocrProcessing, setOcrProcessing] = useState(false);
            const [searchTerm, setSearchTerm] = useState("");

            const [formData, setFormData] = useState({
                surname: "", name: "", sex: "M", birthDate: "", birthCity: "", birthProvince: "",
                citizenship: "ITALIANA", residenceCity: "", residenceProvince: "",
                residenceAddress: "", houseNumber: "", issuedBy: "COMUNE DI", issuedManual: "", docNumber: "", expiryDate: ""
            });
            
            const [dataTrue, setDataTrue] = useState(false);
            const sigCanvasRef = useRef(null);
            const videoRef = useRef(null); 
            const fileInputRef = useRef(null); 

            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'tuscan-retreats-portal';

            // Firebase Boot logic
            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(checkFB);
                        try {
                             const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                             const auth = window.FirebaseSDK.getAuth(app);
                             const db = window.FirebaseSDK.getFirestore(app);
                             window.db = db;
                             const initAuth = async () => { await window.FirebaseSDK.signInAnonymously(auth); window.FirebaseSDK.onAuthStateChanged(auth, setUser); };
                             initAuth();
                        } catch(e) { console.log("Firebase init error", e); }
                    }
                }, 100);
            }, []);

            // Link Analysis (?p= or ?d=)
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const d = params.get('d');
                const p = params.get('p');
                
                if (d) {
                    try {
                        const decoded = JSON.parse(atob(d)); 
                        if (PROPERTIES[decoded.p]) {
                            setProperty(PROPERTIES[decoded.p]);
                            setBookingDetails({ guestName: decoded.n || "Ospite", doorCode: decoded.c });
                            // Check if already done locally
                            if (localStorage.getItem(`checkin_done_${d}`)) setStep('success');
                        }
                    } catch (e) {}
                } else if (p) {
                    const propKey = p.toUpperCase();
                    if (PROPERTIES[propKey]) {
                        setProperty(PROPERTIES[propKey]);
                        setBookingDetails({ guestName: "Ospite", doorCode: PROPERTIES[propKey].defaultCode });
                    }
                }
            }, []);

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); alert("Copiato!"); } catch (err) {} document.body.removeChild(textArea);
            };

            const downloadImage = (dataUrl, filename) => {
                const link = document.createElement('a'); link.href = dataUrl; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const compress = async (url) => {
                return new Promise(res => {
                    const img = new Image(); img.src = url;
                    img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const s = Math.min(800 / img.width, 1); c.width = img.width * s; c.height = img.height * s;
                        ctx.drawImage(img, 0, 0, c.width, c.height); res(c.toDataURL('image/jpeg', 0.6));
                    }
                });
            };

            const saveToCloud = async () => {
                setIsSaving(true);
                let signatureData = sigCanvasRef.current?.toDataURL();
                try {
                    const id = `${property?.id || 'TEST'}_${Date.now()}`;
                    const processed = await Promise.all(guests.map(async g => ({ ...g, imgFront: g.imgFront ? await compress(g.imgFront) : null, imgBack: g.imgBack ? await compress(g.imgBack) : null })));
                    const payload = { guests: processed, signature: signatureData, booking: property?.id || "", timestamp: new Date().toISOString(), checkinDate: new Date().toISOString().split('T')[0], guestName: bookingDetails.guestName, property: property?.name || "" };
                    if (user && window.db) {
                         const path = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id);
                         await window.FirebaseSDK.setDoc(path, payload);
                    }
                    localStorage.setItem(`checkin_done_${id}`, 'true');
                } catch(e) { console.log("Save error", e); }
                setIsSaving(false); setStep('success');
            };

            const fetchCloud = async () => {
                if (!user || !window.db) return;
                try {
                    const col = window.FirebaseSDK.collection(window.db, 'artifacts', appId, 'public', 'data', 'checkins');
                    const snap = await window.FirebaseSDK.getDocs(col);
                    let list = []; snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    setAdminData(list);
                } catch (e) { console.error("Cloud fetch error", e); }
            };

            const deleteSession = async (sessionId) => {
                if(!confirm("Cancellare questo check-in?")) return;
                if (user && window.db) { try { const docRef = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', sessionId); await window.FirebaseSDK.deleteDoc(docRef); } catch(e) {} }
                fetchCloud();
            };

            const fixOCRText = (s, type) => {
                if(!s) return "";
                if(type === 'N') return s.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
                if(type === 'L') return s.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B').replace(/4/g,'A');
                return s;
            };

            const parseCIE = (raw) => {
                const up = raw.toUpperCase(); const clean = up.replace(/\s/g, '');
                let newForm = { ...formData }; let found = false;
                let dc = clean.match(/ITA([A-Z0-9]{9})/); if(dc) { newForm.docNumber = dc[1]; found = true; }
                let nm = clean.match(/([A-Z0-9]+)<<([A-Z0-9]+)/);
                if(nm) { 
                    newForm.surname = fixOCRText(nm[1], 'L');
                    newForm.name = fixOCRText(nm[2], 'L').replace(/</g, ' '); 
                    found = true;
                }
                let bioMatch = clean.match(/([0-9OIZSB]{6,7})([MF])([0-9OIZSB]{6,7})([A-Z0-9]{3})/);
                if(bioMatch) {
                    newForm.birthDate = formatDateOCR(fixOCRText(bioMatch[1].substr(0,6), 'N'));
                    newForm.sex = bioMatch[2];
                    newForm.expiryDate = formatDateOCR(fixOCRText(bioMatch[3].substr(0,6), 'N'));
                    found = true;
                }
                up.split('\n').forEach(l => {
                     if(l.match(/^(VIA|V\.|PIAZZA|P\.|CORSO|C\.|LARGO|VICOLO|STRADA)\s+/)) {
                         let parts = l.match(/(.+?)\s+(\d+[A-Z]?)$/); 
                         if(parts) { newForm.residenceAddress = parts[1].trim(); newForm.houseNumber = parts[2]; } else { newForm.residenceAddress = l.trim(); }
                         found = true;
                     }
                });
                if(found) { setFormData(newForm); alert(t.ocr_success); setStep('manual_entry'); } 
                else { alert("Nessun dato rilevato. Riprova o inserisci manualmente."); }
                setOcrProcessing(false); setIsScanning(false);
            };

            const formatDateOCR = (d) => { if(!d || d.length<6) return ""; let y = d.substring(0,2); let m = d.substring(2,4); let day = d.substring(4,6); return (parseInt(y) > 40 ? "19" : "20") + y + "-" + m + "-" + day; };

            const runOCR = async (source) => {
                setOcrProcessing(true);
                const canvas = document.getElementById('ocr-canvas'); const ctx = canvas.getContext('2d');
                canvas.width = 1280; const scale = 1280 / (source.videoWidth || source.width);
                canvas.height = (source.videoHeight || source.height) * scale;
                ctx.drawImage(source, 0, 0, canvas.width, canvas.height); ctx.filter = 'grayscale(100%) contrast(150%)'; 
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                    parseCIE(text);
                } catch (e) { alert("Errore OCR."); setOcrProcessing(false); setIsScanning(false); }
            };

            const startCamera = async () => { setIsScanning(true); };

            useEffect(() => {
                if (isScanning && videoRef.current) {
                    (async () => {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } });
                            if (videoRef.current) videoRef.current.srcObject = stream;
                        } catch (err) { alert("Attiva permessi fotocamera."); setIsScanning(false); }
                    })();
                }
                return () => { videoRef.current?.srcObject?.getTracks().forEach(t => t.stop()); };
            }, [isScanning]);

            const startNewGuest = () => {
                setFormData({ surname: "", name: "", sex: "M", birthDate: "", birthCity: "", birthProvince: "", citizenship: "ITALIANA", residenceCity: "", residenceProvince: "", residenceAddress: "", houseNumber: "", issuedBy: "COMUNE DI", issuedManual: "", docNumber: "", expiryDate: "" });
                setImages({ front: null, back: null }); setDataTrue(false); setStep('type_select');
            };

            const isFormComplete = () => {
                const isItalian = formData.citizenship === 'ITALIANA';
                let base = formData.surname && formData.name && formData.birthDate && formData.docNumber;
                if (isItalian) { if (!formData.birthCity || !formData.birthProvince || !formData.residenceCity || !formData.residenceProvince || !formData.residenceAddress) base = false; }
                return base && dataTrue;
            };

            const formatDateIT = (d) => d ? d.split('-').reverse().join('/') : "";

            if (step === 'login') return (
                <div className="app-container p-8 justify-center items-center text-center">
                    <div className="logo-wrapper"><div className="logo-circle"><img src="logo.png" className="logo-img" /></div></div>
                    <h1 className="text-3xl font-bold text-slate-800 mb-8 uppercase tracking-widest tracking-tight">Login</h1>
                    <form onSubmit={e => { e.preventDefault(); const c = e.target.code.value.toUpperCase(); if(c==='ADMIN') setStep('admin_pass'); else if(PROPERTIES[c]){ setProperty(PROPERTIES[c]); setBookingDetails({ guestName: "Ospite", doorCode: PROPERTIES[c].defaultCode }); setStep('welcome'); } else alert('Codice errato'); }} className="space-y-4 w-full px-4">
                        <input name="code" type="text" className="input-field text-center uppercase font-bold tracking-widest" placeholder={t.login_ph} required />
                        <button type="submit" className="btn btn-primary shadow-xl uppercase font-bold text-white">ENTRA</button>
                    </form>
                    <button onClick={() => setStep('admin_pass')} className="mt-20 text-xs text-slate-300 underline uppercase tracking-widest font-bold">Area Proprietario</button>
                </div>
            );

            if (step === 'admin_pass') return (
                <div className="app-container p-8 justify-center items-center flex-col text-center">
                    <h2 className="text-xl font-bold mb-6 text-teal-800 uppercase tracking-widest">Sblocca</h2>
                    <form onSubmit={e => { e.preventDefault(); if (e.target.pass.value === 'W0d@w0d@') setStep('admin_panel'); else alert('Err'); }} className="w-full space-y-4 px-4">
                        <input name="pass" type="password" className="input-field text-center font-bold" placeholder="Password" autoFocus required />
                        <button type="submit" className="btn btn-primary font-bold shadow-lg text-white">SBLOCCA</button>
                    </form>
                    <button onClick={()=>setStep('login')} className="mt-8 text-sm text-slate-400 underline">Indietro</button>
                </div>
            );

            if (step === 'admin_panel') return (
                <div className="app-container p-6 overflow-y-auto space-y-8">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="login" />
                    <div className="bg-slate-50 p-6 rounded-2xl border space-y-4 text-slate-800 text-center">
                        <h2 className="text-xl font-bold text-teal-800 uppercase tracking-widest">Generatore Link</h2>
                        <select id="adm_prop" className="input-field">{Object.keys(PROPERTIES).map(k => <option key={k} value={k}>{PROPERTIES[k].name}</option>)}</select>
                        <input id="adm_name" className="input-field" placeholder="Nome Ospite" />
                        <input id="adm_code" className="input-field" placeholder="Codice Porta" />
                        <button onClick={() => {
                            const p = document.getElementById('adm_prop').value; const n = document.getElementById('adm_name').value; const c = document.getElementById('adm_code').value;
                            const data = btoa(JSON.stringify({ p, n, c }));
                            copyToClipboard(`${window.location.origin}${window.location.pathname}?d=${data}`);
                        }} className="btn btn-primary w-full text-white font-bold uppercase shadow-lg">COPIA LINK WHATSAPP</button>
                    </div>
                    <div className="border-t pt-8 text-slate-800 text-center">
                        <h2 className="text-xl font-bold mb-4 text-blue-800 uppercase tracking-widest">Esportazione Dati</h2>
                        <div className="bg-blue-50 p-6 rounded-2xl border border-blue-200 space-y-4">
                            <label className="input-label">Codice Moturist</label><input type="text" value={moturistCode} onChange={e=>setMoturistCode(e.target.value)} className="input-field" placeholder="0520..." />
                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="input-label">Arrivo</label><input type="date" value={dates.arrival} onChange={e=>setDates({...dates, arrival: e.target.value})} className="input-field" /></div>
                                <div><label className="input-label">Partenza</label><input type="date" value={dates.departure} onChange={e=>setDates({...dates, departure: e.target.value})} className="input-field" /></div>
                            </div>
                            <button onClick={fetchCloud} className="btn bg-blue-600 text-white font-bold uppercase w-full">Aggiorna Cloud</button>
                            <input type="text" placeholder="Cerca ospite..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="input-field text-center font-bold text-slate-600 mb-2" />
                            <div className="space-y-3 max-h-60 overflow-y-auto">
                                {adminData.filter(item => item.guestName?.toLowerCase().includes(searchTerm.toLowerCase())).map((s, idx) => (
                                    <div key={idx} className="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm" onClick={() => setSelectedSession(s)}>
                                        <div className="flex-1 text-left"><div className="font-bold text-sm">{s.guestName}</div><div className="text-[9px] text-slate-400 uppercase">{s.property} - {formatDateIT(s.checkinDate)}</div></div>
                                        <button onClick={(e) => { e.stopPropagation(); deleteSession(s.id); }} className="ml-3 p-2 bg-red-100 rounded-full text-red-500 hover:bg-red-200"><Icon name="trash" className="w-4 h-4" /></button>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => {
                                let csv = "CodiceStruttura;Cognome;Nome;Sesso;DataNascita;ComuneNascita;Cittadinanza;NumeroDocumento\n";
                                adminData.forEach(r => r.guests.forEach(g => csv += `${moturistCode};${g.surname};${g.name};${g.sex};${g.birthDate};${g.birthCity};${g.citizenship};${g.docNumber}\n`));
                                const b = new Blob([csv], { type: 'text/csv;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `moturist.csv`; a.click();
                            }} disabled={adminData.length===0} className="btn bg-blue-900 text-white font-bold w-full uppercase">CSV MOTURIST</button>
                            <button onClick={() => {
                                let txt = ""; adminData.forEach(s => s.guests.forEach((g, i) => { const type = i === 0 ? "18" : "20"; const arr = dates.arrival.split('-').reverse().join('/'); const surname = g.surname.padEnd(50, ' '); const name = g.name.padEnd(30, ' '); txt += `${type}${arr}01${surname}${name}${g.sex==='M'?'1':'2'}${g.birthDate.split('-').reverse().join('/')}\n`; }));
                                const b = new Blob([txt], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `polizia.txt`; a.click();
                            }} disabled={adminData.length===0} className="btn bg-slate-800 text-white font-bold w-full uppercase mt-2">TXT POLIZIA</button>
                        </div>
                    </div>
                    {selectedSession && (
                        <div className="modal" onClick={() => setSelectedSession(null)}>
                            <div className="bg-white w-full max-h-[85vh] rounded-3xl p-6 overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-center mb-4 uppercase">{selectedSession.guestName}</h3>
                                {selectedSession.guests.map((g, i) => (
                                    <div key={i} className="mb-6 border-b pb-4">
                                        <div className="bg-slate-50 p-4 rounded-xl border mb-4">
                                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 border-b pb-2">Smart Copy</h4>
                                            <div className="grid grid-cols-2 gap-2">
                                                <CopyField label="Cognome" value={g.surname} /><CopyField label="Nome" value={g.name} /><CopyField label="Sesso" value={g.sex} /><CopyField label="Data Nascita" value={formatDateIT(g.birthDate)} /><CopyField label="Comune Nascita" value={g.birthCity} /><CopyField label="Prov. Nascita" value={g.birthProvince} />
                                                <div className="col-span-2"><CopyField label="Indirizzo" value={g.residenceAddress} /></div><CopyField label="N. Civico" value={g.houseNumber} /><CopyField label="CittÃ " value={g.residenceCity} /><CopyField label="Prov." value={g.residenceProvince} /><CopyField label="Numero Doc" value={g.docNumber} /><CopyField label="Scadenza" value={formatDateIT(g.expiryDate)} />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-center">
                                            <div><span className="text-[8px] font-bold text-slate-400">FRONTE</span><img src={g.imgFront} className="rounded border shadow-sm"/></div>
                                            <div><span className="text-[8px] font-bold text-slate-400">RETRO</span><img src={g.imgBack} className="rounded border shadow-sm"/></div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => setSelectedSession(null)} className="btn btn-primary w-full mt-4 font-bold text-white">CHIUDI</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (step === 'welcome') return (
                <div className="app-container">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="login" />
                    <div className="p-8 text-center flex-1 flex flex-col justify-center text-slate-800">
                        <h1 className="text-2xl font-bold mb-6 uppercase tracking-tight">{property?.name || "Benvenuto"}</h1>
                        <div className="bg-teal-50 border-l-4 border-teal-600 p-8 rounded-r-3xl shadow-sm mb-10 flex flex-col items-center">
                            <div className="w-32 h-32 rounded-full bg-white mb-4 mt-20 border-4 border-white shadow-xl overflow-hidden"><img src="foto.jpg" className="w-full h-full object-cover" /></div>
                            <p className="text-lg italic leading-relaxed mt-6">"{t.welcome}"</p>
                            <p className="font-bold text-teal-800 mt-4">- Giulia</p>
                        </div>
                        <button onClick={() => setStep('ask_guests')} className="btn btn-primary uppercase font-bold shadow-xl">{t.start_btn}</button>
                    </div>
                </div>
            );

            if (step === 'ask_guests') return (
                 <div className="app-container p-8 flex flex-col justify-center items-center text-center">
                     <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="welcome" />
                     <h2 className="text-2xl font-bold mb-4 mt-8">{t.guest_count_q}</h2>
                     <div className="info-blue">{t.guest_count_tip}</div>
                     <div className="flex items-center justify-center gap-6 mb-10">
                         <button onClick={() => setExpectedGuests(Math.max(1, expectedGuests - 1))} className="w-12 h-12 rounded-full bg-slate-100 text-2xl font-bold text-slate-600">-</button>
                         <span className="text-5xl font-bold text-teal-700">{expectedGuests}</span>
                         <button onClick={() => setExpectedGuests(expectedGuests + 1)} className="w-12 h-12 rounded-full bg-teal-100 text-2xl font-bold text-teal-700">+</button>
                     </div>
                     <button onClick={() => { setGuests([]); setStep('guest_list'); }} className="btn btn-primary uppercase font-bold shadow-xl">{t.continue}</button>
                 </div>
            );

            if (step === 'guest_list') return (
                <div className="app-container flex flex-col text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="ask_guests" />
                    <div className="p-6 bg-white border-b flex justify-between items-center shadow-sm font-bold uppercase">
                        <span>{t.guest_list}</span><div className="text-teal-600 bg-teal-50 px-4 py-1 rounded-full text-sm border border-teal-100">{guests.length} / {expectedGuests}</div>
                    </div>
                    <div className="flex-1 p-6 space-y-4 overflow-y-auto">
                        {guests.map((g, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                                <div className="font-bold uppercase">{g.surname} {g.name}</div>
                                <button onClick={() => setGuests(guests.filter((_, idx) => idx !== i))} className="text-red-400 p-2"><Icon name="trash" /></button> 
                            </div>
                        ))}
                        {guests.length < expectedGuests ? <button onClick={startNewGuest} className="w-full py-6 border-2 border-dashed border-teal-700 rounded-2xl font-bold text-lg hover:bg-teal-50 transition uppercase text-teal-700 tracking-widest">+ {t.add_guest}</button> : <div className="p-4 bg-green-50 border border-green-200 rounded-xl text-green-800 text-center font-bold text-sm">Tutti gli ospiti registrati!</div>}
                    </div>
                    <div className="p-6 bg-white border-t shadow-lg text-center font-bold">
                        {guests.length < expectedGuests && <p className="text-xs text-red-500 mb-2 uppercase tracking-widest">{t.guests_missing} ({expectedGuests - guests.length})</p>}
                        <button onClick={() => setStep('sign')} disabled={guests.length < expectedGuests} className="btn btn-primary w-full uppercase font-bold disabled:opacity-50">{t.finish_btn}</button>
                    </div>
                </div>
            );

            if (step === 'type_select') return (
                <div className="app-container p-6 flex flex-col text-center text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guest_list" />
                    <h2 className="text-2xl font-bold mb-8 uppercase tracking-tight">{t.doc_type}</h2>
                    <div className="space-y-4">
                        <div onClick={() => { setDocType('electronic'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.electronic}<h3 className="font-bold text-lg uppercase ml-4">{t.doc_e}</h3></div>
                        <div onClick={() => { setDocType('paper'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.paper}<h3 className="font-bold text-lg uppercase ml-4">{t.doc_p}</h3></div>
                        <div onClick={() => { setDocType('passport'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.passport}<h3 className="font-bold text-lg uppercase ml-4">{t.doc_pass}</h3></div>
                    </div>
                </div>
            );

            if (step === 'scan') return (
                <div className="app-container flex flex-col text-center">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="type_select" />
                    {isScanning ? (
                        <div className="flex-1 flex flex-col bg-black">
                            <div className="scan-wrapper-full">
                                 <video ref={videoRef} autoPlay playsInline muted></video>
                                 <div className="guide-overlay">
                                    <div className="zone-residenza"><span className="label-guide">{t.label_res_zone}</span></div>
                                    <div className="zone-mrz"><span className="label-guide">{t.label_mrz_zone}</span></div>
                                </div>
                            </div>
                            <div className="p-4 bg-white flex justify-center gap-4">
                                 <button onClick={() => { setIsScanning(false); }} className="btn bg-red-600 text-white w-1/3 text-xs uppercase font-bold">Annulla</button>
                                 <button id="snap-btn" onClick={() => runOCR(videoRef.current)} className="btn btn-primary w-1/3 text-xs uppercase font-bold shadow-lg">SCATTA</button>
                            </div>
                        </div>
                    ) : (
                         <div className="p-6 flex-1">
                            <h2 className="text-2xl font-bold mb-4 uppercase tracking-tight">{t.scan_title}</h2>
                            <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r-xl text-xs text-blue-900 mb-6 italic">{t.scan_help}</div>
                            <div className="flex flex-col gap-3 mt-4">
                                <button onClick={startCamera} className="btn bg-teal-600 text-white w-full py-4 uppercase font-bold flex gap-2 rounded-xl shadow-lg"><Icon name="scan" /> {t.ocr_btn}</button>
                                <div className="relative"><button onClick={() => fileInputRef.current.click()} className="btn btn-secondary w-full py-4 uppercase font-bold rounded-xl border border-slate-300 bg-white text-slate-700">{t.ocr_file_btn}</button><input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileUpload} style={{display:'none'}}/>{ocrProcessing && <div className="absolute inset-0 bg-white/80 flex items-center justify-center rounded-xl"><p className="text-xs text-blue-600 font-bold animate-pulse">{t.ocr_processing}</p></div>}</div>
                            </div>
                            <button onClick={() => setStep('manual_entry')} className="btn btn-primary w-full mt-6 uppercase font-bold tracking-widest shadow-lg">SALTARE SCANSIONE</button>
                        </div>
                    )}
                </div>
            );

            if (step === 'manual_entry') return (
                <div className="app-container flex flex-col text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="scan" />
                    <div className="flex-1 p-6 overflow-y-auto">
                        <h2 className="text-xl font-bold mb-6 uppercase tracking-tight text-center">{t.verify}</h2>
                        <form onSubmit={(e) => { e.preventDefault(); setStep('upload_docs'); }} className="space-y-4 pb-20">
                            <div><label className="input-label required">{t.label_surname}</label><input className="input-field" value={formData.surname} onChange={e=>setFormData({...formData, surname: e.target.value.toUpperCase()})} required /></div>
                            <div><label className="input-label required">{t.label_name}</label><input className="input-field" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value.toUpperCase()})} required /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="input-label">{t.label_sex}</label><select className="input-field bg-white" value={formData.sex} onChange={e=>setFormData({...formData, sex: e.target.value})}><option value="M">M</option><option value="F">F</option></select></div>
                                <div><label className="input-label required">{t.label_birth}</label><input type="date" className="input-field text-center font-bold" value={formData.birthDate} onChange={e=>setFormData({...formData, birthDate: e.target.value})} required /></div>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                <div className="col-span-3"><label className={`input-label ${formData.citizenship==='ITALIANA'?'required':''}`}>{t.label_city}</label><input className="input-field" value={formData.birthCity} onChange={e=>setFormData({...formData,birthCity: e.target.value.toUpperCase()})} required={formData.citizenship==='ITALIANA'} /></div>
                                <div><label className={`input-label ${formData.citizenship==='ITALIANA'?'required':''}`}>{t.label_prov}</label><input className="input-field text-center uppercase" maxLength="2" value={formData.birthProvince} onChange={e=>setFormData({...formData, birthProvince: e.target.value.toUpperCase()})} placeholder="PR" required={formData.citizenship==='ITALIANA'} /></div>
                            </div>
                            <div><label className="input-label">{t.label_citizenship}</label><select className="input-field bg-white" value={formData.citizenship} onChange={e=>setFormData({...formData, citizenship: e.target.value.toUpperCase()})}><option value="ITALIANA">ITALIANA</option><option value="FRANCESE">FRANCESE</option><option value="INGLESE">INGLESE</option><option value="SPAGNOLA">SPAGNOLA</option><option value="TEDESCA">TEDESCA</option><option value="ALTRO">ALTRO</option></select></div>
                            <div className="border-t pt-4 grid grid-cols-4 gap-2">
                                <div className="col-span-3"><label className={`input-label ${formData.citizenship==='ITALIANA'?'required':''}`}>{t.label_res_city}</label><input className="input-field" value={formData.residenceCity} onChange={e=>setFormData({...formData, residenceCity: e.target.value.toUpperCase()})} required={formData.citizenship==='ITALIANA'} /></div>
                                <div><label className={`input-label ${formData.citizenship==='ITALIANA'?'required':''}`}>{t.label_res_prov}</label><input className="input-field uppercase text-center" maxLength="2" value={formData.residenceProvince} onChange={e=>setFormData({...formData, residenceProvince: e.target.value.toUpperCase()})} placeholder="PR" required={formData.citizenship==='ITALIANA'} /></div>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2"><label className={`input-label ${formData.citizenship==='ITALIANA'?'required':''}`}>{t.label_address}</label><input className="input-field" value={formData.residenceAddress} onChange={e=>setFormData({...formData, residenceAddress: e.target.value.toUpperCase()})} required={formData.citizenship==='ITALIANA'} /></div>
                                <div><label className="input-label">{t.label_civic}</label><input className="input-field text-center" value={formData.houseNumber} onChange={e=>setFormData({...formData, houseNumber: e.target.value})} /></div>
                            </div>
                            <div className="pt-4 border-t-2 border-teal-100">
                                <div className="grid grid-cols-2 gap-4 mt-2">
                                    <div><label className="input-label required">{t.label_docnum}</label><input className="input-field font-mono uppercase bg-blue-50 text-center font-bold" value={formData.docNumber} onChange={e=>setFormData({...formData, docNumber: e.target.value.toUpperCase()})} required /></div>
                                    <div><label className="input-label required">{t.label_expiry}</label><input type="date" className="input-field bg-slate-50 text-center font-bold" value={formData.expiryDate} onChange={e=>setFormData({...formData, expiryDate: e.target.value})} required /></div>
                                </div>
                            </div>
                            <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mt-4 flex items-center">
                                <input type="checkbox" id="dataTrue" checked={dataTrue} onChange={e => setDataTrue(e.target.checked)} className="w-5 h-5 text-teal-600 mr-3" />
                                <label htmlFor="dataTrue" className="text-xs font-bold text-yellow-900 uppercase text-left">{t.data_true_label}</label>
                            </div>
                            <button type="submit" disabled={!isFormComplete()} className="btn btn-success w-full mt-6 uppercase tracking-widest font-bold shadow-lg text-white">{t.proceed_docs}</button>
                        </form>
                    </div>
                </div>
            );

            if (step === 'upload_docs') return (
                <div className="app-container flex flex-col text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="manual_entry" />
                    <div className="flex-1 p-6 text-center">
                        <h2 className="text-xl font-bold mb-4 uppercase tracking-tight text-center">{t.upload_docs_title}</h2>
                        <p className="text-sm text-gray-500 mb-6">{t.upload_docs_desc}</p>
                        <div className="mb-6"><span className="input-label mb-2 text-center block w-full">{t.front}</span><div className="upload-preview mb-2">{images.front ? <img src={images.front} /> : <Icon name="camera" className="w-12 h-12 text-slate-300" />}</div><div className="upload-row"><button className="upload-btn-small" onClick={() => document.getElementById('cam-front').click()}><Icon name="camera" className="w-4 h-4"/> {t.take_photo}</button><button className="upload-btn-small" onClick={() => document.getElementById('file-front').click()}><Icon name="upload" className="w-4 h-4"/> {t.upload_file}</button></div><input id="cam-front" type="file" accept="image/*" capture="environment" onChange={e => e.target.files[0] && setImages({...images, front: URL.createObjectURL(e.target.files[0])})} className="hidden" /><input id="file-front" type="file" accept="image/*" onChange={e => e.target.files[0] && setImages({...images, front: URL.createObjectURL(e.target.files[0])})} className="hidden" /></div>
                        {docType !== 'passport' && <div className="mb-6"><span className="input-label mb-2 text-center block w-full">{t.back_doc}</span><div className="upload-preview mb-2">{images.back ? <img src={images.back} /> : <Icon name="camera" className="w-12 h-12 text-slate-300" />}</div><div className="upload-row"><button className="upload-btn-small" onClick={() => document.getElementById('cam-back').click()}><Icon name="camera" className="w-4 h-4"/> {t.take_photo}</button><button className="upload-btn-small" onClick={() => document.getElementById('file-back').click()}><Icon name="upload" className="w-4 h-4"/> {t.upload_file}</button></div><input id="cam-back" type="file" accept="image/*" capture="environment" onChange={e => e.target.files[0] && setImages({...images, back: URL.createObjectURL(e.target.files[0])})} className="hidden" /><input id="file-back" type="file" accept="image/*" onChange={e => e.target.files[0] && setImages({...images, back: URL.createObjectURL(e.target.files[0])})} className="hidden" /></div>}
                        <button onClick={() => { setGuests([...guests, {...formData, imgFront: images.front, imgBack: images.back, docType}]); setImages({front:null, back:null}); setStep('guest_list'); }} disabled={!checkPhotos()} className="btn btn-success w-full mt-4 uppercase font-bold shadow-lg text-white">{t.save_guest}</button>
                    </div>
                </div>
            );

            if (step === 'sign') return (
                <div className="app-container p-6 flex flex-col text-center text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guest_list" />
                    <h2 className="text-2xl font-bold mb-6 uppercase tracking-tight font-bold tracking-widest text-center">{t.sign_title}</h2>
                    <div className="p-4 rounded-3xl text-[12px] mb-6 border-2 bg-orange-50 border-orange-100 text-orange-900 italic text-center leading-relaxed font-medium">{t.tax_info}</div>
                    <div className="flex-1 border-2 border-slate-200 rounded-3xl bg-slate-50 relative overflow-hidden mb-6 h-80 shadow-inner">
                        <div className="absolute inset-0 flex items-center justify-center text-slate-200 pointer-events-none uppercase font-bold opacity-30 text-2xl">Firma Qui</div>
                        <SignaturePad canvasRef={sigCanvasRef} />
                    </div>
                    <div className="flex gap-2">
                        <button onClick={clearSignature} className="btn bg-red-100 text-red-500 border border-red-200 w-1/3 font-bold uppercase shadow-sm">{t.clear_sign}</button>
                        <button onClick={saveToCloud} disabled={isSaving} className="btn btn-primary w-2/3 uppercase font-bold shadow-xl text-white">
                            {isSaving ? <span className="loader mr-2"></span> : "CONFERMA E FINE"}
                        </button>
                    </div>
                    {isSaving && <p className="text-xs text-teal-600 mt-2 font-bold animate-pulse uppercase text-center">{t.cloud_save}</p>}
                </div>
            );

            if (step === 'success') return (
                <div className="app-container bg-teal-800 text-white items-center p-10 text-center relative overflow-hidden flex flex-col justify-center min-h-screen">
                    <div className="w-24 h-24 bg-white text-teal-700 rounded-full flex items-center justify-center mb-8 shadow-2xl animate-bounce"><Icon name="check" className="w-12 h-12" /></div>
                    <h1 className="text-3xl font-bold mb-2 uppercase tracking-tight">{t.thanks}, {guests[0]?.name || "Ospite"}!</h1>
                    <p className="opacity-80 text-xl mb-12 uppercase font-bold tracking-wide">{t.success_msg}</p>
                    <div className="bg-white text-slate-900 rounded-3xl p-10 w-full shadow-2xl relative z-10 border border-teal-500 text-center">
                        <p className="input-label text-slate-400 text-center mb-6 tracking-widest font-bold uppercase">{property?.type === 'electronic' ? "CODICE TASTIERINO" : "CODICE KEYBOX"}</p>
                        <div className="flex flex-col items-center">
                            <div className="p-6 bg-slate-50 rounded-2xl mb-4 text-teal-600 border border-teal-100 shadow-inner"><Icon name="lock" className="w-16 h-16"/></div>
                            <div className="text-5xl font-mono font-bold tracking-widest text-slate-800 uppercase">{bookingDetails.doorCode || "9988"}</div>
                        </div>
                    </div>
                    <div className="info-success">
                        {t.save_link_msg}
                    </div>
                    <div className="mt-8 pt-8 border-t border-teal-700/50 w-full">
                         <button onClick={shareLink} className="btn bg-teal-900 text-teal-100 font-bold uppercase text-sm border border-teal-700/50">
                            <Icon name="copy" className="w-4 h-4 mr-2" /> {t.share_link}
                         </button>
                     </div>
                    <button onClick={handleExit} className="mt-6 text-teal-200 font-bold uppercase tracking-widest text-sm hover:text-white transition underline opacity-60">{t.exit}</button>
                </div>
            );
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>