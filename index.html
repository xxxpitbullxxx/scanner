<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- OCR Engine -->
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); position: relative; }
        
        /* LOGO GIULIA - ZOOM 115% */
        .logo-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; padding: 25px 0; background: white; }
        .logo-circle {
            width: 200px; height: 200px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden;
            border: 3px solid #d4af37; position: relative;
            padding: 0;
        }
        .logo-img { 
            width: 100%; height: 100%; object-fit: cover; 
            transform: scale(1.15); 
            position: relative; z-index: 2;
        }

        .header-logo-circle { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; border: 1px solid #d4af37; background: white; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }

        /* Scanner OCR Styles */
        .cam-box { position: relative; width: 100%; height: 300px; overflow: hidden; border-radius: 20px; background: #000; margin-bottom: 16px; border: 2px solid #333; }
        video { width: 100%; height: 100%; object-fit: cover; }
        /* Guide visive per l'utente */
        .guide-res { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 15%; border: 2px solid #FFD60A; border-radius: 4px; z-index: 10; pointer-events: none; opacity: 0.7; }
        .guide-mrz { position: absolute; top: 80%; left: 50%; transform: translate(-50%, -50%); width: 94%; height: 25%; border: 3px solid #00E0FF; border-radius: 4px; z-index: 10; pointer-events: none; opacity: 0.8; }
        .label-guide { position: absolute; font-size: 10px; font-weight: bold; padding: 2px 5px; top: -18px; left: 0; background: rgba(0,0,0,0.5); color: white; border-radius: 3px; }

        .input-field { 
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; 
            font-size: 16px; background: #fff; transition: all 0.2s; margin-bottom: 8px; color: #1e293b;
        }
        .input-field:focus { border-color: #0f766e; outline: none; box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1); }
        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 4px; text-align: left; }

        .btn { width: 100%; padding: 18px; border-radius: 16px; font-weight: 700; transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: none; }
        .btn-primary { background: #0f766e; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-primary:active:not(:disabled) { transform: scale(0.97); }
        .btn-primary:disabled, .btn-success:disabled { background: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; box-shadow: none; }
        
        .flag-btn { font-size: 20px; padding: 4px; opacity: 0.3; transition: 0.2s; cursor: pointer; border: none; background: transparent; }
        .flag-btn.active { opacity: 1; transform: scale(1.2); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

        .card-select { width: 100%; padding: 18px; border-radius: 18px; border: 2px solid #f1f5f9; background: white; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .card-select:hover { border-color: #0f766e; background: #f0fdfa; }

        /* Stili upload ESPANSO */
        .upload-box {
            border: 2px dashed #cbd5e1; border-radius: 20px; 
            height: 240px; 
            position: relative; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: #f8fafc;
            transition: 0.2s; cursor: pointer; overflow: hidden;
            width: 100%;
        }
        .upload-box:active { border-color: #0f766e; background: #f0fdfa; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <!-- Canvas nascosto per elaborazione OCR -->
    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- TUE CHIAVI FIREBASE REALI ---
        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", type: "electronic", defaultCode: "123456#" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", type: "keybox", defaultCode: "9988" },
            "REGINA": { id: "REGINA", name: "Santa Regina", type: "keybox", defaultCode: "4567" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome: "Ciao! Sono Giulia. Per rendere il tuo arrivo piÃ¹ semplice, ti chiedo di completare il check-in online.", 
                login_ph: "CODICE PRENOTAZIONE", start_btn: "INIZIA IL CHECK-IN", scan_rear: "SCANSIONA DOC", scan_info: "Inquadra il documento. Il sistema leggerÃ  automaticamente i dati dalla C.I. Elettronica.", photo_req: "FOTO OBBLIGATORIA", confirm_btn: "CONFERMA FOTO E PROCEDI", recover_btn: "VEDI IL TUO CODICE PORTA", add_guest: "AGGIUNGI OSPITE", save_guest: "SALVA OSPITE",
                warning_save: "Carica le foto e compila tutti i campi obbligatori per salvare", finish_btn: "FINISCI E PROCEDI", verify: "Verifica Dati", front: "Fronte", back_doc: "Retro",
                tax_info: "In conformitÃ  con le normative locali, se hai prenotato tramite Booking.com la tassa di soggiorno dovrÃ  essere pagata in loco all'arrivo (in contanti), oppure tramite il link sicuro per carta di credito o debito che ti invierÃ² a breve. Se hai prenotato tramite Airbnb, la tassa Ã¨ giÃ  inclusa.",
                doc_type: "Tipo Documento", doc_e: "C.I. Elettronica", doc_p: "C.I. Cartacea", doc_pass: "Passaporto", doc_l: "Patente di Guida",
                label_surname: "Cognome", label_name: "Nome", label_sex: "Sesso", label_birth: "Nato il", label_city: "Comune Nascita", label_prov: "Prov.", label_citizenship: "Cittadinanza", label_cit_ph: "Specifica Cittadinanza...", label_res_city: "CittÃ  Residenza", label_res_prov: "Prov.", label_address: "Via / Piazza", label_civic: "Civico", label_issued: "Rilasciato da", label_issued_ph: "Es. Milano...", label_docnum: "N. Documento", label_expiry: "Scadenza",
                thanks: "Grazie", success_msg: "Check-in completato con successo.", exit: "Esci", guest_list: "Ospiti Registrati", cloud_save: "Salvataggio...",
                data_true_label: "Dichiaro che i dati inseriti sono reali", clear_sign: "CANCELLA FIRMA", sign_title: "Firma e Tassa",
                ocr_btn: "ðŸ” SCANSIONA DOCUMENTO", ocr_processing: "ELABORAZIONE..."
            },
            en: { 
                welcome: "Hi! I'm Giulia. To make your arrival smoother, please complete the online check-in.", 
                login_ph: "BOOKING CODE", start_btn: "START CHECK-IN", scan_rear: "SCAN DOC", scan_info: "Scan document. The system will read data from Electronic ID.", photo_req: "PHOTO REQUIRED", confirm_btn: "CONFIRM & PROCEED", recover_btn: "VIEW YOUR DOOR CODE", add_guest: "ADD GUEST", save_guest: "SAVE GUEST",
                warning_save: "Upload photos and fill all fields to save", finish_btn: "FINISH AND PROCEED", verify: "Verify Data", front: "Front", back_doc: "Back",
                tax_info: "In accordance with local regulations, if you booked via Booking.com, the tourist tax must be paid on-site upon arrival (cash), or via the secure credit/debit card link I will send you shortly. If you booked via Airbnb, the tax is already included.",
                doc_type: "Document Type", doc_e: "Electronic ID", doc_p: "Paper ID", doc_pass: "Passport", doc_l: "Driving License",
                label_surname: "Surname", label_name: "Name", label_sex: "Sex", label_birth: "Birth Date", label_city: "Birth City", label_prov: "Prov.", label_citizenship: "Citizenship", label_cit_ph: "Specify Citizenship...", label_res_city: "Residence City", label_res_prov: "Prov.", label_address: "Address", label_civic: "No.", label_issued: "Issued by", label_issued_ph: "Ex. London...", label_docnum: "Doc Number", label_expiry: "Expiry Date",
                thanks: "Thank you", success_msg: "Check-in successfully completed.", exit: "Exit", guest_list: "Guests", cloud_save: "Saving...",
                data_true_label: "I declare that the data entered is true", clear_sign: "CLEAR SIGNATURE", sign_title: "Signature",
                ocr_btn: "ðŸ” SCAN DOCUMENT", ocr_processing: "PROCESSING..."
            },
            fr: { 
                welcome: "Salut ! Je suis Giulia. Pour faciliter votre arrivÃ©e, je vous demande de remplir l'enregistrement en ligne.", 
                login_ph: "CODE", start_btn: "COMMENCER", scan_rear: "SCANNER DOC", scan_info: "Scannez le document.", photo_req: "PHOTO OBLIGATOIRE", confirm_btn: "CONFIRMER", recover_btn: "VOIR LE CODE", add_guest: "AJOUTER UN INVITÃ‰", save_guest: "ENREGISTRER",
                warning_save: "TÃ©lÃ©chargez les photos et remplissez tous les champs pour enregistrer", finish_btn: "TERMINER", verify: "VÃ©rifier les donnÃ©es", front: "Recto", back_doc: "Verso",
                tax_info: "ConformÃ©ment Ã  la rÃ©glementation locale, si vous avez rÃ©servÃ© via Booking.com, la taxe de sÃ©jour doit Ãªtre payÃ©e sur place Ã  l'arrivÃ©e (en espÃ¨ces) ou via le lien sÃ©curisÃ© par carte de crÃ©dit/dÃ©bit que je vous enverrai sous peu. Si vous avez rÃ©servÃ© via Airbnb, la taxe est dÃ©jÃ  incluse.",
                doc_type: "Type de document", doc_e: "C.I. Ã‰lectronique", doc_p: "C.I. Papier", doc_pass: "Passeport", doc_l: "Permis de Conduire",
                label_surname: "Nom", label_name: "PrÃ©nom", label_sex: "Sexe", label_birth: "NÃ© le", label_city: "Lieu de naissance", label_prov: "Prov.", label_citizenship: "NationalitÃ©", label_cit_ph: "PrÃ©ciser...", label_res_city: "Ville de rÃ©sidence", label_res_prov: "Prov.", label_address: "Adresse", label_civic: "NÂ°", label_issued: "DÃ©livrÃ© par", label_issued_ph: "Ex. Paris...", label_docnum: "NÂ° Document", label_expiry: "Expiration",
                thanks: "Merci", success_msg: "Enregistrement terminÃ© avec succÃ¨s.", exit: "Sortie", guest_list: "InvitÃ©s", cloud_save: "Sauvegarde...",
                data_true_label: "Je dÃ©clare que les donnÃ©es sont rÃ©elles", clear_sign: "EFFACER", sign_title: "Signature",
                ocr_btn: "ðŸ” SCANNER DOCUMENT", ocr_processing: "TRAITEMENT..."
            },
            es: { 
                welcome: "Â¡Hola! Soy Giulia. Para facilitar su llegada, le pido que complete el registro en lÃ­nea.", 
                login_ph: "CÃ“DIGO", start_btn: "EMPEZAR", scan_rear: "ESCANEAR DOC", scan_info: "Escanee el documento.", photo_req: "FOTO OBLIGATORIA", confirm_btn: "CONFIRMAR", recover_btn: "VER TU CÃ“DIGO", add_guest: "AÃ‘ADIR", save_guest: "GUARDAR",
                warning_save: "Cargue las fotos y complete los campos para guardar", finish_btn: "TERMINAR", verify: "Verificar datos", front: "Frente", back_doc: "Dorso",
                tax_info: "De acuerdo con las normativas locales, si reservÃ³ a travÃ©s de Booking.com, la tasa turÃ­stica debe pagarse en el lugar a la llegada (en efectivo) o mediante el enlace seguro de tarjeta de crÃ©dito/dÃ©bito que le enviarÃ© en breve. Si reservÃ³ a travÃ©s de Airbnb, la tasa ya estÃ¡ incluida.",
                doc_type: "Tipo de Documento", doc_e: "DNI ElectrÃ³nico", doc_p: "DNI Papel", doc_pass: "Pasaporte", doc_l: "Licencia de Conducir",
                label_surname: "Apellido", label_name: "Nombre", label_sex: "Sexo", label_birth: "Nacido el", label_city: "Lugar de nacimiento", label_prov: "Prov.", label_citizenship: "CiudadanÃ­a", label_cit_ph: "Especificar...", label_res_city: "Ciudad de residencia", label_res_prov: "Prov.", label_address: "DirecciÃ³n", label_civic: "NÂ°", label_issued: "Expedido por", label_issued_ph: "Ej. Madrid...", label_docnum: "NÂ° Documento", label_expiry: "Caducidad",
                thanks: "Gracias", success_msg: "Registro completado con Ã©xito.", exit: "Salir", guest_list: "HuÃ©spedes", cloud_save: "Guardando...",
                data_true_label: "Declaro que los datos son reales", clear_sign: "BORRAR", sign_title: "Firma",
                ocr_btn: "ðŸ” ESCANEAR DOCUMENTO", ocr_processing: "PROCESANDO..."
            },
            de: { 
                welcome: "Hallo! Ich bin Giulia. Um Ihre Ankunft zu erleichtern, bitte ich Sie, den Online-Check-in abzuschlieÃŸen.", 
                login_ph: "CODE", start_btn: "STARTEN", scan_rear: "DOKUMENT SCANNEN", scan_info: "Scannen Sie das Dokument.", photo_req: "FOTO", confirm_btn: "FOTOS BESTÃ„TIGEN", recover_btn: "TÃœRCODE ANZEIGEN", add_guest: "HINZUFÃœGEN", save_guest: "SPEICHERN",
                warning_save: "Laden Sie Fotos hoch und fÃ¼llen Sie die Felder aus", finish_btn: "ABSCHLIESSEN", verify: "Daten prÃ¼fen", front: "Vorderseite", back_doc: "RÃ¼ckseite",
                tax_info: "GemÃ¤ÃŸ den Ã¶rtlichen Vorschriften muss die Kurtaxe bei Buchung Ã¼ber Booking.com vor Ort bei Ankunft (in bar) oder Ã¼ber den sicheren Kredit-/Debitkartenlink, den ich Ihnen in KÃ¼rze zusende, bezahlt werden. Bei Buchung Ã¼ber Airbnb ist die Steuer bereits enthalten.",
                doc_type: "Dokumentart", doc_e: "Elektronisch ID", doc_p: "Papier ID", doc_pass: "Reisepass", doc_l: "FÃ¼hrerschein",
                label_surname: "Nachname", label_name: "Vorname", label_sex: "Geschlecht", label_birth: "Geburtsdatum", label_city: "Geburtsort", label_prov: "Prov.", label_citizenship: "StaatsangehÃ¶rigkeit", label_cit_ph: "Angeben...", label_res_city: "Wohnort", label_res_prov: "Prov.", label_address: "Adresse", label_civic: "Nr.", label_issued: "Ausgestellt von", label_issued_ph: "Z.B. Berlin...", label_docnum: "Dokumentnummer", label_expiry: "Ablaufdatum",
                thanks: "Danke", success_msg: "Check-in erfolgreich abgeschlossen.", exit: "Beenden", guest_list: "GÃ¤ste", cloud_save: "Speichern...",
                data_true_label: "Ich erklÃ¤re, dass die Daten echt sind", clear_sign: "LÃ–SCHEN", sign_title: "Unterschrift",
                ocr_btn: "ðŸ” DOKUMENT SCANNEN", ocr_processing: "VERARBEITUNG..."
            }
        };

        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                check: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>,
                trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>,
                camera: <React.Fragment><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3" strokeWidth="2"/></React.Fragment>,
                chevronLeft: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />,
                eye: <React.Fragment><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></React.Fragment>,
                lock: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />,
                scan: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7V5a2 2 0 012-2h2m10 0h2a2 2 0 012 2v2m0 10v2a2 2 0 01-2 2h-2m-10 0H5a2 2 0 01-2-2v-2M7 12h10" />,
                copy: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />,
                download: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            };
            return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">{icons[name] || icons.camera}</svg>;
        };

        const SVGIcons = {
            electronic: <svg viewBox="0 0 24 24" className="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="14" rx="2" /><path d="M7 15h.01M11 15h.01M15 15h.01M19 15h.01M7 11h.01M11 11h.01M15 11h.01" /><circle cx="17" cy="9" r="1"/></svg>,
            paper: <svg viewBox="0 0 24 24" className="w-12 h-12 text-orange-600" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>,
            passport: <svg viewBox="0 0 24 24" className="w-12 h-12 text-green-600" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/><path d="M12 12a3 3 0 100-6 3 3 0 000 6z"/><path d="M12 15a5 5 0 00-5 5h10a5 0 00-5-5z"/></svg>,
            license: <svg viewBox="0 0 24 24" className="w-12 h-12 text-pink-600" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="14" rx="2" /><path d="M7 9h2" /><path d="M7 13h10" /><path d="M7 17h6" /><circle cx="16" cy="10" r="2" /></svg>
        };

        const CopyField = ({ label, value }) => (
            <div className="flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-200 relative group text-left mb-2">
                <span className="text-[9px] text-slate-400 uppercase font-bold">{label}</span>
                <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-sm truncate mr-2">{value || "-"}</span>
                    {value && <button onClick={(e) => {
                        e.stopPropagation();
                        const el = document.createElement('textarea');
                        el.value = value;
                        document.body.appendChild(el);
                        el.select();
                        try { document.execCommand('copy'); } catch(e){}
                        document.body.removeChild(el);
                        e.currentTarget.style.color = '#10b981';
                        setTimeout(() => e.currentTarget.style.color = '', 500);
                    }} className="p-1 hover:bg-white rounded transition text-slate-400 hover:text-blue-600"><Icon name="copy" className="w-4 h-4" /></button>}
                </div>
            </div>
        );

        // --- SIGNATURE PAD COMPONENT (Outside App) ---
        const SignaturePad = ({ canvasRef, onClear }) => {
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                let isDrawing = false;

                const resize = () => { 
                    canvas.width = canvas.parentElement.clientWidth; 
                    canvas.height = canvas.parentElement.clientHeight; 
                    ctx.lineWidth = 3; 
                    ctx.lineCap = 'round'; 
                    ctx.strokeStyle = '#000'; 
                };
                
                resize(); 
                window.addEventListener('resize', resize);

                const getPos = (e) => { 
                    const rect = canvas.getBoundingClientRect(); 
                    return { 
                        x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, 
                        y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top 
                    }; 
                };

                const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
                const draw = (e) => { if (!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                const stop = () => isDrawing = false;

                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('mouseleave', stop);
                canvas.addEventListener('touchstart', start, {passive: false});
                canvas.addEventListener('touchmove', draw, {passive: false});
                canvas.addEventListener('touchend', stop);

                return () => {
                    window.removeEventListener('resize', resize);
                    canvas.removeEventListener('mousedown', start);
                    canvas.removeEventListener('mousemove', draw);
                    canvas.removeEventListener('mouseup', stop);
                    canvas.removeEventListener('mouseleave', stop);
                    canvas.removeEventListener('touchstart', start);
                    canvas.removeEventListener('touchmove', draw);
                    canvas.removeEventListener('touchend', stop);
                };
            }, []);
            
            return (
                <canvas ref={canvasRef} className="w-full h-full" style={{width: '100%', height: '100%'}} />
            );
        };

        function App() {
            const [lang, setLang] = useState('it');
            const [user, setUser] = useState(null);
            const [step, setStep] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('d') ? 'welcome' : 'login';
            });
            const [property, setProperty] = useState(null);
            const [bookingDetails, setBookingDetails] = useState({ guestName: '', doorCode: '' });
            const [guests, setGuests] = useState([]);
            const [docType, setDocType] = useState('electronic');
            const [images, setImages] = useState({ front: null, back: null });
            const [isScanning, setIsScanning] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [adminData, setAdminData] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);
            const [moturistCode, setMoturistCode] = useState("");
            const [dates, setDates] = useState({ arrival: new Date().toISOString().split('T')[0], departure: "" });
            const [adminLink, setAdminLink] = useState("");
            const [searchTerm, setSearchTerm] = useState("");

            const [formData, setFormData] = useState({
                surname: "", name: "", sex: "M", birthDate: "", birthCity: "", birthProvince: "",
                citizenship: "ITALIANA", citizenshipManual: "", residenceCity: "", residenceProvince: "",
                residenceAddress: "", houseNumber: "", issuedBy: "COMUNE DI", issuedManual: "", docNumber: "", expiryDate: ""
            });
            
            const [dataTrue, setDataTrue] = useState(false);
            const sigCanvasRef = useRef(null);
            const videoRef = useRef(null); // Reference for camera

            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'tuscan-retreats-portal';

            // Firebase Boot logic
            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(checkFB);
                        // CONFIGURAZIONE FIREBASE
                        const config = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
                            apiKey: "INSERISCI_API_KEY",
                            authDomain: "tuo-progetto.firebaseapp.com",
                            projectId: "tuo-progetto",
                            storageBucket: "tuo-progetto.appspot.com",
                            messagingSenderId: "123456",
                            appId: "1:123456:web:abc"
                        };
                        
                        try {
                             const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                             const auth = window.FirebaseSDK.getAuth(app);
                             const db = window.FirebaseSDK.getFirestore(app);
                             window.db = db;
                             
                             const initAuth = async () => {
                                 await window.FirebaseSDK.signInAnonymously(auth);
                                 window.FirebaseSDK.onAuthStateChanged(auth, setUser);
                             };
                             initAuth();
                        } catch(e) { console.log("Firebase init error", e); }
                    }
                }, 100);
            }, []);

            // Link Analysis
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const d = params.get('d'); 
                if (d) {
                    if (localStorage.getItem(`checkin_done_${d}`)) {
                         try {
                            const decoded = JSON.parse(atob(d)); 
                            if (PROPERTIES[decoded.p]) {
                                setProperty(PROPERTIES[decoded.p]);
                                setBookingDetails({ guestName: decoded.n || "Ospite", doorCode: decoded.c });
                                setStep('success'); 
                                return;
                            }
                        } catch (e) {}
                    }
                    try {
                        const decoded = JSON.parse(atob(d)); 
                        if (PROPERTIES[decoded.p]) {
                            setProperty(PROPERTIES[decoded.p]);
                            setBookingDetails({ guestName: decoded.n || "Ospite", doorCode: decoded.c });
                        }
                    } catch (e) {}
                }
            }, []);

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); alert("Link copiato!"); } catch (err) {}
                document.body.removeChild(textArea);
            };

            const downloadImage = (dataUrl, filename) => {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const compress = async (url) => {
                return new Promise(res => {
                    const img = new Image(); img.src = url;
                    img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const s = Math.min(800 / img.width, 1);
                        c.width = img.width * s; c.height = img.height * s;
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        res(c.toDataURL('image/jpeg', 0.6));
                    }
                });
            };

            const saveToCloud = async () => {
                setIsSaving(true);
                let signatureData = null;
                if(sigCanvasRef.current) {
                    signatureData = sigCanvasRef.current.toDataURL();
                }

                const params = new URLSearchParams(window.location.search);
                const d = params.get('d');

                try {
                    const id = `${property?.id || 'TEST'}_${Date.now()}`;
                    
                    const processed = await Promise.all(guests.map(async g => ({
                        ...g, imgFront: g.imgFront ? await compress(g.imgFront) : null, imgBack: g.imgBack ? await compress(g.imgBack) : null
                    })));

                    const payload = { 
                        guests: processed, 
                        signature: signatureData, 
                        booking: property?.id || "", 
                        timestamp: new Date().toISOString(), 
                        checkinDate: new Date().toISOString().split('T')[0],
                        guestName: bookingDetails.guestName, 
                        property: property?.name || "" 
                    };

                    let savedToCloud = false;
                    if (user && window.db) {
                         try {
                             const path = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id);
                             await window.FirebaseSDK.setDoc(path, payload);
                             savedToCloud = true;
                         } catch(e) {}
                    }

                    const localData = JSON.parse(localStorage.getItem('local_checkins') || '[]');
                    localData.push({ id, ...payload, synced: savedToCloud });
                    localStorage.setItem('local_checkins', JSON.stringify(localData));
                    
                    if(d) localStorage.setItem(`checkin_done_${d}`, 'true');

                } catch(e) { console.log("Errore salvataggio generale", e); }
                
                setIsSaving(false);
                setStep('success');
            };

            const fetchCloud = async () => {
                let list = [];
                const localData = JSON.parse(localStorage.getItem('local_checkins') || '[]');
                list = [...localData];

                if (user && window.db) {
                    try {
                        const col = window.FirebaseSDK.collection(window.db, 'artifacts', appId, 'public', 'data', 'checkins');
                        const snap = await window.FirebaseSDK.getDocs(col);
                        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    } catch (e) { console.error("Cloud fetch error", e); }
                }
                
                const uniqueList = Array.from(new Map(list.map(item => [item.id, item])).values());
                uniqueList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                setAdminData(uniqueList);
            };

            const deleteSession = async (sessionId) => {
                if(!confirm("Sicuro di voler cancellare questo check-in?")) return;
                
                const localData = JSON.parse(localStorage.getItem('local_checkins') || '[]');
                const newLocal = localData.filter(i => i.id !== sessionId);
                localStorage.setItem('local_checkins', JSON.stringify(newLocal));

                if (user && window.db) {
                    try {
                        const docRef = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', sessionId);
                        await window.FirebaseSDK.deleteDoc(docRef);
                    } catch(e) {}
                }

                fetchCloud();
                if (selectedSession && selectedSession.id === sessionId) setSelectedSession(null);
            };

            const deleteAll = async () => {
                if(!confirm("ATTENZIONE: Cancellare TUTTO lo storico?")) return;
                localStorage.removeItem('local_checkins');
                if (user && window.db) {
                    adminData.forEach(async (item) => {
                         try {
                            const docRef = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', item.id);
                            await window.FirebaseSDK.deleteDoc(docRef);
                        } catch(e) {}
                    });
                }
                setAdminData([]);
            };

            // --- OCR Logic Functions ---
            const fixOCRText = (s, type) => {
                if(!s) return "";
                if(type === 'N') return s.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
                if(type === 'L') return s.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B').replace(/4/g,'A');
                return s;
            };

            const cleanDoubleStart = (s) => {
                if (s.length > 2 && s[0] === s[1]) {
                    return s.substring(1);
                }
                return s;
            };
            
            const formatDateOCR = (d) => { 
                if(!d || d.length<6) return ""; 
                let y = d.substring(0,2); let m = d.substring(2,4); let day = d.substring(4,6);
                return (parseInt(y) > 40 ? "19" : "20") + y + "-" + m + "-" + day; 
            };

            const parseV104 = (raw) => {
                const up = raw.toUpperCase();
                const clean = up.replace(/\s/g, '');
                const lines = up.split('\n').map(l => l.trim()).filter(l => l.length > 5);
                let newForm = { ...formData };

                // 1. DOC & NOMI
                let dc = clean.match(/ITA([A-Z0-9]{9})/); 
                if(dc) newForm.docNumber = dc[1];

                let nm = clean.match(/([A-Z0-9]+)<<([A-Z0-9]+)/);
                if(nm) { 
                    let cog = fixOCRText(nm[1], 'L');
                    newForm.surname = cleanDoubleStart(cog);
                    newForm.name = fixOCRText(nm[2], 'L').replace(/</g, ' '); 
                }

                // 2. BIO
                let bioMatch = clean.match(/([0-9OIZSB]{6,7})([MF])([0-9OIZSB]{6,7})([A-Z0-9]{3})/);
                if(bioMatch) {
                    newForm.birthDate = formatDateOCR(fixOCRText(bioMatch[1].substr(0,6), 'N'));
                    newForm.sex = bioMatch[2];
                    newForm.expiryDate = formatDateOCR(fixOCRText(bioMatch[3].substr(0,6), 'N'));
                }

                // 3. RESIDENZA
                lines.forEach(l => {
                    if(l.includes("VIA") || l.includes("PIAZZA") || l.includes("CORSO") || l.match(/\(([A-Z]{2})\)/)) {
                        let prov = l.match(/\(([A-Z]{2})\)/); if(prov) newForm.residenceProvince = prov[1];
                        
                        let civ = l.match(/(?:N\.|,)\s*(\d+[A-Z]?)/) || l.match(/\s(\d+[A-Z]?)$/); 
                        if(civ) newForm.houseNumber = civ[1];
                        
                        let via = l.match(/(VIA|PIAZZA|CORSO|LARGO|VIALE)\s+[A-Z\s\.]+/); 
                        if(via) newForm.residenceAddress = via[0].trim();
                        
                        let com = l.match(/([A-Z\s']+)\s+\(/); 
                        if(com) newForm.residenceCity = com[1].trim();
                    }
                });
                
                setFormData(newForm);
                setIsScanning(false); // Stop scanning automatically on success
                alert("Dati estratti con successo! Verifica la correttezza.");
            };

            const runOCR = async (source) => {
                const btn = document.getElementById('snap-btn');
                if(btn) btn.innerText = t.ocr_processing;
                
                const canvas = document.getElementById('ocr-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1280;
                const scale = 1280 / (source.videoWidth || source.width);
                canvas.height = (source.videoHeight || source.height) * scale;
                ctx.filter = 'grayscale(100%) contrast(300%) brightness(110%)';
                ctx.drawImage(source, 0, 0, canvas.width, canvas.height);
                
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                    parseV104(text);
                } catch (e) { 
                    alert("Errore scansione, riprova o inserisci manualmente.");
                    setIsScanning(false);
                }
            };

            const startCamera = async () => {
                setIsScanning(true);
                setTimeout(async () => {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: "environment", width: { ideal: 1280 } } 
                        });
                        if (videoRef.current) videoRef.current.srcObject = stream;
                    } catch (err) {
                        alert("Impossibile accedere alla fotocamera");
                        setIsScanning(false);
                    }
                }, 500);
            };

            const startNewGuest = () => {
                setFormData({ surname: "", name: "", sex: "M", birthDate: "", birthCity: "", birthProvince: "", citizenship: "ITALIANA", citizenshipManual: "", residenceCity: "", residenceProvince: "", residenceAddress: "", houseNumber: "", issuedBy: "COMUNE DI", issuedManual: "", docNumber: "", expiryDate: "" });
                setImages({ front: null, back: null });
                setDataTrue(false);
                setStep('type_select');
            };

            const checkPhotos = () => images.front && (docType === 'passport' || images.back);

            const isFormComplete = () => {
                const hasPhotos = checkPhotos();
                const hasInfo = formData.surname && formData.name && formData.birthDate && formData.docNumber && formData.issuedManual;
                let citOk = true;
                if (formData.citizenship === 'ALTRO') {
                    citOk = formData.citizenshipManual && formData.citizenshipManual.trim().length > 0;
                }
                return hasPhotos && hasInfo && citOk && dataTrue;
            };

            const formatDateIT = (dateString) => {
                if (!dateString) return "";
                return dateString.split('-').reverse().join('/');
            };

            const clearSignature = () => {
                const canvas = sigCanvasRef.current;
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            };

            const Header = ({ showBack, backStep }) => (
                <div className="flex justify-between items-center p-5 bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                    <div className="flex items-center text-center">
                        {showBack && <button onClick={() => setStep(backStep)} className="mr-3 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                        <div className="header-logo-circle"><img src="logo.png" /></div>
                        <div><span className="block font-bold text-slate-700 text-[9px] leading-tight uppercase tracking-widest text-center ml-2 font-bold">Tuscan Retreats</span></div>
                    </div>
                    <div className="flex space-x-1">
                        {['it','en','fr','es','de'].map(l => <button key={l} onClick={() => setLang(l)} className={`flag-btn ${lang === l ? 'active' : ''}`}>{l.toUpperCase()}</button>)}
                    </div>
                </div>
            );

            if (step === 'login') return (
                <div className="app-container p-8 justify-center items-center text-center">
                    <div className="logo-wrapper"><div className="logo-circle"><img src="logo.png" className="logo-img" /></div></div>
                    <h1 className="text-3xl font-bold text-slate-800 mb-8 uppercase tracking-tight tracking-widest">Login</h1>
                    <form onSubmit={e => { e.preventDefault(); const c = e.target.code.value.toUpperCase(); if(c==='ADMIN') setStep('admin_pass'); else if(PROPERTIES[c]){ setProperty(PROPERTIES[c]); setBookingDetails({ guestName: "Ospite", doorCode: PROPERTIES[c].defaultCode }); setStep('welcome'); } else alert('Err'); }} className="space-y-4 w-full px-4">
                        <input name="code" type="text" className="input-field text-center uppercase font-bold tracking-widest" placeholder={t.login_ph} required />
                        <button type="submit" className="btn btn-primary shadow-xl uppercase font-bold text-white">ENTRA</button>
                    </form>
                    <button onClick={() => setStep('admin_pass')} className="mt-20 text-xs text-slate-300 underline uppercase tracking-widest font-bold">Area Proprietario</button>
                </div>
            );

            if (step === 'admin_pass') return (
                <div className="app-container p-8 justify-center items-center flex-col text-center">
                    <h2 className="text-xl font-bold mb-6 text-teal-800 uppercase tracking-widest">Sblocca</h2>
                    <form onSubmit={e => { e.preventDefault(); if (e.target.pass.value === 'W0d@w0d@') setStep('admin_panel'); else alert('Err'); }} className="w-full space-y-4 px-4">
                        <input name="pass" type="password" className="input-field text-center font-bold" placeholder="Password" autoFocus required />
                        <button type="submit" className="btn btn-primary font-bold shadow-lg text-white">SBLOCCA</button>
                    </form>
                    <button onClick={()=>setStep('login')} className="mt-8 text-sm text-slate-400 underline">Indietro</button>
                </div>
            );

            if (step === 'admin_panel') return (
                <div className="app-container p-6 overflow-y-auto space-y-8">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="login" />
                    <div className="bg-slate-50 p-6 rounded-2xl border space-y-4 text-slate-800 text-center">
                        <h2 className="text-xl font-bold text-teal-800 uppercase tracking-widest">Generatore Link</h2>
                        <select id="adm_prop" className="input-field">{Object.keys(PROPERTIES).map(k => <option key={k} value={k}>{PROPERTIES[k].name}</option>)}</select>
                        <input id="adm_name" className="input-field" placeholder="Nome Ospite" />
                        <input id="adm_code" className="input-field" placeholder="Codice Porta" />
                        <button onClick={() => {
                            const p = document.getElementById('adm_prop').value;
                            const n = document.getElementById('adm_name').value;
                            const c = document.getElementById('adm_code').value;
                            const data = btoa(JSON.stringify({ p, n, c }));
                            copyToClipboard(`${window.location.origin}${window.location.pathname}?d=${data}`);
                        }} className="btn btn-primary w-full text-white font-bold uppercase shadow-lg text-white">COPIA LINK WHATSAPP</button>
                    </div>

                    <div className="border-t pt-8 text-slate-800 text-center">
                        <h2 className="text-xl font-bold mb-4 text-blue-800 uppercase tracking-widest">Esportazione Questura</h2>
                        <div className="bg-blue-50 p-6 rounded-2xl border border-blue-200 space-y-4">
                            <label className="input-label">Codice Moturist</label><input type="text" value={moturistCode} onChange={e=>setMoturistCode(e.target.value)} className="input-field" placeholder="0520..." />
                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="input-label">Arrivo</label><input type="date" value={dates.arrival} onChange={e=>setDates({...dates, arrival: e.target.value})} className="input-field" /></div>
                                <div><label className="input-label">Partenza</label><input type="date" value={dates.departure} onChange={e=>setDates({...dates, departure: e.target.value})} className="input-field" /></div>
                            </div>
                            <button onClick={fetchCloud} className="btn bg-blue-600 text-white font-bold uppercase w-full">Aggiorna dati (Cloud + Locali)</button>
                            
                            <div className="mt-4">
                                <input 
                                    type="text" 
                                    placeholder="Cerca ospite..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="input-field text-center font-bold text-slate-600 mb-2"
                                />
                                <div className="space-y-3 max-h-60 overflow-y-auto">
                                    {adminData
                                        .filter(item => {
                                            const search = searchTerm.toLowerCase();
                                            return (
                                                item.guestName?.toLowerCase().includes(search) ||
                                                item.booking?.toLowerCase().includes(search) ||
                                                item.property?.toLowerCase().includes(search) ||
                                                (item.checkinDate && item.checkinDate.includes(search)) ||
                                                item.guests.some(g => g.surname.toLowerCase().includes(search) || g.name.toLowerCase().includes(search))
                                            );
                                        })
                                        .map((s, idx) => (
                                        <div key={idx} className="card-checkin flex justify-between items-center" onClick={() => setSelectedSession(s)}>
                                            <div className="flex-1 text-left">
                                                <div className="font-bold text-sm">{s.guestName}</div>
                                                <div className="text-[9px] text-slate-400 uppercase">{s.property} - {formatDateIT(s.checkinDate) || new Date(s.timestamp).toLocaleDateString('it-IT')}</div>
                                            </div>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); deleteSession(s.id); }}
                                                className="ml-3 p-2 bg-red-100 rounded-full text-red-500 hover:bg-red-200"
                                            >
                                                <Icon name="trash" className="w-4 h-4" />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="pt-4 border-t border-blue-200">
                                <button onClick={deleteAll} disabled={adminData.length === 0} className="btn btn-danger w-full font-bold uppercase text-[10px] mb-4">CANCELLA TUTTO STORICO</button>
                            </div>

                            <button onClick={() => {
                                let csv = "CodiceStruttura;Cognome;Nome;Sesso;DataNascita;ComuneNascita;Cittadinanza;NumeroDocumento\n";
                                adminData.forEach(r => r.guests.forEach(g => csv += `${moturistCode};${g.surname};${g.name};${g.sex};${g.birthDate};${g.birthCity};${g.citizenship};${g.docNumber}\n`));
                                const b = new Blob([csv], { type: 'text/csv;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `moturist.csv`; a.click();
                            }} disabled={adminData.length===0} className="btn bg-blue-900 text-white font-bold w-full uppercase">CSV MOTURIST</button>
                            <button onClick={() => {
                                let txt = ""; 
                                adminData.forEach(s => s.guests.forEach((g, i) => {
                                    const type = i === 0 ? "18" : "20"; const arr = dates.arrival.split('-').reverse().join('/'); const surname = g.surname.padEnd(50, ' '); const name = g.name.padEnd(30, ' ');
                                    txt += `${type}${arr}01${surname}${name}${g.sex==='M'?'1':'2'}${g.birthDate.split('-').reverse().join('/')}\n`;
                                }));
                                const b = new Blob([txt], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `polizia.txt`; a.click();
                            }} disabled={adminData.length===0} className="btn bg-slate-800 text-white font-bold w-full uppercase mt-2">TXT POLIZIA</button>
                        </div>
                    </div>

                    {selectedSession && (
                        <div className="modal" onClick={() => setSelectedSession(null)}>
                            <div className="bg-white w-full max-h-[85vh] rounded-3xl p-6 overflow-y-auto text-slate-800" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-center mb-4 uppercase">{selectedSession.guestName}</h3>
                                {selectedSession.guests.map((g, i) => (
                                    <div key={i} className="mb-6 border-b pb-4">
                                        
                                        {/* SMART COPY PANEL */}
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                                            <h4 className="text-xs font-bold text-slate-500 uppercase mb-3 border-b pb-2">Dati Copia/Incolla</h4>
                                            <div className="grid grid-cols-2 gap-2">
                                                <CopyField label="Cognome" value={g.surname} />
                                                <CopyField label="Nome" value={g.name} />
                                                <CopyField label="Sesso" value={g.sex} />
                                                <CopyField label="Data Nascita" value={formatDateIT(g.birthDate)} />
                                                <CopyField label="Luogo Nascita" value={g.birthCity} />
                                                <CopyField label="Prov. Nascita" value={g.birthProvince} />

                                                <div className="col-span-2"><CopyField label="Cittadinanza" value={g.citizenship === 'ALTRO' ? g.citizenshipManual : g.citizenship} /></div>
                                                <div className="col-span-2"><CopyField label="Indirizzo" value={g.residenceAddress} /></div>
                                                <CopyField label="N. Civico" value={g.houseNumber} />
                                                <CopyField label="CAP" value="" />
                                                <CopyField label="Comune Residenza" value={g.residenceCity} />
                                                <CopyField label="Prov. Residenza" value={g.residenceProvince} />
                                                
                                                <CopyField label="Tipo Doc" value={g.docType === 'electronic' ? 'CIE' : g.docType === 'passport' ? 'PASS' : g.docType === 'license' ? 'PATENTE' : 'DOC'} />
                                                <CopyField label="Numero Doc" value={g.docNumber} />
                                                
                                                <CopyField label="Ente Rilascio" value={g.issuedBy} />
                                                <CopyField label="Luogo Rilascio" value={g.issuedManual} />
                                                
                                                <CopyField label="Scadenza" value={formatDateIT(g.expiryDate)} />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-2 mt-4 text-center">
                                            <div className="text-center"><span className="text-[8px] font-bold uppercase text-slate-400">FRONTE</span><img src={g.imgFront} className="rounded-lg shadow border" />
                                                <button onClick={() => downloadImage(g.imgFront, `fronte_${g.surname}.jpg`)} className="text-[10px] text-blue-600 underline mt-1 flex items-center justify-center w-full"><Icon name="download" className="w-3 h-3 mr-1"/> Scarica</button>
                                            </div>
                                            {g.imgBack && <div className="text-center"><span className="text-[8px] font-bold text-slate-400">RETRO</span><img src={g.imgBack} className="rounded-lg shadow border" />
                                                <button onClick={() => downloadImage(g.imgBack, `retro_${g.surname}.jpg`)} className="text-[10px] text-blue-600 underline mt-1 flex items-center justify-center w-full"><Icon name="download" className="w-3 h-3 mr-1"/> Scarica</button>
                                            </div>}
                                        </div>
                                    </div>
                                ))}

                                {selectedSession.signature && (
                                    <div className="mt-4 border-t pt-4">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase mb-2 text-center">Firma Ospite</h4>
                                        <div className="border border-slate-200 rounded-lg p-2 bg-white flex flex-col justify-center">
                                            <img src={selectedSession.signature} className="max-h-24 object-contain" />
                                            <button onClick={() => downloadImage(selectedSession.signature, `firma_${selectedSession.guestName}.jpg`)} className="text-[10px] text-blue-600 underline mt-1 flex items-center justify-center w-full"><Icon name="download" className="w-3 h-3 mr-1"/> Scarica</button>
                                        </div>
                                    </div>
                                )}
                                <button onClick={() => setSelectedSession(null)} className="btn btn-primary w-full mt-4 font-bold text-white">CHIUDI</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            if (step === 'welcome') return (
                <div className="app-container">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="login" />
                    <div className="p-8 text-center flex-1 flex flex-col justify-center text-center text-slate-800">
                        <h1 className="text-2xl font-bold mb-6 uppercase">{property?.name || "Benvenuto"}</h1>
                        <div className="bg-teal-50 border-l-4 border-teal-600 p-8 rounded-r-3xl shadow-sm mb-10 flex flex-col items-center text-center">
                            <div className="w-32 h-32 rounded-full bg-white mb-4 mt-20 border-4 border-white shadow-xl overflow-hidden">
                                <img src="foto.jpg" className="w-full h-full object-cover" style={{ objectPosition: 'center 15%' }} onError={(e)=>e.target.style.display='none'} />
                            </div>
                            <p className="text-lg italic leading-relaxed mt-6 text-center">"{t.welcome}"</p>
                            <p className="font-bold text-teal-800 mt-4 text-center">- Giulia</p>
                        </div>
                        <button onClick={() => { setGuests([]); setStep('guest_list'); }} className="btn btn-primary uppercase font-bold shadow-xl text-white">{t.start_btn}</button>
                    </div>
                </div>
            );

            if (step === 'guest_list') return (
                <div className="app-container flex flex-col text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="welcome" />
                    <div className="p-6 bg-white border-b flex justify-between items-center shadow-sm font-bold uppercase text-slate-800">
                        <span>{t.guest_list}</span>
                        <div className="text-teal-600 bg-teal-50 px-4 py-1 rounded-full text-sm border border-teal-100">{guests.length}</div>
                    </div>
                    <div className="flex-1 p-6 space-y-4 overflow-y-auto">
                        {guests.map((g, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center text-slate-800">
                                <div className="font-bold uppercase">{g.surname} {g.name}</div>
                                <button onClick={() => setGuests(guests.filter((_, idx) => idx !== i))} className="text-red-400 p-2"><Icon name="trash" /></button> 
                            </div>
                        ))}
                        <button onClick={startNewGuest} className="w-full py-6 border-2 border-dashed border-teal-700 rounded-2xl font-bold text-lg hover:bg-teal-50 transition uppercase tracking-widest text-teal-700">+ {t.add_guest}</button>
                    </div>
                    <div className="p-6 bg-white border-t border-slate-100 shadow-lg text-slate-800 font-bold text-center">
                        <button onClick={() => setStep('sign')} disabled={guests.length === 0} className="btn btn-primary w-full uppercase tracking-widest font-bold disabled:opacity-50 font-bold">{t.finish_btn}</button>
                    </div>
                </div>
            );

            if (step === 'type_select') return (
                <div className="app-container p-6 flex flex-col text-center text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guest_list" />
                    <h2 className="text-2xl font-bold mb-8 uppercase tracking-tight text-center">{t.doc_type}</h2>
                    <div className="space-y-4">
                        <div onClick={() => { setDocType('electronic'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.electronic}<h3 className="font-bold text-lg uppercase tracking-wide ml-4">{t.doc_e}</h3></div>
                        <div onClick={() => { setDocType('paper'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.paper}<h3 className="font-bold text-lg uppercase tracking-wide ml-4">{t.doc_p}</h3></div>
                        <div onClick={() => { setDocType('passport'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.passport}<h3 className="font-bold text-lg uppercase tracking-wide ml-4">{t.doc_pass}</h3></div>
                        <div onClick={() => { setDocType('license'); setStep('scan'); }} className="card-select shadow-sm">{SVGIcons.license}<h3 className="font-bold text-lg uppercase tracking-wide ml-4">{t.doc_l}</h3></div>
                    </div>
                </div>
            );

            if (step === 'scan') return (
                <div className="app-container p-6 flex flex-col text-center text-slate-800 text-center">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="type_select" />
                    <h2 className="text-2xl font-bold mb-4 text-slate-800 mt-4 uppercase tracking-tight text-center">{t.scan_title}</h2>
                    
                    {/* Scanner solo per Elettronica e Passaporto */}
                    {docType !== 'paper' && docType !== 'license' && (
                        <>
                        <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r-xl text-xs text-blue-900 mb-6 leading-relaxed italic text-center text-center">{t.scan_info}</div>
                        {isScanning ? (
                            <div className="flex-1 flex flex-col text-center text-center">
                                <div className="scan-container"><video ref={videoRef} autoPlay playsInline muted></video><div className="scan-line"></div></div>
                                <button onClick={() => { setIsScanning(false); }} className="btn bg-red-600 text-white mt-4 uppercase font-bold text-center text-center">Annulla</button>
                                <button id="snap-btn" onClick={() => runOCR(videoRef.current)} className="btn btn-primary mt-2 uppercase font-bold shadow-lg">SCATTA E LEGGI</button>
                            </div>
                        ) : (
                            <button onClick={startCamera} className="btn bg-teal-600 text-white w-2/3 mx-auto py-3 uppercase font-bold flex flex-row items-center justify-center shadow-lg mb-4 text-xs gap-2 rounded-full"><Icon name="scan" className="w-5 h-5" /> {t.ocr_btn}</button>
                        )}
                        </>
                    )}

                    {!isScanning && (
                        <div className="space-y-4 flex-1 text-center text-center mt-4">
                            <div className={`upload-box ${images.front ? 'border-teal-500 bg-teal-50' : ''}`} onClick={() => document.getElementById('file-front').click()}>
                                {images.front ? <img src={images.front} className="w-full h-full object-contain" /> : <div className="text-center text-slate-400 font-bold uppercase text-[10px]"><Icon name="camera" />{t.photo_req} ({t.front.toUpperCase()})</div>}
                                <input id="file-front" type="file" accept="image/*" capture="environment" onChange={e => { if(e.target.files[0]) setImages({...images, front: URL.createObjectURL(e.target.files[0])}); }} className="hidden" />
                            </div>
                            
                            {(docType !== 'passport') && (
                                <div className={`upload-box ${images.back ? 'border-teal-500 bg-teal-50' : ''}`} onClick={() => document.getElementById('file-back').click()}>
                                    {images.back ? <img src={images.back} className="w-full h-full object-contain" /> : <div className="text-center text-slate-400 font-bold uppercase text-[10px]"><Icon name="camera" />{t.photo_req} ({t.back_doc.toUpperCase()})</div>}
                                    <input id="file-back" type="file" accept="image/*" capture="environment" onChange={e => { if(e.target.files[0]) setImages({...images, back: URL.createObjectURL(e.target.files[0])}); }} className="hidden" />
                                </div>
                            )}
                            <button onClick={() => setStep('manual_entry')} disabled={!checkPhotos()} className="btn btn-primary w-full mt-6 uppercase font-bold tracking-widest shadow-lg text-center font-bold text-white">{t.confirm_btn}</button>
                        </div>
                    )}
                </div>
            );

            if (step === 'manual_entry') return (
                <div className="app-container flex flex-col text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="scan" />
                    <div className="flex-1 p-6 overflow-y-auto custom-scroll text-slate-800 text-center text-center">
                        <h2 className="text-xl font-bold mb-6 uppercase tracking-tight font-bold text-slate-800">{t.verify}</h2>
                        <form onSubmit={(e) => { e.preventDefault(); setGuests([...guests, {...formData, imgFront: images.front, imgBack: images.back, docType}]); setImages({front:null, back:null}); setStep('guest_list'); }} className="space-y-4 pb-20 text-center text-slate-800">
                            <div><label className="input-label text-left ml-1">{t.label_surname}</label><input className="input-field" value={formData.surname} onChange={e=>setFormData({...formData, surname: e.target.value.toUpperCase()})} required /></div>
                            <div><label className="input-label text-left ml-1">{t.label_name}</label><input className="input-field" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value.toUpperCase()})} required /></div>
                            <div className="grid grid-cols-2 gap-4 text-slate-800 text-center text-center">
                                <div><label className="input-label text-left">{t.label_sex}</label><select className="input-field bg-white" value={formData.sex} onChange={e=>setFormData({...formData, sex: e.target.value})}><option value="M">M</option><option value="F">F</option></select></div>
                                <div><label className="input-label text-left">{t.label_birth}</label><input type="date" className="input-field text-center font-bold" value={formData.birthDate} onChange={e=>setFormData({...formData, birthDate: e.target.value})} required /></div>
                            </div>
                            
                            {/* GRIGLIA CITTA NASCITA E PROVINCIA */}
                            <div><label className="input-label text-left ml-1">{t.label_city}</label><input className="input-field" value={formData.birthCity} onChange={e=>setFormData({...formData,birthCity: e.target.value.toUpperCase()})} required /></div>
                            <div><label className="input-label text-left ml-1">{t.label_prov}</label><input className="input-field text-center uppercase" maxLength="2" value={formData.birthProvince} onChange={e=>setFormData({...formData, birthProvince: e.target.value.toUpperCase()})} placeholder="PR" /></div>

                            <div><label className="input-label">{t.label_citizenship}</label><select className="input-field bg-white" value={formData.citizenship} onChange={e=>setFormData({...formData, citizenship: e.target.value.toUpperCase()})}><option value="ITALIANA">ITALIANA</option><option value="FRANCESE">FRANCESE</option><option value="INGLESE">INGLESE</option><option value="SPAGNOLA">SPAGNOLA</option><option value="TEDESCA">TEDESCA</option><option value="ALTRO">ALTRO</option></select>{formData.citizenship === 'ALTRO' && <input className="input-field mt-2" placeholder={t.label_cit_ph} value={formData.citizenshipManual} onChange={e=>setFormData({...formData, citizenshipManual: e.target.value.toUpperCase()})} />}</div>
                            
                            {/* GRIGLIA CITTA RESIDENZA E PROVINCIA */}
                            <div className="border-t pt-4 grid grid-cols-4 gap-2 text-center text-center">
                                <div className="col-span-3"><label className="input-label text-left">{t.label_res_city}</label><input className="input-field" value={formData.residenceCity} onChange={e=>setFormData({...formData, residenceCity: e.target.value.toUpperCase()})} required /></div>
                                <div><label className="input-label text-left">{t.label_res_prov}</label><input className="input-field uppercase text-center" maxLength="2" value={formData.residenceProvince} onChange={e=>setFormData({...formData, residenceProvince: e.target.value.toUpperCase()})} placeholder="PR" /></div>
                            </div>

                            <div className="grid grid-cols-3 gap-2 text-center text-center">
                                <div className="col-span-2"><label className="input-label text-left">{t.label_address}</label><input className="input-field" value={formData.residenceAddress} onChange={e=>setFormData({...formData, residenceAddress: e.target.value.toUpperCase()})} required /></div>
                                <div><label className="input-label text-left">{t.label_civic}</label><input className="input-field text-center" value={formData.houseNumber} onChange={e=>setFormData({...formData, houseNumber: e.target.value})} required /></div>
                            </div>
                            <div className="pt-4 border-t-2 border-teal-100 text-center text-center">
                                <label className="input-label text-left">{t.label_issued}</label>
                                <select className="input-field bg-white" value={formData.issuedBy} onChange={e=>setFormData({...formData, issuedBy: e.target.value.toUpperCase()})}>
                                    <option value="COMUNE DI">COMUNE DI</option><option value="QUESTURA DI">QUESTURA DI</option><option value="MOTORIZZAZIONE">MOTORIZZAZIONE</option><option value="ALTRO">ALTRO</option>
                                </select>
                                <input className="input-field" placeholder={t.label_issued_ph} value={formData.issuedManual} onChange={e=>setFormData({...formData, issuedManual: e.target.value.toUpperCase()})} required />
                                <div className="grid grid-cols-2 gap-4 mt-2">
                                    <div><label className="input-label text-left">{t.label_docnum}</label><input className="input-field font-mono uppercase bg-blue-50 text-center font-bold" value={formData.docNumber} onChange={e=>setFormData({...formData, docNumber: e.target.value.toUpperCase()})} required /></div>
                                    <div><label className="input-label text-left">{t.label_expiry}</label><input type="date" className="input-field bg-slate-50 text-center font-bold" value={formData.expiryDate} onChange={e=>setFormData({...formData, expiryDate: e.target.value})} required /></div>
                                </div>
                            </div>
                            
                            <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mt-4 flex items-center">
                                <input type="checkbox" id="dataTrue" checked={dataTrue} onChange={e => setDataTrue(e.target.checked)} className="w-5 h-5 text-teal-600 mr-3" />
                                <label htmlFor="dataTrue" className="text-xs font-bold text-yellow-900 uppercase text-left">{t.data_true_label}</label>
                            </div>

                            <button 
                                type="submit" 
                                disabled={!isFormComplete()} 
                                className="btn btn-success w-full mt-6 uppercase tracking-widest font-bold shadow-lg text-center text-white"
                            >
                                {t.save_guest}
                            </button>
                            {(!isFormComplete() || !dataTrue) && <p className="text-[10px] text-red-500 mt-2 font-bold uppercase text-center">{t.warning_save}</p>}
                        </form>
                    </div>
                </div>
            );

            if (step === 'sign') return (
                <div className="app-container p-6 flex flex-col text-center text-slate-800">
                    <Header lang={lang} setLang={setLang} setStep={setStep} showBack={true} backStep="guest_list" />
                    <h2 className="text-2xl font-bold mb-6 uppercase tracking-tight font-bold tracking-widest uppercase text-slate-800 text-center">{t.sign_title}</h2>
                    <div className="p-4 rounded-3xl text-[12px] mb-6 border-2 bg-orange-50 border-orange-100 text-orange-900 italic text-center leading-relaxed font-medium">{t.tax_info}</div>
                    <div className="flex-1 border-2 border-slate-200 rounded-3xl bg-slate-50 relative overflow-hidden mb-6 h-80 shadow-inner text-center">
                        <div className="absolute inset-0 flex items-center justify-center text-slate-200 pointer-events-none uppercase font-bold opacity-30 text-2xl">Firma Qui</div>
                        <SignaturePad canvasRef={sigCanvasRef} />
                    </div>
                    <div className="flex gap-2">
                        <button onClick={clearSignature} className="btn bg-red-100 text-red-500 border border-red-200 w-1/3 font-bold uppercase shadow-sm text-center">{t.clear_sign}</button>
                        <button onClick={async () => { await saveToCloud(); sessionStorage.setItem('checkin_done', 'true'); setStep('success'); }} disabled={isSaving} className="btn btn-primary w-2/3 uppercase font-bold shadow-xl text-white font-bold">
                            {isSaving ? <span className="loader mr-2"></span> : "CONFERMA E FINE"}
                        </button>
                    </div>
                    {isSaving && <p className="text-xs text-teal-600 mt-2 font-bold animate-pulse uppercase text-center">{t.cloud_save}</p>}
                </div>
            );

            if (step === 'success') return (
                <div className="app-container bg-teal-800 text-white items-center p-10 text-center relative overflow-hidden flex flex-col justify-center min-h-screen text-center text-center text-center text-center">
                    <div className="w-24 h-24 bg-white text-teal-700 rounded-full flex items-center justify-center mb-8 shadow-2xl animate-bounce"><Icon name="check" className="w-12 h-12" /></div>
                    <h1 className="text-3xl font-bold mb-2 uppercase tracking-tight text-center">{t.thanks}, {guests[0]?.name || "Ospite"}!</h1>
                    <p className="opacity-80 text-xl mb-12 uppercase font-bold tracking-wide text-center">{t.success_msg}</p>
                    <div className="bg-white text-slate-900 rounded-3xl p-10 w-full shadow-2xl relative z-10 border border-teal-500 text-center text-center text-center text-center">
                        <p className="input-label text-slate-400 text-center mb-6 tracking-widest font-bold uppercase text-center">{property?.type === 'electronic' ? "CODICE TASTIERINO" : "CODICE KEYBOX"}</p>
                        <div className="flex flex-col items-center text-center">
                            <div className="p-6 bg-slate-50 rounded-2xl mb-4 text-teal-600 border border-teal-100 shadow-inner"><Icon name="lock" className="w-16 h-16"/></div>
                            <div className="text-5xl font-mono font-bold tracking-widest text-slate-800 uppercase text-center">{bookingDetails.doorCode || "9988"}</div>
                        </div>
                    </div>
                    <button onClick={() => { sessionStorage.clear(); window.location.reload(); }} className="mt-12 text-teal-100 font-bold uppercase tracking-widest text-sm hover:text-white transition underline opacity-60 text-center text-center text-center text-center">{t.exit}</button>
                </div>
            );
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
