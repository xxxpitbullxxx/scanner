<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V54 - Real Scale</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; margin: 0; background: #000; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
        }

        /* VIDEOCAMERA */
        .viewport { 
            position: relative; flex: 1; display: flex; 
            justify-content: center; align-items: center; overflow: hidden;
        }
        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
        }

        /* SAGOMA ORIZZONTALE REALE (Ratio 1.58:1) */
        .card-frame {
            position: relative;
            width: 90vw; /* Occupa quasi tutta la larghezza per simulare la grandezza reale */
            aspect-ratio: 85.6 / 54; /* Proporzione esatta ID-1 */
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.9); /* Maschera nera attorno */
            z-index: 10;
            transition: border-color 0.3s;
        }
        .card-frame.success { border-color: #32d74b; box-shadow: 0 0 20px #32d74b, 0 0 0 1000px rgba(0,0,0,0.9); }

        .guide-text {
            position: absolute; top: -50px; width: 100%; text-align: center;
            color: #fff; font-weight: bold; font-size: 16px; text-transform: uppercase;
            text-shadow: 0 2px 4px #000;
        }

        /* LOGO ANCHOR */
        .anchor-icon {
            position: absolute; bottom: 10px; right: 10px; 
            color: rgba(255,255,255,0.5); font-size: 12px; font-weight: bold;
        }

        /* TASTO SCANSIONE */
        .controls {
            position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 20;
        }
        .btn-scan {
            background: #007AFF; color: #fff; border: none; padding: 20px 60px;
            border-radius: 50px; font-size: 20px; font-weight: bold; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); cursor: pointer;
        }

        /* PANNELLO RISULTATI */
        .panel {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #1c1c1e; border-top: 3px solid #32d74b;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s ease-out;
            z-index: 30; max-height: 80vh; overflow-y: auto;
        }
        .panel.visible { transform: translateY(0); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .full { grid-column: span 2; }

        .field { background: #2c2c2e; padding: 10px; border-radius: 8px; }
        .lbl { color: #888; font-size: 10px; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .val { color: #fff; font-size: 16px; font-weight: bold; }

        .btn-reset { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 10px; font-weight: bold; }

        #loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #00E0FF; padding: 20px; border-radius: 10px; z-index: 25; font-weight: bold; }
        
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="webcam" autoplay playsinline></video>
        
        <div class="card-frame" id="frame">
            <div class="guide-text">Inquadra il Retro (Orizzontale)</div>
            <div class="anchor-icon">ANCHOR V3.0</div>
        </div>

        <div id="loader">Lettura MRZ in corso...</div>

        <div class="controls">
            <button class="btn-scan" id="btn-snap">SCANSIONA</button>
        </div>
    </div>

    <div class="panel" id="result-panel">
        <div style="text-align:center; color:#32d74b; font-weight:bold; margin-bottom:15px;">DATI ACQUISITI CORRETTAMENTE</div>
        
        <div class="grid">
            <div class="field full"><span class="lbl">Cognome</span><div class="val" id="v-cog">---</div></div>
            <div class="field full"><span class="lbl">Nome</span><div class="val" id="v-nom">---</div></div>
            
            <div class="field"><span class="lbl">Nato il</span><div class="val" id="v-dob">---</div></div>
            <div class="field"><span class="lbl">Sesso</span><div class="val" id="v-sex">---</div></div>
            
            <div class="field"><span class="lbl">N. Documento</span><div class="val" id="v-doc">---</div></div>
            <div class="field"><span class="lbl">Scadenza</span><div class="val" id="v-scad">---</div></div>
            
            <div class="field full"><span class="lbl">Cittadinanza</span><div class="val" id="v-cit">---</div></div>
            
            <div class="field full"><span class="lbl">Residenza (Extra)</span><div class="val" id="v-res">---</div></div>
        </div>

        <button class="btn-reset" onclick="resetScan()">Nuova Scansione</button>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const btn = document.getElementById('btn-snap');
        const frame = document.getElementById('frame');
        const panel = document.getElementById('result-panel');
        const loader = document.getElementById('loader');

        // Alta risoluzione per leggere i caratteri piccoli del MRZ
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 3840 }, height: { ideal: 2160 } } 
        }).then(s => video.srcObject = s);

        btn.addEventListener('click', async () => {
            btn.style.display = 'none';
            loader.style.display = 'block';

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            
            // Filtro Anchor: B/N e alto contrasto
            ctx.filter = 'grayscale(100%) contrast(200%)';
            ctx.drawImage(video, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                const ok = parseMRZ(text);
                
                loader.style.display = 'none';
                if(ok) {
                    frame.classList.add('success');
                    panel.classList.add('visible');
                } else {
                    alert("MRZ non trovato. Assicurati che il codice a 3 righe sia ben visibile.");
                    btn.style.display = 'inline-block';
                }
            } catch (e) {
                loader.style.display = 'none';
                btn.style.display = 'inline-block';
                alert("Errore tecnico.");
            }
        });

        // --- MOTORE ANCHOR 3-RIGHE (Specifico per la tua foto) ---
        function parseMRZ(raw) {
            // Pulisci tutto: niente spazi, tutto maiuscolo
            const clean = raw.toUpperCase().replace(/\s/g, ''); 
            
            // Variabili dati
            let docNum = null, dob = null, sex = null, expiry = null, surname = null, name = null, cit = "ITA";

            // 1. CERCA RIGA 1: Inizia con C<ITA o I<ITA o A<ITA
            // Esempio foto: C<ITACA07427WT1<<<<<<<<<<<<<<<
            const line1Regex = /[ACI]<ITA([A-Z0-9]{9})/;
            const match1 = clean.match(line1Regex);
            
            if (match1) {
                docNum = match1[1];
            } else {
                // Fallback generico se non trova C<ITA
                const docGeneric = clean.match(/ITA([A-Z0-9]{9})/);
                if(docGeneric) docNum = docGeneric[1];
            }

            // 2. CERCA RIGA 2: Numeri + Sesso
            // Esempio foto: 7212158F3412156ITA<<<<<<<<<<<8
            // Formato: [YYMMDD] [check] [Sex] [YYMMDD]
            const line2Regex = /(\d{6})\d([MF])(\d{6})/;
            const match2 = clean.match(line2Regex);

            if (match2) {
                // Data Nascita
                let d = match2[1];
                let year = (parseInt(d.substr(0,2)) > 40) ? '19' + d.substr(0,2) : '20' + d.substr(0,2);
                dob = `${d.substr(4,2)}/${d.substr(2,2)}/${year}`;
                
                // Sesso
                sex = match2[2];

                // Scadenza
                let e = match2[3];
                let eYear = '20' + e.substr(0,2);
                expiry = `${e.substr(4,2)}/${e.substr(2,2)}/${eYear}`;
            }

            // 3. CERCA RIGA 3: Cognome e Nome
            // Esempio foto: BETTI<<GIULIA<<<<<<<<<<<<<<<<<
            const line3Regex = /([A-Z]+)<<([A-Z]+)/;
            const match3 = clean.match(line3Regex);

            if (match3) {
                surname = match3[1];
                name = match3[2];
            }

            // 4. RESIDENZA (Extra, via Regex)
            let resTxt = "---";
            const rawLines = raw.toUpperCase().split('\n');
            const addrLine = rawLines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE)\s/));
            if(addrLine) resTxt = addrLine.replace(/[^A-Z0-9\s,\.]/g, '').trim();

            // VERIFICA FINALE
            if (docNum && dob && surname) {
                document.getElementById('v-doc').innerText = docNum;
                document.getElementById('v-dob').innerText = dob;
                document.getElementById('v-sex').innerText = sex;
                document.getElementById('v-scad').innerText = expiry;
                document.getElementById('v-cog').innerText = surname;
                document.getElementById('v-nom').innerText = name;
                document.getElementById('v-cit').innerText = cit;
                document.getElementById('v-res').innerText = resTxt;
                return true;
            }
            return false;
        }

        function resetScan() {
            panel.classList.remove('visible');
            frame.classList.remove('success');
            btn.style.display = 'inline-block';
        }
    </script>
</body>
</html>
