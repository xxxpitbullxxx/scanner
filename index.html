<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V53 - Alloggiati Anchor</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* RESET E BASE */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background: #000; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; 
        }

        /* AREA CAMERA */
        .viewport { 
            position: relative; flex: 1; background: #000; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }
        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
        }

        /* SAGOMA CARTA ESATTA (Proporzione ID-1: 85.60 x 53.98 mm -> Ratio ~1.58) */
        .card-frame {
            position: relative;
            width: 85vw; 
            height: 53.8vw; /* Mantiene il ratio corretto */
            max-width: 500px; max-height: 316px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.85); /* Effetto focus scuro */
            z-index: 10;
            pointer-events: none; /* Lascia passare i click */
        }

        /* Testo Guida */
        .guide-text {
            position: absolute; top: -40px; width: 100%; text-align: center;
            color: #fff; font-weight: 700; font-size: 14px; letter-spacing: 1px;
            text-shadow: 0 2px 4px #000; text-transform: uppercase;
        }

        /* BOTTONE SCANSIONE */
        .controls {
            position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 20;
        }
        .btn-scan {
            background: #007AFF; color: #fff; border: none; 
            padding: 18px 50px; border-radius: 50px; 
            font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.5); cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-scan:active { transform: scale(0.95); }

        /* LOADING */
        #loader {
            display: none; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); z-index: 25;
            background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 12px;
            color: #00E0FF; font-weight: bold; font-size: 14px; text-transform: uppercase;
        }

        /* PANNELLO RISULTATI (Nascosto di base) */
        .result-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #1c1c1e; border-top: 2px solid #333;
            border-radius: 20px 20px 0 0; 
            padding: 20px; box-sizing: border-box;
            max-height: 85vh; overflow-y: auto;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 30;
            display: flex; flex-direction: column; gap: 10px;
        }
        .result-panel.visible { transform: translateY(0); }

        .panel-header { text-align: center; color: #32d74b; font-weight: 800; margin-bottom: 10px; text-transform: uppercase; font-size: 14px; }

        /* GRIGLIA CAMPI */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }

        .field-box { 
            background: #2c2c2e; padding: 10px 12px; 
            border-radius: 8px; border-left: 4px solid #555; 
        }
        .field-box.ok { border-left-color: #007AFF; background: #1a222e; }

        .lbl { font-size: 9px; color: #888; display: block; margin-bottom: 3px; text-transform: uppercase; font-weight: bold; }
        .val { font-size: 15px; color: #fff; font-weight: 700; min-height: 18px; word-break: break-word; }

        .btn-reset {
            width: 100%; padding: 15px; background: #333; color: #fff; 
            border: none; border-radius: 12px; font-weight: bold; margin-top: 10px;
            text-transform: uppercase;
        }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="webcam" autoplay playsinline></video>
        
        <div class="card-frame">
            <div class="guide-text">Inquadra il Retro</div>
        </div>

        <div id="loader">Analisi Anchor in corso...</div>

        <div class="controls">
            <button class="btn-scan" id="btn-snap">SCANSIONA</button>
        </div>
    </div>

    <div class="result-panel" id="panel">
        <div class="panel-header">Dati Alloggiati Web (Retro)</div>
        
        <div class="grid">
            <div class="field-box full ok"><span class="lbl">Cognome</span><div class="val" id="v-cog">---</div></div>
            <div class="field-box full ok"><span class="lbl">Nome</span><div class="val" id="v-nom">---</div></div>
            
            <div class="field-box ok"><span class="lbl">Nato il</span><div class="val" id="v-dob">---</div></div>
            <div class="field-box ok"><span class="lbl">Sesso</span><div class="val" id="v-sex">---</div></div>
            
            <div class="field-box full ok"><span class="lbl">Cittadinanza</span><div class="val" id="v-cit">ITALIANA</div></div>

            <div class="field-box ok"><span class="lbl">Numero Doc</span><div class="val" id="v-doc">---</div></div>
            <div class="field-box ok"><span class="lbl">Scadenza</span><div class="val" id="v-scad">---</div></div>

            <div class="field-box full ok"><span class="lbl">Comune Residenza</span><div class="val" id="v-com">---</div></div>
            <div class="field-box full ok"><span class="lbl">Indirizzo</span><div class="val" id="v-via">---</div></div>
        </div>

        <button class="btn-reset" onclick="resetScan()">Nuova Scansione</button>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const btn = document.getElementById('btn-snap');
        const panel = document.getElementById('panel');
        const loader = document.getElementById('loader');

        // Camera ad alta risoluzione per leggere i caratteri piccoli del retro
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 2560 }, height: { ideal: 1440 } } 
        }).then(s => video.srcObject = s);

        btn.addEventListener('click', async () => {
            btn.style.display = 'none';
            loader.style.display = 'block';

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            
            // Filtro ANCHOR: Alto contrasto per far risaltare il nero su azzurrino
            ctx.filter = 'grayscale(100%) contrast(180%) brightness(100%)';
            ctx.drawImage(video, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                const success = parseAnchor(text);
                
                loader.style.display = 'none';
                if (success) {
                    panel.classList.add('visible');
                } else {
                    alert("Dati non agganciati. Assicurati che l'immagine sia a fuoco e riprova.");
                    btn.style.display = 'inline-block';
                }
            } catch (e) {
                loader.style.display = 'none';
                btn.style.display = 'inline-block';
                alert("Errore tecnico OCR.");
            }
        });

        // --- LOGICA ANCHOR (SOLO RETRO) ---
        function parseAnchor(raw) {
            const clean = raw.toUpperCase().replace(/\s/g, ''); // Per codici MRZ
            const lines = raw.toUpperCase().split('\n').map(l => l.trim()).filter(l => l.length > 2); // Per Indirizzo

            let foundImportantData = false;

            // 1. ANCHOR: MRZ (Machine Readable Zone) - Infallibile se a fuoco
            // Cerca Cognome e Nome (Formato: COGNOME<<NOME)
            let nameMatch = clean.match(/([A-Z]+)<<([A-Z]+)/);
            if (nameMatch) {
                document.getElementById('v-cog').innerText = nameMatch[1];
                document.getElementById('v-nom').innerText = nameMatch[2].replace(/</g, ' ');
                foundImportantData = true;
            }

            // Cerca Numero Documento (Inizia con C o I, seguito da <IT o TA)
            // Esempio: C<ITACA50322TW
            let docMatch = clean.match(/[CI]<IT[A-Z]?([A-Z0-9]{9})/);
            if (!docMatch) docMatch = clean.match(/ITA([A-Z0-9]{9})/); // Fallback
            if (docMatch) {
                document.getElementById('v-doc').innerText = docMatch[1];
                foundImportantData = true;
            }

            // Cerca Date e Sesso (Riga 2 MRZ: YYMMDD S YYMMDD)
            // Esempio: 9912016M331201... (Nato 01/12/99 M, Scade 01/12/33)
            let bioMatch = clean.match(/(\d{6})\d([MF])(\d{6})/);
            if (bioMatch) {
                // Data Nascita
                let d = bioMatch[1]; 
                let y = (parseInt(d.substr(0,2)) > 40) ? '19'+d.substr(0,2) : '20'+d.substr(0,2);
                document.getElementById('v-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                
                // Sesso
                document.getElementById('v-sex').innerText = bioMatch[2];

                // Scadenza (i 6 numeri dopo il sesso)
                let e = bioMatch[3];
                let ye = '20'+e.substr(0,2);
                document.getElementById('v-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ye}`;
            }

            // 2. ANCHOR: INDIRIZZO (Via/Piazza)
            // Cerca la riga che contiene una parola chiave di via
            let addrLine = lines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE|LARGO|VICOLO)\s/));
            if (addrLine) {
                // Pulizia Via
                let viaClean = addrLine.split(/,|N\.|CIV/)[0].trim(); // Prendi tutto prima del numero civico
                document.getElementById('v-via').innerText = viaClean;

                // Cerca Comune e Provincia (Riga successiva o fine riga)
                // Cerca pattern: NOME COMUNE (XX)
                let cityRegex = /([A-Z\s']+)\s*\(?([A-Z]{2})\)?/;
                let cityMatch = null;
                
                // Controlla riga corrente
                let currentMatch = addrLine.match(cityRegex);
                // Controlla riga successiva (pi√π probabile)
                let nextIdx = lines.indexOf(addrLine) + 1;
                let nextMatch = (lines[nextIdx]) ? lines[nextIdx].match(cityRegex) : null;

                // Preferisci la riga successiva se contiene la provincia (XX)
                if (nextMatch) cityMatch = nextMatch;
                else if (currentMatch && currentMatch[0].length < addrLine.length) cityMatch = currentMatch;

                if (cityMatch) {
                    let comune = cityMatch[1].replace(/.*N\.\s*\d+/, '').trim(); // Rimuovi residui numeri
                    document.getElementById('v-com').innerText = comune + " (" + cityMatch[2] + ")";
                }
            }

            return foundImportantData;
        }

        function resetScan() {
            panel.classList.remove('visible');
            btn.style.display = 'inline-block';
            // Resetta i campi
            document.querySelectorAll('.val').forEach(el => el.innerText = '---');
        }
    </script>
</body>
</html>
