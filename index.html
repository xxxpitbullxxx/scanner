<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Scanner V70 - Auto</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* RESET & LAYOUT */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* VIDEO A TUTTO SCHERMO */
        #cam-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        video { 
            width: 100%; height: 100%; object-fit: cover; 
        }

        /* SAGOMA GUIDA (Semplice) */
        .guide-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; /* Occupa quasi tutta la larghezza */
            aspect-ratio: 1.58; /* Proporzione ID-1 */
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.8); /* Maschera nera esterna */
            z-index: 10; pointer-events: none;
        }
        .guide-text {
            position: absolute; top: -30px; width: 100%; text-align: center;
            color: #fff; font-weight: bold; font-size: 14px; text-transform: uppercase; text-shadow: 0 1px 3px #000;
        }

        /* CONTROLLI (Sempre visibili) */
        .controls {
            position: absolute; bottom: 30px; width: 100%; z-index: 50;
            display: flex; justify-content: space-around; align-items: center;
        }

        .btn-capture {
            width: 80px; height: 80px; border-radius: 50%; background: #fff;
            border: 4px solid #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-capture:active { transform: scale(0.95); background: #eee; }

        .btn-upload {
            background: #333; color: #fff; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; font-weight: bold; border: 1px solid #666; cursor: pointer;
        }

        /* LOADING */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: #00E0FF; font-size: 18px; font-weight: bold; text-align: center;
        }

        /* RISULTATI */
        #results {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 200; display: none; overflow-y: auto; padding: 20px;
        }
        .res-title { color: #32d74b; margin-bottom: 20px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        .field { background: #1f1f1f; padding: 12px; border-radius: 8px; border-left: 4px solid #007AFF; }
        .lbl { color: #888; font-size: 10px; display: block; margin-bottom: 4px; text-transform: uppercase; }
        .val { color: #fff; font-size: 16px; font-weight: bold; word-break: break-word; }

        .btn-reset { width: 100%; padding: 15px; margin-top: 20px; background: #444; color: #fff; border: none; font-size: 18px; border-radius: 10px; }

        #file-input { display: none; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="cam-view">
        <video id="video" autoplay playsinline muted></video>
    </div>

    <div class="guide-box">
        <div class="guide-text">INQUADRA IL RETRO QUI</div>
    </div>

    <div class="controls">
        <button class="btn-upload" onclick="document.getElementById('file-input').click()">CARICA<br>FILE</button>
        <div class="btn-capture" id="snap-btn"></div>
        <div style="width: 60px;"></div> </div>

    <input type="file" id="file-input" accept="image/*">

    <div id="loader">
        <div>ANALISI INTELLIGENTE...</div>
        <div style="font-size:12px; color:#888; margin-top:10px;" id="status-text">Sto cercando l'orientamento giusto</div>
    </div>

    <div id="results">
        <h2 class="res-title">DATI ESTRATTI</h2>
        <div class="grid">
            <div class="field full"><span class="lbl">COGNOME</span><div class="val" id="v-cog">---</div></div>
            <div class="field full"><span class="lbl">NOME</span><div class="val" id="v-nom">---</div></div>
            <div class="field"><span class="lbl">NASCITA</span><div class="val" id="v-dob">---</div></div>
            <div class="field"><span class="lbl">SESSO</span><div class="val" id="v-sex">---</div></div>
            <div class="field full"><span class="lbl">DOCUMENTO</span><div class="val" id="v-doc">---</div></div>
            <div class="field"><span class="lbl">SCADENZA</span><div class="val" id="v-scad">---</div></div>
            <div class="field"><span class="lbl">CITTADINANZA</span><div class="val" id="v-cit">ITA</div></div>
            
            <div class="field full"><span class="lbl">INDIRIZZO</span><div class="val" id="v-via">---</div></div>
            <div class="field"><span class="lbl">CIVICO</span><div class="val" id="v-civ">---</div></div>
            <div class="field full"><span class="lbl">COMUNE</span><div class="val" id="v-com">---</div></div>
            <div class="field"><span class="lbl">PROVINCIA</span><div class="val" id="v-prov">---</div></div>
        </div>
        <button class="btn-reset" onclick="location.reload()">NUOVA SCANSIONE</button>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('cvs');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const results = document.getElementById('results');

        // 1. AVVIO CAMERA PIÙ ROBUSTO POSSIBILE
        async function startCamera() {
            try {
                // Chiediamo la massima risoluzione possibile
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 4096 },
                        height: { ideal: 2160 }
                    },
                    audio: false
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Errore fotocamera. Usa il tasto 'Carica File'.");
            }
        }
        startCamera();

        // FULLSCREEN AL CLICK
        document.body.addEventListener('click', () => {
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
        }, {once: true});

        // 2. GESTIONE INPUT (Scatto o File)
        document.getElementById('snap-btn').addEventListener('click', () => processImage(video));
        
        document.getElementById('file-input').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const img = new Image();
                img.onload = () => processImage(img);
                img.src = URL.createObjectURL(e.target.files[0]);
            }
        });

        // 3. MOTORE "BRUTE FORCE" (Prova a ruotare l'immagine finché non legge)
        async function processImage(source) {
            loader.style.display = 'flex';
            
            let w = source.videoWidth || source.width;
            let h = source.videoHeight || source.height;
            
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            
            // Disegna immagine originale
            ctx.drawImage(source, 0, 0);

            // TENTATIVO 1: Immagine Originale
            statusText.innerText = "Tentativo 1 (Originale)...";
            if (await tryOCR(canvas)) return;

            // TENTATIVO 2: Ruota 90° (Spesso i telefoni scattano così)
            statusText.innerText = "Tentativo 2 (Ruoto 90°)...";
            rotateCanvas(canvas, 90);
            if (await tryOCR(canvas)) return;

            // TENTATIVO 3: Ruota altri 90° (Totale 180°)
            statusText.innerText = "Tentativo 3 (Ruoto 180°)...";
            rotateCanvas(canvas, 90); // Ruota su se stesso
            if (await tryOCR(canvas)) return;

            // TENTATIVO 4: Ruota altri 90° (Totale 270°)
            statusText.innerText = "Tentativo 4 (Ruoto 270°)...";
            rotateCanvas(canvas, 90);
            if (await tryOCR(canvas)) return;

            alert("Impossibile leggere i dati. Assicurati che la foto sia a fuoco e che ci sia luce.");
            loader.style.display = 'none';
        }

        // Funzione helper per ruotare il canvas fisicamente
        function rotateCanvas(cvs, deg) {
            const temp = document.createElement('canvas');
            const tCtx = temp.getContext('2d');
            
            // Scambia dimensioni se 90/270
            if (deg === 90 || deg === 270) {
                temp.width = cvs.height;
                temp.height = cvs.width;
            } else {
                temp.width = cvs.width;
                temp.height = cvs.height;
            }

            tCtx.translate(temp.width/2, temp.height/2);
            tCtx.rotate(deg * Math.PI / 180);
            tCtx.drawImage(cvs, -cvs.width/2, -cvs.height/2);
            
            // Copia indietro
            cvs.width = temp.width;
            cvs.height = temp.height;
            cvs.getContext('2d').drawImage(temp, 0, 0);
        }

        // 4. ESECUZIONE OCR E PARSING
        async function tryOCR(cvs) {
            // Applica filtri temporanei per l'OCR
            const ctx = cvs.getContext('2d');
            const imgData = ctx.getImageData(0,0, cvs.width, cvs.height);
            // (Qui potremmo manipolare i pixel, ma lasciamo fare a Tesseract su canvas pulito)
            
            try {
                const { data: { text } } = await Tesseract.recognize(cvs, 'ita');
                const clean = text.toUpperCase().replace(/\s/g, ''); 
                
                // VERIFICA SE ABBIAMO TROVATO QUALCOSA (Anchor ITA)
                // Se non troviamo "ITA" o "<", l'orientamento è sbagliato
                if (!clean.includes('ITA') && !clean.includes('<')) return false;

                // Parsing
                const lines = text.toUpperCase().split('\n');
                let foundData = false;

                // MRZ
                let docMatch = clean.match(/[CI]<ITA([A-Z0-9]{9})/);
                if(!docMatch) docMatch = clean.match(/ITA([A-Z0-9]{9})/);
                let bioMatch = clean.match(/(\d{6})\d([MF])(\d{6})/);
                let nameMatch = clean.match(/([A-Z]+)<<([A-Z]+)/);

                if(docMatch && bioMatch && nameMatch) {
                    fillData(docMatch, nameMatch, bioMatch);
                    foundData = true;
                }

                // INDIRIZZO
                let addrLine = lines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE|LARGO|V\.)\s/));
                if(addrLine) {
                    parseAddr(addrLine);
                    // Se troviamo l'indirizzo, consideriamo il tentativo valido anche se l'MRZ fallisce parzialmente
                    if(foundData) return true; 
                }

                return foundData;

            } catch (e) {
                return false;
            }
        }

        function fillData(doc, name, bio) {
            document.getElementById('v-doc').innerText = doc[1];
            document.getElementById('v-cog').innerText = name[1];
            document.getElementById('v-nom').innerText = name[2].replace(/</g, ' ');

            let d = bio[1]; 
            let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
            document.getElementById('v-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
            document.getElementById('v-sex').innerText = bio[2];

            let e = bio[3];
            let ey = '20'+e.substr(0,2);
            document.getElementById('v-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
            
            loader.style.display = 'none';
            results.style.display = 'block';
        }

        function parseAddr(line) {
            let txt = line.replace(/[^A-Z0-9\s,\.\(\)]/g, '').trim();
            
            let provM = txt.match(/\(([A-Z]{2})\)/);
            if(provM) {
                document.getElementById('v-prov').innerText = provM[1];
                txt = txt.replace(provM[0], '');
            }

            let civM = txt.match(/,\s*(\d+[A-Z]?)/) || txt.match(/\s(\d+[A-Z]?)$/);
            if(civM) {
                document.getElementById('v-civ').innerText = civM[1];
                let parts = txt.split(civM[0]);
                document.getElementById('v-via').innerText = parts[0].trim();
                if(parts[1]) document.getElementById('v-com').innerText = parts[1].trim();
            } else {
                document.getElementById('v-via').innerText = txt;
            }
        }
    </script>
</body>
</html>
