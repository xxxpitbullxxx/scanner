<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; overflow-x: hidden; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); position: relative; overflow-x: hidden; }
        
        /* LOGO GIULIA */
        .logo-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; padding: 25px 0; background: white; }
        .logo-circle {
            width: 200px; height: 200px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden;
            border: 3px solid #d4af37; position: relative;
            padding: 0;
        }
        .logo-img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); position: relative; z-index: 2; }

        /* HEADER LOGO */
        .header-logo-circle { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 2px solid #d4af37; background: white; flex-shrink: 0; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }

        /* SCANNER FULL WIDTH */
        .scan-wrapper-full {
            position: relative;
            width: 100vw; 
            height: 480px; 
            background: #000;
            overflow: hidden;
            left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; 
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* GUIDE VISIVE */
        .guide-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;
        }
        
        .zone-residenza {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            width: 94%; height: 14%; border: 2px solid #FFD60A; border-radius: 4px;
            background: rgba(255, 214, 10, 0.1); z-index: 10;
        }

        .zone-mrz {
            position: absolute; top: 82%; left: 50%; transform: translate(-50%, -50%);
            width: 96%; height: 25%; border: 3px solid #00E0FF; border-radius: 4px;
            background: rgba(0, 224, 255, 0.1); z-index: 10;
        }

        .label-guide { 
            position: absolute; top: -20px; left: 0;
            font-size: 10px; font-weight: 800; padding: 2px 6px; 
            background: rgba(0,0,0,0.7); color: white; border-radius: 4px; 
            text-transform: uppercase; letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .warning-red { color: #ef4444; font-size: 11px; font-weight: 700; line-height: 1.3; margin-top: 5px; text-align: center; border: 1px solid #fee2e2; background: #fef2f2; padding: 8px; border-radius: 8px; }
        .info-blue { color: #1e40af; font-size: 12px; line-height: 1.4; background: #eff6ff; padding: 12px; border-radius: 12px; border: 1px solid #dbeafe; text-align: left; margin-bottom: 20px; }
        .info-success { background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; padding: 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-top: 15px; text-align: center; }

        .input-field { 
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; 
            font-size: 16px; background: #fff; transition: all 0.2s; margin-bottom: 8px; color: #1e293b;
        }
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: none; }
        .btn-primary { background: #0f766e; color: white; }
        .btn-success { background: #10b981; color: white; }
        .flag-btn { font-size: 24px; padding: 4px 6px; opacity: 0.5; transition: 0.2s; cursor: pointer; border: none; background: transparent; filter: grayscale(100%); }
        .flag-btn.active { opacity: 1; transform: scale(1.1); filter: grayscale(0%); }

        .upload-preview { width: 100%; height: 200px; border: 2px dashed #cbd5e1; border-radius: 16px; display: flex; align-items: center; justify-content: center; background: #f8fafc; overflow: hidden; position: relative; margin-bottom: 10px; }
        .upload-preview img { width: 100%; height: 100%; object-fit: contain; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, updateDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", welcome: "https://welcomebooklovenest.netlify.app" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", welcome: "https://welcomebooklatartaruga.netlify.app" },
            "REGINA": { id: "REGINA", name: "Santa Regina", welcome: "" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome: "Ciao! Sono Giulia. Per rendere il tuo arrivo piÃ¹ semplice, ti chiedo di completare il check-in online.", 
                login_ph: "CODICE PRENOTAZIONE", start_btn: "INIZIA IL CHECK-IN", 
                confirm_btn: "CONFERMA E CONTINUA", add_guest: "AGGIUNGI OSPITE", save_guest: "SALVA OSPITE",
                finish_btn: "FINISCI E PROCEDI", verify: "Verifica Dati", front: "Fronte", back_doc: "Retro",
                thanks: "Grazie", success_msg: "Documenti inviati con successo.", exit: "Esci", guest_list: "Ospiti Registrati", cloud_save: "Salvataggio...", 
                ocr_btn: "SCATTA E LEGGI", ocr_processing: "ELABORAZIONE...", ocr_file_btn: "ðŸ“ CARICA FOTO", ocr_success: "Dati rilevati!",
                guest_count_q: "Quanti ospiti siete? (1+ anni)", share_link: "INVIA LINK AGLI ALTRI OSPITI",
                waiting_approval: "Giulia sta verificando i tuoi dati...",
                code_ready_soon: "Il codice apparirÃ  automaticamente appena pronto.",
                welcome_book_btn: "ðŸ“– APRI WELCOME BOOK",
                save_link_msg: "ðŸ’¡ CONSIGLIO: Salva questa pagina! Qui troverai il codice sbloccato appena verificato.",
                label_surname: "Cognome", label_name: "Nome", label_docnum: "N. Documento", label_expiry: "Scadenza"
            },
            en: { 
                welcome: "Hi! I'm Giulia. Please complete online check-in.", 
                login_ph: "BOOKING CODE", start_btn: "START", 
                confirm_btn: "SAVE", add_guest: "ADD GUEST", save_guest: "SAVE GUEST",
                finish_btn: "FINISH", verify: "Verify", front: "Front", back_doc: "Back",
                thanks: "Thanks", success_msg: "Sent!", exit: "Exit", guest_list: "Guests", cloud_save: "Saving...", 
                ocr_btn: "SNAP", ocr_processing: "LOADING...", ocr_file_btn: "ðŸ“ UPLOAD", ocr_success: "Data found!",
                guest_count_q: "How many guests?", share_link: "SEND LINK TO OTHERS",
                waiting_approval: "Giulia is verifying...",
                code_ready_soon: "Code will appear when ready.",
                welcome_book_btn: "ðŸ“– OPEN WELCOME BOOK",
                save_link_msg: "ðŸ’¡ TIP: Save this page!",
                label_surname: "Surname", label_name: "Name", label_docnum: "Doc No", label_expiry: "Expiry"
            },
            fr: { 
                welcome: "Salut ! C'est Giulia.", login_ph: "CODE", start_btn: "DÃ‰BUT", success_msg: "EnvoyÃ© !", 
                waiting_approval: "Giulia vÃ©rifie...", welcome_book_btn: "ðŸ“– WELCOME BOOK", 
                save_link_msg: "ðŸ’¡ CONSEIL : Enregistrez cette page !", exit: "Sortie" 
            },
            es: { 
                welcome: "Â¡Hola! Soy Giulia.", login_ph: "CÃ“DIGO", start_btn: "INICIO", success_msg: "Â¡Enviado!", 
                waiting_approval: "Giulia estÃ¡ verificando...", welcome_book_btn: "ðŸ“– BIENVENIDA", 
                save_link_msg: "ðŸ’¡ CONSEJO: Â¡Guarda esta pÃ¡gina!", exit: "Salir" 
            },
            de: { 
                welcome: "Hallo! Ich bin Giulia.", login_ph: "CODE", start_btn: "START", success_msg: "Gesendet!", 
                waiting_approval: "Giulia prÃ¼ft...", welcome_book_btn: "ðŸ“– WELCOME BOOK", 
                save_link_msg: "ðŸ’¡ TIPP: Seite speichern!", exit: "Beenden" 
            }
        };

        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                check: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>,
                trash: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>,
                camera: <React.Fragment><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3" strokeWidth="2"/></React.Fragment>,
                chevronLeft: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />,
                lock: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />,
                share: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            };
            return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">{icons[name] || icons.camera}</svg>;
        };

        const SignaturePad = ({ canvasRef }) => {
            useEffect(() => {
                const canvas = canvasRef.current; if (!canvas) return;
                const ctx = canvas.getContext('2d'); let isDrawing = false;
                const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000'; };
                resize(); window.addEventListener('resize', resize);
                const getPos = (e) => { const rect = canvas.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; };
                const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
                const draw = (e) => { if (!isDrawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                const stop = () => isDrawing = false;
                canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', stop);
                return () => window.removeEventListener('resize', resize);
            }, []);
            return <canvas ref={canvasRef} className="w-full h-full" />;
        };

        const Header = ({ showBack, setStep, setLang, lang }) => (
            <div className="flex flex-col bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                <div className="flex justify-end p-2 pb-0">
                     <div className="flex space-x-1">
                        {['it','en','fr','es','de'].map(l => (
                             <button key={l} onClick={() => setLang(l)} className={`flag-btn ${lang === l ? 'active' : ''}`}>
                                 {l === 'it' ? 'ðŸ‡®ðŸ‡¹' : l === 'en' ? 'ðŸ‡¬ðŸ‡§' : l === 'fr' ? 'ðŸ‡«ðŸ‡·' : l === 'es' ? 'ðŸ‡ªðŸ‡¸' : 'ðŸ‡©ðŸ‡ª'}
                             </button>
                        ))}
                    </div>
                </div>
                <div className="flex items-center justify-center p-3 pt-0">
                    {showBack && <button onClick={() => setStep('welcome')} className="absolute left-4 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                    <div className="header-logo-circle"><img src="logo.png" /></div>
                    <div className="ml-3 font-bold text-slate-700 text-[14px] uppercase tracking-widest">Tuscan Retreats</div>
                </div>
            </div>
        );

        function App() {
            const [lang, setLang] = useState('it');
            const [step, setStep] = useState('login');
            const [property, setProperty] = useState(null);
            const [bookingId, setBookingId] = useState("");
            const [doorCode, setDoorCode] = useState("WAIT");
            const [guests, setGuests] = useState([]);
            const [expectedGuests, setExpectedGuests] = useState(1);
            const [formData, setFormData] = useState({ surname: "", name: "", sex: "M", birthDate: "", docNumber: "", expiryDate: "" });
            const [adminData, setAdminData] = useState([]);
            const sigCanvasRef = useRef(null);
            const videoRef = useRef(null);
            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;

            useEffect(() => {
                const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                window.db = window.FirebaseSDK.getFirestore(app);
                window.FirebaseSDK.signInAnonymously(window.FirebaseSDK.getAuth(app));

                const params = new URLSearchParams(window.location.search);
                const d = params.get('d');
                if (d) {
                    try {
                        const decoded = JSON.parse(atob(d));
                        if (PROPERTIES[decoded.p]) {
                            setProperty(PROPERTIES[decoded.p]);
                            const sid = `${decoded.p}_${(decoded.n || "Guest").replace(/\s/g, '_')}`;
                            setBookingId(sid); setStep('welcome');
                            window.FirebaseSDK.onSnapshot(window.FirebaseSDK.doc(window.db, 'checkins', sid), (doc) => {
                                if (doc.exists()) setDoorCode(doc.data().doorCode || "WAIT");
                            });
                        }
                    } catch (e) {}
                }
            }, []);

            // --- QUI INSERISCI TUTTI I TUOI PARSER MRZ E FUNZIONI OCR ORIGINALI ---
            const runOCR = async (source) => { /* LOGICA COMPLETA DEL TUO FILE */ };

            const saveToCloud = async () => {
                const sid = bookingId || `B_${Date.now()}`;
                const payload = { guests, propertyId: property.id, expectedGuests, doorCode: "WAIT", timestamp: new Date().toISOString() };
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(window.db, 'checkins', sid), payload);
                setStep('success');
            };

            if (step === 'login') return (
                <div className="app-container p-8 justify-center items-center text-center">
                    <div className="logo-wrapper"><div className="logo-circle"><img src="logo.png" className="logo-img" /></div></div>
                    <input className="input-field text-center font-bold" placeholder={t.login_ph} onKeyDown={e => {
                        if(e.key === 'Enter') {
                            const val = e.target.value.toUpperCase();
                            if(val === 'ADMIN') setStep('admin_pass');
                            else if(PROPERTIES[val]) { setProperty(PROPERTIES[val]); setStep('welcome'); }
                        }
                    }} />
                </div>
            );

            if (step === 'admin_pass') return (
                <div className="app-container p-8 justify-center items-center text-center">
                    <h2 className="text-xl font-bold mb-6 uppercase text-teal-800 tracking-widest text-center">Sblocca</h2>
                    <input type="password" placeholder="Password" className="input-field text-center font-bold" onKeyDown={e => {
                        if(e.key === 'Enter' && e.target.value === 'W0d@w0d@') setStep('admin_panel');
                        else if(e.key === 'Enter') alert('Err');
                    }} />
                    <button onClick={()=>setStep('login')} className="mt-8 text-sm underline opacity-50">Indietro</button>
                </div>
            );

            if (step === 'admin_panel') return (
                <div className="app-container p-6 overflow-y-auto">
                    <h2 className="font-bold text-teal-800 uppercase mb-4 border-b pb-2">Area Proprietario</h2>
                    <button onClick={async () => {
                        const snap = await window.FirebaseSDK.getDocs(window.FirebaseSDK.collection(window.db, 'checkins'));
                        const l = []; snap.forEach(d => l.push({id: d.id, ...d.data()})); setAdminData(l);
                    }} className="btn btn-primary mb-4 text-xs font-bold uppercase">Aggiorna Check-in</button>
                    <div className="space-y-4">
                        {adminData.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(c => (
                            <div key={c.id} className="bg-slate-50 p-4 rounded-xl border">
                                <div className="flex justify-between font-bold text-[10px] mb-2 uppercase text-slate-500">
                                    <span>{c.id}</span>
                                    <span>{c.guests?.length} / {c.expectedGuests}</span>
                                </div>
                                <div className="flex gap-2">
                                    <input id={`c_${c.id}`} className="input-field py-1 mb-0 text-sm" placeholder="Codice Porta" defaultValue={c.doorCode==='WAIT'?'':c.doorCode}/>
                                    <button onClick={() => window.FirebaseSDK.updateDoc(window.FirebaseSDK.doc(window.db, 'checkins', c.id), {doorCode: document.getElementById(`c_${c.id}`).value})} className="btn btn-success p-2 w-24 text-[10px] uppercase font-bold">Salva</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if (step === 'success') return (
                <div className="app-container bg-teal-800 text-white items-center p-10 text-center flex flex-col justify-center min-h-screen">
                    <div className="w-20 h-20 bg-white text-teal-700 rounded-full flex items-center justify-center mb-6 shadow-2xl animate-bounce text-center"><Icon name="check" className="w-10 h-10" /></div>
                    <h1 className="text-2xl font-bold mb-2 uppercase text-center">{t.thanks}, {guests[0]?.name || "Ospite"}!</h1>
                    <div className="bg-white text-slate-900 rounded-3xl p-8 w-full shadow-2xl border mb-6 text-center">
                        {doorCode === "WAIT" ? (
                            <div className="animate-pulse text-center">
                                <div className="p-4 bg-orange-50 rounded-2xl mb-4 text-orange-500 mx-auto w-20"><Icon name="lock" /></div>
                                <p className="text-sm italic mt-2 leading-relaxed">{t.waiting_approval}</p>
                                <p className="text-[9px] font-bold mt-4 text-slate-500 uppercase">{t.code_ready_soon}</p>
                            </div>
                        ) : (
                            <div className="text-center">
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-4">Codice d'Ingresso</p>
                                <div className="text-5xl font-mono font-bold text-slate-800 my-4 tracking-tighter">{doorCode}</div>
                                <p className="text-[10px] text-teal-600 font-bold uppercase mt-4">Sbloccato âœ…</p>
                            </div>
                        )}
                    </div>
                    {PROPERTIES[property.id]?.welcome && (
                        <a href={PROPERTIES[property.id].welcome} target="_blank" className="btn bg-white text-teal-800 w-full mb-4 font-bold shadow-lg flex items-center justify-center gap-2 uppercase text-xs tracking-widest">
                            {t.welcome_book_btn}
                        </a>
                    )}
                    <button onClick={()=>{if(navigator.share)navigator.share({url:window.location.href})}} className="btn bg-teal-900 text-teal-100 font-bold uppercase text-xs mb-6 border border-teal-700 flex gap-2">
                        <Icon name="share" className="w-4 h-4"/> {t.share_link}
                    </button>
                    <div className="p-4 bg-teal-900/40 rounded-xl text-[11px] text-teal-100 border border-teal-700 italic leading-relaxed text-center">
                        {t.save_link_msg}
                    </div>
                </div>
            );

            // --- REINSERISCI QUI TUTTA LA LOGICA DEGLI STEP ORIGINALI (Welcome, Scan, Manual Entry, Sign) ---
            return (
                <div className="app-container">
                    <Header setLang={setLang} lang={lang} />
                    <div className="p-8 text-center flex-1 flex flex-col justify-center">
                        <div className="logo-circle mx-auto mb-6"><img src="foto.jpg" className="logo-img" /></div>
                        <p className="italic text-lg mb-8 text-center">"{t.welcome}"</p>
                        <button onClick={() => setStep('ask_guests')} className="btn btn-primary font-bold shadow-xl">{t.start_btn}</button>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
