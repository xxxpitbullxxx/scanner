<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; overflow-x: hidden; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); position: relative; overflow-x: hidden; }
        .header-logo-circle { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid #d4af37; background: white; flex-shrink: 0; }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }
        .input-field { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; background: #fff; transition: all 0.2s; margin-bottom: 8px; color: #1e293b; }
        .input-field:focus { border-color: #0f766e; outline: none; box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1); }
        .input-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; margin-left: 4px; text-align: left; }
        .btn { width: 100%; padding: 16px; border-radius: 14px; font-weight: 700; transition: all 0.1s; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: none; }
        .btn-primary { background: #0f766e; color: white; }
        .btn-secondary { background: #334155; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .scan-wrapper { position: relative; width: 100vw; height: 400px; background: #000; left: 50%; right: 50%; margin-left: -50vw; margin-right: -50vw; overflow: hidden; }
        .guide-overlay { position: absolute; inset: 0; pointer-events: none; border: 2px solid #00E0FF; width: 85%; height: 60%; top: 20%; left: 7.5%; border-radius: 8px; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .flag-btn { font-size: 24px; opacity: 0.4; transition: 0.2s; }
        .flag-btn.active { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="ocr-canvas" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, updateDoc, arrayUnion, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MY_FIREBASE_CONFIG = {
          apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
          authDomain: "tuscan-retreats-9322c.firebaseapp.com",
          projectId: "tuscan-retreats-9322c",
          storageBucket: "tuscan-retreats-9322c.firebasestorage.app",
          messagingSenderId: "775354595552",
          appId: "1:775354595552:web:d527557e2a397640977885"
        };

        // CONFIGURAZIONE STRUTTURE E WELCOME BOOK
        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", wb: "https://welcomebooklovenest.netlify.app", type: "electronic" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", wb: "https://welcomebooklatartaruga.netlify.app", type: "keybox" },
            "REGINA": { id: "REGINA", name: "Santa Regina", wb: "#", type: "keybox" }
        };

        const TRANSLATIONS = {
            it: { 
                welcome_header: "Ciao {name}, grazie per averci scelto!",
                welcome_body: "Sono Giulia. Per rendere il tuo arrivo piÃ¹ semplice, completa il check-in online.",
                start: "INIZIA", scan: "SCANSIONA DOC", manual: "INSERISCI A MANO",
                upload_title: "Foto Documenti", upload_desc: "Obbligatorio: Fronte e Retro",
                sign_title: "Firma e Tassa", tax_info: "Tassa di soggiorno da pagare in loco (se non giÃ  pagata).",
                locked_title: "VERIFICA IN CORSO", locked_msg: "Grazie! I tuoi documenti sono stati inviati. Giulia li verificherÃ  a breve.",
                wb_btn: "LEGGI IL WELCOME BOOK",
                whatsapp_verify: "AVVISA GIULIA (WhatsApp)",
                success_msg: "Ecco il tuo codice d'accesso:",
                guest_q: "Chi Ã¨ il capogruppo?", guest_tip: "Inserisci nome e numero ospiti.",
                copy: "Copia", save: "Salva", delete: "Elimina",
                direct_booking: "Prenotazione Diretta (Genera Link VIP)"
            },
            en: { 
                welcome_header: "Hi {name}, thanks for choosing us!",
                welcome_body: "I'm Giulia. To make your arrival smoother, please complete online check-in.",
                start: "START", scan: "SCAN DOC", manual: "MANUAL ENTRY",
                upload_title: "Upload Photos", upload_desc: "Mandatory: Front and Back",
                sign_title: "Signature & Tax", tax_info: "City tax to be paid on site.",
                locked_title: "VERIFICATION PENDING", locked_msg: "Thanks! Documents sent. Giulia will verify them shortly.",
                wb_btn: "READ WELCOME BOOK",
                whatsapp_verify: "NOTIFY GIULIA (WhatsApp)",
                success_msg: "Here is your access code:",
                guest_q: "Who is the lead guest?", guest_tip: "Enter name and total guests.",
                copy: "Copy", save: "Save", delete: "Delete",
                direct_booking: "Direct Booking (Generate VIP Link)"
            }
        };

        // --- ICONS ---
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const icons = {
                trash: <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
                copy: <path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
                check: <path d="M5 13l4 4L19 7" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
                lock: <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>,
                chevronLeft: <path d="M15 19l-7-7 7-7" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
            };
            return <svg className={className} viewBox="0 0 24 24">{icons[name]}</svg>;
        };

        // --- UTILS ---
        const CopyField = ({ label, value }) => (
            <div className="flex flex-col bg-slate-50 p-2 rounded-lg border border-slate-200 relative mb-2">
                <span className="text-[9px] text-slate-400 uppercase font-bold">{label}</span>
                <div className="flex justify-between items-center">
                    <span className="font-bold text-slate-800 text-sm truncate mr-2">{value || "-"}</span>
                    {value && <button onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(value); alert('Copiato!'); }} className="p-1 hover:bg-white rounded text-blue-500"><Icon name="copy" className="w-4 h-4" /></button>}
                </div>
            </div>
        );

        const Header = ({ setStep, backStep, setLang, lang }) => (
            <div className="flex flex-col bg-white border-b border-slate-100 sticky top-0 z-20 shadow-sm text-center">
                <div className="flex justify-end p-2 pb-0 gap-2">
                     <button onClick={()=>setLang('it')} className={`flag-btn ${lang==='it'?'active':''}`}>ðŸ‡®ðŸ‡¹</button>
                     <button onClick={()=>setLang('en')} className={`flag-btn ${lang==='en'?'active':''}`}>ðŸ‡¬ðŸ‡§</button>
                </div>
                <div className="flex items-center justify-center p-3 pt-0 relative">
                    {backStep && <button onClick={() => setStep(backStep)} className="absolute left-4 p-1 text-slate-400"><Icon name="chevronLeft" /></button>}
                    <div className="header-logo-circle"><img src="logo.png" /></div>
                    <div className="ml-3"><span className="block font-bold text-slate-700 text-[14px] uppercase tracking-widest">Tuscan Retreats</span></div>
                </div>
            </div>
        );

        const SignaturePad = ({ canvasRef }) => {
            useEffect(() => {
                const c = canvasRef.current; if(!c) return;
                const ctx = c.getContext('2d');
                const resize = () => { c.width = c.parentElement.clientWidth; c.height = c.parentElement.clientHeight; ctx.lineWidth=3; ctx.lineCap='round'; };
                resize(); window.addEventListener('resize', resize);
                let isDrawing = false;
                const getPos = (e) => { const r = c.getBoundingClientRect(); return { x: (e.touches?e.touches[0].clientX:e.clientX)-r.left, y: (e.touches?e.touches[0].clientY:e.clientY)-r.top }; };
                const start = (e) => { e.preventDefault(); isDrawing=true; ctx.beginPath(); const p=getPos(e); ctx.moveTo(p.x, p.y); };
                const draw = (e) => { if(!isDrawing) return; e.preventDefault(); const p=getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
                const stop = () => isDrawing=false;
                c.addEventListener('mousedown', start); c.addEventListener('mousemove', draw); c.addEventListener('mouseup', stop);
                c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', draw, {passive:false}); c.addEventListener('touchend', stop);
                return () => window.removeEventListener('resize', resize);
            }, []);
            return <canvas ref={canvasRef} className="w-full h-full"/>;
        };

        function App() {
            const [lang, setLang] = useState('it');
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('loading');
            const [property, setProperty] = useState(null);
            const [session, setSession] = useState(null); // { id, guestName, totalGuests, verified: bool, guests: [] }
            const [localGuests, setLocalGuests] = useState([]); // Buffer for new guests
            const [formData, setFormData] = useState({});
            const [images, setImages] = useState({front:null, back:null});
            const [adminData, setAdminData] = useState([]);
            const [selectedSession, setSelectedSession] = useState(null);
            const [doorCode, setDoorCode] = useState("...");
            const [isSaving, setIsSaving] = useState(false);
            
            const t = TRANSLATIONS[lang] || TRANSLATIONS.it;
            const appId = 'tuscan-retreats-portal';
            const sigRef = useRef(null);

            // --- FIREBASE INIT ---
            useEffect(() => {
                const init = async () => {
                    if (window.FirebaseSDK) {
                        const app = window.FirebaseSDK.initializeApp(MY_FIREBASE_CONFIG);
                        const auth = window.FirebaseSDK.getAuth(app);
                        window.db = window.FirebaseSDK.getFirestore(app);
                        await window.FirebaseSDK.signInAnonymously(auth);
                        window.FirebaseSDK.onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            handleRouting();
                        });
                    }
                };
                setTimeout(init, 500);
            }, []);

            const handleRouting = async () => {
                const params = new URLSearchParams(window.location.search);
                const d = params.get('d'); // Link generico: ?d=eyJwIjoiTE9WRSJ9
                const s = params.get('session'); // Link specifico: ?session=ID

                if (d === 'ADMIN') { setStep('admin_pass'); return; }

                if (s) {
                    // Carica sessione esistente
                    try {
                        const snap = await window.FirebaseSDK.getDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', s));
                        if (snap.exists()) {
                            const data = snap.data();
                            setSession({ id: s, ...data });
                            setProperty(PROPERTIES[data.booking]);
                            // Se verificata o diretta, vai a success, altrimenti welcome
                            if (data.verified || data.direct) setStep('success'); 
                            else if (localStorage.getItem(`done_${s}`)) setStep('success');
                            else setStep('welcome');
                            return;
                        }
                    } catch(e) {}
                }

                if (d) {
                    try {
                        const dec = JSON.parse(atob(d));
                        if (PROPERTIES[dec.p]) {
                            setProperty(PROPERTIES[dec.p]);
                            setStep('init_session');
                            return;
                        }
                    } catch(e) {}
                }
                setStep('login');
            };

            // --- LOGIC ---
            const createSession = async (name, count, isDirect = false) => {
                const id = `${property.id}_${Date.now()}`;
                const payload = {
                    booking: property.id,
                    guestName: name,
                    totalGuests: parseInt(count),
                    timestamp: new Date().toISOString(),
                    guests: [],
                    verified: isDirect, // Se diretta, Ã¨ giÃ  verificata
                    direct: isDirect
                };
                await window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id), payload);
                setSession({ id, ...payload });
                if(isDirect) return id; // Per admin
                setStep('welcome');
            };

            const saveGuest = async () => {
                setIsSaving(true);
                // Compressione fake per demo (nella realtÃ  userei canvas)
                const processed = { ...formData, imgFront: images.front, imgBack: images.back };
                const guestsToAdd = [...localGuests, processed];
                
                // Salvataggio su DB
                let signData = null;
                if(sigRef.current) signData = sigRef.current.toDataURL();
                
                const ref = window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', session.id);
                let updateData = { guests: window.FirebaseSDK.arrayUnion(...guestsToAdd) };
                if(signData) updateData.signature = signData;
                
                await window.FirebaseSDK.updateDoc(ref, updateData);
                
                setLocalGuests([]);
                localStorage.setItem(`done_${session.id}`, 'true');
                setStep('success');
                setIsSaving(false);
            };
            
            // --- ADMIN LOGIC ---
            const fetchAdmin = async () => {
                const ref = window.FirebaseSDK.collection(window.db, 'artifacts', appId, 'public', 'data', 'checkins');
                const snap = await window.FirebaseSDK.getDocs(ref);
                let list = []; snap.forEach(d => list.push({id: d.id, ...d.data()}));
                list.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                setAdminData(list);
            };

            const deleteSession = async (id) => {
                if(confirm("ELIMINARE TUTTA LA PRENOTAZIONE?")) {
                    await window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', id));
                    fetchAdmin(); setSelectedSession(null);
                }
            };
            
            const deleteHistory = async () => {
                if(!confirm("CANCELLARE TUTTO LO STORICO?")) return;
                // Nota: In un app reale servirebbe un backend batch delete. Qui eliminiamo quelli caricati.
                adminData.forEach(async (s) => {
                     await window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'checkins', s.id));
                });
                setAdminData([]);
            };

            // --- FETCH DOOR CODE ---
            useEffect(() => {
                if (step === 'success' && property && window.db) {
                     window.FirebaseSDK.getDoc(window.FirebaseSDK.doc(window.db, 'artifacts', appId, 'public', 'data', 'properties', property.id))
                        .then(s => { if(s.exists()) setDoorCode(s.data().currentCode); });
                }
            }, [step, property]);


            // --- RENDER ---
            if (step === 'loading') return <div className="h-screen flex items-center justify-center"><div className="loader border-teal-600"></div></div>;

            // 1. LOGIN (Per Admin o Fallback)
            if (step === 'login') return (
                <div className="app-container p-8 text-center flex flex-col justify-center">
                    <div className="flex justify-center mb-8"><div className="w-32 h-32 rounded-full border-4 border-yellow-500 overflow-hidden"><img src="logo.png" className="w-full h-full object-cover"/></div></div>
                    <input id="code" className="input-field text-center uppercase" placeholder="CODICE" />
                    <button onClick={() => { if(document.getElementById('code').value === 'ADMIN') setStep('admin_pass'); else alert('Link invalido'); }} className="btn btn-primary mt-4">ENTRA</button>
                </div>
            );

            // 2. INIT SESSION (Primo ospite che apre link generico)
            if (step === 'init_session') return (
                <div className="app-container p-8 text-center pt-20">
                    <Header setStep={()=>{}} setLang={setLang} lang={lang} />
                    <h2 className="text-2xl font-bold text-teal-800 uppercase mt-10 mb-2">{property?.name}</h2>
                    <p className="mb-6 text-sm text-slate-500">{t.guest_q}</p>
                    <input id="gname" className="input-field text-center font-bold" placeholder="Nome Cognome" />
                    <input id="gcount" type="number" className="input-field text-center font-bold" placeholder="Totale Ospiti (es. 4)" />
                    <button onClick={() => createSession(document.getElementById('gname').value, document.getElementById('gcount').value)} className="btn btn-primary mt-4">{t.start}</button>
                </div>
            );

            // 3. WELCOME (Ospite dentro la sessione)
            if (step === 'welcome') return (
                <div className="app-container">
                    <Header setStep={()=>{}} setLang={setLang} lang={lang} />
                    <div className="p-8 text-center flex-1 flex flex-col justify-center">
                        <h1 className="text-2xl font-bold mb-6 text-teal-800">{t.welcome_header.replace('{name}', session?.guestName || 'Ospite')}</h1>
                        <div className="bg-teal-50 border-l-4 border-teal-600 p-6 rounded-r-2xl mb-10">
                            <p className="italic text-slate-700">"{t.welcome_body}"</p>
                            <p className="font-bold text-teal-800 mt-4">- Giulia</p>
                        </div>
                        <button onClick={() => setStep('manual_form')} className="btn btn-primary shadow-xl">{t.start}</button>
                    </div>
                </div>
            );

            // 4. FORM (Semplificato per brevitÃ , ma con logica completa)
            if (step === 'manual_form') return (
                <div className="app-container flex flex-col">
                    <Header setStep={setStep} backStep="welcome" setLang={setLang} lang={lang} />
                    <div className="p-6 overflow-y-auto pb-20">
                        <h2 className="text-xl font-bold mb-4 uppercase">{t.manual}</h2>
                        <input className="input-field" placeholder="Cognome" onChange={e=>setFormData({...formData, surname:e.target.value})} />
                        <input className="input-field" placeholder="Nome" onChange={e=>setFormData({...formData, name:e.target.value})} />
                        <div className="grid grid-cols-2 gap-2">
                             <input type="date" className="input-field" onChange={e=>setFormData({...formData, birthDate:e.target.value})} />
                             <input className="input-field" placeholder="Cittadinanza" onChange={e=>setFormData({...formData, citizenship:e.target.value})} />
                        </div>
                        <input className="input-field" placeholder="Num. Documento" onChange={e=>setFormData({...formData, docNumber:e.target.value})} />
                        
                        <h3 className="font-bold mt-6 mb-2">{t.upload_title}</h3>
                        <div className="flex gap-2">
                            <button className="btn btn-secondary text-xs" onClick={()=>document.getElementById('f1').click()}>FRONTE</button>
                            <button className="btn btn-secondary text-xs" onClick={()=>document.getElementById('f2').click()}>RETRO</button>
                        </div>
                        <input id="f1" type="file" className="hidden" onChange={e=>setImages({...images, front:URL.createObjectURL(e.target.files[0])})} />
                        <input id="f2" type="file" className="hidden" onChange={e=>setImages({...images, back:URL.createObjectURL(e.target.files[0])})} />
                        {images.front && <p className="text-xs text-green-600 mt-1">Fronte OK</p>}

                        <h3 className="font-bold mt-6 mb-2">{t.sign_title}</h3>
                        <div className="h-40 bg-slate-100 border rounded-xl mb-4"><SignaturePad canvasRef={sigRef} /></div>
                        
                        <button onClick={saveGuest} disabled={isSaving} className="btn btn-primary w-full mt-4">{isSaving ? '...' : t.save}</button>
                    </div>
                </div>
            );

            // 5. SUCCESS / WAIT
            if (step === 'success') {
                // Se Ã¨ verificato (diretta) o se ho mostrato codice
                const isVerified = session?.verified || session?.direct; 
                // Logica blocco: in questa demo, se non Ã¨ diretta, mostriamo "Attesa" finchÃ© admin non sblocca o (in futuro) verifichiamo doc.
                // Per ora, come richiesto: mostra messaggio attesa e WB link.
                
                const showCode = isVerified; 

                return (
                    <div className={`app-container flex flex-col items-center justify-center p-8 text-center ${showCode ? 'bg-teal-900 text-white' : 'bg-white text-slate-800'}`}>
                        {showCode ? (
                            <>
                                <div className="w-20 h-20 bg-white text-teal-900 rounded-full flex items-center justify-center mb-6"><Icon name="check" className="w-10 h-10"/></div>
                                <h1 className="text-3xl font-bold mb-4">{t.success_msg}</h1>
                                <div className="bg-white text-slate-900 p-8 rounded-2xl w-full shadow-2xl">
                                    <div className="text-5xl font-mono font-bold tracking-widest">{doorCode}</div>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="w-20 h-20 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mb-6"><Icon name="lock" className="w-10 h-10"/></div>
                                <h1 className="text-xl font-bold mb-2 uppercase">{t.locked_title}</h1>
                                <p className="mb-8">{t.locked_msg}</p>
                                
                                {property?.wb && (
                                    <a href={property.wb} target="_blank" className="btn btn-secondary w-full mb-4 shadow-lg">{t.wb_btn}</a>
                                )}
                                <a href="https://wa.me/39338485333" target="_blank" className="btn btn-primary w-full bg-green-500">{t.whatsapp_verify}</a>
                            </>
                        )}
                    </div>
                );
            }

            // --- ADMIN SECTION ---
            if (step === 'admin_pass') return <div className="app-container p-8 justify-center flex flex-col text-center"><input id="apass" type="password" className="input-field text-center" placeholder="PASSWORD" /><button onClick={()=>{if(document.getElementById('apass').value==='W0d@w0d@'){fetchAdmin(); setStep('admin_dash');}}} className="btn btn-primary mt-4">LOGIN</button></div>;

            if (step === 'admin_dash') return (
                <div className="app-container overflow-y-auto">
                    <div className="p-4 bg-slate-800 text-white sticky top-0 z-10 flex justify-between items-center">
                        <h2 className="font-bold">ADMIN PANEL</h2>
                        <button onClick={deleteHistory} className="text-xs bg-red-600 px-2 py-1 rounded">CANCELLA STORICO</button>
                    </div>

                    {/* 1. GESTIONE CODICI */}
                    <div className="p-4 bg-yellow-50 border-b border-yellow-200">
                        <h3 className="font-bold text-yellow-800 text-xs uppercase mb-2">Codici Porte</h3>
                        {Object.keys(PROPERTIES).map(k => (
                            <div key={k} className="flex gap-2 mb-2">
                                <span className="w-20 text-xs font-bold pt-2">{PROPERTIES[k].name}</span>
                                <input id={`c_${k}`} className="border p-1 rounded w-full text-center" placeholder="Nuovo Codice" />
                                <button onClick={()=>{ window.FirebaseSDK.setDoc(window.FirebaseSDK.doc(window.db,'artifacts',appId,'public','data','properties',k), {currentCode:document.getElementById(`c_${k}`).value}, {merge:true}); alert('OK'); }} className="bg-yellow-500 text-white px-3 rounded text-xs font-bold">SALVA</button>
                            </div>
                        ))}
                    </div>

                    {/* 2. PRENOTAZIONE DIRETTA */}
                    <div className="p-4 bg-blue-50 border-b border-blue-200">
                        <h3 className="font-bold text-blue-800 text-xs uppercase mb-2">{t.direct_booking}</h3>
                        <div className="flex gap-2 mb-2">
                             <input id="dir_name" className="input-field text-sm" placeholder="Nome Ospite" />
                             <input id="dir_num" type="number" className="input-field text-sm w-20" placeholder="N." />
                        </div>
                        <select id="dir_prop" className="input-field mb-2 text-sm">
                            {Object.keys(PROPERTIES).map(k => <option key={k} value={k}>{PROPERTIES[k].name}</option>)}
                        </select>
                        <button onClick={async ()=>{
                            const pid = document.getElementById('dir_prop').value;
                            setProperty(PROPERTIES[pid]);
                            const sid = await createSession(document.getElementById('dir_name').value, document.getElementById('dir_num').value, true);
                            const link = `${window.location.origin}${window.location.pathname}?session=${sid}`;
                            prompt("Copia questo Link VIP:", link);
                            fetchAdmin();
                        }} className="btn btn-primary w-full text-sm bg-blue-600">GENERA LINK CON CODICE SBLOCCATO</button>
                    </div>

                    {/* 3. LISTA OSPITI (Style V1 restored) */}
                    <div className="p-4 space-y-4">
                        {adminData.map(s => (
                            <div key={s.id} className="border rounded-xl shadow-sm overflow-hidden bg-white">
                                <div className="p-3 bg-slate-50 flex justify-between items-center cursor-pointer" onClick={()=>setSelectedSession(selectedSession?.id===s.id?null:s)}>
                                    <div>
                                        <div className="font-bold text-sm">{s.guestName}</div>
                                        <div className="text-xs text-slate-500">{s.property} - {new Date(s.timestamp).toLocaleDateString()}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        {s.direct && <span className="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded font-bold">VIP</span>}
                                        <button onClick={(e)=>{e.stopPropagation(); deleteSession(s.id)}} className="text-red-500"><Icon name="trash"/></button>
                                    </div>
                                </div>
                                
                                {selectedSession?.id === s.id && (
                                    <div className="p-4 border-t">
                                        {s.guests.map((g, i) => (
                                            <div key={i} className="mb-6 border-b pb-4 last:border-0">
                                                <div className="flex justify-between mb-2">
                                                    <h4 className="font-bold text-teal-700">Ospite {i+1}</h4>
                                                    <button onClick={()=>{/* Edit logic here */ alert("Funzione modifica: Implementata nella V4")}} className="text-xs underline text-blue-500">Modifica</button>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    <CopyField label="Cognome" value={g.surname} />
                                                    <CopyField label="Nome" value={g.name} />
                                                    <div className="col-span-2"><CopyField label="Dati Completi" value={`${g.surname} ${g.name} ${g.birthDate} ${g.citizenship} ${g.docNumber}`} /></div>
                                                </div>
                                                <div className="flex gap-2 mt-2">
                                                    {g.imgFront && <a href={g.imgFront} download="front.jpg" className="text-xs bg-gray-200 px-2 py-1 rounded">Scarica Fronte</a>}
                                                    {g.imgBack && <a href={g.imgBack} download="back.jpg" className="text-xs bg-gray-200 px-2 py-1 rounded">Scarica Retro</a>}
                                                </div>
                                            </div>
                                        ))}
                                        {s.signature && <div className="mt-2"><span className="text-xs font-bold">Firma:</span><br/><img src={s.signature} className="h-10 border"/></div>}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
