<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V39 - Deep Scan</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; background: #000; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Navigazione Superiore */
        .tabs { display: flex; background: #1c1c1e; border-bottom: 1px solid #333; }
        .tab { 
            flex: 1; padding: 15px; text-align: center; color: #666; 
            font-weight: 800; font-size: 12px; cursor: pointer;
        }
        .tab.active { color: #fff; border-bottom: 3px solid #FFD60A; background: #2c2c2e; }

        /* Area Telecamera */
        .cam-container { position: relative; flex: 0 0 35%; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 70%; border: 3px solid #FFD60A; border-radius: 12px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.6);
        }

        /* Pannello Dati Scorrevole */
        .data-panel { 
            flex: 1; background: #121212; display: flex; flex-direction: column; 
            border-top: 1px solid #333; overflow: hidden;
        }

        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; 
            padding-bottom: 100px; /* Spazio per non coprire l'ultimo dato */
        }

        .btn-main { 
            background: #FFD60A; color: #000; width: 90%; padding: 15px; 
            border: none; border-radius: 10px; font-weight: 900; 
            margin: 10px auto; display: block; cursor: pointer;
        }

        .field { 
            background: #1c1c1e; padding: 12px; margin-bottom: 8px; 
            border-radius: 8px; border-left: 4px solid #333;
        }
        .field.ok { border-left-color: #32d74b; background: #1a241a; }
        
        .lbl { font-size: 10px; color: #aaa; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .val { font-size: 15px; color: #fff; font-weight: 600; min-height: 18px; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab">1. RETRO (Completato)</div>
        <div class="tab active">2. FRONTE (Deep Scan)</div>
    </div>

    <div class="cam-container">
        <video id="webcam" autoplay playsinline></video>
        <div class="guide"></div>
    </div>

    <div class="data-panel">
        <button class="btn-main" id="snap">SCANSIONA FRONTE COMPLETO</button>
        
        <div class="scroll-area">
            <div class="field" id="f-nom"><span class="lbl">Cognome e Nome</span><div class="val" id="v-nom">---</div></div>
            <div class="field" id="f-luogo"><span class="lbl">Luogo di Nascita</span><div class="val" id="v-luogo">---</div></div>
            <div class="field" id="f-sex"><span class="lbl">Sesso</span><div class="val" id="v-sex">---</div></div>
            <div class="field" id="f-cit"><span class="lbl">Cittadinanza</span><div class="val" id="v-cit">---</div></div>
            <div class="field" id="f-scad"><span class="lbl">Scadenza</span><div class="val" id="v-scad">---</div></div>
            <div class="field" id="f-res"><span class="lbl">Residenza / Indirizzo</span><div class="val" id="v-res">---</div></div>
            <div class="field" id="f-ente"><span class="lbl">Ente Rilascio</span><div class="val" id="v-ente">---</div></div>
        </div>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const btn = document.getElementById('snap');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } })
            .then(s => video.srcObject = s);

        btn.addEventListener('click', async () => {
            btn.innerText = "ANALISI PROFONDA...";
            const ctx = canvas.getContext('2d');
            
            // Cattura il fronte a risoluzione aumentata
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.filter = 'grayscale(100%) contrast(150%) brightness(110%)';
            ctx.drawImage(video, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    logger: m => console.log(m)
                });
                parseFrontData(text);
                btn.innerText = "SCANSIONA FRONTE COMPLETO";
            } catch (e) { btn.innerText = "ERRORE - RIPROVA"; }
        });

        function parseFrontData(raw) {
            const up = raw.toUpperCase();
            const lines = up.split('\n').map(l => l.trim()).filter(l => l.length > 3);

            // 1. CITTADINANZA
            if (up.includes("ITALIANA")) fill("v-cit", "f-cit", "ITALIANA");

            // 2. SESSO
            if (up.includes(" M ") || up.includes("/M")) fill("v-sex", "f-sex", "M");
            else if (up.includes(" F ") || up.includes("/F")) fill("v-sex", "f-sex", "F");

            // 3. ENTE RILASCIO
            if (up.includes("MINISTERO")) fill("v-ente", "f-ente", "MINISTERO DELL'INTERNO");
            else {
                let comune = lines.find(l => l.includes("COMUNE"));
                if (comune) fill("v-ente", "f-ente", comune);
            }

            // 4. SCADENZA (Cerca formato DD.MM.YYYY o DD/MM/YYYY)
            let scadMatch = up.match(/(\d{2}[\/\.]\d{2}[\/\.]\d{4})/g);
            if (scadMatch) {
                // Prendi la data piÃ¹ lontana nel futuro come scadenza
                fill("v-scad", "f-scad", scadMatch[scadMatch.length - 1]);
            }

            // 5. RESIDENZA (Cerca parole chiave Via, Piazza, ecc.)
            let resLine = lines.find(l => l.includes("VIA ") || l.includes("PIAZZA ") || l.includes("CORSO ") || l.includes("LOC."));
            if (resLine) fill("v-res", "f-res", resLine);

            // 6. LUOGO DI NASCITA
            let luogoLine = lines.find(l => l.includes("NATO A") || l.includes("NATA A"));
            if (luogoLine) {
                fill("v-luogo", "f-luogo", luogoLine.replace("NATO A", "").replace("NATA A", "").trim());
            }
        }

        function fill(valId, fieldId, text) {
            document.getElementById(valId).innerText = text;
            document.getElementById(fieldId).classList.add('ok');
        }
    </script>
</body>
</html>
