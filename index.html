<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner ID V31 - Total Sniper</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; background: #121212; color: white; overflow: hidden; }
        
        .viewport { position: relative; width: 100vw; height: 55vh; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* MIRINO SNIPER: Leggermente più alto per prendere le 3 righe MRZ */
        .sniper-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; height: 30%; /* Altezza aumentata per le 3 righe */
            border: 3px solid #ff3b30; 
            border-radius: 12px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.85);
            z-index: 10;
        }
        /* Linee guida interne per le righe di testo */
        .sniper-grid {
            width: 100%; height: 33%; border-bottom: 1px dashed rgba(255, 59, 48, 0.5);
        }

        .hud-panel { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 45vh; 
            background: #f2f2f7; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; 
            color: #333; overflow-y: auto;
        }

        .btn-fire { 
            background: #ff3b30; color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); margin-bottom: 20px;
        }

        .field-group { margin-bottom: 12px; }
        label { font-size: 10px; font-weight: 900; color: #888; text-transform: uppercase; margin-bottom: 4px; display: block; }
        input { 
            width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; 
            font-size: 16px; font-weight: 600; background: #fff; box-sizing: border-box;
        }
        /* Highlight verde quando il dato è trovato */
        input.found { border-color: #34C759; background-color: #e8fce8; color: #008000; }

        #log { font-size: 11px; color: #aaa; text-align: center; margin-top: 10px; font-family: monospace; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="viewport">
        <video id="video" autoplay playsinline></video>
        <div class="sniper-box">
            <div class="sniper-grid"></div>
            <div class="sniper-grid"></div>
        </div>
    </div>

    <div class="hud-panel">
        <button class="btn-fire" id="scan-btn">SCANSIONA RETRO (MRZ)</button>
        
        <div class="field-group"><label>Cognome</label><input type="text" id="res-cognome"></div>
        <div class="field-group"><label>Nome</label><input type="text" id="res-nome"></div>
        <div class="field-group"><label>N. Documento</label><input type="text" id="res-doc"></div>
        <div class="field-group"><label>Data di Nascita</label><input type="text" id="res-nascita"></div>
        
        <div id="log">Inquadra le 3 righe con "<<" nel rettangolo rosso</div>
    </div>

    <canvas id="proc-canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('proc-canvas');
        const log = document.getElementById('log');
        
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 } } 
        }).then(s => video.srcObject = s);

        document.getElementById('scan-btn').addEventListener('click', async () => {
            log.innerText = "ELABORAZIONE SNIPER...";
            const ctx = canvas.getContext('2d');
            
            // Ritaglio esatto del mirino rosso (30% dell'altezza centrale)
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const cw = vw * 0.90;
            const ch = vh * 0.30;
            const cx = (vw - cw) / 2;
            const cy = (vh - ch) / 2;

            canvas.width = cw;
            canvas.height = ch;

            // Filtro Alto Contrasto per lettura perfetta
            ctx.filter = 'grayscale(100%) contrast(250%)';
            ctx.drawImage(video, cx, cy, cw, ch, 0, 0, cw, ch);

            try {
                // OCR Generico ma limitato a caratteri MRZ
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                    logger: m => log.innerText = `Analisi: ${Math.round(m.progress * 100)}%`
                });

                parseMRZ(text);
                log.innerText = "SCANSIONE COMPLETATA";
            } catch (e) {
                log.innerText = "ERRORE OCR";
            }
        });

        // Funzione Correzione Caratteri (quella che ha funzionato!)
        function fixChar(str, isNum) {
            if (!str) return "";
            if (isNum) {
                return str.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8').replace(/A/g,'4');
            } else {
                return str.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
            }
        }

        function parseMRZ(raw) {
            console.log("RAW:", raw);
            const lines = raw.split('\n').map(l => l.replace(/\s/g, '').toUpperCase()).filter(l => l.length > 5);
            
            // 1. TROVA NUMERO DOCUMENTO (Riga che inizia con C<IT o I<IT o ITA)
            const docLine = lines.find(l => l.includes('IT') && (l.match(/\d/) || l.includes('<')));
            if (docLine) {
                // Cerca pattern 9 chars dopo ITA o C<IT
                let m = docLine.match(/IT([A-Z0-9]{9})/);
                if (m) {
                    let dirtyDoc = m[1];
                    // Applichiamo la logica posizionale LL NNNNN LL
                    let p1 = fixChar(dirtyDoc.substr(0,2), false);
                    let p2 = fixChar(dirtyDoc.substr(2,5), true);
                    let p3 = fixChar(dirtyDoc.substr(7,2), false);
                    let finalDoc = p1 + p2 + p3;
                    
                    document.getElementById('res-doc').value = finalDoc;
                    document.getElementById('res-doc').classList.add('found');
                }
            }

            // 2. TROVA NOME E COGNOME (Riga con <<)
            const nameLine = lines.find(l => l.includes('<<') && !l.includes('IT'));
            if (nameLine) {
                let parts = nameLine.split('<<');
                if (parts.length >= 2) {
                    let surname = parts[0].replace(/</g, '').trim();
                    let name = parts[1].replace(/</g, '').trim();
                    
                    document.getElementById('res-cognome').value = surname;
                    document.getElementById('res-nome').value = name;
                    document.getElementById('res-cognome').classList.add('found');
                    document.getElementById('res-nome').classList.add('found');
                }
            }

            // 3. DATA DI NASCITA (Seconda riga numerica)
            // Solitamente è la riga che inizia con numeri e ha M o F
            const birthLine = lines.find(l => l.match(/^\d/) && (l.includes('M') || l.includes('F')));
            if (birthLine) {
                // Le prime 6 cifre sono la data YYMMDD
                let dob = birthLine.substr(0, 6);
                dob = fixChar(dob, true); // Sicuro numeri
                if (dob.length === 6) {
                    let y = dob.substr(0,2);
                    let m = dob.substr(2,2);
                    let d = dob.substr(4,2);
                    // Indovina secolo (se > 30 è 1900, altrimenti 2000)
                    let fullY = (parseInt(y) > 40) ? '19'+y : '20'+y;
                    document.getElementById('res-nascita').value = `${d}/${m}/${fullY}`;
                    document.getElementById('res-nascita').classList.add('found');
                }
            }
        }
    </script>
</body>
</html>
