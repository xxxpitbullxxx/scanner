<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Scanner ID Pro - Universal</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* Scorrimento forzato e layout semplice */
        html, body { background: #f0f2f5; color: #1c1e21; margin: 0; padding: 0; overflow-y: scroll !important; -webkit-overflow-scrolling: touch; }
        .camera-box { position: relative; width: 100%; height: 320px; background: #000; border-bottom: 3px solid #007AFF; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .reticolo { position: absolute; top: 15%; left: 10%; width: 80%; height: 70%; border: 2px solid #34C759; border-radius: 10px; pointer-events: none; z-index: 5; box-shadow: 0 0 0 2000px rgba(0,0,0,0.4); }
        .content { padding: 20px; }
        .btn-ocr { background: #007AFF; color: white; width: 100%; padding: 18px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; margin-bottom: 20px; cursor: pointer; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #8e8e93; text-transform: uppercase; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        #status-log { text-align: center; color: #007AFF; font-weight: bold; margin-bottom: 10px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="camera-box">
        <video id="video" autoplay playsinline></video>
        <div class="reticolo"></div>
    </div>

    <div class="content">
        <div id="status-log">Inquadra e premi Scansiona</div>
        <button class="btn-ocr" id="scan-btn">SCANSIONA ORA</button>

        <div class="form-group"><label>Cognome</label><input type="text" id="res-cognome"></div>
        <div class="form-group"><label>Nome</label><input type="text" id="res-nome"></div>
        <div class="form-group"><label>Numero Doc</label><input type="text" id="res-doc"></div>
        <div class="form-group"><label>Residenza</label><input type="text" id="res-via"></div>
    </div>

    <canvas id="temp-canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('temp-canvas');
        const status = document.getElementById('status-log');

        // Accesso camera base
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => video.srcObject = s);

        document.getElementById('scan-btn').addEventListener('click', async () => {
            status.innerText = "ANALISI...";
            const ctx = canvas.getContext('2d');
            
            // Definiamo una risoluzione fissa orizzontale
            canvas.width = 1280;
            canvas.height = 720;

            // ROTAZIONE SOFTWARE: Se il video Ã¨ verticale, lo forziamo orizzontale nel canvas
            if (video.videoHeight > video.videoWidth) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(video, -canvas.height / 2, -canvas.width / 2, canvas.height, canvas.width);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            } else {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }

            // Pulizia immagine
            ctx.filter = 'contrast(170%) grayscale(100%)';
            
            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita+eng');
                parse(text);
                status.innerText = "COMPLETATO!";
            } catch (e) { status.innerText = "ERRORE OCR"; }
        });

        function parse(raw) {
            const t = raw.toUpperCase();
            const lines = t.split('\n').map(l => l.trim());
            lines.forEach((l, i) => {
                if (l.includes("COGNOME")) document.getElementById('res-cognome').value = lines[i+1]?.split(' ')[0].replace(/[^A-Z]/g, "") || "";
                if (l.includes("NOME")) document.getElementById('res-nome').value = lines[i+1]?.split(' ')[0].replace(/[^A-Z]/g, "") || "";
            });
            const doc = t.match(/[A-Z]{2}\s?\d{5}[A-Z]{2}/) || t.match(/[A-Z]{2}\s?\d{7}/);
            if (doc) document.getElementById('res-doc').value = doc[0].replace(/\s/g, '');
            const via = t.match(/(VIA|PIAZZA|CORSO|LUNGO).*?\d+/);
            if (via) document.getElementById('res-via').value = via[0];
        }
    </script>
</body>
</html>
