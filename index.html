<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tuscan Retreats - Guest Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; touch-action: manipulation; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); }
        .logo-circle { width: 180px; height: 180px; border-radius: 50%; overflow: hidden; border: 3px solid #d4af37; margin: 0 auto; }
        .logo-img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.1); }
        .scan-box { position: relative; width: 100%; height: 400px; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .guide-mrz { position: absolute; top: 75%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 20%; border: 3px solid #00E0FF; border-radius: 8px; z-index: 10; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); }
        .btn { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; }
        .btn-primary { background: #0f766e; color: white; }
        .input-field { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="ocr-cvs" style="display:none;"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.FB = { initializeApp, getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDocs, getAuth, signInAnonymously };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PROPERTIES = {
            "LOVE": { id: "LOVE", name: "Love Nest", welcome: "https://welcomebooklovenest.netlify.app" },
            "TARTARUGA": { id: "TARTARUGA", name: "La Tartaruga", welcome: "https://welcomebooklatartaruga.netlify.app" }
        };

        function App() {
            const [step, setStep] = useState('login');
            const [prop, setProp] = useState(null);
            const [guestName, setGuestName] = useState("");
            const [doorCode, setDoorCode] = useState("WAIT");
            const [formData, setFormData] = useState({ surname: "", name: "", doc: "" });
            const [loading, setLoading] = useState(false);
            const videoRef = useRef(null);

            useEffect(() => {
                const app = window.FB.initializeApp({
                    apiKey: "AIzaSyAI9ehjq0UAiYu6l_VxXiAZCV12QL0RbDk",
                    authDomain: "tuscan-retreats-9322c.firebaseapp.com",
                    projectId: "tuscan-retreats-9322c"
                });
                window.db = window.FB.getFirestore(app);
                window.FB.signInAnonymously(window.FB.getAuth(app));

                const params = new URLSearchParams(window.location.search);
                const d = params.get('d');
                if (d) {
                    try {
                        const decoded = JSON.parse(atob(d));
                        if (PROPERTIES[decoded.p]) {
                            setProp(PROPERTIES[decoded.p]);
                            setGuestName(decoded.n || "Ospite");
                            setStep('welcome');
                            const sid = `${decoded.p}_${(decoded.n || "Guest").replace(/\s/g, '_')}`;
                            window.FB.onSnapshot(window.FB.doc(window.db, 'checkins', sid), (doc) => {
                                if (doc.exists()) setDoorCode(doc.data().doorCode || "WAIT");
                            });
                        }
                    } catch (e) { console.error("Link Error"); }
                }
            }, []);

            const fix = (s, type) => {
                if(!s) return "";
                return type === 'N' ? s.replace(/O/g,'0').replace(/I/g,'1') : s.replace(/0/g,'O').replace(/1/g,'I');
            };

            const runOCR = async () => {
                setLoading(true);
                const cvs = document.getElementById('ocr-cvs');
                const ctx = cvs.getContext('2d');
                cvs.width = 1280; cvs.height = videoRef.current.videoHeight * (1280/videoRef.current.videoWidth);
                ctx.filter = 'grayscale(100%) contrast(250%)';
                ctx.drawImage(videoRef.current, 0, 0, cvs.width, cvs.height);
                const { data: { text } } = await Tesseract.recognize(cvs, 'eng');
                
                const up = text.toUpperCase().replace(/\s/g, '');
                let p = up.match(/P<([A-Z]{3})([A-Z<]+)/);
                if(p) { // Passport
                    let n = p[2].split('<<');
                    setFormData({ surname: fix(n[0], 'L').replace(/</g,' '), name: fix(n[1], 'L').replace(/</g,' '), doc: up.match(/([A-Z0-9]{9})/)?.[0] || "" });
                }
                setLoading(false); setStep('manual');
            };

            if (step === 'login') return (
                <div className="app-container p-10 flex flex-col justify-center items-center">
                    <div className="logo-circle mb-8"><img src="logo.png" className="logo-img" /></div>
                    <input className="input-field text-center font-bold" placeholder="CODICE" onKeyDown={e => {
                        if(e.key === 'Enter' && e.target.value.toUpperCase() === 'ADMIN') {
                            if(prompt("Pass:") === 'W0d@w0d@') setStep('admin');
                        }
                    }} />
                </div>
            );

            if (step === 'welcome') return (
                <div className="app-container p-10 text-center flex flex-col justify-center">
                    <div className="logo-circle mb-6"><img src="foto.jpg" className="logo-img" /></div>
                    <h2 className="text-xl italic mb-10">"Ciao {guestName}, completa il check-in per ricevere il codice porta."</h2>
                    <button onClick={() => {
                        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                            videoRef.current.srcObject = s; setStep('scan');
                        });
                    }} className="btn btn-primary shadow-xl">INIZIA SCAN DOCUMENTO</button>
                </div>
            );

            if (step === 'scan') return (
                <div className="app-container bg-black">
                    <div className="scan-box"><video ref={videoRef} autoPlay playsinline /><div className="guide-mrz"></div></div>
                    <div className="p-6"><button onClick={runOCR} className="btn btn-primary">{loading ? "ANALISI..." : "SCANSIONA"}</button></div>
                </div>
            );

            if (step === 'manual') return (
                <div className="app-container p-6">
                    <h2 className="font-bold mb-4">VERIFICA DATI</h2>
                    <input className="input-field" value={formData.surname} onChange={e=>setFormData({...formData, surname: e.target.value.toUpperCase()})} placeholder="Cognome" />
                    <input className="input-field" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value.toUpperCase()})} placeholder="Nome" />
                    <input className="input-field" value={formData.doc} onChange={e=>setFormData({...formData, doc: e.target.value.toUpperCase()})} placeholder="N. Documento" />
                    <button onClick={() => {
                        const sid = `${prop.id}_${guestName.replace(/\s/g, '_')}`;
                        window.FB.setDoc(window.FB.doc(window.db, 'checkins', sid), { doorCode: "WAIT", timestamp: new Date().toISOString() });
                        setStep('success');
                    }} className="btn btn-primary mt-4 font-bold">INVIA E FINISCI</button>
                </div>
            );

            if (step === 'success') return (
                <div className="app-container bg-teal-800 text-white p-10 text-center flex flex-col justify-center min-h-screen">
                    <div className="w-20 h-20 bg-white text-teal-700 rounded-full flex items-center justify-center mb-6 mx-auto animate-bounce text-3xl font-bold">âœ“</div>
                    <h1 className="text-2xl font-bold mb-6">GRAZIE, {guestName}!</h1>
                    <div className="bg-white text-slate-900 rounded-3xl p-8 mb-6 shadow-2xl">
                        {doorCode === "WAIT" ? (
                            <div className="animate-pulse text-slate-500 italic">Giulia sta verificando i tuoi dati...<br/><small>Il codice apparirÃ  qui tra poco.</small></div>
                        ) : (
                            <div><p className="text-[10px] text-slate-400 font-bold uppercase mb-2">CODICE PORTA</p><div className="text-5xl font-mono font-bold text-slate-800 tracking-tighter">{doorCode}</div><p className="text-xs text-teal-600 font-bold mt-4">SBLOCCATO âœ…</p></div>
                        )}
                    </div>
                    {prop?.welcome && <a href={prop.welcome} target="_blank" className="btn bg-white text-teal-800 font-bold mb-4">ðŸ“– APRI WELCOME BOOK</a>}
                </div>
            );
            return null;
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
