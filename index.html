<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V68 - Force</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* STRUTTURA BASE */
        body { 
            margin: 0; padding: 0; background: #000; 
            height: 100dvh; /* Si adatta alla barra indirizzi */
            width: 100vw; overflow: hidden; font-family: Arial, sans-serif;
        }

        /* CONTENITORE PRINCIPALE RUOTABILE */
        #app-container {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.3s ease, width 0.3s, height 0.3s;
            transform-origin: center center;
        }

        /* VIDEO */
        video { 
            width: 100%; height: 100%; object-fit: cover; 
        }

        /* GRIGLIA RETTANGOLI (Reference V49 che funzionava) */
        .overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* Rettangolo VERDE (Alto sx - Ente/Comune) */
        .box-green {
            position: absolute; top: 10%; left: 5%; width: 45%; height: 15%;
            border: 3px solid #32d74b; background: rgba(50, 215, 75, 0.1);
            border-radius: 8px;
        }
        .tag-green { background: #32d74b; color: #000; padding: 2px 5px; font-size: 10px; font-weight: bold; position: absolute; top: -15px; left: 0; }

        /* Rettangolo GIALLO (Centro - Dati) */
        .box-yellow {
            position: absolute; top: 30%; left: 5%; width: 90%; height: 25%;
            border: 3px solid #FFD60A; background: rgba(255, 214, 10, 0.1);
            border-radius: 8px;
        }
        .tag-yellow { background: #FFD60A; color: #000; padding: 2px 5px; font-size: 10px; font-weight: bold; position: absolute; top: -15px; left: 0; }

        /* Rettangolo BLU (Basso - MRZ) */
        .box-blue {
            position: absolute; bottom: 5%; left: 5%; width: 90%; height: 30%;
            border: 3px solid #00E0FF; background: rgba(0, 224, 255, 0.1);
            border-radius: 8px;
        }
        .tag-blue { background: #00E0FF; color: #000; padding: 2px 5px; font-size: 10px; font-weight: bold; position: absolute; top: -15px; left: 0; }

        /* CONTROLLI */
        .controls {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 20px; z-index: 50;
        }

        .btn {
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; color: #fff; text-align: center; font-size: 10px;
            box-shadow: 0 0 10px #000;
        }
        .btn-shot { background: rgba(255,0,0,0.5); font-size: 12px; }
        .btn-upload { background: rgba(0,122,255,0.5); }
        .btn-rotate { 
            position: absolute; top: 20px; right: 20px; z-index: 100;
            width: 50px; height: 50px; background: #333; font-size: 24px;
        }

        /* LOADING */
        #loader {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #00E0FF; padding: 20px; z-index: 100;
            border-radius: 10px; font-weight: bold; text-align: center;
        }

        /* RISULTATI */
        #results {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh;
            background: #111; z-index: 200; display: none; overflow-y: auto;
            flex-direction: column; padding: 15px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .full { grid-column: span 2; }
        .field { background: #222; padding: 10px; border-left: 4px solid #00E0FF; border-radius: 5px; }
        .lbl { color: #888; font-size: 9px; display: block; }
        .val { color: #fff; font-size: 14px; font-weight: bold; }
        .btn-close { width: 100%; padding: 15px; margin-top: 20px; background: #444; color: #fff; border: none; font-size: 18px; }

        canvas { display: none; }
        #file-input { display: none; }
    </style>
</head>
<body>

    <button class="btn btn-rotate" onclick="rotateInterface()">↻</button>

    <div id="app-container">
        <video id="webcam" autoplay playsinline muted></video>

        <div class="overlay-layer">
            <div class="box-green"><span class="tag-green">ENTE / COMUNE</span></div>
            <div class="box-yellow"><span class="tag-yellow">INDIRIZZO / DATI</span></div>
            <div class="box-blue"><span class="tag-blue">CODICI MRZ</span></div>
        </div>

        <div class="controls">
            <button class="btn btn-shot" id="snap-btn">SCATTA</button>
            <button class="btn btn-upload" onclick="document.getElementById('file-input').click()">CARICA<br>FOTO</button>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*">
    <canvas id="cvs"></canvas>

    <div id="loader">ELABORAZIONE...<br><small>Non chiudere</small></div>

    <div id="results">
        <h3 style="color:#32d74b; text-align:center; margin:0;">DATI ESTRATTI</h3>
        <div class="grid">
            <div class="field full"><span class="lbl">COGNOME</span><span class="val" id="v-cog">---</span></div>
            <div class="field full"><span class="lbl">NOME</span><span class="val" id="v-nom">---</span></div>
            <div class="field"><span class="lbl">NASCITA</span><span class="val" id="v-dob">---</span></div>
            <div class="field"><span class="lbl">SESSO</span><span class="val" id="v-sex">---</span></div>
            <div class="field full"><span class="lbl">NUMERO DOC</span><span class="val" id="v-doc">---</span></div>
            <div class="field"><span class="lbl">SCADENZA</span><span class="val" id="v-scad">---</span></div>
            <div class="field"><span class="lbl">CITTADINANZA</span><span class="val" id="v-cit">ITA</span></div>
            
            <div class="field full"><span class="lbl">VIA/PIAZZA</span><span class="val" id="addr-via">---</span></div>
            <div class="field"><span class="lbl">CIVICO</span><span class="val" id="addr-civ">---</span></div>
            <div class="field"><span class="lbl">PROVINCIA</span><span class="val" id="addr-prov">---</span></div>
            <div class="field full"><span class="lbl">COMUNE</span><span class="val" id="addr-com">---</span></div>
        </div>
        <button class="btn-close" onclick="location.reload()">CHIUDI</button>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const app = document.getElementById('app-container');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');

        // 1. AVVIO CAMERA (Automatico e Silenzioso)
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
        }).then(stream => video.srcObject = stream)
          .catch(e => alert("Errore fotocamera: " + e.message));

        // 2. LOGICA ROTAZIONE INTERFACCIA
        let rotation = 0;
        function rotateInterface() {
            rotation = (rotation + 90) % 360;
            // Ruotiamo il contenitore
            app.style.transform = `rotate(${rotation}deg)`;
            
            // Adattiamo le dimensioni per non lasciare spazi neri
            if(rotation === 90 || rotation === 270) {
                app.style.width = "100vh";
                app.style.height = "100vw";
                // Centriamo
                app.style.position = "absolute";
                app.style.top = "50%";
                app.style.left = "50%";
                app.style.margin = "-50vw 0 0 -50vh"; // Offset metà larghezza/altezza scambiate
            } else {
                app.style.width = "100%";
                app.style.height = "100%";
                app.style.position = "relative";
                app.style.top = "0";
                app.style.left = "0";
                app.style.margin = "0";
            }
        }

        // 3. GESTIONE SCATTO
        document.getElementById('snap-btn').addEventListener('click', () => processSource(video));
        document.getElementById('file-input').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const img = new Image();
                img.onload = () => processSource(img);
                img.src = URL.createObjectURL(e.target.files[0]);
            }
        });

        async function processSource(source) {
            loader.style.display = 'block';
            
            const ctx = canvas.getContext('2d');
            let w = source.videoWidth || source.width;
            let h = source.videoHeight || source.height;

            // Gestione rotazione canvas per OCR
            if(rotation === 90 || rotation === 270) {
                canvas.width = h; canvas.height = w;
                ctx.translate(h/2, w/2);
                ctx.rotate(rotation * Math.PI / 180);
                ctx.drawImage(source, -w/2, -h/2);
            } else {
                canvas.width = w; canvas.height = h;
                ctx.drawImage(source, 0, 0);
            }

            // Filtro nitidezza
            ctx.filter = 'grayscale(100%) contrast(150%)'; 

            try {
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('ita');
                await worker.initialize('ita');
                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                if(parseData(text)) {
                    loader.style.display = 'none';
                    results.style.display = 'flex';
                } else {
                    alert("Non ho trovato i dati. Prova a ruotare l'immagine con il tasto ↻ o carica un file.");
                    loader.style.display = 'none';
                }
            } catch (e) {
                alert("Errore analisi: " + e.message);
                loader.style.display = 'none';
            }
        }

        function parseData(raw) {
            const clean = raw.toUpperCase().replace(/\s/g, '');
            const lines = raw.toUpperCase().split('\n');
            let found = false;

            // MRZ
            let docM = clean.match(/[CI]<ITA([A-Z0-9]{9})/);
            if(!docM) docM = clean.match(/ITA([A-Z0-9]{9})/);
            let bioM = clean.match(/(\d{6})\d([MF])(\d{6})/);
            let nameM = clean.match(/([A-Z]+)<<([A-Z]+)/);

            if(docM && bioM && nameM) {
                document.getElementById('v-doc').innerText = docM[1];
                document.getElementById('v-cog').innerText = nameM[1];
                document.getElementById('v-nom').innerText = nameM[2].replace(/</g, ' ');

                let d = bioM[1];
                let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
                document.getElementById('v-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                document.getElementById('v-sex').innerText = bioM[2];

                let e = bioM[3];
                let ey = '20'+e.substr(0,2);
                document.getElementById('v-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
                found = true;
            }

            // INDIRIZZO
            let addrLine = lines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE)\s/));
            if(addrLine) {
                let txt = addrLine.replace(/[^A-Z0-9\s,\.\(\)]/g, '').trim();
                
                let provM = txt.match(/\(([A-Z]{2})\)/);
                if(provM) {
                    document.getElementById('addr-prov').innerText = provM[1];
                    txt = txt.replace(provM[0], '');
                }

                let civM = txt.match(/,\s*(\d+[A-Z]?)/) || txt.match(/\s(\d+[A-Z]?)$/);
                if(civM) {
                    document.getElementById('addr-civ').innerText = civM[1];
                    let parts = txt.split(civM[0]);
                    document.getElementById('addr-via').innerText = parts[0].trim();
                    if(parts[1]) document.getElementById('addr-com').innerText = parts[1].trim();
                } else {
                    document.getElementById('addr-via').innerText = txt;
                }
            }

            return found;
        }
    </script>
</body>
</html>
