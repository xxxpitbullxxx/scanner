<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuscan Retreats - Guest Check-in (Local Test)</title>
    
    <!-- 1. Tailwind CSS per lo stile -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Import Map: Solo React e Lucide, NIENTE Firebase per ora -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- 3. Babel: Per far capire il codice React al browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Piccoli aggiustamenti scrollbar */
        .overflow-y-auto::-webkit-scrollbar { width: 8px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #f1f1f1; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- 4. IL TUO CODICE APPLICAZIONE -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, UserCheck, LayoutDashboard, CheckCircle, AlertCircle, 
            ArrowRight, ArrowLeft, Key, Lock, Pencil, ScanLine, Home, 
            BookOpen, Copy, Unlock, Baby, Loader2, Search, MapPin, 
            CreditCard, Globe, ShieldCheck, UserPlus, Trash2, Video, 
            Eye, X, Save, Settings, LogOut, FileText, ScrollText, ExternalLink,
            Share2, Link as LinkIcon, Bomb, CalendarDays, Info, Upload, File, MessageCircle
        } from 'lucide-react';
        
        // --- NIENTE FIREBASE PER ORA (USIAMO LOCALSTORAGE) ---

        // --- COSTANTI APP ---
        const ADMIN_PASSWORD = "123"; 
        const GIULIA_NUMBER = "393384845333";

        const PROPERTIES = {
            'lovenest': {
                id: 'LOVENEST', name: 'Love Nest', logo: 'love.jpg', 
                cir: '052016LTN0141', cin: 'IT052016C2PNDZZE8F',
                accessType: 'Maniglia Elettronica', 
                defaultCode: '5566',
                welcomeBookUrl: 'https://welcomebooklovenest.netlify.app',
                accessInstruction: {
                it: "Digita il codice e premi # (cancelletto) per confermare.",
                en: "Enter code and press # (hash) to confirm.",
                fr: "Entrez le code et appuyez sur # pour confirmer.",
                de: "Code eingeben und # dr√ºcken.",
                es: "Introduce el c√≥digo y pulsa # para confirmar."
                },
                suffix: '#'
            },
            'tartaruga': {
                id: 'TARTARUGA', name: 'La Tartaruga', logo: 'tartaruga.jpg', 
                cir: '052032LTN1161', cin: 'IT052032C2KQXL45JD',
                accessType: 'Keybox', 
                defaultCode: '1234',
                welcomeBookUrl: 'https://welcomebooklatartaruga.netlify.app',
                accessInstruction: {
                it: "Usa il codice per aprire la cassetta di sicurezza.",
                en: "Use code to open the keybox.",
                fr: "Utilisez le code pour ouvrir la bo√Æte √† cl√©s.",
                de: "Code f√ºr die Schl√ºsselbox verwenden.",
                es: "Usa el c√≥digo para abrir la caja de llaves."
                },
                suffix: ''
            }
        };

        const LANGUAGES = [
            { code: 'it', flag: 'üáÆüáπ', label: 'Italiano' },
            { code: 'en', flag: 'üá¨üáß', label: 'English' },
            { code: 'fr', flag: 'üá´üá∑', label: 'Fran√ßais' },
            { code: 'de', flag: 'üá©üá™', label: 'Deutsch' },
            { code: 'es', flag: 'üá™üá∏', label: 'Espa√±ol' }
        ];

        const COMMON_COUNTRIES = [
            "Italia", "Francia", "Germania", "Spagna", "Regno Unito", "USA", "Svizzera", "Paesi Bassi", "Belgio", "Altro"
        ];

        const TRANSLATIONS = {
            it: {
                welcomeTitle: "Benvenuti in Toscana",
                welcomeSubtitle: "Dove ogni soggiorno diventa una storia indimenticabile.",
                giuliaMessage: "Ciao! Sono Giulia. Per rendere il tuo arrivo pi√π semplice, ti chiedo di completare il check-in online.",
                searchLabel: "Hai gi√† un codice gruppo? Cerca qui:",
                searchPlaceholder: "Es: LNS-1234",
                startCheckin: "INIZIA IL CHECK-IN ONLINE",
                adminLogin: "Accesso Riservato",
                passwordPlaceholder: "Inserisci Password",
                login: "Entra",
                wrongPass: "Password errata",
                adminDashboard: "Pannello di Controllo Giulia",
                pendingGuests: "Mancano ospiti",
                viewDocs: "Vedi Dati e Documenti",
                editGuest: "Modifica Dati Completi",
                deleteGuest: "Elimina Ospite",
                deleteAll: "Elimina Gruppo",
                nukeDb: "CANCELLA TUTTO DB",
                confirmNuke: "ATTENZIONE: Stai per cancellare TUTTI i dati. Inserisci password:",
                save: "Salva",
                cancel: "Annulla",
                close: "CHIUDI",
                accessCodeLabel: "Codice Accesso",
                waitingRoom: "Sala d'Attesa",
                yourCode: "Il tuo codice d'ingresso:",
                copy: "COPIA",
                copied: "Copiato!",
                manualCopy: "Copia manualmente:",
                instruction: "Istruzioni:",
                manualEntry: "Inserimento Manuale",
                scan: "Scansione Documento",
                mrzCIE: "Retro C.I. Elettronica", mrzPass: "Fronte Passaporto",
                personalData: "Dati Personali",
                residence: "Residenza",
                privacy: "Privacy & GDPR",
                next: "Avanti",
                submit: "Registra Ospite",
                groupCode: "Codice Gruppo",
                checkStatus: "Cerca",
                docFront: "Fronte", docBack: "Retro", docSelfie: "Selfie/DeVisu", docSign: "Firma",
                rulesTitle: "Regolamento Interno",
                rulesAccept: "Ho compilato e firmato il modulo",
                rulesDesc: "La compilazione √® obbligatoria. Clicca il tasto sopra.",
                rulesOpenExternal: "APRI MODULO REGOLAMENTO",
                shareLink: "Copia Link per Amico",
                continueHere: "Registra Altro Ospite Qui",
                goToWaiting: "Vai alla Sala d'Attesa",
                forceUnlock: "SBLOCCA ORA (Jolly)",
                unlockedMsg: "Gruppo Sbloccato con Successo!",
                statusPartial: "Registrati",
                statusFull: "Completo",
                waitingMsgPartial: "ospiti su",
                waitingMsgTotal: "hanno completato.",
                waitingMsgHidden: "Il codice sar√† visibile quando TUTTI avranno finito.",
                docType: "Tipo Documento", docNum: "Numero", docExp: "Scadenza", docAuth: "Ente Rilascio",
                name: "Nome", surname: "Cognome", birthDate: "Data di Nascita",
                birthPlace: "Luogo di Nascita", birthProv: "Prov.",
                gender: "Sesso", citizen: "Cittadinanza",
                address: "Indirizzo", streetNum: "N. Civico", city: "Citt√†", zip: "CAP", country: "Nazione",
                familyAdvice: "Minore di 14 anni", familyAdviceDesc: "Videochiamata obbligatoria.",
                callGiuliaBtn: "VIDEOCHIAMATA WHATSAPP", callGiuliaDone: "Chiamata Fatta",
                sameResQuestion: "Abiti con il Capogruppo?", sameResYes: "S√¨, stesso indirizzo", sameResNo: "No, diverso",
                guestsLabel: "Ospiti", checkInLabel: "Arrivo", checkOutLabel: "Partenza",
                openWelcomeBook: "APRI WELCOME BOOK",
                uploadMode: "Modalit√† Caricamento", useCamera: "Usa Fotocamera", useFile: "Carica File",
                uploadPdf: "Carica PDF (Unico File)", uploadImg: "Carica Immagini (JPG/PNG)",
                docAuthComune: "Comune", docAuthQuestura: "Questura", docAuthUCO: "U.C.O.", docAuthMCTC: "MCTC (Motorizzazione)", docAuthMAE: "Ministero Affari Esteri",
                expiredCode: "CODICE SCADUTO: Il soggiorno √® terminato.",
                copyGroupCode: "COPIA CODICE GRUPPO",
                copyGroupDesc: "Copia e custodisci questo codice: serve per far accedere gli altri ospiti o rientrare qui.",
                notifyGiulia: "AVVISA GIULIA (OBBLIGATORIO)",
                notifyGiuliaDesc: "Clicca per inviare la conferma a Giulia e sbloccare i tasti successivi.",
                notifyMsgStart: "Ciao Giulia, sono",
                notifyMsgEnd: "ho fatto il check-in.",
                notifyMsgMissing: "Mancano",
                notifyMsgOf: "di",
                notifyMsgFor: "per avere il codice"
            },
            en: {
                welcomeTitle: "Welcome to Tuscany",
                welcomeSubtitle: "Where every stay becomes an unforgettable story.",
                giuliaMessage: "Hi! I'm Giulia. To make your arrival easier, please complete the online check-in.",
                searchLabel: "Already have a group code? Search here:",
                searchPlaceholder: "Ex: LNS-1234",
                startCheckin: "START ONLINE CHECK-IN",
                adminLogin: "Restricted Access",
                passwordPlaceholder: "Enter Password",
                login: "Login",
                wrongPass: "Wrong password",
                adminDashboard: "Giulia's Control Panel",
                pendingGuests: "Missing guests",
                viewDocs: "View Data & Docs",
                editGuest: "Edit Full Data",
                deleteGuest: "Delete Guest",
                deleteAll: "Delete Group",
                nukeDb: "DELETE ALL DB",
                confirmNuke: "WARNING: Deleting ALL data. Password:",
                save: "Save",
                cancel: "Cancel",
                close: "CLOSE",
                accessCodeLabel: "Access Code",
                waitingRoom: "Waiting Room",
                yourCode: "Your Entry Code:",
                copy: "COPY",
                copied: "Copied!",
                manualCopy: "Copy manually:",
                instruction: "Instructions:",
                manualEntry: "Manual Entry",
                scan: "Document Scan",
                mrzCIE: "Back of ID Card", mrzPass: "Passport Photo Page",
                personalData: "Personal Data",
                residence: "Residence",
                privacy: "Privacy & GDPR",
                next: "Next",
                submit: "Register Guest",
                groupCode: "Group Code",
                checkStatus: "Search",
                docFront: "Front", docBack: "Back", docSelfie: "Selfie", docSign: "Signature",
                rulesTitle: "House Rules",
                rulesAccept: "I have filled and signed the form",
                rulesDesc: "Mandatory. Click the button above.",
                rulesOpenExternal: "OPEN RULES FORM",
                shareLink: "Copy Link for Friend",
                continueHere: "Register Next Guest",
                goToWaiting: "Go to Waiting Room",
                forceUnlock: "FORCE UNLOCK",
                unlockedMsg: "Group Unlocked Successfully!",
                statusPartial: "Registration Complete",
                statusFull: "Complete",
                waitingMsgPartial: "guests out of",
                waitingMsgTotal: "completed.",
                waitingMsgHidden: "Code appears when EVERYONE is done.",
                docType: "Doc Type", docNum: "Number", docExp: "Expiry", docAuth: "Authority",
                name: "Name", surname: "Surname", birthDate: "Date of Birth",
                birthPlace: "Place of Birth", birthProv: "Prov.",
                gender: "Gender", citizen: "Citizenship",
                address: "Address", streetNum: "No.", city: "City", zip: "ZIP", country: "Country",
                familyAdvice: "Under 14", familyAdviceDesc: "Video call mandatory.",
                callGiuliaBtn: "WHATSAPP VIDEO CALL", callGiuliaDone: "Call Done",
                sameResQuestion: "Living with Leader?", sameResYes: "Yes", sameResNo: "No",
                guestsLabel: "Guests", checkInLabel: "Check-in", checkOutLabel: "Check-out",
                openWelcomeBook: "OPEN WELCOME BOOK",
                uploadMode: "Upload Mode", useCamera: "Use Camera", useFile: "Upload File",
                uploadPdf: "Upload PDF", uploadImg: "Upload Images",
                docAuthComune: "Municipality", docAuthQuestura: "Police HQ", docAuthUCO: "U.C.O.", docAuthMCTC: "DMV", docAuthMAE: "Foreign Ministry",
                expiredCode: "CODE EXPIRED: Stay ended.",
                copyGroupCode: "COPY GROUP CODE",
                copyGroupDesc: "Copy and keep this code safe: needed for other guests or to return here.",
                notifyGiulia: "NOTIFY GIULIA (MANDATORY)",
                notifyGiuliaDesc: "Click to send confirmation to Giulia and unlock next steps.",
                notifyMsgStart: "Hi Giulia, I am",
                notifyMsgEnd: "I have checked in.",
                notifyMsgMissing: "Missing",
                notifyMsgOf: "of",
                notifyMsgFor: "to get the code"
            },
            fr: { 
                welcomeTitle: "Bienvenue en Toscane",
                welcomeSubtitle: "O√π chaque s√©jour devient une histoire inoubliable.",
                giuliaMessage: "Salut! Je suis Giulia. Pour faciliter votre arriv√©e, veuillez compl√©ter l'enregistrement en ligne.",
                startCheckin: "COMMENCER L'ENREGISTREMENT", rulesOpenExternal: "OUVRIR FORMULAIRE", searchLabel: "Code groupe?",
                waitingRoom: "Salle d'Attente", yourCode: "Votre Code:", copy: "COPIER", instruction: "Instructions:",
                waitingMsgPartial: "invit√©s sur", waitingMsgTotal: "ont termin√©.", waitingMsgHidden: "Code visible √† la fin.",
                familyAdvice: "Moins de 14 ans", familyAdviceDesc: "Appel vid√©o obligatoire.", callGiuliaBtn: "APPEL VID√âO WHATSAPP",
                callGiuliaDone: "Fait", personalData: "Donn√©es Personnelles", residence: "R√©sidence",
                sameResQuestion: "M√™me adresse?", sameResYes: "Oui", sameResNo: "Non",
                docFront: "Recto", docBack: "Verso", docSelfie: "Selfie", submit: "Enregistrer",
                rulesTitle: "R√®glement", rulesAccept: "Formulaire rempli", rulesDesc: "Obligatoire.",
                uploadMode: "Mode", useCamera: "Cam√©ra", useFile: "Fichier", guestsLabel: "Invit√©s", checkInLabel: "Arriv√©e", checkOutLabel: "D√©part",
                searchPlaceholder: "Ex: LNS-1234", save: "Sauver", cancel: "Annuler", close: "FERMER",
                editGuest: "Modifier", expiredCode: "CODE EXPIR√â", copyGroupCode: "COPIER CODE GROUPE",
                copyGroupDesc: "Copiez et conservez ce code pour revenir.",
                notifyGiulia: "AVERTIR GIULIA (OBLIGATOIRE)", notifyMsgStart: "Salut Giulia, je suis", notifyGiuliaDesc: "Cliquez pour confirmer."
            },
            de: { 
                welcomeTitle: "Willkommen in der Toskana",
                welcomeSubtitle: "Wo jeder Aufenthalt zu einer unvergesslichen Geschichte wird.",
                giuliaMessage: "Hallo! Ich bin Giulia. Um Ihre Ankunft zu erleichtern, bitte ich Sie, den Online-Check-in abzuschlie√üen.",
                startCheckin: "CHECK-IN STARTEN", rulesOpenExternal: "FORMULAR √ñFFNEN", searchLabel: "Gruppencode?",
                waitingRoom: "Warteraum", yourCode: "Ihr Code:", copy: "KOPIEREN", instruction: "Anweisungen:",
                waitingMsgPartial: "G√§ste von", waitingMsgTotal: "fertig.", waitingMsgHidden: "Code erscheint am Ende.",
                familyAdvice: "Unter 14", familyAdviceDesc: "Videoanruf erforderlich.", callGiuliaBtn: "WHATSAPP VIDEOANRUF",
                callGiuliaDone: "Erledigt", personalData: "Pers√∂nliche Daten", residence: "Wohnsitz",
                sameResQuestion: "Gleiche Adresse?", sameResYes: "Ja", sameResNo: "Nein",
                docFront: "Vorderseite", docBack: "R√ºckseite", docSelfie: "Selfie", submit: "Registrieren",
                rulesTitle: "Hausordnung", rulesAccept: "Formular ausgef√ºllt", rulesDesc: "Pflicht.",
                uploadMode: "Modus", useCamera: "Kamera", useFile: "Datei", guestsLabel: "G√§ste", checkInLabel: "Anreise", checkOutLabel: "Abreise",
                searchPlaceholder: "Bsp: LNS-1234", save: "Speichern", cancel: "Abbrechen", close: "SCHLIESSEN",
                editGuest: "Bearbeiten", expiredCode: "CODE ABGELAUFEN", copyGroupCode: "GRUPPENCODE KOPIEREN",
                copyGroupDesc: "Kopieren und aufbewahren.",
                notifyGiulia: "GIULIA BENACHRICHTIGEN (PFLICHT)", notifyMsgStart: "Hallo Giulia, ich bin", notifyGiuliaDesc: "Klicken zum Best√§tigen."
            },
            es: { 
                welcomeTitle: "Bienvenido a la Toscana",
                welcomeSubtitle: "Donde cada estancia se convierte en una historia inolvidable.",
                giuliaMessage: "¬°Hola! Soy Giulia. Para facilitar tu llegada, te pido que completes el registro en l√≠nea.",
                startCheckin: "INICIAR REGISTRO", rulesOpenExternal: "ABRIR FORMULARIO", searchLabel: "¬øC√≥digo de grupo?",
                waitingRoom: "Sala de Espera", yourCode: "Tu C√≥digo:", copy: "COPIAR", instruction: "Instrucciones:",
                waitingMsgPartial: "hu√©spedes de", waitingMsgTotal: "completados.", waitingMsgHidden: "C√≥digo visible al final.",
                familyAdvice: "Menor de 14", familyAdviceDesc: "Videollamada obligatoria.", callGiuliaBtn: "VIDEOLLAMADA WHATSAPP",
                callGiuliaDone: "Hecho", personalData: "Datos Personales", residence: "Residencia",
                sameResQuestion: "¬øMisma direcci√≥n?", sameResYes: "S√≠", sameResNo: "No",
                docFront: "Frente", docBack: "Dorso", docSelfie: "Selfie", submit: "Registrar",
                rulesTitle: "Normas", rulesAccept: "Formulario completado", rulesDesc: "Obligatorio.",
                uploadMode: "Modo", useCamera: "C√°mara", useFile: "Archivo", guestsLabel: "Hu√©spedes", checkInLabel: "Llegada", checkOutLabel: "Salida",
                searchPlaceholder: "Ej: LNS-1234", save: "Guardar", cancel: "Cancelar", close: "CERRAR",
                editGuest: "Editar", expiredCode: "C√ìDIGO EXPIRADO", copyGroupCode: "COPIAR C√ìDIGO GRUPO",
                copyGroupDesc: "Copia y guarda este c√≥digo.",
                notifyGiulia: "AVISAR A GIULIA (OBLIGATORIO)", notifyMsgStart: "Hola Giulia, soy", notifyGiuliaDesc: "Clic para confirmar."
            }
        };

        const legacyCopy = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); return true; } catch (err) { return false; } finally { document.body.removeChild(textArea); }
        };

        const formatDateIT = (dateString) => {
            if (!dateString) return "";
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        const calculateAge = (birthDate) => {
            if(!birthDate) return 100;
            const diff = Date.now() - new Date(birthDate).getTime();
            return Math.abs(new Date(diff).getUTCFullYear() - 1970);
        };

        const INITIAL_FORM = {
            nome: '', cognome: '', dataNascita: '', luogoNascita: '', provinciaNascita: '',
            sesso: 'M', cittadinanza: 'Italia',
            tipoDocumento: 'C.I. Elettronica', numeroDocumento: '', scadenzaDocumento: '', enteRilascio: '',
            address: '', civico: '', city: '', zip: '', country: '',
            imgFront: null, imgBack: null, imgPdf: null, selfie: null, signature: null, privacy: false,
            videoCallDone: false, rulesAccepted: false, uploadMethod: 'camera'
        };

        // --- COMPONENTI ---

        const DocModal = ({ guest, onClose, t }) => {
            if (!guest) return null;
            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 overflow-y-auto">
                <div className="bg-white rounded-3xl w-full max-w-4xl p-6 relative flex flex-col max-h-[90vh]">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 className="text-2xl font-black uppercase text-slate-800">{guest.nome} {guest.cognome}</h3>
                    <button onClick={onClose} className="px-6 py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-black uppercase flex items-center gap-2 transition-colors shadow-lg active:scale-95">
                        <X size={24}/> {t.close}
                    </button>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                    <div className="mb-8 bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <h4 className="text-lg font-black text-indigo-600 uppercase mb-4 flex items-center gap-2"><FileText size={20}/> Dati Anagrafici</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Nato/a il</span> {formatDateIT(guest.dataNascita)}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">A</span> {guest.luogoNascita} ({guest.provinciaNascita})</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Sesso/Cittadinanza</span> {guest.sesso} - {guest.cittadinanza}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Documento</span> {guest.tipoDocumento}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Numero</span> {guest.numeroDocumento}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Scadenza</span> {formatDateIT(guest.scadenzaDocumento)}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Ente Rilascio</span> {guest.enteRilascio}</div>
                        <div className="bg-white p-3 rounded-xl border border-slate-100"><span className="block font-bold text-slate-400 text-xs">Residenza</span> {guest.address} {guest.civico}, {guest.city} ({guest.country})</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-2">
                        <p className="font-bold text-slate-500 uppercase text-xs">Documento</p>
                        <div className="aspect-video bg-slate-100 rounded-xl border-2 border-dashed flex items-center justify-center relative overflow-hidden">
                            {guest.imgPdf ? <div className="text-blue-600 font-bold">PDF Unico Caricato</div> : (
                            guest.imgFront ? <div className="text-green-600 font-bold">Fronte + Retro Caricati</div> : <span className="text-red-400">Mancante</span>
                            )}
                        </div>
                        </div>
                        <div className="space-y-2">
                        <p className="font-bold text-slate-500 uppercase text-xs">{t.docSelfie}</p>
                        <div className="aspect-square bg-slate-100 rounded-xl border-2 border-dashed flex items-center justify-center">
                            {guest.selfie ? <div className="bg-green-100 text-green-700 font-bold px-4 py-2 rounded-lg">Selfie OK</div> : (guest.videoCallDone ? <span className="text-orange-500 font-bold">Videochiamata</span> : <span className="text-red-400">Mancante</span>)}
                        </div>
                        </div>
                        <div className="space-y-2">
                        <p className="font-bold text-slate-500 uppercase text-xs">{t.docSign}</p>
                        {guest.signature ? <img src={guest.signature} alt="Firma" className="w-full h-32 object-contain bg-slate-50 rounded-xl border" /> : <span className="text-red-400">Mancante</span>}
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const EditModal = ({ guest, onClose, onSave, t }) => {
            const [data, setData] = useState({...guest});
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
                    <h3 className="text-2xl font-black mb-6 uppercase">Modifica Dati Completi</h3>
                    <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Nome</label><input className="w-full p-3 border rounded-xl" value={data.nome} onChange={e=>setData({...data, nome: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Cognome</label><input className="w-full p-3 border rounded-xl" value={data.cognome} onChange={e=>setData({...data, cognome: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Data Nascita</label><input className="w-full p-3 border rounded-xl" type="date" value={data.dataNascita} onChange={e=>setData({...data, dataNascita: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Luogo Nascita</label><input className="w-full p-3 border rounded-xl" value={data.luogoNascita} onChange={e=>setData({...data, luogoNascita: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Provincia</label><input className="w-full p-3 border rounded-xl" value={data.provinciaNascita} onChange={e=>setData({...data, provinciaNascita: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Sesso</label><input className="w-full p-3 border rounded-xl" value={data.sesso} onChange={e=>setData({...data, sesso: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Cittadinanza</label><input className="w-full p-3 border rounded-xl" value={data.cittadinanza} onChange={e=>setData({...data, cittadinanza: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Tipo Doc</label><input className="w-full p-3 border rounded-xl" value={data.tipoDocumento} onChange={e=>setData({...data, tipoDocumento: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Numero Doc</label><input className="w-full p-3 border rounded-xl" value={data.numeroDocumento} onChange={e=>setData({...data, numeroDocumento: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Scadenza</label><input className="w-full p-3 border rounded-xl" type="date" value={data.scadenzaDocumento} onChange={e=>setData({...data, scadenzaDocumento: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Ente Rilascio</label><input className="w-full p-3 border rounded-xl" value={data.enteRilascio} onChange={e=>setData({...data, enteRilascio: e.target.value})}/></div>
                    <div className="space-y-1 col-span-2"><label className="text-xs font-bold text-slate-400">Indirizzo Completo</label><input className="w-full p-3 border rounded-xl" value={data.address} onChange={e=>setData({...data, address: e.target.value})}/></div>
                    <div className="space-y-1"><label className="text-xs font-bold text-slate-400">Civico</label><input className="w-full p-3 border rounded-xl" value={data.civico} onChange={e=>setData({...data, civico: e.target.value})}/></div>
                    </div>
                    <div className="flex gap-4">
                    <button onClick={() => onSave(guest.id, data)} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">{t.save}</button>
                    <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">{t.cancel}</button>
                    </div>
                </div>
                </div>
            );
        };

        const SignaturePad = ({ onSave, onClear }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const getPos = (e) => { const rect = canvasRef.current.getBoundingClientRect(); return { x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left, y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top }; };
            const draw = (e) => { if (!isDrawing) return; const { x, y } = getPos(e); const ctx = canvasRef.current.getContext('2d'); ctx.lineTo(x, y); ctx.stroke(); };
            return (
                <div className="border-2 border-slate-200 rounded-2xl p-4 bg-white touch-none">
                <div className="flex justify-between mb-2"><span className="text-xs font-bold uppercase text-slate-500">Firma Qui</span><button onClick={() => { canvasRef.current.getContext('2d').clearRect(0,0,300,150); onClear(); }} className="text-xs text-red-500 font-bold uppercase">Cancella</button></div>
                <canvas ref={canvasRef} width={300} height={150} className="w-full bg-slate-50 rounded-xl" onMouseDown={e => { setIsDrawing(true); const {x,y}=getPos(e); const ctx=canvasRef.current.getContext('2d'); ctx.beginPath(); ctx.moveTo(x,y); }} onMouseUp={() => { setIsDrawing(false); onSave(canvasRef.current.toDataURL()); }} onMouseMove={draw} onTouchStart={e => { setIsDrawing(true); const {x,y}=getPos(e); const ctx=canvasRef.current.getContext('2d'); ctx.beginPath(); ctx.moveTo(x,y); }} onTouchEnd={() => { setIsDrawing(false); onSave(canvasRef.current.toDataURL()); }} onTouchMove={draw} />
                </div>
            );
        };

        const App = () => {
            const [lang, setLang] = useState('it');
            const [view, setView] = useState('landing');
            const [user, setUser] = useState(null);
            const [adminAuth, setAdminAuth] = useState(false);
            const [adminPassInput, setAdminPassInput] = useState("");
            const [waClicked, setWaClicked] = useState(false);
            
            const t = { ...TRANSLATIONS.it, ...(TRANSLATIONS[lang] || {}) };

            // --- LOCAL STORAGE INIT (MOCK DATABASE) ---
            const [allGuests, setAllGuests] = useState(() => JSON.parse(localStorage.getItem('tuscan_guests') || '[]'));
            
            useEffect(() => {
                localStorage.setItem('tuscan_guests', JSON.stringify(allGuests));
            }, [allGuests]);

            // --- GLOBAL STATE ---
            const [groupId, setGroupId] = useState("");
            const [selectedProperty, setSelectedProperty] = useState('lovenest');
            const [stayDates, setStayDates] = useState({ checkIn: '', checkOut: '' });
            const [guestCount, setGuestCount] = useState(1);
            const [currentGuestIndex, setCurrentGuestIndex] = useState(1);
            const [headOfGroupAddress, setHeadOfGroupAddress] = useState(null);
            const [editingCode, setEditingCode] = useState("");
            
            const [viewingDocGuest, setViewingDocGuest] = useState(null);
            const [editingGuest, setEditingGuest] = useState(null);
            const [formData, setFormData] = useState({...INITIAL_FORM});
            const [isScanning, setIsScanning] = useState(false);
            const [copyFeedback, setCopyFeedback] = useState("");

            const groupGuests = allGuests.filter(g => g.groupId === groupId);
            const isJollyActive = groupGuests.some(g => g.accessAuthorized === true);
            const isCompleted = groupGuests.length > 0 && groupGuests.every(g => g.approved) && groupGuests.length >= (groupGuests[0]?.totalGuests || 1);
            const isGroupUnlocked = isJollyActive || isCompleted;
            const accessCode = groupGuests[0]?.accessCode || PROPERTIES[selectedProperty].defaultCode;

            // --- ACTIONS ---

            const handleCopy = (text) => {
                const success = legacyCopy(text);
                if (success) { setCopyFeedback(t.copied); setTimeout(() => setCopyFeedback(""), 2000); } 
                else { alert(t.manualCopy + " " + text); }
            };

            const handleAdminLogin = () => {
                if (adminPassInput === ADMIN_PASSWORD) { setAdminAuth(true); setView('admin_dashboard'); } 
                else { alert(t.wrongPass); }
            };

            const handleNukeDb = () => {
                const pass = prompt(t.confirmNuke);
                if (pass === ADMIN_PASSWORD) {
                    localStorage.removeItem('tuscan_guests');
                    setAllGuests([]);
                    alert("Database Cancellato / Database Deleted");
                    window.location.reload(); 
                } else { alert(t.wrongPass); }
            };

            const handleDelete = (id, isGroup = false) => {
                const pass = prompt("Password:");
                if (pass === ADMIN_PASSWORD) {
                    if (isGroup) {
                        setAllGuests(prev => prev.filter(g => g.groupId !== id));
                    } else {
                        setAllGuests(prev => prev.filter(g => g.id !== id));
                    }
                    window.location.reload();
                } else { alert(t.wrongPass); }
            };

            const handleForceUnlock = (gId) => {
                setAllGuests(prev => prev.map(g => g.groupId === gId ? { ...g, accessAuthorized: true } : g));
                alert(t.unlockedMsg);
            };

            const handleEditSave = (id, newData) => {
                setAllGuests(prev => prev.map(g => g.id === id ? { ...g, ...newData } : g));
                setEditingGuest(null);
            };

            const startCheckin = () => {
                const prefix = selectedProperty === 'lovenest' ? 'LNS-' : 'TRT-';
                const newId = prefix + Math.floor(1000 + Math.random() * 9000);
                setGroupId(newId);
                setFormData({...INITIAL_FORM});
                setCurrentGuestIndex(1);
                setHeadOfGroupAddress(null);
                setWaClicked(false);
                setView('form');
            };

            const checkStatus = (code) => {
                if (!code) return;
                const cleanCode = code.trim().toUpperCase();
                setGroupId(cleanCode);
                setFormData({...INITIAL_FORM});
                setWaClicked(false);

                const existing = allGuests.filter(g => g.groupId === cleanCode);
                
                if (existing.length > 0) {
                    setSelectedProperty(existing[0].property);
                    setGuestCount(existing[0].totalGuests);
                    
                    const isForceUnlocked = existing.some(g => g.accessAuthorized === true);
                    const isComplete = existing.every(g => g.approved) && existing.length >= existing[0].totalGuests;
                    
                    const checkOutDate = new Date(existing[0].checkOut);
                    const today = new Date();
                    if (today > checkOutDate) { alert(t.expiredCode); return; }

                    if (isForceUnlocked || isComplete) { setView('waiting'); } 
                    else if (existing.length < existing[0].totalGuests) {
                        setCurrentGuestIndex(existing.length + 1);
                        if (existing.length > 0) {
                           setHeadOfGroupAddress({ 
                             address: existing[0].address, civico: existing[0].civico, city: existing[0].city, zip: existing[0].zip, country: existing[0].country
                           });
                        }
                        setView('form');
                    } else { setView('waiting'); }
                } else { alert("Codice non trovato / Code not found"); }
            };

            const handleScan = (type) => {
                setIsScanning(true);
                setTimeout(() => {
                    setFormData(prev => ({ ...prev, nome: "MARIO", cognome: "ROSSI", dataNascita: "1980-01-01", luogoNascita: "ROMA", provinciaNascita: "RM", sesso: "M", cittadinanza: "ITALIA", tipoDocumento: type === 'CIE' ? 'C.I. Elettronica' : 'Passaporto', numeroDocumento: "CA12345AA" }));
                    setIsScanning(false);
                }, 1500);
            };

            const saveCurrentGuest = () => {
                if (currentGuestIndex === 1) setHeadOfGroupAddress({ address: formData.address, civico: formData.civico, city: formData.city, zip: formData.zip, country: formData.country });
                
                const newGuest = {
                    ...formData,
                    id: Date.now().toString(),
                    groupId, property: selectedProperty, checkIn: stayDates.checkIn, checkOut: stayDates.checkOut,
                    guestIndex: currentGuestIndex, totalGuests: guestCount, approved: false, accessAuthorized: false,
                    createdAt: new Date().toISOString(), accessCode: null 
                };
                
                setAllGuests(prev => [...prev, newGuest]);
                setWaClicked(false);
                setView('share_interstitial');
            };
            
            const updateCode = (gId, newCode) => {
                 setAllGuests(prev => prev.map(g => g.groupId === gId ? { ...g, accessCode: newCode } : g));
            };

            const approveGuest = (id, currentStatus) => {
                 setAllGuests(prev => prev.map(g => g.id === id ? { ...g, approved: !currentStatus } : g));
            };

            const getWhatsAppLink = () => {
                const total = guestCount;
                const missing = total - currentGuestIndex;
                const accessType = PROPERTIES[selectedProperty].accessType;
                const msg = `${t.notifyMsgStart} ${formData.nome} ${formData.cognome}, ${t.notifyMsgEnd} ${t.notifyMsgMissing} ${missing} ${t.notifyMsgOf} ${total} ${t.notifyMsgFor} ${accessType}.`;
                return `https://wa.me/${GIULIA_NUMBER}?text=${encodeURIComponent(msg)}`;
            };

            // --- UI ---
            if (view === 'landing') return (
                <div className="min-h-screen bg-slate-50 flex flex-col relative overflow-hidden">
                <div className="w-full flex justify-between items-center p-6 z-10">
                    <div className="flex gap-2">{LANGUAGES.map(l => (<button key={l.code} onClick={() => setLang(l.code)} className={`text-2xl transition-transform ${lang === l.code ? 'scale-125' : 'opacity-50 grayscale hover:grayscale-0'}`}>{l.flag}</button>))}</div>
                    <button onClick={() => setView('admin_login')} className="bg-white/80 p-2 rounded-xl backdrop-blur-sm text-slate-500 hover:text-indigo-600 shadow-sm"><Lock size={20}/></button>
                </div>
                <div className="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-8 z-10 pb-20">
                    <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-white shadow-2xl mb-4"><img src="foto.jpg" alt="Giulia Host" className="w-full h-full object-cover" /></div>
                    <div className="bg-white/90 backdrop-blur-md p-8 rounded-[2.5rem] shadow-xl border border-white/50 max-w-md w-full">
                    <img src="logo.png" alt="Tuscan Retreats" className="h-16 mx-auto mb-4" />
                    <h1 className="text-3xl font-black text-slate-900 mb-2 italic tracking-tight">{t.welcomeTitle}</h1>
                    <p className="text-slate-500 font-medium leading-relaxed mb-4">{t.welcomeSubtitle}</p>
                    <p className="text-indigo-600 font-bold text-sm italic mb-8">"{t.giuliaMessage}"</p>
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-3">{Object.values(PROPERTIES).map(p => (<button key={p.id} onClick={() => setSelectedProperty(p.id.toLowerCase())} className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${selectedProperty === p.id.toLowerCase() ? 'border-indigo-600 bg-indigo-50 text-indigo-900 shadow-md scale-[1.02]' : 'border-slate-100 text-slate-400'}`}><img src={p.logo} alt={p.name} className="w-16 h-16 rounded-full object-cover border-2 border-white shadow-sm" /><span className="text-xs font-bold leading-tight">{p.name}</span></button>))}</div>
                        <div className="text-[10px] text-slate-400 uppercase font-bold tracking-widest bg-slate-50 p-2 rounded-lg">CIN: {PROPERTIES[selectedProperty].cin} ‚Ä¢ CIR: {PROPERTIES[selectedProperty].cir}</div>
                        <div className="grid grid-cols-2 gap-3"><div><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-2">{t.checkInLabel}</label><input type="date" value={stayDates.checkIn} onChange={e => setStayDates(d => ({...d, checkIn: e.target.value}))} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 text-xs outline-none" /></div><div><label className="text-[9px] font-black uppercase text-slate-400 tracking-widest ml-2">{t.checkOutLabel}</label><input type="date" value={stayDates.checkOut} onChange={e => setStayDates(d => ({...d, checkOut: e.target.value}))} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 text-xs outline-none" /></div></div>
                        <div className="flex items-center gap-4 bg-slate-50 p-2 rounded-xl"><span className="flex-1 text-left ml-2 text-xs font-black uppercase text-slate-400">{t.guestsLabel}</span><button onClick={() => setGuestCount(Math.max(1, guestCount -1))} className="w-8 h-8 bg-white rounded-lg shadow-sm font-black text-slate-600">-</button><span className="font-black text-lg text-indigo-600 w-6">{guestCount}</span><button onClick={() => setGuestCount(Math.min(10, guestCount +1))} className="w-8 h-8 bg-white rounded-lg shadow-sm font-black text-slate-600">+</button></div>
                        <button onClick={startCheckin} disabled={!stayDates.checkIn || !stayDates.checkOut} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-indigo-700 active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 uppercase tracking-widest">{t.startCheckin}</button>
                    </div>
                    </div>
                    <div className="flex flex-col gap-2 w-full max-w-md"><p className="text-[10px] uppercase font-bold text-slate-500 tracking-widest">{t.searchLabel}</p><div className="flex gap-2"><input id="code-input" type="text" placeholder={t.searchPlaceholder} className="flex-1 p-4 bg-white/80 border-2 border-white rounded-2xl font-mono text-center outline-none focus:border-indigo-500 uppercase font-bold backdrop-blur-sm shadow-lg" /><button onClick={() => checkStatus(document.getElementById('code-input').value)} className="p-4 bg-white/80 border-2 border-white rounded-2xl hover:bg-white text-indigo-600 shadow-lg"><Search size={24}/></button></div></div>
                </div>
                </div>
            );

            if (view === 'admin_login') return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6"><div className="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center"><Lock size={48} className="mx-auto text-indigo-600 mb-6"/><h2 className="text-2xl font-black text-slate-900 mb-6">{t.adminLogin}</h2><input type="password" value={adminPassInput} onChange={e => setAdminPassInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAdminLogin()} placeholder={t.passwordPlaceholder} className="w-full p-4 bg-slate-100 rounded-xl mb-4 font-mono text-center text-lg outline-none focus:ring-2 focus:ring-indigo-500" /><div className="flex gap-3"><button onClick={() => setView('landing')} className="flex-1 py-4 bg-slate-100 text-slate-500 rounded-xl font-bold">{t.cancel}</button><button onClick={handleAdminLogin} className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-bold">{t.login}</button></div></div></div>
            );

            if (view === 'admin_dashboard') {
                // Raggruppamento locale
                const groups = allGuests.reduce((acc, g) => {
                    const gid = g.groupId || 'UNKNOWN';
                    if(!acc[gid]) acc[gid] = { id: gid, guests: [], property: g.property, total: g.totalGuests, dates: `${formatDateIT(g.checkIn)} > ${formatDateIT(g.checkOut)}` };
                    acc[gid].guests.push(g);
                    return acc;
                }, {});

                return (
                    <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans"><div className="max-w-6xl mx-auto"><div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-sm gap-4"><div><img src="logo.png" className="h-8 mb-2" /><h1 className="text-2xl font-black text-slate-900 uppercase italic flex items-center gap-2"><ShieldCheck className="text-indigo-600"/> {t.adminDashboard}</h1><p className="text-xs text-slate-400 font-bold mt-1">Modalit√† Protetta Attiva (Locale)</p></div><div className="flex gap-2"><button onClick={handleNukeDb} className="bg-red-600 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg shadow-red-200 hover:bg-red-700"><Bomb size={16}/> {t.nukeDb}</button><button onClick={() => { setAdminAuth(false); setView('landing'); }} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-slate-200"><LogOut size={16}/> Esci</button></div></div>
                    <div className="grid gap-6">{Object.values(groups).map(g => {
                        const registeredCount = g.guests.length; const missingCount = g.total - registeredCount; const currentAccessCode = g.guests[0]?.accessCode || PROPERTIES[g.guests[0]?.property || 'lovenest'].defaultCode; const isForceUnlocked = g.guests.some(guest => guest.accessAuthorized);
                        return (<div key={g.id} className="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-lg border border-slate-100 relative overflow-hidden"><div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div><div className="flex flex-col md:flex-row justify-between md:items-center gap-6 mb-8"><div className="flex items-center gap-4"><img src={PROPERTIES[g.guests[0]?.property || 'lovenest'].logo} className="w-16 h-16 rounded-full object-cover border-2 border-slate-200" /><div><h2 className="text-2xl font-black text-slate-800">{PROPERTIES[g.guests[0]?.property || 'lovenest'].name}</h2><div className="flex gap-2 mt-2"><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-xs font-mono font-bold tracking-widest">{g.id}</span><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-xs font-bold">{g.dates}</span></div></div></div><div className="flex flex-col items-end gap-2"><button title="Copia Gruppo" onClick={() => handleCopy(g.id)} className="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 flex items-center gap-1"><Copy size={12}/> Copia ID Gruppo</button><div className="bg-slate-50 p-2 rounded-xl border border-slate-200 flex items-center gap-2"><Key size={14} className="text-slate-400"/><span className="text-[10px] font-bold uppercase text-slate-400 mr-2">{t.accessCodeLabel}</span><input type="text" defaultValue={currentAccessCode} onChange={(e) => setEditingCode(e.target.value)} className="w-20 bg-transparent font-mono font-black text-center outline-none text-indigo-600"/><button title="Salva Codice" onClick={() => updateCode(g.id, editingCode || currentAccessCode)} className="bg-indigo-600 text-white p-1 rounded hover:bg-indigo-700"><Save size={14}/></button><button title="Copia Codice" onClick={() => handleCopy(currentAccessCode)} className="bg-slate-200 text-slate-600 p-1 rounded hover:bg-slate-300"><Copy size={14}/></button></div></div></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{g.guests.map(guest => (<div key={guest.id} className={`p-5 rounded-2xl border-2 transition-all ${guest.approved ? 'border-green-100 bg-green-50/50' : 'border-slate-100 bg-slate-50'}`}><div className="flex justify-between items-start mb-3"><span className="text-[10px] font-black uppercase tracking-widest text-slate-400">Ospite {guest.guestIndex}</span><div className="flex gap-1"><button onClick={() => setViewingDocGuest(guest)} className="p-1.5 bg-white rounded-lg shadow-sm text-blue-500 hover:scale-110 transition-transform" title={t.viewDocs}><Eye size={16}/></button><button onClick={() => setEditingGuest(guest)} className="p-1.5 bg-white rounded-lg shadow-sm text-orange-500 hover:scale-110 transition-transform" title={t.editGuest}><Pencil size={16}/></button><button onClick={() => handleDelete(guest.id)} className="p-1.5 bg-white rounded-lg shadow-sm text-red-500 hover:scale-110 transition-transform" title={t.deleteGuest}><Trash2 size={16}/></button></div></div><p className="font-black text-slate-800 uppercase text-sm truncate">{guest.nome} {guest.cognome}</p><div className="mt-4 pt-4 border-t border-slate-200/50"><button onClick={() => approveGuest(guest.id, guest.approved)} className={`w-full py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-colors ${guest.approved ? 'bg-red-50 text-red-500 hover:bg-red-100' : 'bg-green-500 text-white hover:bg-green-600 shadow-md shadow-green-200'}`}>{guest.approved ? t.revoke : t.approve}</button></div></div>))}</div><div className="mt-8 pt-6 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4"><div className="flex gap-2"><button onClick={() => handleDelete(g.id, true)} className="text-red-400 text-xs font-bold uppercase hover:text-red-600 flex items-center gap-2 px-4 py-2 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={14}/> {t.deleteAll}</button><button onClick={() => handleForceUnlock(g.id)} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase flex items-center gap-2 transition-colors ${isForceUnlocked ? 'bg-green-500 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}>{isForceUnlocked ? <CheckCircle size={14}/> : <Unlock size={14}/>} {isForceUnlocked ? "SBLOCCATO MANUALMENTE" : t.forceUnlock}</button></div></div></div>);
                    })}</div></div><DocModal guest={viewingDocGuest} onClose={() => setViewingDocGuest(null)} t={t} />{editingGuest && <EditModal guest={editingGuest} onClose={() => setEditingGuest(null)} onSave={handleEditSave} t={t} />}</div>
                );
            }
            
            // ... (IL RESTO DELLE VIEW: FORM, WAITING, SHARE_INTERSTITIAL SONO IDENTICHE AL CODICE PRECEDENTE E VANNO INSERITE QUI)
            // Per brevit√† di output, devi copiare le view `share_interstitial`, `form` e `waiting` dal blocco di codice precedente e incollarle qui.
            // L'unica differenza √® che ora usano le funzioni locali `saveCurrentGuest` ecc.
            
            if (view === 'share_interstitial') { return ( <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6"><div className="bg-white p-8 rounded-[2rem] shadow-xl max-w-md w-full text-center space-y-6"><div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto"><CheckCircle size={40}/></div><h2 className="text-2xl font-black text-slate-900">{t.statusPartial}</h2><p className="text-slate-500">Hai completato la registrazione per l'ospite {currentGuestIndex}.</p><div className="space-y-3"><div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4"><p className="text-xs font-bold text-yellow-800 uppercase mb-2">{t.notifyGiulia}</p><p className="text-xs text-yellow-700 mb-4">{t.notifyGiuliaDesc}</p><a href={getWhatsAppLink()} target="_blank" rel="noreferrer" onClick={() => setWaClicked(true)} className="w-full py-4 bg-green-500 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-green-600 transition-transform active:scale-95"><MessageCircle size={20}/> {t.notifyGiulia}</a></div>{currentGuestIndex < guestCount && (<><button onClick={() => { setCurrentGuestIndex(prev => prev + 1); setFormData({...INITIAL_FORM}); window.scrollTo(0,0); setView('form'); }} disabled={!waClicked} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-50"><UserPlus size={20}/> {t.continueHere}</button><div className="relative py-2"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><span className="relative bg-white px-2 text-xs text-slate-400 uppercase font-bold">OPPURE</span></div><button onClick={() => { legacyCopy(window.location.origin + window.location.pathname + '?groupId=' + groupId); alert("Link copiato! Invialo al tuo amico."); }} className="w-full py-4 bg-white border-2 border-indigo-100 text-indigo-600 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-50"><Share2 size={20}/> {t.shareLink}</button></>)}<button onClick={() => setView('waiting')} disabled={!waClicked} className="w-full py-4 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 disabled:opacity-50">{t.goToWaiting}</button></div></div></div> ); }

            if (view === 'form') { const isMinor = calculateAge(formData.dataNascita) < 14; return ( <div className="min-h-screen bg-slate-50 p-6 pb-32"><div className="max-w-xl mx-auto mb-8 sticky top-0 bg-slate-50/90 backdrop-blur-sm z-10 py-4 border-b border-slate-200 flex justify-between items-center"><button onClick={() => setView('landing')} className="p-2 bg-white rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors"><ArrowLeft size={24} className="text-slate-600"/></button><span className="text-xs font-black uppercase text-indigo-600 tracking-widest">{t.guestStep} {currentGuestIndex} / {guestCount}</span></div><div className="max-w-xl mx-auto space-y-6"><div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><div className="flex justify-between items-center mb-6"><h3 className="text-lg font-black text-slate-800 flex items-center gap-2"><ScanLine size={20}/> {t.personalData}</h3><div className="flex gap-2 p-1 bg-slate-100 rounded-lg"><button onClick={() => setFormData(p => ({...p, uploadMethod: 'camera'}))} className={`px-3 py-1 text-xs font-bold rounded-md ${formData.uploadMethod === 'camera' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>{t.useCamera}</button><button onClick={() => setFormData(p => ({...p, uploadMethod: 'file'}))} className={`px-3 py-1 text-xs font-bold rounded-md ${formData.uploadMethod === 'file' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>{t.useFile}</button></div></div>{formData.uploadMethod === 'camera' && (<div className="grid grid-cols-2 gap-4 mb-6"><button onClick={() => handleScan('CIE')} className="p-4 border-2 border-dashed border-indigo-200 bg-indigo-50 rounded-2xl flex flex-col items-center gap-2 hover:bg-indigo-100 transition-colors"><CreditCard className="text-indigo-600"/><span className="text-[10px] font-black uppercase text-indigo-800 text-center">{t.mrzCIE}</span></button><button onClick={() => handleScan('PASS')} className="p-4 border-2 border-dashed border-slate-200 bg-slate-50 rounded-2xl flex flex-col items-center gap-2 hover:bg-slate-100 transition-colors"><Globe className="text-slate-500"/><span className="text-[10px] font-black uppercase text-slate-600 text-center">{t.mrzPass}</span></button></div>)}<div className="space-y-4"><input type="text" placeholder={t.name} value={formData.nome} onChange={e => setFormData({...formData, nome: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="text" placeholder={t.surname} value={formData.cognome} onChange={e => setFormData({...formData, cognome: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="date" value={formData.dataNascita} onChange={e => setFormData({...formData, dataNascita: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><div className="grid grid-cols-2 gap-2"><input type="text" placeholder={t.birthPlace} value={formData.luogoNascita} onChange={e => setFormData({...formData, luogoNascita: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="text" placeholder={t.birthProv} maxLength={2} value={formData.provinciaNascita} onChange={e => setFormData({...formData, provinciaNascita: e.target.value.toUpperCase()})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none text-center" /></div><div className="grid grid-cols-2 gap-2"><select value={formData.sesso} onChange={e => setFormData({...formData, sesso: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none"><option value="M">M</option><option value="F">F</option></select><select value={formData.cittadinanza} onChange={e => setFormData({...formData, cittadinanza: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none"><option value="">{t.citizen}</option>{COMMON_COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}</select>{formData.cittadinanza === 'Altro' && <input type="text" placeholder="Specifica Cittadinanza" className="col-span-2 p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" onChange={e => setFormData({...formData, cittadinanza: e.target.value})}/>}</div><select value={formData.tipoDocumento} onChange={e => setFormData({...formData, tipoDocumento: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none"><option>C.I. Elettronica</option><option>Passaporto</option><option>Patente</option></select><div className="grid grid-cols-2 gap-2"><input type="text" placeholder={t.docNum} value={formData.numeroDocumento} onChange={e => setFormData({...formData, numeroDocumento: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="text" placeholder={t.docExp} onFocus={(e) => e.target.type = 'date'} onBlur={(e) => e.target.type = 'text'} value={formData.scadenzaDocumento} onChange={e => setFormData({...formData, scadenzaDocumento: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /></div>{formData.cittadinanza?.toLowerCase().includes('ital') ? (<select value={formData.enteRilascio} onChange={e => setFormData({...formData, enteRilascio: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none"><option value="">{t.docAuth}</option><option value="Comune">{t.docAuthComune}</option><option value="Questura">{t.docAuthQuestura}</option><option value="UCO">{t.docAuthUCO}</option><option value="MCTC">{t.docAuthMCTC}</option><option value="MAE">{t.docAuthMAE}</option></select>) : (<input type="text" placeholder={t.docAuth} value={formData.enteRilascio} onChange={e => setFormData({...formData, enteRilascio: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" />)}</div></div><div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><div className="flex flex-col gap-2 mb-6"><h3 className="text-lg font-black text-slate-800 flex items-center gap-2"><MapPin size={20}/> {t.residenceData}</h3>{currentGuestIndex > 1 && headOfGroupAddress && (<div className="flex gap-2 p-1 bg-slate-100 rounded-lg"><button onClick={() => setFormData(p => ({...p, ...headOfGroupAddress}))} className="flex-1 py-2 text-[10px] font-bold uppercase rounded-md bg-white shadow-sm text-indigo-600">{t.sameResQuestion}</button></div>)}</div><div className="space-y-4"><div className="grid grid-cols-3 gap-2"><input type="text" placeholder={t.address} value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} className="col-span-2 p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="text" placeholder={t.streetNum} value={formData.civico} onChange={e => setFormData({...formData, civico: e.target.value})} className="col-span-1 p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /></div><div className="grid grid-cols-3 gap-2"><input type="text" placeholder={t.city} value={formData.city} onChange={e => setFormData({...formData, city: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><input type="text" placeholder={t.zip} value={formData.zip} onChange={e => setFormData({...formData, zip: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" /><select value={formData.country} onChange={e => setFormData({...formData, country: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none"><option value="">{t.country}</option>{COMMON_COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}</select>{formData.country === 'Altro' && <input type="text" placeholder="Specifica Nazione" className="col-span-3 p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none" onChange={e => setFormData({...formData, country: e.target.value})}/>}</div></div></div><div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><h3 className="text-lg font-black text-slate-800 mb-6 flex items-center gap-2"><Camera size={20}/> {t.uploadDocStep}</h3>{formData.uploadMethod === 'file' ? (<div className="grid grid-cols-1 gap-4"><div className="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 relative"><input type="file" accept="application/pdf" className="absolute inset-0 opacity-0 cursor-pointer" onChange={() => setFormData(p => ({...p, imgPdf: true}))} /><File className="mx-auto text-slate-400 mb-2"/><span className="text-xs font-bold text-slate-600 block">{t.uploadPdf}</span>{formData.imgPdf && <span className="text-green-500 text-[10px] font-bold">PDF Caricato</span>}</div><div className="text-center text-[10px] font-bold text-slate-400">- OPPURE -</div><div className="grid grid-cols-2 gap-4"><div className="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 relative"><input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={() => setFormData(p => ({...p, imgFront: true}))} /><span className="text-[10px] font-bold text-slate-600">{t.docFront}</span>{formData.imgFront && <CheckCircle size={12} className="text-green-500 absolute top-2 right-2"/>}</div><div className="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 relative"><input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={() => setFormData(p => ({...p, imgBack: true}))} /><span className="text-[10px] font-bold text-slate-600">{t.docBack}</span>{formData.imgBack && <CheckCircle size={12} className="text-green-500 absolute top-2 right-2"/>}</div></div></div>) : (<div className="grid grid-cols-2 gap-4 mb-4"><button onClick={() => setFormData(p => ({...p, imgFront: true}))} className={`aspect-video rounded-xl border-2 border-dashed flex flex-col items-center justify-center ${formData.imgFront ? 'bg-green-50 border-green-500' : 'bg-slate-50'}`}><span className="text-[10px] font-bold uppercase">{t.docFront}</span></button><button onClick={() => setFormData(p => ({...p, imgBack: true}))} className={`aspect-video rounded-xl border-2 border-dashed flex flex-col items-center justify-center ${formData.imgBack ? 'bg-green-50 border-green-500' : 'bg-slate-50'}`}><span className="text-[10px] font-bold uppercase">{t.docBack}</span></button></div>)}{isMinor ? (<div className="bg-orange-50 p-4 rounded-xl border border-orange-200 text-center mt-4"><p className="text-xs font-bold text-orange-700 mb-2">{t.familyAdviceDesc}</p><button onClick={() => setFormData(p => ({...p, videoCallDone: true}))} className="bg-green-500 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase w-full">{t.callGiuliaBtn}</button></div>) : (<button onClick={() => setFormData(p => ({...p, selfie: true}))} className={`w-full py-4 rounded-xl border-2 border-dashed flex items-center justify-center mt-4 ${formData.selfie ? 'bg-green-50 border-green-500' : 'bg-slate-50'}`}><span className="text-xs font-bold uppercase">{t.docSelfie}</span></button>)}</div><div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden"><h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><ScrollText size={20}/> {t.rulesTitle}</h3><div className="flex justify-center mb-6"><a href="https://form.jotform.com/260433210963046" target="_blank" rel="noreferrer" className="w-full py-4 bg-indigo-50 text-indigo-600 rounded-xl font-bold uppercase flex items-center justify-center gap-2 hover:bg-indigo-100 transition-colors border border-indigo-100 shadow-sm"><ExternalLink size={20}/> {t.rulesOpenExternal}</a></div><label className="flex items-center gap-3 p-4 bg-slate-50 rounded-xl cursor-pointer border border-slate-200 hover:bg-indigo-50 hover:border-indigo-200 transition-colors"><input type="checkbox" checked={formData.rulesAccepted} onChange={e => setFormData(p => ({...p, rulesAccepted: e.target.checked}))} className="w-5 h-5 accent-indigo-600"/><div><span className="block text-xs font-bold text-slate-800 uppercase">{t.rulesAccept}</span><span className="block text-[10px] text-slate-500">{t.rulesDesc}</span></div></label></div><div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100"><SignaturePad onSave={d => setFormData(p => ({...p, signature: d}))} onClear={() => setFormData(p => ({...p, signature: null}))} /><div className="flex items-center gap-2 mt-4"><input type="checkbox" checked={formData.privacy} onChange={e => setFormData(p => ({...p, privacy: e.target.checked}))} /><span className="text-xs font-bold text-slate-500">{t.privacy}</span></div></div><button onClick={saveCurrentGuest} disabled={!formData.nome || !formData.cognome || !formData.privacy || !formData.rulesAccepted} className="w-full py-5 bg-indigo-600 text-white rounded-[2rem] font-black text-lg shadow-xl hover:bg-indigo-700 active:scale-95 transition-all disabled:opacity-50">{t.submit} <ArrowRight className="inline ml-2"/></button></div></div> );
            }

            if (view === 'waiting') {
                const registeredCount = groupGuests.length;
                const total = groupGuests[0]?.totalGuests || 1;
                const missing = total - registeredCount;

                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white text-center"><div className="w-full max-w-md space-y-12 animate-in zoom-in-95"><div><p className="text-xs font-black uppercase tracking-[0.3em] text-slate-400 mb-2">{t.waitingRoom}</p><h1 className="text-5xl font-black tracking-tighter mb-4">{PROPERTIES[selectedProperty]?.name}</h1><div className="inline-block px-4 py-2 bg-white/10 rounded-xl font-mono text-xl font-bold tracking-widest">{groupId}</div><button onClick={() => handleCopy(groupId)} className="block mx-auto mt-2 text-[10px] text-slate-400 uppercase font-bold hover:text-white flex items-center gap-1"><Copy size={12}/> {t.copyGroupCode}</button></div><div className={`w-48 h-48 mx-auto rounded-[3rem] flex items-center justify-center border-4 ${isGroupUnlocked ? 'bg-green-500 border-green-400' : 'bg-slate-800 border-slate-700'}`}>{isGroupUnlocked ? <Unlock size={80}/> : <Lock size={80}/>}</div><div><h2 className="text-3xl font-black italic uppercase tracking-tight mb-2">{isGroupUnlocked ? t.approved : t.pending}</h2><div className="mt-4 bg-white/10 p-4 rounded-xl"><p className="text-sm font-bold">{registeredCount} {t.waitingMsgPartial} {total} {t.waitingMsgTotal}</p>{!isGroupUnlocked && <p className="text-xs text-slate-400 mt-1">{t.waitingMsgHidden}</p>}</div></div>{isGroupUnlocked && (<div className="p-8 bg-white text-slate-900 rounded-[2.5rem] shadow-2xl"><p className="text-xs font-black uppercase tracking-widest text-slate-400 mb-2">{t.yourCode}</p><div className="flex items-center justify-center gap-3"><span className="text-6xl font-black font-mono tracking-tighter">{accessCode}{PROPERTIES[selectedProperty].suffix}</span></div><button onClick={() => handleCopy(accessCode)} className="w-full mt-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-colors"><Copy size={20}/> {t.copy}</button><div className="mt-4 bg-slate-100 p-4 rounded-xl text-left border-l-4 border-indigo-600"><p className="text-[10px] font-bold uppercase text-indigo-600 mb-1 flex items-center gap-1"><Info size={12}/> {t.instruction}</p><p className="text-sm font-bold text-slate-800 leading-relaxed">{PROPERTIES[selectedProperty].accessInstruction[lang] || PROPERTIES[selectedProperty].accessInstruction.it}</p></div><div className="mt-4 bg-blue-50 p-4 rounded-xl text-left border-l-4 border-blue-500"><p className="text-[10px] font-bold uppercase text-blue-600 mb-1 flex items-center gap-1"><Info size={12}/> {t.copyGroupCode}</p><p className="text-xs font-bold text-slate-600 mb-2">{t.copyGroupDesc}</p><button onClick={() => handleCopy(groupId)} className="w-full py-2 bg-white text-blue-600 border border-blue-200 rounded-lg text-xs font-bold uppercase flex items-center justify-center gap-2 hover:bg-blue-50"><Copy size={14}/> {t.copy}</button></div></div>)}<div className="grid grid-cols-1 gap-4"><a href={PROPERTIES[selectedProperty]?.welcomeBookUrl} target="_blank" rel="noreferrer" className="w-full py-4 bg-white/10 rounded-2xl hover:bg-white/20 transition-colors flex items-center justify-center gap-2 font-bold uppercase tracking-widest border border-white/20"><BookOpen size={20} className="text-indigo-400"/> {t.openWelcomeBook}</a><button onClick={() => setView('landing')} className="p-4 text-slate-400 hover:text-white flex items-center justify-center gap-2 text-xs font-bold uppercase"><Home size={16}/> Home</button></div>{copyFeedback && <div className="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg animate-bounce">{copyFeedback}</div>}</div></div>
                );
            }

            return <div></div>; // Placeholder for initial render
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
