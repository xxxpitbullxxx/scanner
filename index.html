<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V73 - Fix</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: sans-serif; }

        /* VIDEO */
        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
        }

        /* LAYOUT SCANNER */
        #scanner-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Lascia passare i click */
        }

        /* GUIDE VISIVE SEMPLICI */
        .guide-rect {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; height: 55vw; /* Proporzione Carta */
            border: 2px solid rgba(255,255,255,0.7); border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7);
        }
        .text-hint {
            position: absolute; top: -30px; width: 100%; text-align: center; color: #fff; font-weight: bold;
        }

        /* CONTROLLI (Basso) */
        .controls {
            position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: auto;
            display: flex; justify-content: center; gap: 20px; z-index: 50;
        }

        .btn {
            border: none; border-radius: 50px; padding: 15px 30px; 
            font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn-cam { background: #fff; color: #000; border: 4px solid #ccc; height: 80px; width: 80px; border-radius: 50%; font-size: 12px; }
        .btn-file { background: #007AFF; color: #fff; display: flex; align-items: center; }

        /* LOADING */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; display: none;
            color: #00E0FF; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        /* RISULTATI (Scrollabile) */
        #results {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 200; display: none;
            overflow-y: auto; /* ABILITA SCROLL */
            padding: 20px;
        }
        
        .res-container {
            padding-bottom: 100px; /* Spazio extra in fondo per lo scroll */
        }

        h2 { color: #32d74b; text-align: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .row { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .lbl { color: #888; font-size: 11px; display: block; margin-bottom: 4px; }
        .val { color: #fff; font-size: 18px; font-weight: bold; }

        .btn-close {
            width: 100%; padding: 20px; background: #444; color: #fff; 
            border: none; font-size: 18px; border-radius: 10px; margin-top: 20px;
        }

        /* Canvas nascosto */
        canvas { display: none; }
    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>

    <div id="scanner-ui">
        <div class="guide-rect">
            <div class="text-hint">INQUADRA IL RETRO</div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-file" onclick="document.getElementById('file-in').click()">Carica Foto</button>
        <button class="btn btn-cam" id="snap">SCATTA</button>
    </div>

    <input type="file" id="file-in" accept="image/*" style="display:none">
    
    <canvas id="cvs"></canvas>

    <div id="loader" style="display:none">Elaborazione in corso...</div>

    <div id="results">
        <div class="res-container">
            <h2>DATI ESTRATTI</h2>
            
            <div class="row"><span class="lbl">COGNOME</span><div class="val" id="r-cog">---</div></div>
            <div class="row"><span class="lbl">NOME</span><div class="val" id="r-nom">---</div></div>
            <div class="row"><span class="lbl">CITTADINANZA (DA MRZ)</span><div class="val" id="r-cit">---</div></div>
            <div class="row"><span class="lbl">NASCITA</span><div class="val" id="r-dob">---</div></div>
            <div class="row"><span class="lbl">SESSO</span><div class="val" id="r-sex">---</div></div>
            <div class="row"><span class="lbl">DOCUMENTO</span><div class="val" id="r-doc">---</div></div>
            <div class="row"><span class="lbl">SCADENZA</span><div class="val" id="r-scad">---</div></div>
            
            <h3 style="color:#FFD60A; margin-top:30px;">INDIRIZZO</h3>
            <div class="row"><span class="lbl">VIA / PIAZZA</span><div class="val" id="r-via">---</div></div>
            <div class="row"><span class="lbl">CIVICO</span><div class="val" id="r-civ">---</div></div>
            <div class="row"><span class="lbl">COMUNE</span><div class="val" id="r-com">---</div></div>
            <div class="row"><span class="lbl">PROVINCIA</span><div class="val" id="r-prov">---</div></div>

            <button class="btn-close" onclick="location.reload()">CHIUDI</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('cvs');
        const loader = document.getElementById('loader');
        const results = document.getElementById('results');

        // 1. AVVIO FOTOCAMERA (Versione Base e Stabile)
        async function startCamera() {
            try {
                // Nessuna richiesta 4K, solo "usa la camera dietro"
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error(err);
                alert("Errore Fotocamera: " + err.message + "\nUsa il tasto 'Carica Foto'.");
            }
        }
        // Avvia subito
        startCamera();

        // 2. SCATTO FOTO
        document.getElementById('snap').addEventListener('click', () => {
            processImage(video);
        });

        // 3. CARICAMENTO FILE (Fix Analisi)
        document.getElementById('file-in').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = () => processImage(img); // Avvia analisi appena caricata
                    img.src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // 4. ELABORAZIONE IMMAGINE
        async function processImage(source) {
            loader.style.display = 'flex';
            
            // Imposta canvas
            const ctx = canvas.getContext('2d');
            canvas.width = source.videoWidth || source.naturalWidth;
            canvas.height = source.videoHeight || source.naturalHeight;
            
            // Disegna immagine
            ctx.drawImage(source, 0, 0);

            // Filtro per aiutare OCR
            ctx.filter = 'grayscale(100%) contrast(150%)';
            ctx.drawImage(canvas, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                parseData(text);
                
                loader.style.display = 'none';
                results.style.display = 'block'; // Mostra risultati
            } catch (e) {
                alert("Errore OCR: " + e.message);
                loader.style.display = 'none';
            }
        }

        // 5. PARSING DATI (Logica Corretta)
        function parseData(text) {
            const clean = text.toUpperCase().replace(/\s/g, ''); 
            const lines = text.toUpperCase().split('\n');

            // --- MRZ e CITTADINANZA ---
            // Cerca riga che inizia con C< o I< seguito da 3 lettere (Cittadinanza)
            // Es: C<ITA...
            let line1 = clean.match(/([ACI])<([A-Z]{3})([A-Z0-9]{9})/);
            if(line1) {
                document.getElementById('r-cit').innerText = line1[2]; // Prende ITA o altro
                document.getElementById('r-doc').innerText = line1[3];
            } else {
                // Fallback ricerca ITA
                let fallback = clean.match(/ITA([A-Z0-9]{9})/);
                if(fallback) {
                     document.getElementById('r-cit').innerText = "ITA";
                     document.getElementById('r-doc').innerText = fallback[1];
                }
            }

            // Cognome/Nome
            let nameMatch = clean.match(/([A-Z]+)<<([A-Z]+)/);
            if(nameMatch) {
                document.getElementById('r-cog').innerText = nameMatch[1];
                document.getElementById('r-nom').innerText = nameMatch[2].replace(/</g, ' ');
            }

            // Date e Sesso
            let bioMatch = clean.match(/(\d{6})\d([MF])(\d{6})/);
            if(bioMatch) {
                let d = bioMatch[1];
                let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
                document.getElementById('r-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                document.getElementById('r-sex').innerText = bioMatch[2];

                let e = bioMatch[3];
                let ey = '20'+e.substr(0,2);
                document.getElementById('r-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
            }

            // --- INDIRIZZO (Splitter V3) ---
            let addrLine = lines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE)\s/));
            if(addrLine) {
                let raw = addrLine.replace(/[^A-Z0-9\s,\.\(\)]/g, '').trim(); 
                
                // Prov
                let provM = raw.match(/\(([A-Z]{2})\)/);
                if(provM) {
                    document.getElementById('r-prov').innerText = provM[1];
                    raw = raw.replace(provM[0], '').trim();
                }

                // Civico
                let civM = raw.match(/(?:N\.|,)\s*(\d+[A-Z]?)/) || raw.match(/\s(\d+[A-Z]?)$/);
                if(civM) {
                    document.getElementById('r-civ').innerText = civM[1];
                    let parts = raw.split(civM[0]);
                    document.getElementById('r-via').innerText = parts[0].replace(/,$/, '').trim();
                    if(parts[1]) document.getElementById('r-com').innerText = parts[1].trim();
                } else {
                    document.getElementById('r-via').innerText = raw;
                }
            }
        }
    </script>
</body>
</html>
