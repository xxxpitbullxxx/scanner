<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V74 - HighRes</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; background: #000; height: 100vh; overflow: hidden; font-family: Arial, sans-serif; }

        /* VIDEO FULLSCREEN */
        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; 
        }

        /* LIVELLO ANCORE (Guide visive) */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        }

        /* Sagoma Generale */
        .card-shape {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85vw; aspect-ratio: 1.58;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); /* Scurisce fuori */
            border-radius: 10px;
        }

        /* ANCORA GIALLA (Indirizzo) */
        .anchor-addr {
            position: absolute; top: 12%; left: 2%; width: 96%; height: 25%;
            border: 2px solid #FFD60A; background: rgba(255, 214, 10, 0.1);
        }
        .tag-addr { position: absolute; top: -18px; left: 0; background: #FFD60A; color: #000; font-size: 10px; padding: 2px 4px; font-weight: bold; }

        /* ANCORA BLU (MRZ) */
        .anchor-mrz {
            position: absolute; bottom: 5%; left: 2%; width: 96%; height: 35%;
            border: 2px solid #00E0FF; background: rgba(0, 224, 255, 0.1);
        }
        .tag-mrz { position: absolute; top: -18px; left: 0; background: #00E0FF; color: #000; font-size: 10px; padding: 2px 4px; font-weight: bold; }

        /* UI */
        .controls {
            position: absolute; bottom: 30px; width: 100%; text-align: center; pointer-events: auto;
            display: flex; justify-content: center; gap: 30px; z-index: 50;
        }
        .btn {
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; color: #fff; font-size: 11px;
            box-shadow: 0 4px 10px #000;
        }
        .btn-shot { background: rgba(255,0,0,0.6); font-size: 14px; }
        .btn-file { background: #007AFF; }

        /* LOADING */
        #loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            color: #00E0FF; flex-direction: column; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold;
        }

        /* RISULTATI */
        #results {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 200; display: none; overflow-y: auto; padding: 20px;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .full { grid-column: span 2; }
        .field { background: #222; padding: 10px; border-radius: 5px; border-left: 4px solid #333; }
        .f-addr { border-left-color: #FFD60A; }
        .f-mrz { border-left-color: #00E0FF; }
        .l { color: #888; font-size: 10px; display: block; margin-bottom: 3px; }
        .v { color: #fff; font-size: 15px; font-weight: bold; word-break: break-word; }
        .btn-close { width: 100%; padding: 15px; background: #444; color: #fff; border: none; font-size: 18px; border-radius: 8px; }

        canvas { display: none; }
    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="overlay">
        <div class="card-shape">
            <div class="anchor-addr"><div class="tag-addr">INDIRIZZO (Giallo)</div></div>
            <div class="anchor-mrz"><div class="tag-mrz">CODICI (Blu)</div></div>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-file" onclick="document.getElementById('file-in').click()">CARICA<br>FOTO</button>
        <button class="btn btn-shot" id="snap">SCATTA</button>
    </div>

    <input type="file" id="file-in" accept="image/*" style="display:none">
    
    <canvas id="cvs-main"></canvas>
    <canvas id="cvs-crop"></canvas>

    <div id="loader">
        <div>ANALISI IN CORSO...</div>
        <div style="font-size:12px; color:#aaa; margin-top:10px;">Leggo Zona Gialla & Blu Separately</div>
    </div>

    <div id="results">
        <h3 style="color:#32d74b; text-align:center;">DATI CARTA</h3>
        
        <div class="grid">
            <div class="field full f-mrz"><span class="l">COGNOME</span><span class="v" id="r-cog">---</span></div>
            <div class="field full f-mrz"><span class="l">NOME</span><span class="v" id="r-nom">---</span></div>
            <div class="field f-mrz"><span class="l">NASCITA</span><span class="v" id="r-dob">---</span></div>
            <div class="field f-mrz"><span class="l">SESSO</span><span class="v" id="r-sex">---</span></div>
            <div class="field full f-mrz"><span class="l">DOCUMENTO</span><span class="v" id="r-doc">---</span></div>
            <div class="field f-mrz"><span class="l">SCADENZA</span><span class="v" id="r-scad">---</span></div>
            <div class="field f-mrz"><span class="l">CITTADINANZA</span><span class="v" id="r-cit">---</span></div>
        </div>

        <h3 style="color:#FFD60A; margin:0 0 10px;">RESIDENZA</h3>
        <div class="grid">
            <div class="field full f-addr"><span class="l">VIA</span><span class="v" id="r-via">---</span></div>
            <div class="field f-addr"><span class="l">CIVICO</span><span class="v" id="r-civ">---</span></div>
            <div class="field f-addr"><span class="l">PROVINCIA</span><span class="v" id="r-prov">---</span></div>
            <div class="field full f-addr"><span class="l">COMUNE</span><span class="v" id="r-com">---</span></div>
        </div>

        <button class="btn-close" onclick="location.reload()">CHIUDI</button>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const mainCvs = document.getElementById('cvs-main');
        const cropCvs = document.getElementById('cvs-crop');
        const loader = document.getElementById('loader');

        // 1. FOTOCAMERA AD ALTA RISOLUZIONE (Cruciale!)
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "environment", 
                width: { ideal: 4096 }, // Chiedo il 4K
                height: { ideal: 2160 } 
            } 
        }).then(stream => video.srcObject = stream).catch(e => console.error(e));

        // 2. SCATTO LIVE
        document.getElementById('snap').addEventListener('click', () => analyzeImage(video));

        // 3. CARICAMENTO FILE
        document.getElementById('file-in').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const img = new Image();
                img.onload = () => analyzeImage(img);
                img.src = URL.createObjectURL(e.target.files[0]);
            }
        });

        // 4. ANALISI ZONALE (IL SEGRETO)
        async function analyzeImage(source) {
            loader.style.display = 'flex';

            // Setup Canvas Principale
            const ctx = mainCvs.getContext('2d');
            let w = source.videoWidth || source.naturalWidth;
            let h = source.videoHeight || source.naturalHeight;
            mainCvs.width = w; mainCvs.height = h;
            ctx.drawImage(source, 0, 0);

            // --- FASE 1: RITAGLIO ZONA GIALLA (INDIRIZZO) ---
            // Coordinate (Top 12% a 37% circa)
            let addrY = h * 0.12;
            let addrH = h * 0.25;
            cropCvs.width = w; cropCvs.height = addrH;
            cropCvs.getContext('2d').drawImage(mainCvs, 0, addrY, w, addrH, 0, 0, w, addrH);
            
            // OCR INDIRIZZO
            let textAddr = "";
            try {
                const res = await Tesseract.recognize(cropCvs, 'ita');
                textAddr = res.data.text;
            } catch(e) {}

            // --- FASE 2: RITAGLIO ZONA BLU (MRZ) ---
            // Coordinate (Bottom 35%)
            let mrzY = h * 0.60; 
            let mrzH = h * 0.35;
            cropCvs.width = w; cropCvs.height = mrzH;
            
            // Filtro contrasto alto per MRZ
            let mCtx = cropCvs.getContext('2d');
            mCtx.filter = 'grayscale(100%) contrast(150%)';
            mCtx.drawImage(mainCvs, 0, mrzY, w, mrzH, 0, 0, w, mrzH);

            // OCR MRZ
            let textMrz = "";
            try {
                const res = await Tesseract.recognize(cropCvs, 'ita');
                textMrz = res.data.text;
            } catch(e) {}

            // --- FASE 3: PARSING TOTALE ---
            parseAll(textAddr, textMrz);
            loader.style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }

        function parseAll(addrRaw, mrzRaw) {
            const cleanMrz = mrzRaw.toUpperCase().replace(/\s/g, '');
            const linesAddr = addrRaw.toUpperCase().split('\n');

            // --- MRZ PARSER ---
            let docM = cleanMrz.match(/[CI]<([A-Z]{3})([A-Z0-9]{9})/); // C<ITA...
            if(!docM) docM = cleanMrz.match(/([A-Z]{3})([A-Z0-9]{9})/); // Fallback
            
            let nameM = cleanMrz.match(/([A-Z]+)<<([A-Z]+)/);
            let bioM = cleanMrz.match(/(\d{6})\d([MF])(\d{6})/);

            if(docM) {
                document.getElementById('r-cit').innerText = docM[1]; // ITA
                document.getElementById('r-doc').innerText = docM[2]; // Num Doc
            }
            if(nameM) {
                document.getElementById('r-cog').innerText = nameM[1];
                document.getElementById('r-nom').innerText = nameM[2].replace(/</g, ' ');
            }
            if(bioMatch = cleanMrz.match(/(\d{6})\d([MF])(\d{6})/)) {
                 let d = bioMatch[1];
                 let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
                 document.getElementById('r-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                 document.getElementById('r-sex').innerText = bioMatch[2];
                 
                 let e = bioMatch[3];
                 let ey = '20'+e.substr(0,2);
                 document.getElementById('r-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
            }

            // --- ADDR PARSER (V3 - Logic "N.") ---
            // Cerca la riga con VIA/PIAZZA
            let addrLine = linesAddr.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE|LARGO|V\.)\s/));
            
            if(addrLine) {
                let txt = addrLine.replace(/[^A-Z0-9\s,\.\(\)]/g, '').trim(); 

                // 1. PROV
                let provM = txt.match(/\(([A-Z]{2})\)/);
                if(provM) {
                    document.getElementById('r-prov').innerText = provM[1];
                    txt = txt.replace(provM[0], '');
                }

                // 2. CIVICO
                let civM = txt.match(/(?:N\.|,)\s*(\d+[A-Z]?)/) || txt.match(/\s(\d+[A-Z]?)$/);
                if(civM) {
                    document.getElementById('r-civ').innerText = civM[1];
                    let parts = txt.split(civM[0]);
                    
                    document.getElementById('r-via').innerText = parts[0].replace(/,$/, '').trim();
                    if(parts[1]) document.getElementById('r-com').innerText = parts[1].trim();
                } else {
                    document.getElementById('r-via').innerText = txt;
                }
            }
        }
    </script>
</body>
</html>
