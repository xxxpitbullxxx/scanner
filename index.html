<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V34 - Light Flex</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* Layout a colonna che riempie lo schermo senza scorrere */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background: #000; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* La camera occupa tutto lo spazio disponibile in alto */
        .cam-area { 
            position: relative; flex: 1; background: #000; overflow: hidden; 
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Mirino Ottimizzato */
        .guide-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; height: 35%; 
            border: 4px solid #007AFF; 
            border-radius: 12px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); /* Scurisce lo sfondo */
            z-index: 10;
        }

        /* Pannello Risultati: Bianco, fisso in basso, non copre nulla */
        .result-panel { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 20px 20px 0 0; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
            /* Altezza massima per evitare che esca dallo schermo su telefoni piccoli */
            max-height: 50vh; 
            overflow-y: auto;
        }

        .btn-action { 
            background: #007AFF; color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: 700; 
            text-transform: uppercase; cursor: pointer; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,122,255,0.3);
        }
        .btn-action:active { transform: scale(0.98); }

        /* Campi Dati Ben Visibili */
        .data-row { 
            background: #f2f2f7; border-radius: 10px; padding: 12px; 
            border-left: 6px solid #ccc; display: flex; flex-direction: column;
        }
        .data-row label { font-size: 11px; font-weight: 800; color: #8e8e93; text-transform: uppercase; margin-bottom: 4px; }
        .data-val { font-size: 18px; font-weight: 600; color: #1c1c1e; min-height: 24px; word-break: break-all; }

        /* Colori di stato */
        .data-row.success { border-left-color: #34C759; background: #e8fce8; } /* Verde */
        .data-row.warning { border-left-color: #FF9500; background: #fff5e6; } /* Arancione */

        #status-log { text-align: center; font-size: 12px; color: #888; margin-top: 5px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="cam-area">
        <video id="webcam" autoplay playsinline></video>
        <div class="guide-box"></div>
    </div>

    <div class="result-panel">
        <button class="btn-action" id="run-scan">SCANSIONA DOCUMENTO</button>

        <div class="data-row" id="row-doc">
            <label>Numero Documento</label>
            <div class="data-val" id="val-doc">---</div>
        </div>
        
        <div class="data-row" id="row-dob">
            <label>Data di Nascita</label>
            <div class="data-val" id="val-dob">---</div>
        </div>

        <div class="data-row" id="row-nom">
            <label>Nome Completo</label>
            <div class="data-val" id="val-nom">---</div>
        </div>

        <div id="status-log">Pronto. Inquadra il retro.</div>
    </div>

    <canvas id="hidden-canvas"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('hidden-canvas');
        const log = document.getElementById('status-log');

        // Configurazione Camera
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 } } 
        }).then(stream => video.srcObject = stream);

        document.getElementById('run-scan').addEventListener('click', async () => {
            log.innerText = "ELABORAZIONE AD ALTO CONTRASTO...";
            
            // 1. Cattura immagine
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            // Ritaglio che corrisponde al rettangolo blu (circa)
            const cw = vw * 0.90;
            const ch = vh * 0.35;
            const cx = (vw - cw) / 2;
            const cy = (vh - ch) / 2;

            canvas.width = cw * 1.5; // Leggero zoom digitale 1.5x
            canvas.height = ch * 1.5;
            
            const ctx = canvas.getContext('2d');
            // Filtro per massimizzare la leggibilità su sfondo chiaro
            ctx.filter = 'grayscale(100%) contrast(200%) brightness(105%)';
            ctx.drawImage(video, cx, cy, cw, ch, 0, 0, canvas.width, canvas.height);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                    logger: m => log.innerText = `Lettura: ${Math.round(m.progress * 100)}%`
                });
                
                parseData(text);
                log.innerText = "SCANSIONE COMPLETATA";
            } catch (e) { log.innerText = "Errore: Riprova"; }
        });

        // Funzione di pulizia caratteri (LL NNNNN LL)
        function fixCie(str) {
            if (!str) return "";
            let res = "";
            // Puliamo caratteri strani
            let s = str.replace(/[^A-Z0-9]/g, '');
            // Prendiamo max 9 caratteri
            s = s.substring(0, 9);
            
            for(let i=0; i<s.length; i++) {
                if ([0,1,7,8].includes(i)) { // Lettere
                    res += s[i].replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
                } else { // Numeri
                    res += s[i].replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8').replace(/A/g,'4');
                }
            }
            return res;
        }

        function parseData(raw) {
            console.log(raw);
            const lines = raw.split('\n').map(l => l.replace(/\s/g, '').toUpperCase()).filter(l => l.length > 5);

            // 1. DATA DI NASCITA (La più facile da trovare: inizia con numeri)
            let dateRow = lines.find(l => l.match(/^\d/) && (l.includes('M') || l.includes('F')));
            if (dateRow) {
                let dob = dateRow.substring(0, 6).replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5');
                if (dob.length === 6) {
                    let d = dob.substr(4,2);
                    let m = dob.substr(2,2);
                    let y = (parseInt(dob.substr(0,2)) > 40) ? '19'+dob.substr(0,2) : '20'+dob.substr(0,2);
                    
                    document.getElementById('val-dob').innerText = `${d}/${m}/${y}`;
                    document.getElementById('row-dob').classList.add('success');
                }
            }

            // 2. NOME E COGNOME (Contiene <<)
            let nameRow = lines.find(l => l.includes('<<') && !l.match(/^\d/) && !l.includes('IT'));
            if (nameRow) {
                let parts = nameRow.split('<<');
                let full = (parts[0] + " " + (parts[1] || "")).replace(/</g, ' ').replace(/[0-9]/g, '').trim();
                document.getElementById('val-nom').innerText = full;
                document.getElementById('row-nom').classList.add('success');
            }

            // 3. NUMERO DOCUMENTO (Contiene IT e numeri)
            let docRow = lines.find(l => (l.includes('IT') || l.includes('1T')) && l.match(/\d/) && l.includes('<'));
            
            // Logica: Se non trovo la riga perfetta, cerco qualsiasi cosa assomigli a 9 caratteri alfanumerici
            if (!docRow) {
                 // Tentativo disperato: cerca la prima riga che non sia data o nome
                 docRow = lines.find(l => l !== dateRow && l !== nameRow && l.length > 8);
            }

            if (docRow) {
                // Cerchiamo di estrarre il codice
                let m = docRow.match(/IT([A-Z0-9]{9})/);
                if (!m) m = docRow.match(/1T([A-Z0-9]{9})/);
                
                let code = "";
                if (m) {
                    code = fixCie(m[1]);
                } else {
                    // Se non troviamo "IT", prendiamo i primi 9 caratteri puliti della riga
                    code = fixCie(docRow);
                }

                document.getElementById('val-doc').innerText = code;
                
                // Se rispetta il formato perfetto (2L 5N 2L), diventa VERDE. Altrimenti ARANCIONE.
                if (code.match(/^[A-Z]{2}[0-9]{5}[A-Z]{2}$/)) {
                    document.getElementById('row-doc').className = "data-row success";
                } else {
                    document.getElementById('row-doc').className = "data-row warning";
                }
            }
        }
    </script>
</body>
</html>
