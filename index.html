<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner ID V29 - Sniper Scope</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; background: #000; color: white; overflow: hidden; }
        
        /* Area Camera a tutto schermo */
        .cam-area { position: relative; width: 100vw; height: 60vh; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* MIRINO DI PRECISIONE (SNIPER) */
        /* È stretto e lungo, serve solo per la riga MRZ */
        .sniper-guide { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 90%; 
            height: 15%; /* Molto sottile per prendere SOLO la riga */
            border: 3px solid #ff3b30; /* Rosso per alta visibilità */
            border-radius: 8px; 
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.9); /* Oscura tutto il resto */
            z-index: 10;
        }

        /* Linea centrale per aiutare l'allineamento */
        .sniper-line {
            position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(255, 59, 48, 0.5);
        }

        .controls { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40vh; 
            background: white; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; 
            color: #333; display: flex; flex-direction: column; align-items: center;
        }

        .btn-fire { 
            background: #ff3b30; color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }

        .result-box { width: 100%; text-align: left; }
        label { font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; }
        input { 
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px;
            border: 2px solid #ddd; border-radius: 8px; font-size: 22px; 
            font-weight: bold; text-align: center; letter-spacing: 2px;
        }
        
        /* Se valido diventa verde */
        input.valid { border-color: #34C759; color: #34C759; background: #f0fff4; }

        #debug { font-size: 10px; color: #aaa; margin-top: 10px; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div class="cam-area">
        <video id="webcam" autoplay playsinline></video>
        <div class="sniper-guide">
            <div class="sniper-line"></div>
        </div>
    </div>

    <div class="controls">
        <div id="status" style="margin-bottom: 10px; font-weight: bold; color: #ff3b30;">CENTRA SOLO LA RIGA "<<<"</div>
        <button class="btn-fire" id="snap-btn">CATTURA MRZ</button>

        <div class="result-box">
            <label>Numero Documento Rilevato</label>
            <input type="text" id="doc-result" placeholder="In attesa..." readonly>
        </div>
        <div id="debug">Ready.</div>
    </div>

    <canvas id="crop-canvas"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('crop-canvas');
        const docInput = document.getElementById('doc-result');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');

        // Avvio Camera 
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
        }).then(stream => { video.srcObject = stream; });

        document.getElementById('snap-btn').addEventListener('click', async () => {
            status.innerText = "ELABORAZIONE...";
            docInput.value = "";
            docInput.classList.remove('valid');

            const ctx = canvas.getContext('2d');
            
            // Calcoliamo le dimensioni reali del video rispetto allo schermo
            const videoW = video.videoWidth;
            const videoH = video.videoHeight;
            
            // Il mirino è al centro, largo 90% e alto 15%
            // Dobbiamo ritagliare ESATTAMENTE quella porzione dal video originale
            const cropW = videoW * 0.80; // Margine di sicurezza
            const cropH = videoH * 0.15;
            const cropX = (videoW - cropW) / 2;
            const cropY = (videoH - cropH) / 2;

            canvas.width = cropW;
            canvas.height = cropH;

            // Filtro Estremo: Solo Bianco e Nero puro
            ctx.filter = 'grayscale(100%) contrast(300%)';
            
            // Disegniamo solo la strisciolina centrale
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            try {
                // Whitelist: diciamo a Tesseract di cercare SOLO lettere maiuscole e numeri e il simbolo <
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                    logger: m => debug.innerText = `Scan: ${Math.round(m.progress * 100)}%`
                });

                analyzeSniperData(text);
            } catch (e) {
                status.innerText = "ERRORE TECNICO";
            }
        });

        function fixCIE(str) {
            // Correzione forzata: LL NNNNN LL
            let res = "";
            for(let i=0; i<Math.min(9, str.length); i++) {
                let c = str[i];
                if ([0,1,7,8].includes(i)) { // Lettere
                    res += c.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
                } else { // Numeri
                    res += c.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8').replace(/A/g,'4');
                }
            }
            return res;
        }

        function analyzeSniperData(raw) {
            console.log("Raw:", raw);
            const clean = raw.replace(/\s/g, '');
            
            // Cerchiamo il pattern specifico: CA50322TW
            // Pattern 1: Troviamo "ITA" seguito da 9 caratteri
            let match = clean.match(/ITA([A-Z0-9]{9})/);
            
            // Pattern 2: Troviamo 2 lettere, 5 numeri, 2 lettere (anche senza ITA)
            if (!match) match = clean.match(/[A-Z]{2}[0-9]{5}[A-Z]{2}/);
            
            // Pattern 3: C<IT...
            if (!match) match = clean.match(/C<IT([A-Z0-9]{9})/);

            if (match) {
                let found = match[1] || match[0];
                // Pulizia finale
                let finalCode = fixCIE(found);
                
                docInput.value = finalCode;
                docInput.classList.add('valid');
                status.innerText = "DOCUMENTO IDENTIFICATO";
                status.style.color = "#34C759";
            } else {
                status.innerText = "NESSUN DATO VALIDO - RIPROVA";
                debug.innerText = "Letto: " + raw.substring(0, 15) + "...";
            }
        }
    </script>
</body>
</html>
