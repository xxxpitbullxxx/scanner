<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V71 - Master</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; height: 100vh; overflow: hidden; font-family: Arial, sans-serif; }

        /* LAUNCHER (Per Fullscreen) */
        #launcher {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: #111; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        .btn-start {
            padding: 20px 40px; font-size: 22px; font-weight: bold; 
            background: #007AFF; color: white; border: none; border-radius: 50px;
            box-shadow: 0 0 30px rgba(0,122,255,0.5); cursor: pointer;
        }

        /* CONTAINER ROTANTE (Video + Rettangoli) */
        #rotator {
            position: absolute; width: 100vw; height: 100vh; 
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease; transform-origin: center center;
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        /* OVERLAY RETTANGOLI */
        #overlay {
            position: absolute; width: 80vw; aspect-ratio: 1.58; /* CIE Ratio */
            border-radius: 15px; pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); /* Maschera nera */
        }
        
        .box-addr {
            position: absolute; top: 15%; left: 3%; width: 94%; height: 25%;
            border: 2px solid #FFD60A; background: rgba(255, 214, 10, 0.1);
        }
        .box-mrz {
            position: absolute; bottom: 5%; left: 3%; width: 94%; height: 35%;
            border: 2px solid #00E0FF; background: rgba(0, 224, 255, 0.1);
        }
        .lbl { position: absolute; top: -15px; left: 0; background: inherit; color: #fff; font-size: 10px; padding: 2px; font-weight: bold; }

        /* UI FISSA (Bottoni) */
        #ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none;
        }
        
        /* Tasto Rotazione */
        .btn-rotate {
            position: absolute; top: 20px; right: 20px; pointer-events: auto;
            width: 60px; height: 60px; border-radius: 10px; background: #333; 
            border: 2px solid #fff; color: #fff; font-size: 30px; cursor: pointer;
        }

        /* Tasti Azione */
        .controls {
            position: absolute; right: 30px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 20px; pointer-events: auto;
        }
        .btn-circle {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff;
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 12px; color: #fff; cursor: pointer; text-align: center;
        }
        .btn-shot { background: rgba(255,0,0,0.6); }
        .btn-file { background: #007AFF; font-size: 10px; }

        /* RISULTATI */
        #results {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 200; display: none; overflow-y: auto; padding: 15px; pointer-events: auto;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .full { grid-column: span 2; }
        .field { background: #222; padding: 10px; border-radius: 5px; border-left: 4px solid #32d74b; }
        .field.addr { border-left-color: #FFD60A; }
        .l { color: #888; font-size: 9px; display: block; text-transform: uppercase; }
        .v { color: #fff; font-size: 16px; font-weight: bold; }
        .btn-close { width: 100%; padding: 15px; margin-top: 20px; background: #444; color: #fff; border: none; font-size: 18px; border-radius: 10px; }

        #loader {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #00E0FF; padding: 20px; border-radius: 10px; z-index: 150; font-weight: bold;
        }
        
        #file-in { display: none; }
    </style>
</head>
<body>

    <div id="launcher">
        <button class="btn-start" onclick="startApp()">AVVIA SCANNER</button>
        <p style="color:#aaa; margin-top:15px;">Gira il telefono in orizzontale</p>
    </div>

    <div id="rotator">
        <video id="webcam" autoplay playsinline muted></video>
        <div id="overlay">
            <div class="box-addr"><span class="lbl" style="background:#FFD60A; color:black">INDIRIZZO</span></div>
            <div class="box-mrz"><span class="lbl" style="background:#00E0FF; color:black">CODICI MRZ</span></div>
        </div>
    </div>

    <div id="ui">
        <button class="btn-rotate" onclick="rotateCam()">↻</button>
        <div class="controls">
            <button class="btn-circle btn-shot" id="snap">SCATTA</button>
            <button class="btn-circle btn-file" onclick="document.getElementById('file-in').click()">CARICA<br>FILE</button>
        </div>
    </div>

    <input type="file" id="file-in" accept="image/*">
    <canvas id="cvs" style="display:none"></canvas>
    <div id="loader">ELABORAZIONE...</div>

    <div id="results">
        <h3 style="color:#32d74b; text-align:center;">DATI ESTRATTI</h3>
        
        <div class="res-grid">
            <div class="field full"><span class="l">COGNOME</span><span class="v" id="r-cog">---</span></div>
            <div class="field full"><span class="l">NOME</span><span class="v" id="r-nom">---</span></div>
            <div class="field"><span class="l">NASCITA</span><span class="v" id="r-dob">---</span></div>
            <div class="field"><span class="l">SESSO</span><span class="v" id="r-sex">---</span></div>
            <div class="field full"><span class="l">DOCUMENTO</span><span class="v" id="r-doc">---</span></div>
            <div class="field"><span class="l">SCADENZA</span><span class="v" id="r-scad">---</span></div>
            <div class="field"><span class="l">CITTADINANZA</span><span class="v" id="r-cit">ITA</span></div>
        </div>

        <h4 style="color:#FFD60A; margin: 15px 0 5px;">RESIDENZA</h4>
        <div class="res-grid" style="margin-top:0;">
            <div class="field full addr"><span class="l">VIA</span><span class="v" id="r-via">---</span></div>
            <div class="field addr"><span class="l">CIVICO</span><span class="v" id="r-civ">---</span></div>
            <div class="field addr"><span class="l">PROVINCIA</span><span class="v" id="r-prov">---</span></div>
            <div class="field full addr"><span class="l">COMUNE</span><span class="v" id="r-com">---</span></div>
        </div>

        <button class="btn-close" onclick="location.reload()">CHIUDI</button>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const rotator = document.getElementById('rotator');
        const canvas = document.getElementById('cvs');
        const loader = document.getElementById('loader');
        
        let rotationAngle = 0;

        // AVVIO
        async function startApp() {
            document.getElementById('launcher').style.display = 'none';
            // Fullscreen
            try { if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); } catch(e){}
            
            // Camera
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                video.srcObject = stream;
            } catch(e) { alert("Errore camera: " + e.message); }
        }

        // ROTAZIONE MANUALE (La chiave per risolvere il tuo problema)
        function rotateCam() {
            rotationAngle = (rotationAngle + 90) % 360;
            rotator.style.transform = `rotate(${rotationAngle}deg)`;
            
            // Adatta le dimensioni per riempire lo schermo quando ruotato
            if(rotationAngle === 90 || rotationAngle === 270) {
                rotator.style.width = "100vh"; rotator.style.height = "100vw";
            } else {
                rotator.style.width = "100vw"; rotator.style.height = "100vh";
            }
        }

        // SCATTO
        document.getElementById('snap').addEventListener('click', () => processImage(video, true));
        
        // CARICA FILE
        document.getElementById('file-in').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const img = new Image();
                img.onload = () => processImage(img, false);
                img.src = URL.createObjectURL(e.target.files[0]);
            }
        });

        async function processImage(source, isCamera) {
            loader.style.display = 'block';
            const ctx = canvas.getContext('2d');
            
            let w = source.videoWidth || source.naturalWidth;
            let h = source.videoHeight || source.naturalHeight;

            // Se è la camera, dobbiamo rispettare la rotazione che hai impostato a schermo
            if(isCamera && (rotationAngle === 90 || rotationAngle === 270)) {
                canvas.width = h; canvas.height = w;
                ctx.translate(h/2, w/2);
                ctx.rotate(rotationAngle * Math.PI / 180);
                ctx.drawImage(source, -w/2, -h/2);
            } else {
                canvas.width = w; canvas.height = h;
                ctx.drawImage(source, 0, 0);
            }

            // Filtro Ottimizzato per CIE
            ctx.filter = 'grayscale(100%) contrast(160%)'; 
            ctx.drawImage(canvas, 0, 0); // Applica filtro

            try {
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('ita');
                await worker.initialize('ita');
                // Parametri per forzare lettura singola riga se serve
                await worker.setParameters({ tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<,./() ' });
                
                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                if(parseData(text)) {
                    document.getElementById('results').style.display = 'flex';
                    loader.style.display = 'none';
                } else {
                    alert("Dati non trovati. Se usi la fotocamera, assicurati di RUOTARE (tasto in alto) finché la carta non è dritta.");
                    loader.style.display = 'none';
                }
            } catch(e) {
                alert("Errore: " + e.message); loader.style.display = 'none';
            }
        }

        // PARSING CHIRURGICO (Anchor + Splitter)
        function parseData(text) {
            const clean = text.toUpperCase().replace(/\s/g, ''); // Per codici
            const rawLines = text.toUpperCase().split('\n'); // Per indirizzo
            let found = false;

            // 1. MRZ (Codici)
            let docM = clean.match(/[CI]<ITA([A-Z0-9]{9})/);
            if(!docM) docM = clean.match(/ITA([A-Z0-9]{9})/);
            let bioM = clean.match(/(\d{6})\d([MF])(\d{6})/);
            let nameM = clean.match(/([A-Z]+)<<([A-Z]+)/);

            if(docM && bioM && nameM) {
                document.getElementById('r-doc').innerText = docM[1];
                document.getElementById('r-cog').innerText = nameM[1];
                document.getElementById('r-nom').innerText = nameM[2].replace(/</g, ' ');

                let d = bioM[1];
                let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
                document.getElementById('r-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                document.getElementById('r-sex').innerText = bioM[2];

                let e = bioM[3];
                let ey = '20'+e.substr(0,2);
                document.getElementById('r-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
                found = true;
            }

            // 2. INDIRIZZO (Splitter V2)
            // Cerchiamo la riga che contiene "VIA" o "PIAZZA" e numeri
            let addrLine = rawLines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE|LARGO|STRADA)\s+[A-Z\s,]+[0-9]+/));
            
            if(addrLine) {
                // Pulizia base caratteri strani OCR
                let safeTxt = addrLine.replace(/[^A-Z0-9\s,\.\(\)]/g, '').trim(); 
                
                // A. PROVINCIA: Cerca (SI), (RM), ecc. alla fine
                let provMatch = safeTxt.match(/\(([A-Z]{2})\)/);
                if(provMatch) {
                    document.getElementById('r-prov').innerText = provMatch[1];
                    // Rimuovi la provincia dalla stringa per non confondere il comune
                    safeTxt = safeTxt.replace(provMatch[0], '').trim();
                }

                // B. CIVICO: Cerca il numero civico (es. ", 68" o " N. 68" o " 68 ")
                // Strategia: Cerca l'ultimo numero della stringa
                let civMatch = safeTxt.match(/(\d+[A-Z]?)\s*$/) || safeTxt.match(/,\s*(\d+[A-Z]?)/) || safeTxt.match(/\s(\d+[A-Z]?)\s/);
                
                if(civMatch) {
                    let civico = civMatch[1];
                    document.getElementById('r-civ').innerText = civico;

                    // Split su civico
                    let parts = safeTxt.split(civico);
                    
                    // VIA: è la prima parte
                    let viaRaw = parts[0].replace(/,\s*$/, '').replace(/N\.\s*$/, '').trim();
                    document.getElementById('r-via').innerText = viaRaw;

                    // COMUNE: è quello che resta dopo il civico (se c'è)
                    if(parts[1] && parts[1].trim().length > 2) {
                        document.getElementById('r-com').innerText = parts[1].trim();
                    } else {
                        // Se non c'è niente dopo il civico, il comune era prima del civico?
                        // Proviamo a vedere se "VIA ROMA 10 MILANO" è stato parsato male.
                        // Nel dubbio, se non trovi il comune, lascia ---
                    }
                } else {
                    // Fallback: Tutto in Via
                    document.getElementById('r-via').innerText = safeTxt;
                }
            }

            return found;
        }
    </script>
</body>
</html>
