<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V63 - Side Control</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        /* LAYOUT GENERALE */
        body { 
            margin: 0; padding: 0; background: #000; 
            height: 100vh; width: 100vw; overflow: hidden; 
            display: flex; flex-direction: row; /* Layout Orizzontale: Video a Sx, Tasti a Dx */
        }

        /* 1. AREA VIDEO (Sinistra, occupa tutto meno la barra) */
        #viewport {
            position: relative; flex: 1; height: 100%; 
            display: flex; align-items: center; justify-content: center;
            background: #000; overflow: hidden;
        }
        video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }

        /* 2. BARRA CONTROLLI (Destra, Fissa) */
        #sidebar {
            width: 120px; height: 100%; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 30px;
            z-index: 50; border-left: 1px solid #333;
        }

        /* TASTO SCATTO (Fuori dal video) */
        .btn-shot {
            width: 80px; height: 80px; border-radius: 50%;
            background: #fff; border: 4px solid #ccc;
            box-shadow: 0 0 10px rgba(255,255,255,0.5); cursor: pointer;
        }
        .btn-shot:active { background: #ccc; transform: scale(0.95); }

        /* TASTO AVVIO (Verde) */
        .btn-start {
            width: 80px; height: 80px; border-radius: 50%;
            background: #32d74b; border: 4px solid #fff;
            color: #000; font-weight: bold; font-size: 12px;
            cursor: pointer; text-transform: uppercase;
        }

        /* 3. SAGOMA CARTA (Centrata nel viewport) */
        .card-frame {
            position: relative; z-index: 10;
            /* Dimensione calcolata per stare comoda a sinistra della barra */
            width: 65vw; 
            aspect-ratio: 85.6 / 54; /* Ratio ID-1 */
            
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.85); /* Maschera Scura */
            pointer-events: none;
        }
        .card-frame.success { border-color: #32d74b; }

        .guide-text {
            position: absolute; top: -40px; width: 100%; text-align: center;
            color: #fff; font-family: Arial, sans-serif; font-weight: bold; text-shadow: 0 2px 4px #000;
        }

        /* LOADING & MESSAGGI */
        #overlay-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #00E0FF; padding: 20px; 
            border-radius: 10px; font-family: Arial; font-weight: bold; display: none; z-index: 100;
            text-align: center;
        }

        /* PANNELLO RISULTATI */
        #results {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 200; display: none;
            flex-direction: column; padding: 20px; overflow-y: auto; font-family: Arial;
        }
        .res-row { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .lbl { color: #888; font-size: 10px; text-transform: uppercase; }
        .val { color: #fff; font-size: 18px; font-weight: bold; }
        .btn-close { padding: 15px; background: #444; color: #fff; border: none; width: 100%; border-radius: 8px; font-size: 18px; }

        /* Rotazione forzata visiva */
        #rotate-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; text-align: center;
        }
        @media screen and (orientation: landscape) { #rotate-warning { display: none; } }

        canvas { display: none; }
    </style>
</head>
<body>

    <div id="rotate-warning">GIRA IL TELEFONO ↻</div>

    <div id="viewport">
        <video id="webcam" autoplay playsinline muted></video>
        <div class="card-frame" id="frame">
            <div class="guide-text">INQUADRA IL RETRO</div>
        </div>
        <div id="overlay-msg"></div>
    </div>

    <div id="sidebar">
        <button class="btn-start" id="btn-init" onclick="initCam()">AVVIA</button>
        <button class="btn-shot" id="btn-snap" style="display:none;" onclick="snap()"></button>
    </div>

    <div id="results">
        <h2 style="color:#32d74b; text-align:center;">DATI ESTRATTI</h2>
        <div class="res-row"><span class="lbl">Cognome</span><div class="val" id="r-cog">---</div></div>
        <div class="res-row"><span class="lbl">Nome</span><div class="val" id="r-nom">---</div></div>
        <div class="res-row"><span class="lbl">Data Nascita</span><div class="val" id="r-dob">---</div></div>
        <div class="res-row"><span class="lbl">Sesso</span><div class="val" id="r-sex">---</div></div>
        <div class="res-row"><span class="lbl">Cittadinanza</span><div class="val" id="r-cit">ITA</div></div>
        <div class="res-row"><span class="lbl">Numero Doc</span><div class="val" id="r-doc">---</div></div>
        <div class="res-row"><span class="lbl">Scadenza</span><div class="val" id="r-scad">---</div></div>
        <div class="res-row"><span class="lbl">Indirizzo</span><div class="val" id="r-via">---</div></div>
        <div class="res-row"><span class="lbl">Comune</span><div class="val" id="r-com">---</div></div>
        <button class="btn-close" onclick="location.reload()">CHIUDI</button>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const msg = document.getElementById('overlay-msg');
        const frame = document.getElementById('frame');

        // 1. AVVIO MANUALE (Per sbloccare permessi)
        async function initCam() {
            try {
                // Richiedi fullscreen
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                video.srcObject = stream;
                
                // Switch tasti
                document.getElementById('btn-init').style.display = 'none';
                document.getElementById('btn-snap').style.display = 'block';
            } catch (e) {
                alert("Errore: " + e.message);
            }
        }

        // 2. SCATTO E ANALISI
        async function snap() {
            msg.style.display = 'block';
            msg.innerText = "ANALISI IN CORSO...";
            
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // FILTRO V63: Contrasto estremo per leggere caratteri neri su sfondo CIE
            ctx.filter = 'grayscale(100%) contrast(200%) brightness(110%)';
            ctx.drawImage(video, 0, 0);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita');
                if(parseData(text)) {
                    frame.classList.add('success');
                    msg.style.display = 'none';
                    document.getElementById('results').style.display = 'flex';
                } else {
                    msg.innerText = "DATI NON LEGGIBILI. AVVICINATI.";
                    setTimeout(() => msg.style.display = 'none', 2000);
                }
            } catch (e) {
                msg.innerText = "ERRORE OCR";
            }
        }

        // 3. PARSER ANCHOR (Potenziato per Indirizzo)
        function parseData(raw) {
            const clean = raw.toUpperCase().replace(/\s/g, ''); 
            const lines = raw.toUpperCase().split('\n');

            let found = false;

            // A. MRZ (Codici in basso)
            // Cerca DocNum (C<ITA...)
            let docM = clean.match(/[CI]<ITA([A-Z0-9]{9})/);
            if(!docM) docM = clean.match(/ITA([A-Z0-9]{9})/);
            
            // Cerca Cognome<<Nome
            let nameM = clean.match(/([A-Z]+)<<([A-Z]+)/);
            
            // Cerca Date
            let bioM = clean.match(/(\d{6})\d([MF])(\d{6})/);

            if(docM && nameM && bioM) {
                document.getElementById('r-doc').innerText = docM[1];
                document.getElementById('r-cog').innerText = nameM[1];
                document.getElementById('r-nom').innerText = nameMatch[2].replace(/</g, ' '); // FIX: era nameMatch

                // Date
                let d = bioM[1]; 
                let y = (parseInt(d.substr(0,2))>40 ? '19':'20') + d.substr(0,2);
                document.getElementById('r-dob').innerText = `${d.substr(4,2)}/${d.substr(2,2)}/${y}`;
                
                document.getElementById('r-sex').innerText = bioM[2];

                let e = bioM[3];
                let ey = '20'+e.substr(0,2);
                document.getElementById('r-scad').innerText = `${e.substr(4,2)}/${e.substr(2,2)}/${ey}`;
                found = true;
            }

            // B. INDIRIZZO (Cerca nella parte alta)
            let addrLine = lines.find(l => l.match(/(VIA|PIAZZA|CORSO|VIALE|LARGO|LOC)\s/));
            if(addrLine) {
                // Indirizzo grezzo
                let fullAddr = addrLine.replace(/[^A-Z0-9\s,\.]/g, '').trim();
                
                // Prova a separare Comune (Se c'è parentesi finale)
                let cityMatch = fullAddr.match(/([A-Z\s]+)\s*\(?([A-Z]{2})\)?$/);
                
                if(cityMatch) {
                    // Se trova (SI), separa
                    document.getElementById('r-com').innerText = cityMatch[1].trim() + " (" + cityMatch[2] + ")";
                    // La via è tutto quello che c'era prima del comune
                    let viaPart = fullAddr.replace(cityMatch[0], "").replace(/,\s*$/, "");
                    document.getElementById('r-via').innerText = viaPart;
                } else {
                    // Se non trova parentesi, mette tutto in via
                    document.getElementById('r-via').innerText = fullAddr;
                }
            }

            return found;
        }
    </script>
</body>
</html>
