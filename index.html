<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner V37 - Alloggiati Web</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: #f2f2f7; height: 100vh; display: flex; flex-direction: column;
        }

        .cam-section { 
            position: relative; height: 40vh; background: #000; overflow: hidden; 
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Mirino Allargato per prendere tutto il blocco MRZ */
        .mrz-guide { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; height: 35%; 
            border: 3px solid #007AFF; 
            border-radius: 8px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7);
            z-index: 10;
        }
        .mrz-guide::after {
            content: "INQUADRA TUTTE LE 3 RIGHE DEL RETRO";
            position: absolute; bottom: -25px; width: 100%; text-align: center;
            color: #007AFF; font-size: 11px; font-weight: bold;
        }

        .form-section { 
            flex: 1; background: #fff; padding: 20px; 
            border-radius: 20px 20px 0 0; margin-top: -20px; z-index: 20;
            overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }

        .btn-main { 
            background: #007AFF; color: white; width: 100%; padding: 16px; 
            border: none; border-radius: 12px; font-size: 18px; font-weight: 700; 
            cursor: pointer; margin-bottom: 10px; flex-shrink: 0;
        }

        /* Griglia Dati Alloggiati */
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .field-group { 
            background: #f5f5f7; padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e5ea;
        }
        .field-group.full { grid-column: span 2; }
        
        label { font-size: 10px; color: #888; font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 4px; }
        input { 
            width: 100%; border: none; background: transparent; font-size: 16px; 
            font-weight: 600; color: #1c1c1e; outline: none; font-family: monospace;
        }
        input::placeholder { color: #ccc; }

        .status-bar { font-size: 11px; text-align: center; color: #888; margin-top: 10px; }
        
        /* Evidenzia i campi compilati */
        .filled { background: #e8fce8; border-color: #34C759; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="cam-section">
        <video id="webcam" autoplay playsinline></video>
        <div class="mrz-guide"></div>
    </div>

    <div class="form-section">
        <button class="btn-main" id="scan-btn">SCANSIONA DATI OSPITE</button>

        <div class="field-group full">
            <label>Tipo Documento</label>
            <input type="text" value="CARTA D'IDENTITÀ" readonly>
        </div>

        <div class="grid-row">
            <div class="field-group" id="grp-doc">
                <label>Numero</label>
                <input type="text" id="res-doc" placeholder="---">
            </div>
            <div class="field-group" id="grp-cit">
                <label>Cittadinanza</label>
                <input type="text" id="res-cit" placeholder="---">
            </div>
        </div>

        <div class="grid-row">
            <div class="field-group" id="grp-cog">
                <label>Cognome</label>
                <input type="text" id="res-cog" placeholder="---">
            </div>
            <div class="field-group" id="grp-nom">
                <label>Nome</label>
                <input type="text" id="res-nom" placeholder="---">
            </div>
        </div>

        <div class="grid-row">
            <div class="field-group" id="grp-dob">
                <label>Nascita</label>
                <input type="text" id="res-dob" placeholder="GG/MM/AAAA">
            </div>
            <div class="field-group" id="grp-sex">
                <label>Sesso</label>
                <input type="text" id="res-sex" placeholder="M/F">
            </div>
        </div>

        <div class="grid-row">
            <div class="field-group full" id="grp-exp">
                <label>Scadenza Documento</label>
                <input type="text" id="res-exp" placeholder="GG/MM/AAAA">
            </div>
        </div>
        
        <div class="status-bar" id="log">Pronto per la scansione</div>
    </div>

    <canvas id="cvs"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('cvs');
        const log = document.getElementById('log');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } })
            .then(s => video.srcObject = s);

        document.getElementById('scan-btn').addEventListener('click', async () => {
            log.innerText = "Elaborazione dati completi...";
            const ctx = canvas.getContext('2d');
            
            // Ritaglio Ampio per prendere le 3 righe
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const cw = vw * 0.95; 
            const ch = vh * 0.35;
            const cx = (vw - cw) / 2;
            const cy = (vh - ch) / 2;

            canvas.width = cw * 2; // Zoom 2x
            canvas.height = ch * 2;
            
            ctx.filter = 'grayscale(100%) contrast(200%)';
            ctx.drawImage(video, cx, cy, cw, ch, 0, 0, canvas.width, canvas.height);

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'ita', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
                });
                parseAlloggiati(text);
                log.innerText = "Dati estratti";
            } catch (e) { log.innerText = "Riprova"; }
        });

        // Solita funzione di correzione
        function fix(s, type) {
            if(!s) return "";
            if(type === 'N') return s.replace(/O/g,'0').replace(/I/g,'1').replace(/S/g,'5').replace(/Z/g,'2').replace(/B/g,'8');
            if(type === 'L') return s.replace(/0/g,'O').replace(/1/g,'I').replace(/5/g,'S').replace(/2/g,'Z').replace(/8/g,'B');
            return s;
        }

        function formatDate(yymmdd) {
            if(!yymmdd || yymmdd.length !== 6) return yymmdd;
            let y = parseInt(yymmdd.substr(0,2));
            let m = yymmdd.substr(2,2);
            let d = yymmdd.substr(4,2);
            let fullY = (y > 40) ? '19'+y : '20'+y; // Logica secolo
            return `${d}/${m}/${fullY}`;
        }

        function parseAlloggiati(raw) {
            const lines = raw.split('\n').map(l => l.replace(/\s/g, '').toUpperCase()).filter(l => l.length > 5);
            console.log(lines);

            // 1. RIGA DOCUMENTO (C<IT...)
            let docLine = lines.find(l => (l.includes('IT') || l.includes('1T')) && l.includes('<') && l.match(/\d/));
            if (docLine) {
                let m = docLine.match(/IT([A-Z0-9]{9})/);
                if(!m) m = docLine.match(/1T([A-Z0-9]{9})/);
                
                if(m) {
                    let code = m[1];
                    // Fix: LL NNNNN LL
                    let finalCode = fix(code.substr(0,2),'L') + fix(code.substr(2,5),'N') + fix(code.substr(7,2),'L');
                    document.getElementById('res-doc').value = finalCode;
                    document.getElementById('grp-doc').classList.add('filled');
                    
                    // Cittadinanza (di solito è ITA prima del codice, o ricavata dal codice stato)
                    document.getElementById('res-cit').value = "ITALIA"; // Default per CIE
                    document.getElementById('grp-cit').classList.add('filled');
                }
            }

            // 2. RIGA DATI (Inizia con numeri: YYMMDD...)
            // Struttura: [Nascita 6] [Check 1] [Sesso 1] [Scadenza 6] ...
            let dataLine = lines.find(l => l.match(/^\d{6}/) && (l.includes('M') || l.includes('F')));
            if (dataLine) {
                // A. Data Nascita (Primi 6)
                let dobRaw = fix(dataLine.substr(0, 6), 'N');
                document.getElementById('res-dob').value = formatDate(dobRaw);
                document.getElementById('grp-dob').classList.add('filled');

                // B. Sesso (Carattere 8, indice 7)
                // A volte c'è un check digit in mezzo. Cerchiamo M o F nella prima metà
                let sexChar = dataLine.match(/[0-9]([MF])/);
                if(sexChar) {
                    document.getElementById('res-sex').value = sexChar[1];
                    document.getElementById('grp-sex').classList.add('filled');
                }

                // C. Scadenza (Dopo il sesso c'è la scadenza YYMMDD)
                // Esempio: 990101 1 M 280101
                let parts = dataLine.split(/[MF]/);
                if(parts[1] && parts[1].length >= 6) {
                    let expRaw = fix(parts[1].substr(0, 6), 'N');
                    document.getElementById('res-exp').value = formatDate(expRaw);
                    document.getElementById('grp-exp').classList.add('filled');
                }
            }

            // 3. RIGA NOMI (Cognome<<Nome)
            let nameLine = lines.find(l => l.includes('<<') && !l.includes('IT') && !l.match(/^\d/));
            if(nameLine) {
                let parts = nameLine.split('<<');
                let cog = fix(parts[0].replace(/</g, ''), 'L');
                let nom = fix(parts[1].replace(/</g, ''), 'L');
